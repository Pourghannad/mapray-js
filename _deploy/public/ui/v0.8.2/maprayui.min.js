!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@mapray/mapray-js")):"function"==typeof define&&define.amd?define(["@mapray/mapray-js"],t):(e=e||self).maprayui=t(e.mapray)}(this,(function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var a=function(e){return e&&e.Math==Math&&e},o=a("object"==typeof globalThis&&globalThis)||a("object"==typeof window&&window)||a("object"==typeof self&&self)||a("object"==typeof t&&t)||Function("return this")(),i=function(e){try{return!!e()}catch(e){return!0}},n=!i((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),s={}.propertyIsEnumerable,_=Object.getOwnPropertyDescriptor,c={f:_&&!s.call({1:2},1)?function(e){var t=_(this,e);return!!t&&t.enumerable}:s},u=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},h={}.toString,l="".split,p=i((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==function(e){return h.call(e).slice(8,-1)}(e)?l.call(e,""):Object(e)}:Object,f=function(e){return p(function(e){if(null==e)throw TypeError("Can't call method on "+e);return e}(e))},m=function(e){return"object"==typeof e?null!==e:"function"==typeof e},v=function(e,t){if(!m(e))return e;var r,a;if(t&&"function"==typeof(r=e.toString)&&!m(a=r.call(e)))return a;if("function"==typeof(r=e.valueOf)&&!m(a=r.call(e)))return a;if(!t&&"function"==typeof(r=e.toString)&&!m(a=r.call(e)))return a;throw TypeError("Can't convert object to primitive value")},d={}.hasOwnProperty,y=function(e,t){return d.call(e,t)},g=o.document,w=m(g)&&m(g.createElement),M=!n&&!i((function(){return 7!=Object.defineProperty((e="div",w?g.createElement(e):{}),"a",{get:function(){return 7}}).a;var e})),E=Object.getOwnPropertyDescriptor,A={f:n?E:function(e,t){if(e=f(e),t=v(t,!0),M)try{return E(e,t)}catch(e){}if(y(e,t))return u(!c.f.call(e,t),e[t])}},O=function(e){if(!m(e))throw TypeError(String(e)+" is not an object");return e},k=Object.defineProperty,T={f:n?k:function(e,t,r){if(O(e),t=v(t,!0),O(r),M)try{return k(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},b=n?function(e,t,r){return T.f(e,t,u(1,r))}:function(e,t,r){return e[t]=r,e},R=function(e,t){try{b(o,e,t)}catch(r){o[e]=t}return t},L=o["__core-js_shared__"]||R("__core-js_shared__",{}),N=Function.toString;"function"!=typeof L.inspectSource&&(L.inspectSource=function(e){return N.call(e)});var P,I,V,F,S=L.inspectSource,C=o.WeakMap,G="function"==typeof C&&/native code/.test(S(C)),U=r((function(e){(e.exports=function(e,t){return L[e]||(L[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.6.4",mode:"global",copyright:"Â© 2020 Denis Pushkarev (zloirock.ru)"})})),D=0,x=Math.random(),j=U("keys"),H={},K=o.WeakMap;if(G){var z=new K,Y=z.get,W=z.has,B=z.set;P=function(e,t){return B.call(z,e,t),t},I=function(e){return Y.call(z,e)||{}},V=function(e){return W.call(z,e)}}else{var q=j[F="state"]||(j[F]=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++D+x).toString(36)}(F));H[q]=!0,P=function(e,t){return b(e,q,t),t},I=function(e){return y(e,q)?e[q]:{}},V=function(e){return y(e,q)}}var X={set:P,get:I,has:V,enforce:function(e){return V(e)?I(e):P(e,{})},getterFor:function(e){return function(t){var r;if(!m(t)||(r=I(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},Z=r((function(e){var t=X.get,r=X.enforce,a=String(String).split("String");(e.exports=function(e,t,i,n){var s=!!n&&!!n.unsafe,_=!!n&&!!n.enumerable,c=!!n&&!!n.noTargetGet;"function"==typeof i&&("string"!=typeof t||y(i,"name")||b(i,"name",t),r(i).source=a.join("string"==typeof t?t:"")),e!==o?(s?!c&&e[t]&&(_=!0):delete e[t],_?e[t]=i:b(e,t,i)):_?e[t]=i:R(t,i)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||S(this)}))})),J=o,Q=function(e){return"function"==typeof e?e:void 0},$=Math.ceil,ee=Math.floor,te=function(e){return isNaN(e=+e)?0:(e>0?ee:$)(e)},re=Math.min,ae=Math.max,oe=Math.min,ie=function(e){return function(t,r,a){var o,i,n=f(t),s=(o=n.length)>0?re(te(o),9007199254740991):0,_=function(e,t){var r=te(e);return r<0?ae(r+t,0):oe(r,t)}(a,s);if(e&&r!=r){for(;s>_;)if((i=n[_++])!=i)return!0}else for(;s>_;_++)if((e||_ in n)&&n[_]===r)return e||_||0;return!e&&-1}},ne={includes:ie(!0),indexOf:ie(!1)}.indexOf,se=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"].concat("length","prototype"),_e={f:Object.getOwnPropertyNames||function(e){return function(e,t){var r,a=f(e),o=0,i=[];for(r in a)!y(H,r)&&y(a,r)&&i.push(r);for(;t.length>o;)y(a,r=t[o++])&&(~ne(i,r)||i.push(r));return i}(e,se)}},ce={f:Object.getOwnPropertySymbols},ue=function(e,t){return arguments.length<2?Q(J[e])||Q(o[e]):J[e]&&J[e][t]||o[e]&&o[e][t]}("Reflect","ownKeys")||function(e){var t=_e.f(O(e)),r=ce.f;return r?t.concat(r(e)):t},he=function(e,t){for(var r=ue(t),a=T.f,o=A.f,i=0;i<r.length;i++){var n=r[i];y(e,n)||a(e,n,o(t,n))}},le=/#|\.prototype\./,pe=function(e,t){var r=me[fe(e)];return r==de||r!=ve&&("function"==typeof t?i(t):!!t)},fe=pe.normalize=function(e){return String(e).replace(le,".").toLowerCase()},me=pe.data={},ve=pe.NATIVE="N",de=pe.POLYFILL="P",ye=pe,ge=A.f,we=function(e,t){var r,a,i,n,s,_=e.target,c=e.global,u=e.stat;if(r=c?o:u?o[_]||R(_,{}):(o[_]||{}).prototype)for(a in t){if(n=t[a],i=e.noTargetGet?(s=ge(r,a))&&s.value:r[a],!ye(c?a:_+(u?".":"#")+a,e.forced)&&void 0!==i){if(typeof n==typeof i)continue;he(n,i)}(e.sham||i&&i.sham)&&b(n,"sham",!0),Z(r,a,n,e)}},Me=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},Ee=[].slice,Ae={},Oe=function(e,t,r){if(!(t in Ae)){for(var a=[],o=0;o<t;o++)a[o]="a["+o+"]";Ae[t]=Function("C,a","return new C("+a.join(",")+")")}return Ae[t](e,r)};function ke(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function Te(e){return(Te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function be(e,t){return(be=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Re(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}we({target:"Function",proto:!0},{bind:Function.bind||function(e){var t=Me(this),r=Ee.call(arguments,1),a=function(){var o=r.concat(Ee.call(arguments));return this instanceof a?Oe(t,o.length,o):t.apply(e,o)};return m(t.prototype)&&(a.prototype=t.prototype),a}}),we({target:"Math",stat:!0},{sign:Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}});var Le=e.GeoMath,Ne=e.GeoPoint,Pe=function(t){function r(e,t,a){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=Re(this,Te(r).call(this))).createViewer(e,t,a),o._camera_parameter={latitude:0,longitude:0,height:0,pitch:0,yaw:0,fov:0,near:0,far:0},o._initCameraParameter(a),o._operation_mode=r.OperationMode.NONE,o._mouse_down_position=Le.createVector2f(),o._pre_mouse_position=Le.createVector2f(),o._rotate_center=Le.createVector3(),o._translate_drag=Le.createVector2f(),o._translate_eye_drag=Le.createVector2f(),o._rotate_drag=Le.createVector2f(),o._free_rotate_drag=Le.createVector2f(),o._height_drag=Le.createVector2f(),o._zoom_wheel=0,o._fovy_key=0,o._default_fov=r.DEFAULT_CAMERA_PARAMETER.fov,o._key_mode=!1,o}var a,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&be(e,t)}(r,t),a=r,(o=[{key:"createViewer",value:function(t,r,a){this._viewer&&this.destroy(),this._viewer=new e.Viewer(t,{dem_provider:this._createDemProvider(r,a),image_provider:this._createImageProvider(a),layers:a&&a.layers||null,render_callback:this,render_mode:a&&a.render_mode||e.Viewer.RenderMode.SURFACE,debug_stats:a&&a.debug_stats||null,attribution_controller:a&&a.attribution_controller||null});var o=this._viewer._canvas_element;return o.setAttribute("oncontextmenu","return false;"),o.setAttribute("tabindex","0"),this._addEventListener(),this._viewer}},{key:"destroy",value:function(){this._viewer&&(this._removeEventListener(),this._viewer.destroy(),this._viewer=null)}},{key:"_createDemProvider",value:function(t,r){return r&&r.dem_provider||new e.CloudDemProvider(t)}},{key:"_createImageProvider",value:function(t){return t&&t.image_provider||new e.StandardImageProvider("https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/",".jpg",256,2,18)}},{key:"_initCameraParameter",value:function(e){var t=e&&e.camera_position||r.DEFAULT_CAMERA_POSITION,a=e&&e.lookat_position||r.DEFAULT_LOOKAT_POSITION,o=e&&e.camera_parameter||r.DEFAULT_CAMERA_PARAMETER;this.setCameraPosition(t),this.setLookAtPosition(a),this.setCameraParameter(o),this._updateViewerCamera()}},{key:"_addEventListener",value:function(){var e=this._viewer._canvas_element;this._onBlur=this._onBlur.bind(this),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),window.addEventListener("blur",this._onBlur,{passive:!1}),e.addEventListener("mousedown",this._onMouseDown,{passive:!0}),e.addEventListener("mousemove",this._onMouseMove,{passive:!0}),document.addEventListener("mousemove",this._onMouseMove,{capture:!0}),e.addEventListener("mouseup",this._onMouseUp,{passive:!0}),document.addEventListener("mouseup",this._onMouseUp,{capture:!1}),e.addEventListener("wheel",this._onMouseWheel,{passive:!1}),e.addEventListener("keydown",this._onKeyDown,{capture:!1,passive:!1}),e.addEventListener("keyup",this._onKeyUp,{passive:!0})}},{key:"_removeEventListener",value:function(){var e=this._viewer._canvas_element;window.removeEventListener("blur",this._onBlur,{passive:!1}),e.removeEventListener("mousedown",this._onMouseDown,{passive:!0}),e.removeEventListener("mousemove",this._onMouseMove,{passive:!0}),document.removeEventListener("mousemove",this._onMouseMove,{capture:!0}),e.removeEventListener("mouseup",this._onMouseUp,{passive:!0}),document.removeEventListener("mouseup",this._onMouseUp,{capture:!1}),e.removeEventListener("wheel",this._onMouseWheel,{passive:!1}),e.removeEventListener("keydown",this._onKeyDown,{capture:!1,passive:!1}),e.removeEventListener("keyup",this._onKeyUp,{passive:!0})}},{key:"onStart",value:function(){}},{key:"onStop",value:function(){}},{key:"onUpdateFrame",value:function(e){this._translation(e),this._rotation(),this._freeRotation(e),this._translationOfHeight(),this._translationOfEyeDirection(),this._changeFovy(),this._correctAltitude(),this._updateClipPlane(),this._updateViewerCamera()}},{key:"_updateViewerCamera",value:function(){var e=this._viewer.camera,t=new Ne(this._camera_parameter.longitude,this._camera_parameter.latitude,this._camera_parameter.height).getMlocsToGocsMatrix(Le.createMatrix()),r=Le.rotation_matrix([1,0,0],this._camera_parameter.pitch,Le.createMatrix()),a=Le.rotation_matrix([0,0,1],this._camera_parameter.yaw,Le.createMatrix()),o=Le.mul_AA(a,r,Le.createMatrix());e.view_to_gocs=Le.mul_AA(t,o,Le.createMatrix()),e.fov=this._camera_parameter.fov,e.near=this._camera_parameter.near,e.far=this._camera_parameter.far}},{key:"_updateClipPlane",value:function(){var e=this._viewer.getElevation(this._camera_parameter.latitude,this._camera_parameter.longitude),t=Math.max(this._camera_parameter.height-e,r.MINIMUM_HEIGHT);this._camera_parameter.near=Math.max(t*r.NEAR_FACTOR,r.MINIMUM_NEAR),this._camera_parameter.far=Math.max(this._camera_parameter.near*r.FAR_FACTOR,r.MINIMUM_FAR)}},{key:"_correctAltitude",value:function(){var e=this._viewer.getElevation(this._camera_parameter.latitude,this._camera_parameter.longitude);this._camera_parameter.height=Math.max(this._camera_parameter.height,e+r.MINIMUM_HEIGHT)}},{key:"resetOpEvent",value:function(){this._resetEventParameter()}},{key:"onBlur",value:function(e){this._resetEventParameter()}},{key:"_onBlur",value:function(e){this.onBlur(e)}},{key:"onMouseDown",value:function(e,t){if(this._mouse_down_position=e,this._pre_mouse_position=e,0==t.button)if(t.shiftKey){this._operation_mode=r.OperationMode.ROTATE;var a=this._viewer.camera.getCanvasRay(this._mouse_down_position);this._rotate_center=this._viewer.getRayIntersection(a)}else t.ctrlKey?this._operation_mode=r.OperationMode.FREE_ROTATE:this._operation_mode=r.OperationMode.TRANSLATE;else 1==t.button?(this._operation_mode=r.OperationMode.ROTATE,a=this._viewer.camera.getCanvasRay(this._mouse_down_position),this._rotate_center=this._viewer.getRayIntersection(a)):2==t.button&&(this._operation_mode=t.shiftKey?r.OperationMode.HEIGHT_TRANSLATE:r.OperationMode.EYE_TRANSLATE)}},{key:"_onMouseDown",value:function(e){var t=this._mousePos(this._viewer._canvas_element,e);this.onMouseDown(t,e)}},{key:"onMouseMove",value:function(e,t){var a=e;this._operation_mode==r.OperationMode.TRANSLATE?(this._translate_drag[0]+=a[0]-this._pre_mouse_position[0],this._translate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==r.OperationMode.ROTATE?(this._rotate_drag[0]+=a[0]-this._pre_mouse_position[0],this._rotate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==r.OperationMode.FREE_ROTATE?(this._free_rotate_drag[0]+=a[0]-this._pre_mouse_position[0],this._free_rotate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==r.OperationMode.HEIGHT_TRANSLATE?(this._translate_drag[0]+=a[0]-this._pre_mouse_position[0],this._height_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==r.OperationMode.EYE_TRANSLATE&&(this._translate_eye_drag[1]+=a[1]-this._pre_mouse_position[1]),this._pre_mouse_position=a}},{key:"_onMouseMove",value:function(e){var t=this._mousePos(this._viewer._canvas_element,e);this.onMouseMove(t,e)}},{key:"onMouseUp",value:function(e,t){this._resetEventParameter()}},{key:"_onMouseUp",value:function(e){var t=this._mousePos(this._viewer._canvas_element,e);this.onMouseUp(t,e)}},{key:"onMouseWheel",value:function(e,t){var r;t.preventDefault(),this._mouse_down_position=e,r=-1*Math.sign(t.deltaY)*Math.ceil(Math.abs(t.deltaY)/100),this._zoom_wheel+=r}},{key:"_onMouseWheel",value:function(e){var t=this._mousePos(this._viewer._canvas_element,e);this.onMouseWheel(t,e)}},{key:"onKeyDown",value:function(e){switch(e.key){case"c":case"C":this._operation_mode=r.OperationMode.CHANGE_FOVY,this._fovy_key=1;break;case"z":case"Z":this._operation_mode=r.OperationMode.CHANGE_FOVY,this._fovy_key=-1;break;case"x":case"X":this._camera_parameter.fov=this._default_fov;break;case"ArrowUp":e.preventDefault();var t=[(a=this._viewer.canvas_element).width/2,a.height/2];this._mouse_down_position=t,this._translate_drag[1]=100,this._key_mode=!0;break;case"ArrowDown":var a;e.preventDefault(),t=[(a=this._viewer.canvas_element).width/2,a.height/2],this._mouse_down_position=t,this._translate_drag[1]=-100,this._key_mode=!0;break;case"ArrowLeft":e.preventDefault(),this._free_rotate_drag[0]=100,this._key_mode=!0;break;case"ArrowRight":e.preventDefault(),this._free_rotate_drag[0]=-100,this._key_mode=!0}}},{key:"_onKeyDown",value:function(e){this.onKeyDown(e)}},{key:"onKeyUp",value:function(e){switch(e.key){case"c":case"C":this._operation_mode=r.OperationMode.NONE,this._fovy_key=0;break;case"z":case"Z":this._operation_mode=r.OperationMode.NONE,this._fovy_key=0;break;case"ArrowUp":case"ArrowDown":this._operation_mode=r.OperationMode.NONE,this._translate_drag[1]=0,this._key_mode=!1;break;case"ArrowLeft":case"ArrowRight":this._operation_mode=r.OperationMode.NONE,this._free_rotate_drag[0]=0,this._key_mode=!1}}},{key:"_onKeyUp",value:function(e){this.onKeyUp(e)}},{key:"_resetEventParameter",value:function(){this._translate_drag[0]=0,this._translate_drag[1]=0,this._rotate_drag[0]=0,this._rotate_drag[1]=0,this._free_rotate_drag[0]=0,this._free_rotate_drag[1]=0,this._height_drag[0]=0,this._height_drag[1]=0,this._operation_mode=r.OperationMode.NONE}},{key:"_translation",value:function(t){if(0!=this._translate_drag[0]||0!=this._translate_drag[1]){this._key_mode&&(this._translate_drag[0]*=t,this._translate_drag[1]*=t);var r=this._viewer.camera,a=r.getCanvasRay(this._mouse_down_position),o=this._viewer.getRayIntersection(a),i=[this._mouse_down_position[0]+this._translate_drag[0],this._mouse_down_position[1]+this._translate_drag[1]];a=r.getCanvasRay(i);var n=this._viewer.getRayIntersection(a);if(null==o||null==n)return;var s=new e.GeoPoint;s.setFromGocs(o);var _=new e.GeoPoint;_.setFromGocs(n);var c=Math.pow(this._getVectorLength(a.direction),2),u=2*Le.dot3(a.position,a.direction),h=u*u-4*c*(Math.pow(this._getVectorLength(a.position),2)-Math.pow(s.altitude+Le.EARTH_RADIUS,2));if(s.altitude<this._camera_parameter.height&&_.altitude<this._camera_parameter.height&&h>0){var l=(-u+Math.sqrt(h))/2*c,p=(-u-Math.sqrt(h))/2*c,f=Math.min(l,p);n[0]=a.position[0]+f*a.direction[0],n[1]=a.position[1]+f*a.direction[1],n[2]=a.position[2]+f*a.direction[2],_.setFromGocs(n)}var m=_.latitude-s.latitude,v=_.longitude-s.longitude;this._camera_parameter.latitude-=m,this._camera_parameter.longitude-=v,this._translate_drag[0]=0,this._translate_drag[1]=0,this._mouse_down_position=this._pre_mouse_position}}},{key:"_rotation",value:function(){if(0!=this._rotate_drag[0]||0!=this._rotate_drag[1]){if(null==this._rotate_center)return this._rotate_drag[0]=0,void(this._rotate_drag[1]=0);var t=this._viewer.camera,r=Le.createVector3();r[0]=t.view_to_gocs[12]-this._rotate_center[0],r[1]=t.view_to_gocs[13]-this._rotate_center[1],r[2]=t.view_to_gocs[14]-this._rotate_center[2];var a=new e.GeoPoint;a.setFromGocs(this._rotate_center);var o=a.getMlocsToGocsMatrix(Le.createMatrix()),i=Le.createVector3();i[0]=o[8],i[1]=o[9],i[2]=o[10],i=Le.normalize3(i,Le.createVector3());var n=-this._rotate_drag[0]/10,s=-this._rotate_drag[1]/10,_=this._rotateVector(r,i,n),c=Le.clamp(this._camera_parameter.pitch+s,0,90);c!=this._camera_parameter.pitch&&(i[0]=t.view_to_gocs[0],i[1]=t.view_to_gocs[1],i[2]=t.view_to_gocs[2],_=this._rotateVector(_,i,s));var u=Le.createVector3();u[0]=this._rotate_center[0]+_[0],u[1]=this._rotate_center[1]+_[1],u[2]=this._rotate_center[2]+_[2];var h=new e.GeoPoint;h.setFromGocs(u),this._camera_parameter.latitude=h.latitude,this._camera_parameter.longitude=h.longitude,this._camera_parameter.height=h.altitude,this._camera_parameter.yaw+=n,this._camera_parameter.pitch=c,this._rotate_drag[0]=0,this._rotate_drag[1]=0}}},{key:"_freeRotation",value:function(e){if(0!=this._free_rotate_drag[0]||0!=this._free_rotate_drag[1]){this._key_mode&&(this._free_rotate_drag[0]*=e,this._free_rotate_drag[1]*=e);var t=this._free_rotate_drag[0]/10,r=this._free_rotate_drag[1]/10,a=Le.clamp(this._camera_parameter.pitch+r,0,90);this._camera_parameter.yaw+=t,this._camera_parameter.pitch=a,this._free_rotate_drag[0]=0,this._free_rotate_drag[1]=0}}},{key:"_translationOfHeight",value:function(){if(0!=this._height_drag[0]||0!=this._height_drag[1]){var e=100*this._height_drag[1]*(Le.gudermannian((this._camera_parameter.height-5e4)/1e4)+Math.PI/2);this._camera_parameter.height+=e,this._height_drag[0]=0,this._height_drag[1]=0}}},{key:"_translationOfEyeDirection",value:function(){var t=0;if(0!=this._zoom_wheel?(t=Math.pow(.9,this._zoom_wheel),this._zoom_wheel=0):0!=this._translate_eye_drag[1]&&(t=Math.pow(.995,this._translate_eye_drag[1]),this._translate_eye_drag[1]=0),0!==t){var a=this._viewer.camera,o=a.getCanvasRay(this._mouse_down_position),i=this._viewer.getRayIntersection(o);if(null==i)return;var n=new e.GeoPoint;n.setFromGocs(i);var s=Le.createVector3();s[0]=(i[0]-a.view_to_gocs[12])*t,s[1]=(i[1]-a.view_to_gocs[13])*t,s[2]=(i[2]-a.view_to_gocs[14])*t;var _=Le.createVector3();_[0]=i[0]-s[0],_[1]=i[1]-s[1],_[2]=i[2]-s[2];var c=new e.GeoPoint;c.setFromGocs(_);var u=this._viewer.getElevation(c.latitude,c.longitude);if(u+r.MINIMUM_HEIGHT>c.altitude){var h=c.altitude-(u+r.MINIMUM_HEIGHT),l=n.getUpwardVector(Le.createVector3()),p=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),f=Le.dot3(s,l)/p;Le.scale3(1-h/f/p,s,s),_[0]=i[0]-s[0],_[1]=i[1]-s[1],_[2]=i[2]-s[2],c.setFromGocs(_)}this._camera_parameter.latitude=c.latitude,this._camera_parameter.longitude=c.longitude,this._camera_parameter.height=c.altitude,this._zoom_wheel=0}}},{key:"_changeFovy",value:function(){var e=Math.tan(.5*this._camera_parameter.fov*Le.DEGREE),t=2*Math.atan(e*Math.pow(r.FOV_FACTOR,-this._fovy_key)),a=r.FOV_RANGE;this._camera_parameter.fov=Le.clamp(t/Le.DEGREE,a.min,a.max),this._fovy_key=0}},{key:"setCameraPosition",value:function(e){this._camera_parameter.latitude=e.latitude,this._camera_parameter.longitude=e.longitude,this._camera_parameter.height=e.height,this._camera_parameter.height<r.MINIMUM_HEIGHT&&(this._camera_parameter.height=r.MINIMUM_HEIGHT)}},{key:"setLookAtPosition",value:function(e){var t=new Ne(this._camera_parameter.longitude,this._camera_parameter.latitude,this._camera_parameter.height).getMlocsToGocsMatrix(Le.createMatrix()),r=Le.createVector3();r[0]=t[4],r[1]=t[5],r[2]=t[6];var a=new Ne(e.longitude,e.latitude,e.height).getMlocsToGocsMatrix(Le.createMatrix()),o=Le.createVector3();o[0]=a[12]-t[12],o[1]=a[13]-t[13],o[2]=a[14]-t[14],r=Le.normalize3(r,Le.createVector3()),o=Le.normalize3(o,Le.createVector3());var i=Le.createVector3();i[0]=t[8],i[1]=t[9],i[2]=t[10];var n=this._calculateAngle(i,r,o);this._camera_parameter.yaw=n;var s=Le.createVector3();s[0]=t[8],s[1]=t[9],s[2]=t[10],i[0]=t[0],i[1]=t[1],i[2]=t[2],o[0]=-1*o[0],o[1]=-1*o[1],o[2]=-1*o[2],this._camera_parameter.pitch=Le.clamp(Math.abs(this._calculateAngle(i,s,o)),0,90)}},{key:"setCameraParameter",value:function(e){e.fov&&(this._camera_parameter.fov=e.fov,this._default_fov=e.fov),e.near&&(this._camera_parameter.near=e.near),e.far&&(this._camera_parameter.far=e.far),e.speed_factor&&(this._camera_parameter.speed_factor=e.speed_factor)}},{key:"getLayer",value:function(e){return this._viewer.layers.getLayer(e)}},{key:"getLayerNum",value:function(){return this._viewer.layers.num_layers()}},{key:"addLayer",value:function(e){this._viewer.layers.add(e)}},{key:"insertLayer",value:function(e,t){this._viewer.layers.insert(e,t)}},{key:"removeLayer",value:function(e){this._viewer.layers.remove(e)}},{key:"clearLayer",value:function(){this._viewer.layers.clear()}},{key:"getEntity",value:function(e){return this._viewer.scene.getEntity(e)}},{key:"getEntityNum",value:function(){return this._viewer.scene.num_entities()}},{key:"addEntity",value:function(e){this._viewer.scene.addEntity(e)}},{key:"removeEntity",value:function(e){this._viewer.scene.removeEntity(e)}},{key:"clearEntity",value:function(){this._viewer.scene.clearEntity()}},{key:"_getVectorLength",value:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2))}},{key:"_rotateVector",value:function(e,t,r){var a=Le.rotation_matrix(t,r,Le.createMatrix()),o=Le.createVector3();return o[0]=e[0]*a[0]+e[1]*a[4]+e[2]*a[8]+a[12],o[1]=e[0]*a[1]+e[1]*a[5]+e[2]*a[9]+a[13],o[2]=e[0]*a[2]+e[1]*a[6]+e[2]*a[10]+a[14],o}},{key:"_calculateAngle",value:function(e,t,r){for(var a=Le.createVector3(),o=Le.dot3(e,t),i=0;i<3;i++)a[i]=t[i]-o*e[i];var n=Le.createVector3();for(o=Le.dot3(e,r),i=0;i<3;i++)n[i]=r[i]-o*e[i];if(Le.normalize3(a,a),Le.normalize3(n,n),Math.abs(this._getVectorLength(a)<1e-6)||Math.abs(this._getVectorLength(n)<1e-6))s=0;else{var s=Math.acos(Le.clamp(Le.dot3(a,n)/(this._getVectorLength(a)*this._getVectorLength(n)),-1,1))/Le.DEGREE,_=Le.cross3(a,n,Le.createVector3());_=Le.normalize3(_,Le.createVector3()),Le.dot3(e,_)<0&&(s*=-1)}return s}},{key:"_mousePos",value:function(e,t){var r=e.getBoundingClientRect();return[t.clientX-r.left-e.clientLeft,t.clientY-r.top-e.clientTop]}},{key:"viewer",get:function(){return this._viewer}}])&&ke(a.prototype,o),i&&ke(a,i),r}(e.RenderCallback);return Pe.OperationMode={NONE:"NONE",TRANSLATE:"TRANSLATE",ROTATE:"ROTATE",FREE_ROTATE:"FREE_ROTATE",EYE_TRANSLATE:"EYE_TRANSLATE",HEIGHT_TRANSLATE:"HEIGHT_TRANSLATE",CHANGE_FOVY:"CHANGE_FOVY"},Pe.DEFAULT_CAMERA_POSITION={latitude:35.475968,longitude:138.573161,height:2e3},Pe.DEFAULT_LOOKAT_POSITION={latitude:35.360626,longitude:138.727363,height:2e3},Pe.DEFAULT_CAMERA_PARAMETER={fov:60,near:30,far:5e5,speed_factor:2e3},Pe.MINIMUM_HEIGHT=2,Pe.MINIMUM_NEAR=1,Pe.MINIMUM_FAR=5e5,Pe.NEAR_FACTOR=.01,Pe.FAR_FACTOR=1e4,Pe.FOV_RANGE={min:5,max:120},Pe.FOV_FACTOR=1.148698354997035,{StandardUIViewer:Pe}}));
