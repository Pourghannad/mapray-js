!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mapray",[],t):"object"==typeof exports?exports.mapray=t():e.mapray=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0});var a,o=r(27),s=n(o),u=r(10),_=n(u),l=r(1),c=n(l),f=r(19),h=n(f),d=r(3),v=n(d),p=r(15),m=n(p),y=r(16),g=n(y),b=r(5),w=n(b),E=r(23),x=n(E),k=r(30),M=n(k),T=r(2),A=n(T),P=r(20),O=n(P),R=r(24),I=n(R),D=r(21),F=n(D),L=r(4),N=n(L),j=r(13),S=n(j),U=r(17),C=n(U),z=r(25),V=n(z),q=r(22),B=n(q),Y=r(31),G=n(Y),X=(a={Viewer:s.default,Camera:_.default,GeoMath:c.default,Ray:h.default,CredentialMode:v.default,Layer:m.default,LayerCollection:g.default,DemProvider:w.default,StandardDemProvider:x.default,CloudDemProvider:M.default,ImageProvider:A.default,RenderCallback:O.default,StandardImageProvider:I.default,Scene:F.default,Entity:N.default,GenericEntity:S.default,MarkerLineEntity:C.default},i(a,"MarkerLineEntity",C.default),i(a,"TextEntity",V.default),i(a,"TextEntity",V.default),i(a,"SceneLoader",B.default),i(a,"SceneLoader",B.default),i(a,"DebugStats",G.default),a);window.maprayRequestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,window.maprayCancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame;var H=window.performance,Z=H&&(H.now||H.mozNow||H.msNow||H.oNow||H.webkitNow),W=new Date;window.maprayNow=Z?function(){return Z.call(H)}:function(){return W.getTime()},Math.maprayLog2=Math.log2||function(e){return 1.4426950408889634*Math.log(e)},t.default=X,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,null,[{key:"createMatrix",value:function(e){return new Float64Array(e||16)}},{key:"createMatrixf",value:function(e){return new Float32Array(e||16)}},{key:"createVector4",value:function(e){return new Float64Array(e||4)}},{key:"createVector4f",value:function(e){return new Float32Array(e||4)}},{key:"createVector3",value:function(e){return new Float64Array(e||3)}},{key:"createVector3f",value:function(e){return new Float32Array(e||3)}},{key:"createVector2f",value:function(e){return new Float32Array(e||2)}},{key:"copyMatrix",value:function(e,t){for(var r=0;r<16;++r)t[r]=e[r];return t}},{key:"copyVector4",value:function(e,t){for(var r=0;r<4;++r)t[r]=e[r];return t}},{key:"copyVector3",value:function(e,t){for(var r=0;r<3;++r)t[r]=e[r];return t}},{key:"setIdentity",value:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"dot3",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"cross3",value:function(e,t,r){var n=e[1]*t[2]-e[2]*t[1],i=e[2]*t[0]-e[0]*t[2],a=e[0]*t[1]-e[1]*t[0];return r[0]=n,r[1]=i,r[2]=a,r}},{key:"normalize3",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=1/Math.sqrt(r*r+n*n+i*i);return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}},{key:"mul_AA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],_=e[9],l=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=t[0],p=t[4],m=t[8],y=t[12],g=t[1],b=t[5],w=t[9],E=t[13],x=t[2],k=t[6],M=t[10],T=t[14];return r[0]=n*v+i*g+a*x,r[1]=s*v+u*g+_*x,r[2]=c*v+f*g+h*x,r[3]=0,r[4]=n*p+i*b+a*k,r[5]=s*p+u*b+_*k,r[6]=c*p+f*b+h*k,r[7]=0,r[8]=n*m+i*w+a*M,r[9]=s*m+u*w+_*M,r[10]=c*m+f*w+h*M,r[11]=0,r[12]=n*y+i*E+a*T+o,r[13]=s*y+u*E+_*T+l,r[14]=c*y+f*E+h*T+d,r[15]=1,r}},{key:"mul_GA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],_=e[9],l=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=e[3],p=e[7],m=e[11],y=e[15],g=t[0],b=t[4],w=t[8],E=t[12],x=t[1],k=t[5],M=t[9],T=t[13],A=t[2],P=t[6],O=t[10],R=t[14];return r[0]=n*g+i*x+a*A,r[1]=s*g+u*x+_*A,r[2]=c*g+f*x+h*A,r[3]=v*g+p*x+m*A,r[4]=n*b+i*k+a*P,r[5]=s*b+u*k+_*P,r[6]=c*b+f*k+h*P,r[7]=v*b+p*k+m*P,r[8]=n*w+i*M+a*O,r[9]=s*w+u*M+_*O,r[10]=c*w+f*M+h*O,r[11]=v*w+p*M+m*O,r[12]=n*E+i*T+a*R+o,r[13]=s*E+u*T+_*R+l,r[14]=c*E+f*T+h*R+d,r[15]=v*E+p*T+m*R+y,r}},{key:"mul_PzA",value:function(e,t,r){var n=e[0],i=e[8],a=e[12],o=e[5],s=e[9],u=e[13],_=e[10],l=e[14],c=e[11],f=e[15],h=t[0],d=t[4],v=t[8],p=t[12],m=t[1],y=t[5],g=t[9],b=t[13],w=t[2],E=t[6],x=t[10],k=t[14];return r[0]=n*h+i*w,r[1]=o*m+s*w,r[2]=_*w,r[3]=c*w,r[4]=n*d+i*E,r[5]=o*y+s*E,r[6]=_*E,r[7]=c*E,r[8]=n*v+i*x,r[9]=o*g+s*x,r[10]=_*x,r[11]=c*x,r[12]=n*p+i*k+a,r[13]=o*b+s*k+u,r[14]=_*k+l,r[15]=c*k+f,r}},{key:"inverse_A",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],_=e[13],l=e[2],c=e[6],f=e[10],h=e[14],d=s*f-c*u,v=l*u-o*f,p=o*c-l*s,m=c*i-n*f,y=r*f-l*i,g=l*n-r*c,b=n*u-s*i,w=o*i-r*u,E=r*s-o*n,x=-(a*d+_*m+h*b),k=-(a*v+_*y+h*w),M=-(a*p+_*g+h*E),T=1/(r*d+n*v+i*p);return t[0]=d*T,t[1]=v*T,t[2]=p*T,t[3]=0,t[4]=m*T,t[5]=y*T,t[6]=g*T,t[7]=0,t[8]=b*T,t[9]=w*T,t[10]=E*T,t[11]=0,t[12]=x*T,t[13]=k*T,t[14]=M*T,t[15]=1,t}},{key:"transformPlane_A",value:function(e,t,r){var n=e,i=t[0],a=t[1],o=t[2],s=t[3];return r[0]=i*n[0]+a*n[1]+o*n[2],r[1]=i*n[4]+a*n[5]+o*n[6],r[2]=i*n[8]+a*n[9]+o*n[10],r[3]=i*n[12]+a*n[13]+o*n[14]+s,r}},{key:"iscs_to_gocs_matrix",value:function(t,r){var n=t.longitude*e.DEGREE,i=t.latitude*e.DEGREE,a=Math.sin(n),o=Math.cos(n),s=Math.sin(i),u=Math.cos(i),_=e.EARTH_RADIUS+t.height;return r[0]=-a,r[1]=o,r[2]=0,r[3]=0,r[4]=-o*s,r[5]=-a*s,r[6]=u,r[7]=0,r[8]=u*o,r[9]=u*a,r[10]=s,r[11]=0,r[12]=_*u*o,r[13]=_*u*a,r[14]=_*s,r[15]=1,r}},{key:"gocs_to_iscs",value:function(t,r){var n=t[0],i=t[1],a=t[2],o=n*n,s=i*i,u=a*a;return 0!=n||0!=i?(r.latitude=Math.atan(a/Math.sqrt(o+s))/e.DEGREE,r.longitude=Math.atan2(i,n)/e.DEGREE):(a>0?r.latitude=90:a<0?r.latitude=-90:r.latitude=0,r.longitude=0),r.height=Math.sqrt(o+s+u)-e.EARTH_RADIUS,r}},{key:"frustum_matrix",value:function(e,t,r,n,i,a,o){return o[0]=2*i/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/(n-r),o[6]=0,o[7]=0,o[8]=(t+e)/(t-e),o[9]=(n+r)/(n-r),o[10]=(a+i)/(i-a),o[11]=-1,o[12]=0,o[13]=0,o[14]=2*a*i/(i-a),o[15]=0,o}},{key:"lookat_matrix",value:function(t,r,n,i){var a=e._xaxis,o=e._yaxis,s=e._zaxis;return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],e.normalize3(s,s),e.cross3(n,s,a),e.normalize3(a,a),e.cross3(s,a,o),i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=s[0],i[9]=s[1],i[10]=s[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}},{key:"rotation_matrix",value:function(t,r,n){var i=r*e.DEGREE,a=Math.sin(i),o=Math.cos(i),s=t[0],u=t[1],_=t[2];return n[0]=s*s*(1-o)+o,n[1]=s*u*(1-o)+_*a,n[2]=s*_*(1-o)-u*a,n[3]=0,n[4]=s*u*(1-o)-_*a,n[5]=u*u*(1-o)+o,n[6]=u*_*(1-o)+s*a,n[7]=0,n[8]=s*_*(1-o)+u*a,n[9]=u*_*(1-o)-s*a,n[10]=_*_*(1-o)+o,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}},{key:"gudermannian",value:function(e){return 2*Math.atan(Math.exp(e))-Math.PI/2}},{key:"invGudermannian",value:function(e){return Math.log(Math.tan(e/2+Math.PI/4))}},{key:"clamp",value:function(e,t,r){return Math.min(Math.max(e,t),r)}}]),e}();i.EARTH_RADIUS=6378137,i.DEGREE=.017453292519943295,i.LOG2PI=1.6514961294723187,i._xaxis=i.createVector3(),i._yaxis=i.createVector3(),i._zaxis=i.createVector3(),t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"status",value:function(e){return o.READY}},{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.ImageProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.ImageProvider#cancelRequest() method has not been overridden.")}},{key:"getImageSize",value:function(){throw new Error("mapray.ImageProvider#getImageSize() method has not been overridden.")}},{key:"getZoomLevelRange",value:function(){throw new Error("mapray.ImageProvider#getZoomLevelRange() method has not been overridden.")}}]),e}(),a=function(){function e(t,n){r(this,e),this._min=t,this._max=n}return n(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();i.Range=a;var o={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};i.Status=o,t.default=i,e.exports=t.default},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}};t.default=r,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this.scene=t}return n(e,[{key:"getPrimitives",value:function(e){throw new Error("mapray.Entity#getPrimitives() method has not been overridden.")}},{key:"loadProperties",value:function(e,t,r){for(var n=e.properties||{},i=r||{},a=Object.keys(n),o=0;o<a.length;++o){var s=a[o],u=n[s];"tex-2d"==u.type?i[s]=t[u.ref_texture]:Array.isArray(u)?i[s]=new Float32Array(u):i[s]=u}return i}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.DemProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.DemProvider#cancelRequest() method has not been overridden.")}},{key:"getResolutionPower",value:function(){return 8}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(18),_=n(u),l=r(1),c=n(l),f=function(e){function t(e,r,n){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n))}return o(t,e),s(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,t){}},{key:"setObjToClip",value:function(e,r){var n=r.transform,i=t._obj_to_clip;c.default.mul_GA(e._gocs_to_clip,n,i),this.setMatrix("u_obj_to_clip",i)}}]),t}(_.default);f._obj_to_clip=c.default.createMatrixf(),t.default=f,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e),this._glenv=t,this._num_vertices=0,this._num_indices=0,this._vertices=null,this._indices=null,this._vertex_bytes=0,this._attrib_data={},this._draw_mode=void 0,this._index_type=void 0,n instanceof ArrayBuffer?this._initByBuffer(n):this._initByObject(n)}return n(e,[{key:"_initByBuffer",value:function(t){var r=new DataView(t,0),n=r.getUint8(e.OFFSET_VTYPE),i=r.getUint8(e.OFFSET_ITYPE),a=r.getUint8(e.OFFSET_PTYPE);this._num_vertices=r.getUint32(e.OFFSET_NUM_VERTICES,!0),this._num_indices=r.getUint32(e.OFFSET_NUM_INDICES,!0);var o=e._createVertexInfo(n);this._vertices=this._createVerticesByBuffer(t,o),this._indices=this._createIndicesByBuffer(t,o,i),this._initCommon(o,i,a)}},{key:"_initByObject",value:function(t){var r=e._createVertexInfo(t.vtype);this._num_vertices=t.vertices.length/e._numVertexElements(r),this._num_indices=t.indices.length;var n=this._num_vertices<65536?e.ENUM_ITYPE_UINT16:e.ENUM_ITYPE_UINT32;this._vertices=this._createVerticesByObject(t.vertices,r),this._indices=this._createIndicesByObject(t.indices,n),this._initCommon(r,n,t.ptype)}},{key:"_initCommon",value:function(t,r,n){var i=this._glenv.context;switch(this._vertex_bytes=e._numVertexBytes(t),this._attrib_data=e._createAttribData(t),this._draw_mode=i.TRIANGLES,n){case"triangles":case e.ENUM_PTYPE_TRIANGLES:this._draw_mode=i.TRIANGLES;break;case"lines":case e.ENUM_PTYPE_LINES:this._draw_mode=i.LINES}switch(this._index_type=i.UNSIGNED_INT,r){case e.ENUM_ITYPE_UINT16:this._index_type=i.UNSIGNED_SHORT;break;case e.ENUM_ITYPE_UINT32:this._index_type=i.UNSIGNED_INT}}},{key:"dispose",value:function(){var e=this._glenv.context;e.deleteBuffer(this._vertices),this._vertices=null,e.deleteBuffer(this._indices),this._indices=null}},{key:"draw",value:function(e){var t=this._glenv.context;this._bindVertexAttribs(e),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indices),t.drawElements(this._draw_mode,this._num_indices,this._index_type,0)}},{key:"_bindVertexAttribs",value:function(e){var t=this._glenv.context,r=e.getAttribNames(),n=this._vertex_bytes;t.bindBuffer(t.ARRAY_BUFFER,this._vertices);for(var i=0;i<r.length;++i){var a=r[i],o=this._attrib_data[a];o&&e.bindVertexAttrib(a,o.size,n,o.offset)}t.bindBuffer(t.ARRAY_BUFFER,null)}},{key:"_createVerticesByBuffer",value:function(t,r){for(var n=4,i=e._numVertexElements(r)*this._num_vertices,a=new DataView(t,e.OFFSET_BODY),o=new Float32Array(i),s=0;s<i;++s)o[s]=a.getFloat32(s*n,!0);var u=this._glenv.context,_=u.ARRAY_BUFFER,l=u.createBuffer();return u.bindBuffer(_,l),u.bufferData(_,o,u.STATIC_DRAW),u.bindBuffer(_,null),l}},{key:"_createIndicesByBuffer",value:function(t,r,n){var i,a,o,s=e._numVertexBytes(r)*this._num_vertices,u=new DataView(t,e.OFFSET_BODY+s),_=this._num_indices;switch(n){case e.ENUM_ITYPE_UINT16:for(a=new Uint16Array(_),o=2,i=0;i<_;++i)a[i]=u.getUint16(o*i,!0);break;case e.ENUM_ITYPE_UINT32:for(a=new Uint32Array(_),o=4,i=0;i<_;++i)a[i]=u.getUint32(o*i,!0);break;default:a=null,console.error("mapray: unknown itype: "+n)}var l=this._glenv.context,c=l.ELEMENT_ARRAY_BUFFER,f=l.createBuffer();return l.bindBuffer(c,f),l.bufferData(c,a,l.STATIC_DRAW),l.bindBuffer(c,null),f}},{key:"_createVerticesByObject",value:function(t,r){for(var n=this._num_vertices,i=e._numVertexElements(r)*n,a=new Float32Array(i),o=0;o<i;++o)a[o]=t[o];var s=this._glenv.context,u=s.ARRAY_BUFFER,_=s.createBuffer();return s.bindBuffer(u,_),s.bufferData(u,a,s.STATIC_DRAW),s.bindBuffer(u,null),_}},{key:"_createIndicesByObject",value:function(t,r){var n,i,a=this._num_indices;switch(r){case e.ENUM_ITYPE_UINT16:for(i=new Uint16Array(a),n=0;n<a;++n)i[n]=t[n];break;case e.ENUM_ITYPE_UINT32:for(i=new Uint32Array(a),n=0;n<a;++n)i[n]=t[n];break;default:i=null,console.error("mapray: unknown itype: "+r)}var o=this._glenv.context,s=o.ELEMENT_ARRAY_BUFFER,u=o.createBuffer();return o.bindBuffer(s,u),o.bufferData(s,i,o.STATIC_DRAW),o.bindBuffer(s,null),u}}],[{key:"_createVertexInfo",value:function(t){if(Array.isArray(t))return t;var r=null;switch(t){case"P":case e.ENUM_VTYPE_P:r=[{name:e.ANAME_P,size:e.FSIZE_P}];break;case"PN":case e.ENUM_VTYPE_PN:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N}];break;case"PT":case e.ENUM_VTYPE_PT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_T,size:e.FSIZE_T}];break;case"PNT":case e.ENUM_VTYPE_PNT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N},{name:e.ANAME_T,size:e.FSIZE_T}];break;default:console.error("mapray: unknown vtype: "+t)}return r}},{key:"_createAttribData",value:function(e){for(var t=4,r=e.length,n={},i=0,a=0;a<r;++a)n[e[a].name]={size:e[a].size,offset:i},i+=e[a].size*t;return n}},{key:"_numVertexElements",value:function(e){for(var t=e.length,r=0,n=0;n<t;++n)r+=e[n].size;return r}},{key:"_numVertexBytes",value:function(e){for(var t=4,r=e.length,n=0,i=0;i<r;++i)n+=e[i].size*t;return n}}]),e}();i.OFFSET_VTYPE=0,i.OFFSET_ITYPE=1,i.OFFSET_PTYPE=2,i.OFFSET_NUM_VERTICES=4,i.OFFSET_NUM_INDICES=8,i.OFFSET_BODY=12,i.ENUM_VTYPE_P=0,i.ENUM_VTYPE_PN=1,i.ENUM_VTYPE_PT=2,i.ENUM_VTYPE_PNT=3,i.ENUM_ITYPE_UINT16=0,i.ENUM_ITYPE_UINT32=1,i.ENUM_PTYPE_TRIANGLES=0,i.ENUM_PTYPE_LINES=1,i.ANAME_P="a_position",i.ANAME_N="a_normal",i.ANAME_T="a_texcoord",i.FSIZE_P=3,i.FSIZE_N=3,i.FSIZE_T=2,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=function(){function e(t,r,n,a){i(this,e),this._glenv=t,this.mesh=r,this.material=n,this.transform=a,this.pivot=null,this.bbox=null,this.properties=null,this.sort_z=void 0}return a(e,[{key:"isVisible",value:function(t){var r=e._obj_to_view;s.default.mul_AA(t._gocs_to_view,this.transform,r);var n=this.bbox;if(n){e._transformBBox(n,r);for(var i=t._volume_planes,a=0;a<i.length;++a)if(e._isBBoxBackSide(i[a]))return!1}var o=this.pivot;return o?this.sort_z=r[2]*o[0]+r[6]*o[1]+r[10]*o[2]+r[14]:this.sort_z=r[14],!0}},{key:"isTranslucent",value:function(e){return this.material.isTranslucent(e,this)}},{key:"draw",value:function(e){var t=this.material;t.bindProgram(),t.setParameters(e,this),this.mesh.draw(t)}}],[{key:"_transformBBox",value:function(t,r){for(var n=0;n<2;++n)for(var i=t[n][2],a=0;a<2;++a)for(var o=t[a][1],s=0;s<2;++s){var u=t[s][0],_=e._bbox_points[s+2*a+4*n];_[0]=r[0]*u+r[4]*o+r[8]*i+r[12],_[1]=r[1]*u+r[5]*o+r[9]*i+r[13],_[2]=r[2]*u+r[6]*o+r[10]*i+r[14]}}},{key:"_isBBoxBackSide",value:function(t){for(var r=e._bbox_points,n=0;n<r.length;++n){var i=r[n],a=i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+t[3];if(a>=0)return!1}return!0}}]),e}();u._obj_to_view=s.default.createMatrix(),u._bbox_points=[];for(var _=0;_<8;++_)u._bbox_points.push(s.default.createVector3());t.default=u,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(2),s=n(o),u=r(35),_=n(u),l=r(46),c=n(l),f=r(1),h=n(f),d=function(){function e(t,r){var n=this;i(this,e),this._glenv=t,this._provider=null,this._min_image_z=0,this._max_image_z=0,this._image_zbias=0;var a=function(e){e===s.default.Status.READY?(n._flush(),n._resetImageProvider(r)):e===s.default.Status.FAILED&&console.error("ImageProvider.Status.FAILED in TileTextureCache")};this._resetImageProvider(r.status(a)===s.default.Status.READY?r:new _.default),this._croot=new v,this._max_accesses=0,this._frame_counter=0,this._lower_bound=1,this._upper_bound=1.2,this._num_requesteds=0,this._max_requesteds=75,this._new_requesteds=[];var o=t.context,u=t.EXT_texture_filter_anisotropic;u&&(this._aniso_ext=u,this._max_aniso=o.getParameter(u.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this._use_mipmap=!1}return a(e,[{key:"_resetImageProvider",value:function(e){this._provider=e;var t=e.getZoomLevelRange();this._min_image_z=t.min,this._max_image_z=t.max,this._image_zbias=Math.maprayLog2(2*Math.PI/e.getImageSize())}},{key:"cancel",value:function(){this._flush()}},{key:"_flush",value:function(){new y(this,this._croot),this._croot=new v,this._max_accesses=0}},{key:"getImageZBias",value:function(){return this._image_zbias}},{key:"getImageZMin",value:function(){return this._min_image_z}},{key:"getNumWaitingRequests",value:function(){return this._num_requesteds}},{key:"findNearestAncestors",value:function(t,r,n,i){for(var a,o,s,u,_,l=0,c=this._min_image_z,f=Math.pow(2,1-t),d=(r+.5)*f,p=(n+.5)*f,m=this._croot;l<c;++l)a=Math.floor(d)%2,o=Math.floor(p)%2,s=a+2*o,u=m.children,_=u[s],null===_&&(_=new v,u[s]=_),d*=2,p*=2,m=_;var y=this._max_image_z,b=h.default.clamp(i-1,c,y),w=h.default.clamp(i,c,y),E=null,x=null;if(b<w){for(;l<=b;++l)m.state===g.LOADED?E=m:m.state===g.NONE?(m.state=g.REQUESTED,m.req_power=i-l,this._new_requesteds.push([m,l,Math.floor(.5*d),Math.floor(.5*p)])):m.state===g.REQUESTED&&m.updateRequestPower(i-l),a=Math.floor(d)%2,o=Math.floor(p)%2,s=a+2*o,u=m.children,_=u[s],null===_&&(_=new v,u[s]=_),d*=2,p*=2,m=_;x=E,m.state===g.LOADED?x=m:m.state===g.NONE?(m.state=g.REQUESTED,m.req_power=i-l,this._new_requesteds.push([m,l,Math.floor(.5*d),Math.floor(.5*p)])):m.state===g.REQUESTED&&m.updateRequestPower(i-l)}else for(;;++l){if(m.state===g.LOADED?E=m:m.state===g.NONE?(m.state=g.REQUESTED,m.req_power=i-l,this._new_requesteds.push([m,l,Math.floor(.5*d),Math.floor(.5*p)])):m.state===g.REQUESTED&&m.updateRequestPower(i-l),l==b){x=E;break}a=Math.floor(d)%2,o=Math.floor(p)%2,s=a+2*o,u=m.children,_=u[s],null===_&&(_=new v,u[s]=_),d*=2,p*=2,m=_}m.touch();var k=e._findNearestAncestors_result;return k[0]=null!==x?x.data:null,k[1]=null!==E?E.data:null,k}},{key:"endFrame",value:function(){this._performNewRequests();var e=new p(this._croot,this._frame_counter);if(this._max_accesses=Math.max(e.num_accesses,this._max_accesses),e.num_loadeds>this._upper_bound*this._max_accesses){var t=Math.floor(this._lower_bound*this._max_accesses);this._reduceCache(t)}++this._frame_counter}},{key:"_performNewRequests",value:function(){var e=Math.min(this._max_requesteds-this._num_requesteds,this._new_requesteds.length);this._new_requesteds.sort(function(e,t){var r=e[0],n=t[0];return n.req_power-r.req_power});var t=this;this._new_requesteds.slice(0,e).forEach(function(e){var r=e[0],n=e[1],i=e[2],a=e[3];t._requestTileTexture(n,i,a,r)}),this._new_requesteds.slice(e).forEach(function(e){var t=e[0];t.state=g.NONE}),this._new_requesteds.length=0}},{key:"_requestTileTexture",value:function(e,t,r,n){var i=this;n.data=this._provider.requestTile(e,t,r,function(a){n.state===g.REQUESTED&&(a?(n.data=new c.default(e,t,r,i._createTexture(a)),n.state=g.LOADED):(n.data=null,n.state=g.FAILED),--i._num_requesteds)}),++this._num_requesteds}},{key:"_createTexture",value:function(e){var t=this._glenv.context,r=this._aniso_ext,n=t.TEXTURE_2D,i=t.createTexture();return t.bindTexture(n,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(n,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._use_mipmap&&t.generateMipmap(n),t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,this._use_mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texParameterf(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._max_aniso),t.bindTexture(n,null),i}},{key:"_reduceCache",value:function(e){var t=new m(this._croot);t.nodes.sort(function(e,t){var r=t.aframe-e.aframe;return 0==r&&e.state===g.LOADED&&t.state===g.LOADED?e.data.z-t.data.z:r});var r=this._glenv.context;t.nodes.slice(e).forEach(function(e){e.state===g.LOADED&&e.data.dispose(r),e.state=g.NONE,e.data=null}),t.clean()}}]),e}();d._findNearestAncestors_result=new Array(2);var v=function(){function e(){i(this,e),this.children=[null,null,null,null],this.state=g.NONE,this.data=null,this.req_power=-1,this.aframe=-1}return a(e,[{key:"updateRequestPower",value:function(e){e>this.req_power&&(this.req_power=e)}},{key:"touch",value:function(){this.aframe=!0}}]),e}(),p=function(){function e(t,r){i(this,e),this.num_loadeds=0,this.num_accesses=0,this._frame=r,this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=e.aframe===!0,n=0;n<4;++n){var i=t[n];null!==i&&(r=this._traverse(i)||r)}return e.state===g.LOADED&&(++this.num_loadeds,r&&++this.num_accesses),r&&(e.aframe=this._frame),r}}]),e}(),m=function(){function e(t){i(this,e),this._root=t,this.nodes=[],this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){var t=e.state;t!==g.LOADED&&t!==g.FAILED||this.nodes.push(e);for(var r=e.children,n=0;n<4;++n){var i=r[n];null!==i&&this._traverse(i)}}},{key:"clean",value:function(){this._clean_recur(this._root)}},{key:"_clean_recur",value:function(e){for(var t=e.state===g.NONE,r=e.children,n=0;n<4;++n){var i=r[n];if(null!==i){var a=this._clean_recur(i);a===!0&&(r[n]=null),t=a&&t}}return t}}]),e}(),y=function(){function e(t,r){i(this,e),this._owner=t,this._traverse(r)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=0;r<4;++r){var n=t[r];null!==n&&this._traverse(n)}if(e.state===g.REQUESTED){var i=this._owner;e.state=g.NONE,i._provider.cancelRequest(e.data),--i._num_requesteds}}}]),e}(),g={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=r(19),_=n(u),l=function(){function e(t){i(this,e),this._canvas=t,this.fov=46,this.near=1,this.far=1e3,this.view_to_gocs=s.default.createMatrix(),s.default.setIdentity(this.view_to_gocs)}return a(e,[{key:"getCanvasToView",value:function(e){var t=e||s.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*s.default.DEGREE/2,u=n/r,_=i*Math.tan(o)/Math.sqrt(1+u*u),l=_*u;return t[0]=2*_/(i*r),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l/(i*n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=(i-a)/(i*a),t[12]=-_/i,t[13]=l/i,t[14]=-1,t[15]=1/i,t}},{key:"getCanvasToGocs",value:function(e){var t=this.getCanvasToView(e),r=t[0],n=t[5],i=t[11],a=t[12],o=t[13],s=t[15],u=this.view_to_gocs,_=u[0],l=u[1],c=u[2],f=u[4],h=u[5],d=u[6],v=u[8],p=u[9],m=u[10],y=u[12],g=u[13],b=u[14],w=t;return w[0]=_*r,w[1]=l*r,w[2]=c*r,w[4]=f*n,w[5]=h*n,w[6]=d*n,w[8]=y*i,w[9]=g*i,w[10]=b*i,w[12]=_*a+f*o-v+y*s,w[13]=l*a+h*o-p+g*s,w[14]=c*a+d*o-m+b*s,w}},{key:"getViewToCanvas",value:function(e){var t=e||s.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*s.default.DEGREE/2,u=n/r,_=i*Math.tan(o)/Math.sqrt(1+u*u),l=_*u;return t[0]=i*r/(2*_),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-i*n/(2*l),t[6]=0,t[7]=0,t[8]=-r/2,t[9]=-n/2,t[10]=a/(i-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*a/(i-a),t[15]=0,t}},{key:"getCanvasRay",value:function(t,r){var n=t[0],i=t[1],a=r||new _.default,o=this.getCanvasToGocs(e._temp_mat),u=n*o[0]+i*o[4]+o[12],l=n*o[1]+i*o[5]+o[13],c=n*o[2]+i*o[6]+o[14],f=n*o[3]+i*o[7]+o[15],h=a.position;h[0]=u/f,h[1]=l/f,h[2]=c/f;var d=this.view_to_gocs,v=a.direction;return v[0]=h[0]-d[12],v[1]=h[1]-d[13],v[2]=h[2]-d[14],s.default.normalize3(v,v),a}},{key:"createRenderInfo",value:function(){var e=this._canvas;return new c(this,e.width,e.height)}}]),e}();l._temp_mat=s.default.createMatrix();var c=function(){function e(t,r,n){i(this,e),this._view_to_clip=s.default.createMatrix(),this._volume_planes=[];for(var a=0;a<6;++a)this._volume_planes.push(s.default.createVector4());this._pixel_step=0,this._setup_view_to_clip(t,r,n),this._setup_volume_planes(),this._setup_pixel_step(r,n)}return a(e,[{key:"_setup_view_to_clip",value:function(e,t,r){var n=e.fov*s.default.DEGREE/2,i=r/t,a=e.near*Math.tan(n)/Math.sqrt(1+i*i),o=-a,u=a,_=-a*i,l=a*i;s.default.frustum_matrix(o,u,_,l,e.near,e.far,this._view_to_clip)}},{key:"_setup_volume_planes",value:function(){var e=this._view_to_clip,t=this._volume_planes;this._add_matrix_rows(e,3,2,t[0]),this._sub_matrix_rows(e,3,2,t[1]),this._add_matrix_rows(e,3,0,t[2]),this._sub_matrix_rows(e,3,0,t[3]),this._add_matrix_rows(e,3,1,t[4]),this._sub_matrix_rows(e,3,1,t[5]);for(var r=0;r<6;++r){var n=t[r],i=n[0],a=n[1],o=n[2],s=1/Math.sqrt(i*i+a*a+o*o);n[0]*=s,n[1]*=s,n[2]*=s,n[3]*=s}}},{key:"_setup_pixel_step",value:function(e,t){var r=this._view_to_clip,n=r[0],i=r[5],a=r[11],o=r[15],s=2*(o-a),u=s/(n*e),_=s/(i*t);this._pixel_step=Math.sqrt(u*u+_*_)*Math.SQRT1_2}},{key:"_add_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]+e[r],n[1]=e[t+4]+e[r+4],n[2]=e[t+8]+e[r+8],n[3]=e[t+12]+e[r+12],n}},{key:"_sub_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]-e[r],n[1]=e[t+4]-e[r+4],n[2]=e[t+8]-e[r+8],n[3]=e[t+12]-e[r+12],n}},{key:"view_to_clip",get:function(){return this._view_to_clip}},{key:"volume_planes",get:function(){return this._volume_planes}},{key:"pixel_step",get:function(){return this._pixel_step}}]),e}();t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a,o){r(this,e);var s=4,u=Math.pow(2,t-1),_=1<<a;this._sx=u/Math.PI*_,this._sy=-this._sx,this._ox=(u-n)*_,this._oy=(u-i)*_,this._body=o,this._pitch=s*(_+1),this._max=_}return n(e,[{key:"sample",value:function(e,t){return 0}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}
function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(18),_=n(u),l=r(1),c=n(l),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.glenv,r,n));return o._flake_to_clip=c.default.createMatrixf(),o}return o(t,e),s(t,[{key:"numDrawings",value:function(){return 1}},{key:"isWireframe",value:function(){return!1}},{key:"setFlakeParameter",value:function(e,t,r){return!1}},{key:"setCommonParameter",value:function(e,t){t.mul_flake_to_gocs(e._gocs_to_clip,this._flake_to_clip),this.setMatrix("u_obj_to_clip",this._flake_to_clip)}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(4),_=n(u),l=r(8),c=n(l),f=r(29),h=n(f),d=r(1),v=n(d),p=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(n._transform=v.default.setIdentity(v.default.createMatrix()),n._primitives=[],r&&r.json){var o=r.json,s=r.refs||{};t._getJsonTransform(o,n._transform);var u=s[o.ref_mesh],_=n._getJsonMaterial(o),l=new c.default(e.glenv,u,_,n._transform);l.properties=n.loadProperties(o,s),n._primitives.push(l)}return n}return o(t,e),s(t,[{key:"getPrimitives",value:function(e){return this._primitives}},{key:"setTransform",value:function(e){v.default.copyMatrix(e,this._transform)}},{key:"_getJsonMaterial",value:function(e){var t=e.mode||"basic";switch(t){case"basic":return this._getBasicMaterial();default:return console.error("mapray: unknown GenericEntity mode: "+t),null}}},{key:"_getBasicMaterial",value:function(){var e=this.scene;return e._GenericEntity_basic_material||(e._GenericEntity_basic_material=new h.default(e.glenv)),e._GenericEntity_basic_material}}],[{key:"_getJsonTransform",value:function(e,t){var r=e.transform.matrix;if(r)v.default.copyMatrix(r,t);else{var n=e.transform.cartographic,i={longitude:n[0],latitude:n[1],height:n[2]};v.default.iscs_to_gocs_matrix(i,t)}}}]),t}(_.default);t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=r(32),_=n(u),l=r(37),c=n(l),f=function(){function e(t,r){i(this,e),this._glenv=t,this._dem_provider=r,this._status=h.NOT_READY,this._ρ=r.getResolutionPower(),this._dem_zbias=s.default.LOG2PI-this._ρ+1,this._hist_stats=new v,this._flake_reduce_thresh=1.5,this._flake_reduce_factor=1.2,this._num_cache_flakes=0,this._num_touch_flakes=0,this._mesh_reduce_lower=300,this._mesh_reduce_thresh=1.5,this._mesh_reduce_factor=1.2,this._num_cache_meshes=0,this._num_touch_meshes=0,this._max_dem_requesteds=10,this._num_dem_requesteds=0,this._frame_counter=0,this._root_flake=null,this._avg_height=null,this._root_cancel_id=null,this._requestRoot()}return a(e,[{key:"cancel",value:function(){if(this._status===h.READY)for(var e=this._root_flake._children,t=0;t<4;++t)e[t].dispose();else this._status===h.NOT_READY&&(this._dem_provider.cancelRequest(this._root_cancel_id),this._root_cancel_id=null)}},{key:"getNumDemWaitingRequests",value:function(){return this._num_dem_requesteds}},{key:"findHighestAccuracy",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var u=s.default.clamp(Math.floor(i),0,n-1)%2,_=s.default.clamp(Math.floor(a),0,n-1)%2,l=r._children[u+2*_];if(r.touch(),null===l)break;r._dem_state===m.LOADED&&(o=r),r=l,n*=2,i*=2,a*=2}return o._requestHighestAccuracy(e,t),o._dem_data}},{key:"endFrame",value:function(){var e=this._hist_stats.getMaxValue(this._num_touch_flakes);this._num_cache_flakes>this._flake_reduce_thresh*e&&this._reduceFlakes(e),this._num_cache_meshes>this._mesh_reduce_lower&&this._num_cache_meshes>this._mesh_reduce_thresh*this._num_touch_meshes&&this._reduceMeshes(),this._num_touch_flakes=0,this._num_touch_meshes=0,++this._frame_counter}},{key:"_requestRoot",value:function(){var e=this,t=0,r=0,n=0;this._root_cancel_id=this._dem_provider.requestTile(t,r,n,function(i){if(i){var a=new _.default(t,r,n,e._ρ,i);e._avg_height=a.newAvgHeightMaps(),e._root_flake=new d(null,t,r,n),e._root_flake.setupRoot(e,a),e._status=h.READY}else e._status=h.FAILED;e._root_cancel_id=null,--e._num_dem_requesteds}),++this._num_dem_requesteds}},{key:"_reduceFlakes",value:function(e){var t=this._root_flake.flattenFlakes();t.sort(function(e,t){return e.compareForReduce(t)});var r=Math.floor(this._flake_reduce_factor*e);t.slice(r).forEach(function(e){return e.dispose()})}},{key:"_reduceMeshes",value:function(){var e=this._root_flake.flattenMeshes();e.sort(function(e,t){return e.compareForReduce(t)});var t=Math.floor(this._mesh_reduce_factor*this._num_touch_meshes);e.slice(t).forEach(function(e){return e.dispose()})}},{key:"glenv",get:function(){return this._glenv}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"status",get:function(){return this._status}},{key:"root_flake",get:function(){var e=this._root_flake;return e.touch(),e}}]),e}(),h={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};f.Status=h;var d=function(){function e(t,r,n,a){i(this,e),this.z=r,this.x=n,this.y=a,this._parent=t,this._children=[null,null,null,null],this._globe=null!==t?t._globe:null,this._dem_data=null,this._dem_state=m.NONE,this._meshes=[],this._prev_Za_dem=null,this._prev_Zr_dem=null,this._base_height=0,this._height_min=0,this._height_max=0,this._dem_zlimit=0,this._gocs_x_min=0,this._gocs_x_max=0,this._gocs_y_min=0,this._gocs_y_max=0,this._gocs_z_min=0,this._gocs_z_max=0,this._aframe=-1,null!==this._globe&&(this._globe._num_cache_flakes+=1)}return a(e,[{key:"setupRoot",value:function(e,t){this._globe=e,this._dem_data=t,this._dem_state=m.LOADED,this._estimate(),e._num_cache_flakes+=1}},{key:"newChild",value:function(t,r){var n=t+2*r,i=this._children[n];return null===i&&(i=new e(this,this.z+1,2*this.x+t,2*this.y+r),this._children[n]=i),i._estimate(),i.touch(),i}},{key:"isInvisible",value:function(e){switch(this.z){case 0:return this._isInvisible_0(e);default:return this._isInvisible_N(e)}}},{key:"findMesh",value:function(t){var r,n=Math.pow(2,-t)*e.ε;r=n<=2?Math.max(Math.ceil(s.default.LOG2PI-this.z-Math.maprayLog2(Math.acos(1-n))),0):0;var i,a=this._getCosφ();i=n*a<=2?Math.max(Math.ceil(s.default.LOG2PI-this.z+Math.maprayLog2(a/Math.acos(1-n*a))),0):0;var o=this._getMeshNode(t,r,i);return o.touch(),o.mesh}},{key:"findRayDistance",value:function(e,t){var r;for(r=this;r._dem_state!==m.LOADED;r=r._parent);if(this.z-r.z===this._globe._ρ)return this._findQuadRayDistance(e,t,r);if(this._cullForRayDistance(e,t))return t;for(var n=t,i=0;i<2;++i)for(var a=0;a<2;++a)n=this.newChild(a,i).findRayDistance(e,n);return n}},{key:"dispose",value:function(){var e,t=this._parent;if(null!==t){for(var r=this._globe,n=this._meshes;n.length>0;)n[0].dispose();var i=this._children;for(e=0;e<4;++e){var a=i[e];null!==a&&a.dispose()}var o=t._children;for(e=0;e<4;++e)if(o[e]===this){o[e]=null;break}this._parent=null,this._dem_state===m.REQUESTED&&(r._dem_provider.cancelRequest(this._dem_data),--r._num_dem_requesteds),r._num_cache_flakes-=1}}},{key:"flattenFlakes",value:function(){var e=[];return this._flattenFlakes(e),e}},{key:"flattenMeshes",value:function(){var e=[];return this._flattenMeshes(e),e}},{key:"compareForReduce",value:function(e){var t=this,r=e,n=r._aframe-t._aframe;return 0!==n?n:t.z-r.z}},{key:"_flattenFlakes",value:function(e){e.push(this);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenFlakes(e)}}},{key:"_flattenMeshes",value:function(e){Array.prototype.push.apply(e,this._meshes);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenMeshes(e)}}},{key:"touch",value:function(){var e=this._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_flakes+=1)}},{key:"_getMeshNode",value:function(e,t,r){for(var n=this._getMeshDemBinary(e),i=n.getDivisionPowers(this,e,t,r),a=this._meshes,o=a.length,s=0;s<o;++s){var u=a[s];if(u.match(n,i))return u}var _=new p(this,n,i);return a.unshift(_),_}},{key:"_getMeshDemBinary",value:function(e){var t=s.default.clamp(Math.round(e+this._globe._dem_zbias),0,this._dem_zlimit),r=this._findNearestDemTile(t);if(r.z<t){var n=r.getQuadLevel(this.z,this.x,this.y);n>0&&this._requestAncestorDemTile(Math.min(r.z+n,t))}return r}},{key:"_findNearestDemTile",value:function(e){for(var t=this,r=this.z-e,n=0;n<r;++n)t=t._parent;for(;t._dem_state!==m.LOADED;)t=t._parent;return t._dem_data}},{key:"_requestAncestorDemTile",value:function(e){var t=this._globe;if(!(t._num_dem_requesteds>=t._max_dem_requesteds)){for(var r=this,n=this.z-e,i=0;i<n;++i)r=r._parent;for(;;){var a=r._dem_state;if(a===m.LOADED||a===m.REQUESTED)break;{if(a!==m.FAILED){var o=t._dem_provider;r._dem_data=o.requestTile(r.z,r.x,r.y,function(e){null!==r._parent&&(e?(r._dem_data=new _.default(r.z,r.x,r.y,t._ρ,e),r._dem_state=m.LOADED):(r._dem_data=null,r._dem_state=m.FAILED),--t._num_dem_requesteds)}),r._dem_state=m.REQUESTED,++t._num_dem_requesteds;break}r=r._parent}}}}},{key:"_isInvisible_0",value:function(e){for(var t=s.default.EARTH_RADIUS+this._height_max,r=0;r<e.length;++r){var n=e[r][3];if(n<-t)return!0}return!1}},{key:"_isInvisible_N",value:function(e){for(var t=this._gocs_x_min,r=this._gocs_x_max,n=this._gocs_y_min,i=this._gocs_y_max,a=this._gocs_z_min,o=this._gocs_z_max,s=0;s<e.length;++s){var u=e[s],_=u[0],l=u[1],c=u[2],f=u[3],h=_*t+l*n,d=_*r+l*n,v=_*t+l*i,p=_*r+l*i,m=-c*a-f,y=-c*o-f;if(h<m&&d<m&&v<m&&p<m&&h<y&&d<y&&v<y&&p<y)return!0}return!1}},{key:"_getCosφ",value:function(){var e=this.z;if(e>0){var t=this.y,r=Math.pow(2,1-e),n=Math.abs(1-r*t),i=Math.abs(1-r*(t+1)),a=Math.exp(Math.PI*Math.min(n,i));return 2*a/(a*a+1)}return 1}},{key:"_estimate",value:function(){if(this._prev_Za_dem!==this){var e,t=this.z,r=this._globe._ρ;if(t<r){if(e=this._findNearestDemTile(t),e===this._prev_Zr_dem)return;this._prev_Zr_dem=e,this._estimate_low(e),this._dem_zlimit=t}else{var n=this._findNearestDemTile(t-r);if(n.isLeaf(t,this.x,this.y))this._estimate_leaf(n);else{if(e=this._findNearestDemTile(n.z+r),n===this._prev_Za_dem&&e===this._prev_Zr_dem)return;this._prev_Za_dem=n,this._prev_Zr_dem=e,this._estimate_high(n,e)}this._dem_zlimit=n.z+r}switch(t){case 0:this._updataBoundingBox_0();break;case 1:this._updataBoundingBox_1();break;default:this._updataBoundingBox_N()}}}},{key:"_estimate_low",value:function(t){var r=this.z,n=this.x,i=this.y,a=this._calcAlpha();this._base_height=this._globe._avg_height.sample(r,n,i),this._height_min=Math.max(this._base_height+a*e.Fm,t.height_min),this._height_max=Math.min(this._base_height+a*e.Fp,t.height_max),(t.z==r||t.isLeaf(r,n,i))&&(this._prev_Za_dem=this)}},{key:"_estimate_high",value:function(t,r){var n=this._globe,i=this.z,a=this.x,o=this.y,s=t.z,u=t.x,_=t.y,l=n._ρ,c=Math.pow(2,s-i),f=1<<l,h=Math.floor(f*((a+.5)*c-u)),d=Math.floor(f*((o+.5)*c-_)),v=f*(a*c-u)-h,p=f*((a+1)*c-u)-h,m=f*(o*c-_)-d,y=f*((o+1)*c-_)-d,g=t.getHeights(h,d),b=g[0],w=g[1],E=g[2],x=g[3],k=(b*(1-v)+w*v)*(1-m)+(E*(1-v)+x*v)*m,M=(b*(1-p)+w*p)*(1-m)+(E*(1-p)+x*p)*m,T=(b*(1-v)+w*v)*(1-y)+(E*(1-v)+x*v)*y,A=(b*(1-p)+w*p)*(1-y)+(E*(1-p)+x*p)*y,P=this._calcAlpha();if(this._base_height=.25*(k+M+T+A),this._height_min=Math.max(this._base_height+P*e.Fm,r.height_min),this._height_max=Math.min(this._base_height+P*e.Fp,r.height_max),s<i-l){var O=t.getQuadLevel(i,a,o);this._requestAncestorDemTile(Math.min(s+O,i-l))}else(r.z==i||r.isLeaf(i,a,o))&&(this._prev_Za_dem=this)}},{key:"_estimate_leaf",value:function(e){var t=this.z,r=this.x,n=this.y,i=e.z,a=e.x,o=e.y,s=Math.pow(2,i-t),u=1<<this._globe._ρ,_=Math.floor(u*((r+.5)*s-a)),l=Math.floor(u*((n+.5)*s-o)),c=u*(r*s-a)-_,f=u*((r+1)*s-a)-_,h=u*(n*s-o)-l,d=u*((n+1)*s-o)-l,v=e.getHeights(_,l),p=v[0],m=v[1],y=v[2],g=v[3],b=(p*(1-c)+m*c)*(1-h)+(y*(1-c)+g*c)*h,w=(p*(1-f)+m*f)*(1-h)+(y*(1-f)+g*f)*h,E=(p*(1-c)+m*c)*(1-d)+(y*(1-c)+g*c)*d,x=(p*(1-f)+m*f)*(1-d)+(y*(1-f)+g*f)*d;this._base_height=.25*(b+w+E+x),this._height_min=Math.min(b,w,E,x),this._height_max=Math.max(b,w,E,x),this._prev_Za_dem=this}},{key:"_calcAlpha",value:function(){var t=Math.pow(2,1-this.z);return t*e.πr/Math.cosh((1-t*(this.y+.5))*Math.PI)}},{key:"_updataBoundingBox_0",value:function(){var e=s.default.EARTH_RADIUS+this._height_max;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=-e,this._gocs_y_max=e,this._gocs_z_min=-e,this._gocs_z_max=e}},{key:"_updataBoundingBox_1",value:function(){var e=s.default.EARTH_RADIUS+this._height_max,t=this.x,r=this.y;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=e*(t-1),this._gocs_y_max=e*t,this._gocs_z_min=-e*r,this._gocs_z_max=e*(1-r)}},{key:"_updataBoundingBox_N",value:function(){var e=Math.PI,t=this.z,r=this.x,n=this.y,i=Math.pow(2,1-t)*e,a=-e+r*i,o=-e+(r+1)*i,u=e-(n+1)*i,_=e-n*i,l=a,c=o,f=Math.exp(u),h=Math.exp(_),d=f*f,v=h*h,p=s.default.EARTH_RADIUS+this._height_min,m=s.default.EARTH_RADIUS+this._height_max,y=2*f/(d+1),g=2*h/(v+1);u+_<0?(l+c<-e?(this._gocs_x_min=m*g*Math.cos(l),this._gocs_x_max=p*y*Math.cos(c),this._gocs_y_min=m*g*Math.sin(c),this._gocs_y_max=p*y*Math.sin(l)):l+c<0?(this._gocs_x_min=p*y*Math.cos(l),this._gocs_x_max=m*g*Math.cos(c),this._gocs_y_min=m*g*Math.sin(l),this._gocs_y_max=p*y*Math.sin(c)):l+c<e?(this._gocs_x_min=p*y*Math.cos(c),this._gocs_x_max=m*g*Math.cos(l),this._gocs_y_min=p*y*Math.sin(l),this._gocs_y_max=m*g*Math.sin(c)):(this._gocs_x_min=m*g*Math.cos(c),this._gocs_x_max=p*y*Math.cos(l),this._gocs_y_min=p*y*Math.sin(c),this._gocs_y_max=m*g*Math.sin(l)),this._gocs_z_min=m*(d-1)/(d+1),this._gocs_z_max=p*(v-1)/(v+1)):(l+c<-e?(this._gocs_x_min=m*y*Math.cos(l),this._gocs_x_max=p*g*Math.cos(c),this._gocs_y_min=m*y*Math.sin(c),this._gocs_y_max=p*g*Math.sin(l)):l+c<0?(this._gocs_x_min=p*g*Math.cos(l),this._gocs_x_max=m*y*Math.cos(c),this._gocs_y_min=m*y*Math.sin(l),this._gocs_y_max=p*g*Math.sin(c)):l+c<e?(this._gocs_x_min=p*g*Math.cos(c),this._gocs_x_max=m*y*Math.cos(l),this._gocs_y_min=p*g*Math.sin(l),this._gocs_y_max=m*y*Math.sin(c)):(this._gocs_x_min=m*y*Math.cos(c),this._gocs_x_max=p*g*Math.cos(l),this._gocs_y_min=p*g*Math.sin(c),this._gocs_y_max=m*y*Math.sin(l)),this._gocs_z_min=p*(d-1)/(d+1),this._gocs_z_max=m*(v-1)/(v+1))}},{key:"_requestHighestAccuracy",value:function(e,t){var r=this._dem_data.getQuadLevelDirect(e,t);if(0!=r){for(var n=this,i=Math.round(Math.pow(2,this.z+1)),a=i*e,o=i*t,u=0;u<r;++u){var _=s.default.clamp(Math.floor(a),0,i-1)%2,l=s.default.clamp(Math.floor(o),0,i-1)%2;n=n.newChild(_,l),i*=2,a*=2,o*=2}n._requestAncestorDemTile(n.z)}}},{key:"_findQuadRayDistance",value:function(t,r,n){var i=this._getQuadPositions(n,e._temp_positions),a=e._findTriRayDistance(t,r,i[0],i[2],i[1]);return a===r?e._findTriRayDistance(t,r,i[1],i[2],i[3]):a}},{key:"_getQuadPositions",value:function(e,t){for(var r=this.x,n=this.y,i=e.x,a=e.y,o=1<<this._globe._ρ,u=e._dem_data.getHeights(r-o*i,n-o*a),_=Math.pow(2,1-this.z)*Math.PI,l=r*_-Math.PI,c=Math.PI-n*_,f=0,h=c;f<2;++f,h-=_)for(var d=Math.exp(h),v=d*d,p=(v-1)/(v+1),m=2*d/(v+1),y=0,g=l;y<2;++y,g+=_){var b=y+2*f,w=s.default.EARTH_RADIUS+u[b],E=Math.sin(g),x=Math.cos(g),k=t[b];k[0]=w*m*x,k[1]=w*m*E,k[2]=w*p}return t}},{key:"_cullForRayDistance",value:function(e,t){var r=e.position,n=r[0],i=r[1],a=r[2],o=this._gocs_x_min,s=this._gocs_x_max,u=this._gocs_y_min,_=this._gocs_y_max,l=this._gocs_z_min,c=this._gocs_z_max;if(o<=n&&n<=s&&u<=i&&i<=_&&l<=a&&a<=c)return!1;var f,h,d,v,p=e.direction,m=p[0],y=p[1],g=p[2];if(n<o&&m>0){if(f=(o-n)/m,f<t&&(d=i+f*y,v=a+f*g,u<=d&&d<=_&&l<=v&&v<=c))return!1}else if(n>s&&m<0&&(f=(s-n)/m,f<t&&(d=i+f*y,v=a+f*g,u<=d&&d<=_&&l<=v&&v<=c)))return!1;if(i<u&&y>0){if(f=(u-i)/y,f<t&&(h=n+f*m,v=a+f*g,o<=h&&h<=s&&l<=v&&v<=c))return!1}else if(i>_&&y<0&&(f=(_-i)/y,f<t&&(h=n+f*m,v=a+f*g,o<=h&&h<=s&&l<=v&&v<=c)))return!1;if(a<l&&g>0){if(f=(l-a)/g,f<t&&(h=n+f*m,d=i+f*y,o<=h&&h<=s&&u<=d&&d<=_))return!1}else if(a>c&&g<0&&(f=(c-a)/g,f<t&&(h=n+f*m,d=i+f*y,o<=h&&h<=s&&u<=d&&d<=_)))return!1;return!0}},{key:"base_height",get:function(){return this._base_height}},{key:"height_min",get:function(){return this._height_min}},{key:"height_max",get:function(){return this._height_max}}],[{key:"_findTriRayDistance",value:function(t,r,n,i,a){var o=t.direction,u=e._temp_ray_1;u[0]=i[0]-n[0],u[1]=i[1]-n[1],u[2]=i[2]-n[2];var _=e._temp_ray_2;_[0]=a[0]-n[0],_[1]=a[1]-n[1],_[2]=a[2]-n[2];var l=s.default.cross3(u,_,e._temp_ray_3),c=s.default.dot3(l,o);if(c<0){var f=t.position,h=e._temp_ray_4;h[0]=n[0]-f[0],h[1]=n[1]-f[1],h[2]=n[2]-f[2];var d=s.default.dot3(l,h)/c;if(d>=0&&d<r){var v=e._temp_ray_5;v[0]=f[0]+d*o[0],v[1]=f[1]+d*o[1],v[2]=f[2]+d*o[2];var p=e._temp_ray_6;p[0]=n[0]-v[0],p[1]=n[1]-v[1],p[2]=n[2]-v[2];var m=e._temp_ray_7;m[0]=i[0]-v[0],m[1]=i[1]-v[1],m[2]=i[2]-v[2];var y=e._temp_ray_8;if(y[0]=a[0]-v[0],y[1]=a[1]-v[1],y[2]=a[2]-v[2],s.default.dot3(s.default.cross3(p,m,e._temp_ray_9),l)>=0&&s.default.dot3(s.default.cross3(m,y,e._temp_ray_10),l)>=0&&s.default.dot3(s.default.cross3(y,p,e._temp_ray_11),l)>=0)return d}}return r}}]),e}();d.ε=.0625,d.Fm=-2,d.Fp=2,d.πr=Math.PI*s.default.EARTH_RADIUS,d._temp_positions=function(){for(var e=[],t=0;t<4;++t)e.push(s.default.createVector3());return e}(),d._temp_ray_1=s.default.createVector3(),d._temp_ray_2=s.default.createVector3(),d._temp_ray_3=s.default.createVector3(),d._temp_ray_4=s.default.createVector3(),d._temp_ray_5=s.default.createVector3(),d._temp_ray_6=s.default.createVector3(),d._temp_ray_7=s.default.createVector3(),d._temp_ray_8=s.default.createVector3(),d._temp_ray_9=s.default.createVector3(),d._temp_ray_10=s.default.createVector3(),d._temp_ray_11=s.default.createVector3();var v=function(){function e(){i(this,e),this._history=[],this._max_value=0,this._hsize=200}return a(e,[{key:"getMaxValue",value:function(t){var r=this._history,n=this._max_value;return r.length<this._hsize?t>n&&(this._max_value=t):t>=n?(this._max_value=t,r.shift()):r[0]<n?r.shift():(r.shift(),this._max_value=e._find_max(r)),r.push(t),this._max_value}}],[{key:"_find_max",value:function(e){for(var t=e[0],r=e.length,n=1;n<r;++n){var i=e[n];i>t&&(t=i)}return t}}]),e}(),p=function(){function e(t,r,n){i(this,e),this._flake=t,this._dem=r,this._pow_u=n[0],this._pow_v=n[1],this._aframe=-1,this.mesh=new c.default(t._globe.glenv,t,n,r),t._globe._num_cache_meshes+=1}return a(e,[{key:"match",value:function(e,t){return this._dem===e&&this._pow_u===t[0]&&this._pow_v===t[1]}},{key:"touch",value:function(){var e=this._flake._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_meshes+=1)}},{key:"dispose",value:function(){if(null!==this.mesh){for(var e=this._flake,t=e._meshes,r=t.length,n=0;n<r;++n)if(t[n]===this){t.splice(n,1);break}this.mesh.dispose(),this.mesh=null,e._globe._num_cache_meshes-=1}}},{key:"compareForReduce",value:function(e){var t=this,r=e;return r._aframe-t._aframe}}]),e}(),m={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(2),s=n(o),u=r(9),_=n(u),l=function(){function e(t,r){i(this,e),this._owner=t,this._glenv=t.glenv;var n=r instanceof s.default?{image_provider:r}:r;this._image_provider=n.image_provider,this._visibility=n.visibility||!0,this._opacity=n.opacity||1,this._tile_cache=new _.default(this._glenv,this._image_provider),this._image_provider.status(function(e){t.dirtyDrawingLayers()})}return a(e,[{key:"setImageProvider",value:function(e){var t=this;this._image_provider!==e&&(this._owner.dirtyDrawingLayers(),e.status(function(e){t._owner.dirtyDrawingLayers()})),this._image_provider=e,this._tile_cache.cancel(),this._tile_cache=new _.default(this._glenv,e)}},{key:"setVisibility",value:function(e){this._visibility!=e&&this._owner.dirtyDrawingLayers(),this._visibility=e}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"image_provider",get:function(){return this._image_provider}},{key:"visibility",get:function(){return this._visibility}},{key:"opacity",get:function(){return this._opacity}},{key:"tile_cache",get:function(){return this._tile_cache}}]),e}();t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(15),s=n(o),u=r(2),_=n(u),l=function(){function e(t,r){i(this,e),this._glenv=t,this._layers=[],this._draw_layers=null;for(var n=0;n<r.length;++n)this.add(r[n])}return a(e,[{key:"getLayer",value:function(e){return this._layers[e]}},{key:"clear",value:function(){for(;this.num_layers()>0;)this.remove(0)}},{key:"add",value:function(e){this.insert(this.num_layers,e)}},{key:"insert",value:function(e,t){this._layers.splice(e,0,new s.default(this,t)),this.dirtyDrawingLayers()}},{key:"remove",value:function(e){this._layers.splice(e,1),this.dirtyDrawingLayers()}},{key:"numDrawingLayers",value:function(){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers.length}},{key:"getDrawingLayer",value:function(e){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers[e]}},{key:"endFrame",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.endFrame()}},{key:"cancel",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.cancel()}},{key:"dirtyDrawingLayers",value:function(){this._draw_layers=null}},{key:"_updataDrawingLayers",value:function(){for(var e=this.num_layers,t=[],r=0;r<e;++r){var n=this._layers[r];n.image_provider.status()===_.default.Status.READY&&n.visibility===!0&&t.push(n)}this._draw_layers=t}},{key:"glenv",get:function(){return this._glenv}},{key:"num_layers",get:function(){return this._layers.length}}]),e}();t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(4),_=n(u),l=r(8),c=n(l),f=r(7),h=n(f),d=r(39),v=n(d),p=r(1),m=n(p),y=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n._buffer=new Float64Array(1),n._num_floats=0,n._geom_dirty=!0,n._transform=m.default.setIdentity(m.default.createMatrix()),n._pivot=m.default.createVector3(),n._bbox=[m.default.createVector3(),m.default.createVector3()],n._properties={width:1,color:m.default.createVector3f([1,1,1]),opacity:1};var o=new c.default(e.glenv,null,n._getMarkerLineMaterial(),n._transform);return o.pivot=n._pivot,o.bbox=n._bbox,o.properties=n._properties,n._primitive=o,n._empty=[],n._primitives=[o],r&&r.json&&n._setupByJson(r.json),n}return o(t,e),s(t,[{key:"getPrimitives",value:function(e){return this._num_floats<2?this._empty:(this._updatePrimitive(),this._primitives)}},{key:"setLineWidth",value:function(e){this._properties.width=e}},{key:"setColor",value:function(e){m.default.copyVector3(e,this._properties.color)}},{key:"setOpacity",value:function(e){this._properties.opacity=e}},{key:"addPoints",value:function(e){var t=e.length;if(0!=t){var r=this._num_floats+t,n=this._buffer.length;if(r>n){for(var i=new Float64Array(Math.max(r,2*n)),a=this._buffer,o=this._num_floats,s=0;s<o;++s)i[s]=a[s];this._buffer=i}for(var u=this._buffer,_=this._num_floats,l=0;l<t;++l)u[_+l]=e[l];this._num_floats=r,this._geom_dirty=!0}}},{key:"_getMarkerLineMaterial",value:function(){var e=this.scene;return e._MarkerLineEntity_markerline_material||(e._MarkerLineEntity_markerline_material=new v.default(e.glenv)),e._MarkerLineEntity_markerline_material}},{key:"_updatePrimitive",value:function(){if(this._geom_dirty){this._updateTransformPivotBBox();var e={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(),indices:this._createIndices()},t=new h.default(this.scene.glenv,e),r=this._primitive;r.mesh&&r.mesh.dispose(),r.mesh=t,this._geom_dirty=!1}}},{key:"_updateTransformPivotBBox",value:function(){var e=this._buffer,t=e[0],r=e[1],n=e[2],i=this._transform;i[12]=t,i[13]=r,i[14]=n;for(var a=this._num_floats/3,o=0,s=0,u=0,_=Number.MAX_VALUE,l=Number.MAX_VALUE,c=Number.MAX_VALUE,f=-Number.MAX_VALUE,h=-Number.MAX_VALUE,d=-Number.MAX_VALUE,v=0;v<a;++v){var p=3*v,m=e[p]-t,y=e[p+1]-r,g=e[p+2]-n;o+=m,s+=y,u+=g,m<_&&(_=m),y<l&&(l=y),g<c&&(c=g),m>f&&(f=m),y>h&&(h=y),g>d&&(d=g)}var b=this._pivot;b[0]=o/a,b[1]=s/a,b[2]=u/a;var w=this._bbox,E=w[0],x=w[1];E[0]=_,E[1]=l,E[2]=c,x[0]=f,x[1]=h,x[2]=d}},{key:"_createVertices",value:function(){for(var e=this._buffer,t=e[0],r=e[1],n=e[2],i=this._num_floats/3,a=i-1,o=4*a,s=new Float32Array(8*o),u=0;u<a;++u){var _=3*u,l=e[_]-t,c=e[_+1]-r,f=e[_+2]-n,h=e[_+3]-t,d=e[_+4]-r,v=e[_+5]-n,p=e[_+3]-e[_],m=e[_+4]-e[_+1],y=e[_+5]-e[_+2],g=32*u;s[g]=l,s[g+1]=c,s[g+2]=f,s[g+3]=p,s[g+4]=m,s[g+5]=y,s[g+6]=-1,s[g+7]=1,s[g+8]=l,s[g+9]=c,s[g+10]=f,s[g+11]=p,s[g+12]=m,s[g+13]=y,s[g+14]=-1,s[g+15]=-1,s[g+16]=h,s[g+17]=d,s[g+18]=v,s[g+19]=p,s[g+20]=m,s[g+21]=y,s[g+22]=1,s[g+23]=1,s[g+24]=h,s[g+25]=d,s[g+26]=v,s[g+27]=p,s[g+28]=m,s[g+29]=y,s[g+30]=1,s[g+31]=-1}return s}},{key:"_createIndices",value:function(){for(var e=this._num_floats/3,t=e-1,r=6*t,n=new Uint32Array(r),i=0;i<t;++i){var a=6*i,o=4*i;n[a]=o,n[a+1]=o+1,n[a+2]=o+2,n[a+3]=o+2,n[a+4]=o+1,n[a+5]=o+3}return n}},{key:"_setupByJson",value:function(e){this.addPoints(t._toCartesianPoints(e.points));var r=this._properties;e.line_width&&(r.width=e.line_width),e.color&&m.default.copyVector3(e.color,r.color),e.opacity&&(r.opacity=e.opacity)}}],[{key:"_toCartesianPoints",value:function(e){var t=e.type||"cartesian",r=e.coords,n=null;if("cartesian"==t)n=r;else if("cartographic"==t){var i=m.default.DEGREE,a=m.default.EARTH_RADIUS,o=r.length;n=new Float64Array(o);for(var s=0;s<o;s+=3){var u=r[s]*i,_=r[s+1]*i,l=r[s+2]+a,c=Math.sin(u),f=Math.cos(u),h=Math.sin(_),d=Math.cos(_);n[s]=l*d*f,n[s+1]=l*d*c,n[s+2]=l*h}}else console.error("mapray: unknown points type: "+t),n=[];return n}}]),t}(_.default);t.default=y,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(43),s=n(o),u=function(){function e(t,r,n){i(this,e);var a=new s.default(t,r,n);this._gl=t.context,this._program=this._link_shaders(a.vs_object,a.fs_object),this._attrib_location=this._create_attrib_location(),this._uniform_location=this._create_uniform_location(),this._attrib_names=Object.keys(this._attrib_location),a.dispose()}return a(e,[{key:"_link_shaders",value:function(e,t){var r=this._gl,n=r.createProgram();if(!n)throw new Error("プログラムオブジェクトの生成に失敗しました");try{if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){var i=r.getProgramInfoLog(n);throw r.detachShader(n,t),r.detachShader(n,e),new Error("シェーダのリンクに失敗: "+i)}}catch(e){throw r.deleteProgram(n),e}return n}},{key:"_create_attrib_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i);r[a.name]=e.getAttribLocation(t,a.name)}return r}},{key:"_create_uniform_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[a.name]=e.getUniformLocation(t,a.name)}return r}},{key:"dispose",value:function(){var e=this._gl;e.deleteProgram(this._program),this._program=null}},{key:"getAttribNames",value:function(){return this._attrib_names}},{key:"bindProgram",value:function(){var e=this._gl;e.useProgram(this._program)}},{key:"setInteger",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1i(r,t)}}},{key:"setFloat",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1f(r,t)}}},{key:"setVector2",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform2fv(r,t)}}},{key:"setVector3",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform3fv(r,t)}}},{key:"setVector4",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform4fv(r,t)}}},{key:"setMatrix",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniformMatrix4fv(r,!1,t)}}},{key:"bindVertexAttrib",value:function(e,t,r,n){var i=this._attrib_location[e];if(i>=0){var a=this._gl;a.enableVertexAttribArray(i),a.vertexAttribPointer(i,t,a.FLOAT,!1,r,n)}}},{key:"bindTexture2D",value:function(e,t){var r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t);
}}]),e}();t.default=u,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=r(1),o=n(a),s=function e(t,r){i(this,e),this.position=t||o.default.createVector3(),this.direction=r||o.default.createVector3([0,0,-1])};t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this._viewer=null,this._is_started_=!1}return n(e,[{key:"attach",value:function(e){if(this._viewer)throw new Error("RenderCallback instance is already attached");this._viewer=e,this._is_started_=!1}},{key:"detach",value:function(){this._is_started_&&(this.onStop(),this._is_started_=!1),this._viewer=null}},{key:"onUpdateFrameInner",value:function(e){this._is_started_||(this.onStart(),this._is_started_=!0),this.onUpdateFrame(e)}},{key:"onStart",value:function(){}},{key:"onUpdateFrame",value:function(e){}},{key:"onStop",value:function(){}},{key:"viewer",get:function(){return this._viewer}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._glenv=t,this._entity_list=[],this._loaders=[]}return n(e,[{key:"clearEntities",value:function(){this._entity_list=[]}},{key:"addEntity",value:function(e){if(e.scene!==this)throw new Error("invalid entity");this._entity_list.push(e)}},{key:"removeEntity",value:function(e){var t=this._entity_list,r=t.indexOf(e);r>=0&&t.splice(r,1)}},{key:"getEntity",value:function(e){return this._entity_list[e]}},{key:"draw",value:function(e){for(var t=[],r=[],n=0;n<this._entity_list.length;++n){var i=this._entity_list[n];this._add_primitives(e,i,t,r)}this._draw_opaque_primitives(e,t),this._draw_translucent_primitives(e,r)}},{key:"_add_primitives",value:function(e,t,r,n){for(var i=t.getPrimitives(e),a=0;a<i.length;++a){var o=i[a];if(o.isVisible(e)){var s=o.isTranslucent(e)?n:r;s.push(o)}}}},{key:"_draw_opaque_primitives",value:function(e,t){t.sort(function(e,t){return t.sort_z-e.sort_z});var r=this._glenv.context;r.disable(r.BLEND),r.depthMask(!0);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"_draw_translucent_primitives",value:function(e,t){t.sort(function(e,t){return e.sort_z-t.sort_z});var r=this._glenv.context;r.enable(r.BLEND),r.depthMask(!1);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"cancelLoaders",value:function(){for(var e=this._loaders.concat(),t=0;t<e.length;++t)e[t].cancel()}},{key:"addLoader",value:function(e){this._loaders.push(e)}},{key:"removeLoader",value:function(e){var t=this._loaders.indexOf(e);t>=0&&this._loaders.splice(t,1)}},{key:"glenv",get:function(){return this._glenv}},{key:"num_entities",get:function(){return this._entity_list.length}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){}function o(e,t){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(3),_=n(u),l=r(7),c=n(l),f=r(26),h=n(f),d=r(13),v=n(d),p=r(17),m=n(p),y=r(25),g=n(y),b=function(){function e(t,r,n){i(this,e);var s=n||{};this._scene=t,this._url=r,this._callback=s.callback||a,this._transform=s.transform||o,this._glenv=t.glenv,this._references={},this._cancelled=!1,this._finished=!1,this._abort_ctrl=new AbortController,this._loadFile(),t.addLoader(this)}return s(e,[{key:"cancel",value:function(){var e=this;this._cancelled||(this._abort_ctrl.abort(),this._cancelled=!0,this._scene.removeLoader(this),Promise.resolve().then(function(){e._cancel_callback()}))}},{key:"getReference",value:function(e){var t=this._references[e];return void 0!==t?t:null}},{key:"_setReference",value:function(e,t){this._references[e]=t}},{key:"_loadFile",value:function(){var e=this,t=this._transform(this._url,w.SCENE);fetch(t.url,this._make_fetch_params(t)).then(function(t){return e._check_cancel(),t.json()}).then(function(t){e._check_cancel(),e._load_object(t)}).catch(function(r){e._fail_callback("mapray: failed to retrieve: "+t.url)})}},{key:"_load_object",value:function(e){e.req_count=0,e.req_ended=!1,this._load_mesh_register(e),this._load_texture_register(e),0==e.req_count&&this._postload_object(e),e.req_ended=!0}},{key:"_postload_object",value:function(e){this._cancelled||(this._load_entity_list(e),this._success_callback())}},{key:"_postload_object_ifNoReq",value:function(e){--e.req_count,0==e.req_count&&e.req_ended&&this._postload_object(e)}},{key:"_load_mesh_register",value:function(e){var t=e.mesh_register;if(t)for(var r=Object.keys(t),n=0;n<r.length;++n){var i=r[n],a=t[i];a.binary?this._load_mesh_binary(e,i,a.binary):a.vertices&&this._setReference(i,new c.default(this._glenv,a))}}},{key:"_load_mesh_binary",value:function(e,t,r){var n=this,i=this._transform(r,w.MESH);fetch(i.url,this._make_fetch_params(i)).then(function(e){return n._check_cancel(),e.arrayBuffer()}).then(function(e){n._check_cancel(),n._setReference(t,new c.default(n._glenv,e))}).catch(function(){console.error("mapray: failed to retrieve: "+i.url)}).then(function(){n._postload_object_ifNoReq(e)}),++e.req_count}},{key:"_load_texture_register",value:function(e){var t=e.texture_register;if(t)for(var r=Object.keys(t),n=0;n<r.length;++n){var i=r[n],a=t[i];a.image&&this._load_texture_image(e,i,a.image)}}},{key:"_load_texture_image",value:function(e,t,r){var n=this,i=new Image,a=this._transform(r,w.IMAGE);i.onload=function(){n._cancelled||n._setReference(t,new h.default(n._glenv,i)),n._postload_object_ifNoReq(e)},i.onerror=function(){console.error("mapray: failed to retrieve: "+a.url),n._postload_object_ifNoReq(e)},a.credentials===_.default.SAME_ORIGIN?i.crossOrigin="anonymous":a.credentials===_.default.INCLUDE&&(i.crossOrigin="use-credentials"),++e.req_count,i.src=a.url}},{key:"_load_entity_list",value:function(e){var t=e.entity_list;if(t)for(var r=this._scene,n=0;n<t.length;++n){var i=t[n],a=i.type||"generic",o=null;switch(a){case"generic":o=new v.default(r,{json:i,refs:this._references});break;case"markerline":o=new m.default(r,{json:i,refs:this._references});break;case"text":o=new g.default(r,{json:i,refs:this._references});break;default:console.error("mapray: unknown entity type: "+a)}if(o){r.addEntity(o);var s=i.id;s&&this._setReference(s,o)}}}},{key:"_make_fetch_params",value:function(t){var r={signal:this._abort_ctrl.signal,credentials:(t.credentials||_.default.OMIT).credentials};return t.headers&&(r.headers=t.headers||e._defaultHeaders),r}},{key:"_check_cancel",value:function(){if(this._cancelled)throw new Error("canceled")}},{key:"_cancel_callback",value:function(){this._finished||this._callback(this,!1)}},{key:"_success_callback",value:function(){this._cancelled||(this._finished=!0,this._scene.removeLoader(this),this._callback(this,!0))}},{key:"_fail_callback",value:function(e){this._cancelled||(console.error(e),this._finished=!0,this._scene.removeLoader(this),this._callback(this,!1))}},{key:"scene",get:function(){return this._scene}},{key:"url",get:function(){return this._url}}]),e}(),w={SCENE:{id:"SCENE"},IMAGE:{id:"IMAGE"},MESH:{id:"MESH"}};b.ResourceType=w,b._defaultHeaders={},t.default=b,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(5),_=n(u),l=r(3),c=n(l),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),s=n||{};return o._prefix=e,o._suffix=r,o._credentials=(s.credentials||c.default.OMIT).credentials,o._headers=Object.assign({},s.headers),o}return o(t,e),s(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{credentials:this._credentials,headers:this._headers,signal:i.signal}).then(function(e){return e.arrayBuffer()}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return this._prefix+e+"/"+t+"/"+r+this._suffix}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(2),_=n(u),l=r(3),c=n(l),f=function(e){function t(e,r,n,o,s,u){i(this,t);var _=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));_._prefix=e,_._suffix=r,_._size=n,_._min_level=o,_._max_level=s;var l;u&&u.coord_order&&(u.coord_order===h.ZYX?l=function(e,t,r){return e+"/"+r+"/"+t}:u.coord_order===h.XYZ&&(l=function(e,t,r){return t+"/"+r+"/"+e})),l||(l=function(e,t,r){return e+"/"+t+"/"+r});var f;return u&&u.coord_system&&u.coord_system===d.LOWER_LEFT&&(f=function(e,t,r){var n=Math.round(Math.pow(2,e));return l(e,t,n-r-1)}),f||(f=l),_._coords_part=f,_._crossOrigin="anonymous",u&&u.credentials&&(u.credentials===c.default.OMIT?_._crossOrigin=null:u.credentials===c.default.INCLUDE&&(_._crossOrigin="use-credentials")),_}return o(t,e),s(t,[{key:"requestTile",value:function(e,t,r,n){var i=new Image;return i.onload=function(){n(i)},i.onerror=function(){n(null)},null!==this._crossOrigin&&(i.crossOrigin=this._crossOrigin),i.src=this._makeURL(e,t,r),i}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return this._size}},{key:"getZoomLevelRange",value:function(){return new _.default.Range(this._min_level,this._max_level)}},{key:"_makeURL",value:function(e,t,r){return this._prefix+this._coords_part(e,t,r)+this._suffix}}]),t}(_.default),h={ZXY:{id:"ZXY"},ZYX:{id:"ZYX"},XYZ:{id:"XYZ"}},d={UPPER_LEFT:{id:"UPPER_LEFT"},LOWER_LEFT:{id:"LOWER_LEFT"}};f.CoordOrder=h,f.CoordSystem=d,t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(4),_=n(u),l=r(8),c=n(l),f=r(7),h=n(f),d=r(26),v=n(d),p=r(45),m=n(p),y=r(1),g=n(y),b=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n._entries=[],n._dirty=!0,n._text_parent_props={font_style:"normal",font_weight:"normal",font_size:t.DEFAULT_FONT_SIZE,font_family:t.DEFAULT_FONT_FAMILY,color:g.default.createVector3f(t.DEFAULT_COLOR)},n._transform=g.default.setIdentity(g.default.createMatrix()),n._properties={image:null};var o=new c.default(e.glenv,null,n._getTextMaterial(),n._transform);return o.properties=n._properties,n._primitive=o,n._primitives=[],n._text_upper=t.DEFAULT_TEXT_UPPER,n._text_lower=t.DEFAULT_TEXT_LOWER,r&&r.json&&n._setupByJson(r.json),n}return o(t,e),s(t,[{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"setColor",value:function(e){this._setVector3Property("color",e)}},{key:"addText",value:function(e,t,r){this._entries.push(new w(this,e,t,r)),this._dirty=!0}},{key:"_getTextMaterial",value:function(){var e=this.scene;return e._TextEntity_text_material||(e._TextEntity_text_material=new m.default(e.glenv)),e._TextEntity_text_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._dirty=!0)}},{key:"_setVector3Property",value:function(e,t){var r=this._text_parent_props[e];r[0]==t[0]&&r[1]==t[1]&&r[2]==t[2]||(g.default.copyVector3(t,r),this._dirty=!0)}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;this._updateTransform();var e=new E(this);if(!e.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var t=this._properties;t.image&&t.image.dispose(),t.image=e.texture;var r={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_color",size:4}],vertices:e.vertices,indices:e.indices},n=new h.default(this.scene.glenv,r),i=this._primitive;return i.mesh&&i.mesh.dispose(),i.mesh=n,this._primitives=[i],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(){for(var e=this._entries.length,t=0,r=0,n=0,i=0;i<e;++i){var a=this._entries[i].position;t+=a[0],r+=a[1],n+=a[2]}var o=this._transform;o[12]=t/e,o[13]=r/e,o[14]=n/e}},{key:"_setupByJson",value:function(e){for(var r=e.entries,n=0;n<r.length;++n){var i=r[n];this.addText(i.text,t._toCartesian(i.position),i)}var a=this._text_parent_props;e.font_style&&(a.font_style=e.font_style),e.font_weight&&(a.font_weight=e.font_weight),e.font_size&&(a.font_size=e.font_size),e.font_family&&(a.font_family=e.font_family),e.color&&g.default.copyVector3(e.color,a.color)}}],[{key:"_toCartesian",value:function(e){var t=null;if(e.cartesian)t=e.cartesian;else if(e.cartographic){t=g.default.createVector3();var r=e.cartographic,n=g.default.DEGREE,i=r[0]*n,a=r[1]*n,o=r[2]+g.default.EARTH_RADIUS,s=Math.sin(i),u=Math.cos(i),_=Math.sin(a),l=Math.cos(a);t[0]=o*l*u,t[1]=o*l*s,t[2]=o*_}return t}}]),t}(_.default);b.DEFAULT_FONT_SIZE=16,b.DEFAULT_FONT_FAMILY="sans-serif",b.DEFAULT_COLOR=g.default.createVector3f([1,1,1]),b.DEFAULT_TEXT_UPPER=1.1,b.DEFAULT_TEXT_LOWER=.38,b.SAFETY_PIXEL_MARGIN=1,b.MAX_IMAGE_WIDTH=4096;var w=function(){function e(t,r,n,a){i(this,e),this._owner=t,this._text=r,this._position=g.default.createVector3f(n),this._props=Object.assign({},a),this._copyPropertyVector3f("color")}return s(e,[{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=g.default.createVector3f(t[e]))}},{key:"text",get:function(){return this._text}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.font_size||t.font_size}},{key:"color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.color||t.color}},{key:"font",get:function(){var e=this._props,t=this._owner._text_parent_props,r=e.font_style||t.font_style,n="normal",i=e.font_weight||t.font_weight,a=e.font_family||t.font_family;return r+" "+n+" "+i+" "+this.size+"px "+a}}]),e}(),E=function(){function e(t){i(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var r=this._createRowLayouts();if(0==r.length)return void(this._is_valid=!1);var n=this._setupLocation(r);this._texture=this._createTexture(n.width,n.height),this._vertices=this._createVertices(n.width,n.height),this._indices=this._createIndices()}return s(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){for(var t=this._owner._entries,r=e._createCanvasContext(1,1),n=[],i=0;i<t.length;++i)n.push(new x(this,t[i],r));return n}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort(function(e,t){return e.height_pixel-t.height_pixel});for(var t=[];e.length>0;){var r=new k(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(t,r){var n=e._createCanvasContext(t,r);n.textAlign="left",n.textBaseline="alphabetic",n.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var i=this._items,a=0;a<i.length;++a){var o=i[a];o.is_canceled||o.drawText(n)}var s=this._owner.scene.glenv,u={usage:v.default.Usage.TEXT};return new v.default(s,n.canvas,u)}},{key:"_createVertices",value:function(e,t){for(var r=[],n=this._owner._transform,i=n[12],a=n[13],o=n[14],s=this._items,u=0;u<s.length;++u){var _=s[u];if(!_.is_canceled){var l=_.entry,c=l.position,f=l.color,h=c[0]-i,d=c[1]-a,v=c[2]-o,p=_.pos_x,m=_.pos_y,y=_.upper,g=_.lower,b=_.width,w=1/e,E=1/t;r.push(h,d,v),r.push(-b/2,-g),r.push(p*w,1-(m+g)*E),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(b/2,-g),r.push((p+b)*w,1-(m+g)*E),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(-b/2,y),r.push(p*w,1-(m-y)*E),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(b/2,y),r.push((p+b)*w,1-(m-y)*E),r.push(f[0],f[1],f[2],1)}}return r}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled){var i=4*r;e.push(i,i+1,i+2,i+2,i+1,i+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=b.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+b.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}],[{key:"_createCanvasContext",value:function(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}}]),e}(),x=function(){function e(t,r,n){i(this,e),this._entry=r,this._pos_x=0,this._pos_y=0,n.font=r.font,this._width=n.measureText(r.text).width;var a=t._owner;this._upper=r.size*a._text_upper,this._lower=r.size*a._text_lower,this._is_canceled=!1}return s(e,[{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t+Math.ceil(this._upper)}},{key:"drawText",value:function(e){var t=this._entry;e.font=t.font,e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"entry",get:function(){return this._entry}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"upper",get:function(){return this._upper}},{key:"lower",get:function(){return this._lower}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._upper)+Math.ceil(this._lower)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),k=function(){function e(t){i(this,e);var r=0,n=0,a=[];for(r+=b.SAFETY_PIXEL_MARGIN;t.length>0;){var o=t.shift(),s=o.width_pixel+b.SAFETY_PIXEL_MARGIN;if(r+s<=b.MAX_IMAGE_WIDTH)a.push(o),r+=s,n=Math.max(o.height_pixel,n);else{if(0!=a.length){t.unshift(o);break}o.cancel()}}this._items=a,this._width_assumed=r,this._height_pixel=n}return s(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=b.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+b.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}();t.default=b,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t,this._handle=this._createTexture(n,i)}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;e.deleteTexture(this._handle),this._handle=null}},{key:"_createTexture",value:function(t,r){var n=this._glenv.context,i=n.TEXTURE_2D,a=n.createTexture(),o=e._getParameters(n,r||{});return n.bindTexture(i,a),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!0),n.texImage2D(i,0,o.format,o.format,o.type,t),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),o.gen_mipmap&&n.generateMipmap(i),n.texParameteri(i,n.TEXTURE_MAG_FILTER,o.mag_filter),n.texParameteri(i,n.TEXTURE_MIN_FILTER,o.min_filter),n.texParameteri(i,n.TEXTURE_WRAP_S,o.wrap),n.texParameteri(i,n.TEXTURE_WRAP_T,o.wrap),n.bindTexture(i,null),a}},{key:"handle",get:function(){return this._handle}}],[{key:"_getParameters",value:function(t,r){var n=r.usage||e.Usage.GENERAL,i={format:t.RGBA,type:t.UNSIGNED_BYTE,mag_filter:t.LINEAR,min_filter:t.LINEAR_MIPMAP_LINEAR,wrap:t.REPEAT,gen_mipmap:!0};return n===e.Usage.TEXT&&(i.format=t.ALPHA,i.min_filter=t.LINEAR,i.wrap=t.CLAMP_TO_EDGE,i.gen_mipmap=!1),i}}]),e}(),a={GENERAL:{id:"GENERAL"},TEXT:{id:"TEXT"}};i.Usage=a,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(10),s=n(o),u=r(38),_=n(u),l=r(42),c=n(l),f=r(24),h=n(f),d=r(23),v=n(d),p=r(16),m=n(p),y=r(14),g=n(y),b=r(9),w=n(b),E=r(40),x=n(E),k=r(1),M=n(k),T=r(21),A=n(T),P=r(22),O=(n(P),function(){function e(t,r){i(this,e);var n;n="string"==typeof t?document.getElementById(t):t;var a=this._createCanvas(n);this._container_element=n,this._canvas_element=a,this._glenv=new _.default(a),this._camera=new s.default(a),this._dem_provider=this._createDemProvider(r),this._image_provider=this._createImageProvider(r),this._layers=this._createLayerCollection(r),this._globe=new g.default(this._glenv,this._dem_provider),this._tile_texture_cache=new w.default(this._glenv,this._image_provider),this._scene=new A.default(this._glenv),this._render_mode=r&&r.render_mode||R.SURFACE,this._debug_stats=r&&r.debug_stats||null,this._render_callback=this._createRenderCallback(r),this._frame_req_id=0,this._previous_time=void 0,this._is_destroyed=!1,this._requestNextFrame(),this._updateCanvasSize()}return a(e,[{key:"destroy",value:function(){this._is_destroyed||(0!=this._frame_req_id&&(window.maprayCancelAnimationFrame(this._frame_req_id),this._frame_req_id=0),this._render_callback.detach(),this._render_callback=this._createRenderCallback(),this._container_element.removeChild(this._canvas_element),this._globe.cancel(),this._tile_texture_cache.cancel(),this._layers.cancel(),this._scene.cancelLoaders(),this._is_destroyed=!0)}},{key:"_createCanvas",value:function(e){var t=document.createElement("canvas");return t.className="mapray-canvas",t.style.width="100%",t.style.height="100%",e.appendChild(t),t}},{key:"_createDemProvider",value:function(e){return e&&e.dem_provider?e.dem_provider:new v.default("/dem/",".bin")}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider?e.image_provider:new h.default("http://cyberjapandata.gsi.go.jp/xyz/std/",".png",256,0,18)}},{key:"_createLayerCollection",value:function(e){var t=e&&e.layers?e.layers:{};return new m.default(this._glenv,t)}},{key:"_createRenderCallback",value:function(e){var t;return t=e&&e.render_callback?e.render_callback:new x.default,t.attach(this),t}},{key:"getElevation",value:function(e,t){var r=t+180*Math.floor((90-e)/360+Math.floor((90+e)/360)),n=90-Math.abs(90-e+360*Math.floor((90+e)/360)),i=r-360-360*Math.floor((r-180)/360),a=i*M.default.DEGREE,o=M.default.invGudermannian(n*M.default.DEGREE),s=2*Math.PI,u=a/s+.5,_=.5-o/s;if(_<0||_>1)return 0;var l=this._globe,c=l.findHighestAccuracy(u,_);if(null===c)return 0;var f=l.dem_provider.getResolutionPower(),h=1<<f,d=Math.pow(2,c.z),v=h*(d*u-c.x),p=h*(d*_-c.y),m=M.default.clamp(Math.floor(v),0,h-1),y=M.default.clamp(Math.floor(p),0,h-1),g=c.getHeights(m,y),b=g[0],w=g[1],E=g[2],x=g[3],k=v-m,T=p-y;return(b*(1-k)+w*k)*(1-T)+(E*(1-k)+x*k)*T}},{key:"getRayIntersection",value:function(e){var t=this._globe;if(t.status!==g.default.Status.READY)return null;var r=t.root_flake.findRayDistance(e,Number.MAX_VALUE);if(r===Number.MAX_VALUE)return null;var n=M.default.createVector3(),i=e.position,a=e.direction;return n[0]=i[0]+r*a[0],n[1]=i[1]+r*a[1],n[2]=i[2]+r*a[2],n}},{key:"_requestNextFrame",value:function(){var e=this;this._frame_req_id=window.maprayRequestAnimationFrame(function(){return e._updateFrame()})}},{key:"_updateFrame",value:function(){var e=this._updateTime();this._requestNextFrame(),this._updateCanvasSize(),this._render_callback.onUpdateFrameInner(e),null!==this._debug_stats&&this._debug_stats.clearStats();var t=new c.default(this);t.render(),this._finishDebugStats()}},{key:"_updateTime",value:function(){var e=window.maprayNow(),t=void 0!==this._previous_time?(e-this._previous_time)/1e3:0;return this._previous_time=e,t}},{key:"_updateCanvasSize",value:function(){var e=this._canvas_element;e.width!=e.clientWidth&&(e.width=e.clientWidth),e.height!=e.clientHeight&&(e.height=e.clientHeight)}},{key:"_finishDebugStats",value:function(){var e=this._debug_stats;null!==e&&(e.num_wait_reqs_dem=this._globe.getNumDemWaitingRequests(),e.num_wait_reqs_img=this._tile_texture_cache.getNumWaitingRequests(),e.onUpdate())}},{key:"container_element",get:function(){return this._container_element}},{key:"canvas_element",get:function(){return this._canvas_element}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"image_provider",get:function(){return this._image_provider}},{key:"layers",get:function(){return this._layers}},{key:"render_callback",get:function(){return this._render_callback}},{key:"render_mode",get:function(){return this._render_mode},set:function(e){this._render_mode=e}},{key:"debug_stats",get:function(){return this._debug_stats}},{key:"camera",get:function(){return this._camera}},{key:"scene",get:function(){return this._scene}},{key:"glenv",get:function(){return this._glenv}},{key:"globe",get:function(){return this._globe}},{key:"tile_texture_cache",get:function(){return this._tile_texture_cache}}]),e}()),R={SURFACE:{id:"SURFACE"},WIREFRAME:{id:"WIREFRAME"}};O.RenderMode=R,t.default=O,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){if(r(this,e),this._ρ=t,this._maps=[],t>=1){var i=this._create_first_map(n);this._maps.push(i);for(var a=i,o=-2;o>=-t;--o){var s=this._create_next_map(o,a);this._maps.push(s),a=s}}}return n(e,[{key:"_create_first_map",value:function(e){for(var t=4,r=1<<this._ρ-1,n=new Float32Array(r*r),i=(2*r+1)*t,a=r,o=0;o<r;++o)for(var s=2*o*i,u=o*a,_=0;_<r;++_){var l=e.getFloat32(s,!0),c=e.getFloat32(s+t,!0),f=e.getFloat32(s+2*t,!0),h=e.getFloat32(s+i,!0),d=e.getFloat32(s+i+t,!0),v=e.getFloat32(s+i+2*t,!0),p=e.getFloat32(s+2*i,!0),m=e.getFloat32(s+2*i+t,!0),y=e.getFloat32(s+2*(i+t),!0);n[u]=(l+2*c+f+2*h+4*d+2*v+p+2*m+y)/16,s+=2*t,u+=1}return n}},{key:"_create_next_map",value:function(e,t){for(var r=1<<this._ρ+e,n=new Float32Array(r*r),i=2*r,a=r,o=0;o<r;++o)for(var s=2*o*i,u=o*a,_=0;_<r;++_){var l=t[s],c=t[s+1],f=t[s+i],h=t[s+i+1];n[u]=(l+c+f+h)/4,s+=2,u+=1}return n}},{key:"sample",value:function(e,t,r){var n=this._maps[this._ρ-e-1],i=1<<e;return n[r*i+t]}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(6),_=n(u),l=r(49),c=n(l),f=r(48),h=n(f),d=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.default,h.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),s(t,[{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=n["diffuse-map"];this.bindTexture2D(t.TEXUNIT_IMAGE,i.handle)}}]),t}(_.default);d.TEXUNIT_IMAGE=0,t.default=d,e.exports=t.default},function(e,t,r){"use strict";
function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(5),_=n(u),l=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._headers={"X-Api-Key":e},r}return o(t,e),s(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{headers:this._headers,signal:i.signal}).then(function(e){return e.arrayBuffer()}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return"https://tiles.mapray.com/dem/"+e+"/"+t+"/"+r+".bin"}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this.clearStats()}return n(e,[{key:"clearStats",value:function(){this.num_wait_reqs_dem=0,this.num_wait_reqs_img=0,this.num_drawing_flakes=0,this.num_drawing_flake_vertices=0,this.num_procA_flakes=0,this.num_procB_flakes=0}},{key:"onUpdate",value:function(){}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=r(33),_=n(u),l=r(34),c=n(l),f=r(28),h=n(f),d=function(){function e(t,r,n,a,o){i(this,e),this._z=t,this._x=r,this._y=n,this._ρ=a;var s=new DataView(o);this._qlevels=[s.getUint8(e.OFFSET_QLEVEL_00),s.getUint8(e.OFFSET_QLEVEL_10),s.getUint8(e.OFFSET_QLEVEL_01),s.getUint8(e.OFFSET_QLEVEL_11)],this._hmin=s.getFloat32(e.OFFSET_HMIN,!0),this._hmax=s.getFloat32(e.OFFSET_HMAX,!0),this._ω=this._createωArray(s),this._body=new DataView(o,e.HEADER_BYTES),this._size=(1<<a)+1}return a(e,[{key:"isLeaf",value:function(e,t,r){if(e>this._z)return 0==this.getQuadLevel(e,t,r);var n=this._qlevels;return 0==n[0]||0==n[1]||0==n[2]||0==n[3]}},{key:"getQuadLevel",value:function(e,t,r){var n=Math.pow(2,this._z-e),i=Math.floor(2*((t+.5)*n-this._x)),a=Math.floor(2*((r+.5)*n-this._y));return this._qlevels[2*a+i]}},{key:"getQuadLevelDirect",value:function(e,t){var r=Math.round(Math.pow(2,this._z+1)),n=s.default.clamp(Math.floor(e*r),0,r-1)%2,i=s.default.clamp(Math.floor(t*r),0,r-1)%2;return this._qlevels[2*i+n]}},{key:"getHeights",value:function(t,r){var n=4,i=n*(r*this._size+t),a=n*this._size,o=e._getHeights_result;return o[0]=this._body.getFloat32(i,!0),o[1]=this._body.getFloat32(i+n,!0),o[2]=this._body.getFloat32(i+a,!0),o[3]=this._body.getFloat32(i+a+n,!0),o}},{key:"getDivisionPowers",value:function(t,r,n,i){var a=t.z,o=this._z,u=s.default.LOG2PI-this._ρ+1,_=this._getComplexity(a,t.x,t.y),l=Math.min(o+this._ρ,Math.round(r+u+_))-a,c=e._getDivisionPowers_result;return c[0]=Math.max(n,l),c[1]=Math.max(i,l),c}},{key:"newSampler",value:function(e){var t=e.z-this._z>this._ρ?_.default:c.default;return new t(this._z,this._x,this._y,this._ρ,this._body)}},{key:"newAvgHeightMaps",value:function(){return new h.default(this._ρ,this._body)}},{key:"_createωArray",value:function(t){for(var r=4,n=[],i=0,a=0;a<3;++a){for(var o=1<<2*a,s=new Float32Array(o),u=0;u<o;++u)s[u]=t.getFloat32(e.OFFSET_ω+i,!0),i+=r;n.push(s)}return n}},{key:"_getComplexity",value:function(t,r,n){var i,a,o=t-this._z,s=Math.round(Math.pow(2,o)),u=2,_=4;o<=u?(i=r-s*this._x,a=n-s*this._y):(i=Math.floor(_*((r+.5)/s-this._x)),a=Math.floor(_*((n+.5)/s-this._y)));var l=Math.min(o,u),c=this._ω[l];return Math.min(c[a*(1<<l)+i],e.ω_limit)}},{key:"z",get:function(){return this._z}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"height_min",get:function(){return this._hmin}},{key:"height_max",get:function(){return this._hmax}}]),e}();d.OFFSET_QLEVEL_00=0,d.OFFSET_QLEVEL_10=1,d.OFFSET_QLEVEL_01=2,d.OFFSET_QLEVEL_11=3,d.OFFSET_HMIN=4,d.OFFSET_HMAX=8,d.OFFSET_ω=12,d.HEADER_BYTES=96,d.ω_limit=6,d._getHeights_result=new Array(4),d._getDivisionPowers_result=new Array(2),t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(11),_=n(u),l=r(1),c=n(l),f=function(e){function t(e,r,n,o,s){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,s))}return o(t,e),s(t,[{key:"sample",value:function(e,t){var r=this._sx*e+this._ox,n=Math.floor(r),i=n+1,a=this._sy*t+this._oy,o=Math.floor(a),s=o+1,u=this._sampleInt(n,o),_=this._sampleInt(i,o),l=this._sampleInt(n,s),c=this._sampleInt(i,s),f=r-n,h=a-o;return(u*(1-f)+_*f)*(1-h)+(l*(1-f)+c*f)*h}},{key:"_sampleInt",value:function(e,t){var r=4,n=c.default.clamp(e,0,this._max),i=c.default.clamp(t,0,this._max),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(11),_=n(u),l=function(e){function t(e,r,n,o,s){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,s))}return o(t,e),s(t,[{key:"sample",value:function(e,t){var r=4,n=Math.round(this._sx*e+this._ox),i=Math.round(this._sy*t+this._oy),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(2),_=n(u),l=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),s(t,[{key:"requestTile",value:function(e,t,r,n){return this}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return 4096}},{key:"getZoomLevelRange",value:function(){return new _.default.Range(0,0)}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=r(41),_=n(u),l=function(){function e(t){i(this,e),this._setupViewVectors(t),this._setupClipPlanes(t);var r=t._viewer,n=r.dem_provider,a=r.tile_texture_cache;this._min_image_z=a.getImageZMin();var o=s.default.LOG2PI-n.getResolutionPower()+1;this._max_zbias=Math.max(a.getImageZBias(),o),this._globe=r.globe,this._rflake_list=[],this._debug_stats=r.debug_stats,this._debug_stats&&(this._num_procA_flakes=0,this._num_procB_flakes=0),this._view_dir_N=s.default.createVector3(),this._view_dir_V=s.default.createVector3()}return a(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=s.default.createVector3(),i=s.default.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view,n=e._volume_planes,i=[],a=e._viewer._globe.root_flake,o=s.default.EARTH_RADIUS+a.height_min,u=s.default.EARTH_RADIUS+a.height_max,_=t[12],l=t[13],c=t[14],f=_*_+l*l+c*c,h=o*o,d=u*u,v=Math.sqrt((f-h)*(d-h))-h,p=s.default.createVector4(),m=1/Math.sqrt(f);p[0]=_*m,p[1]=l*m,p[2]=c*m,p[3]=v*m,i.push(p);for(var y=Math.sqrt(f+d+2*v),g=0;g<6;++g){var b=n[g],w=s.default.createVector4();1==g&&b[3]>y&&(b=s.default.createVector4(b),b[3]=y),s.default.transformPlane_A(r,b,w),i.push(w)}this._clip_planes=i}},{key:"traverse",value:function(){return this._collectFlakes(this._globe.root_flake),this._debug_stats&&(this._debug_stats.num_procA_flakes=this._num_procA_flakes,this._debug_stats.num_procB_flakes=this._num_procB_flakes),this._rflake_list}},{key:"_collectFlakes",value:function(t){if(null!==this._debug_stats&&(this._num_procA_flakes+=1),!t.isInvisible(this._clip_planes)){if(t.z<this._min_image_z)return void this._collectNextLevelFlakes(t);null!==this._debug_stats&&(this._num_procB_flakes+=1);var r=this._getLevelOfDetailRange(t),n=r.mid+this._max_zbias;return r.max-r.min>e.MAX_LOD_INTERVAL||n>t.z?void this._collectNextLevelFlakes(t):void this._addRenderFlake(t,r)}}},{key:"_collectNextLevelFlakes",value:function(e){for(var t=0;t<2;++t)for(var r=0;r<2;++r)this._collectFlakes(e.newChild(r,t))}},{key:"_getLevelOfDetailRange",value:function(e){for(var t=Math.PI,r=e.z,n=e.x,i=e.y,a=Math.pow(2,1-r)*t,o=-t+n*a,u=t-(i+1)*a,_=t/32,l=Math.ceil(a/_),c=a/l,f=s.default.EARTH_RADIUS+e.base_height,h=this._view_pos_Q,d=this._view_dir_wU,v=this._view_dir_N,p=this._view_dir_V,m=Number.MAX_VALUE,y=-Number.MAX_VALUE,g=0,b=u;g<l+1;++g,b+=c)for(var w=Math.exp(b),E=w*w,x=(E-1)/(E+1),k=2*w/(E+1),M=1/(f*k),T=0,A=o;T<l+1;++T,A+=c){var P=Math.sin(A),O=Math.cos(A);v[0]=k*O,v[1]=k*P,v[2]=x,p[0]=f*v[0]-h[0],p[1]=f*v[1]-h[1],p[2]=f*v[2]-h[2];var R=s.default.dot3(d,p);if(R<=0)return{min:-1e3,max:1e3,mid:0};var I=R*M;m=Math.min(m,I),y=Math.max(y,I)}var D=-Math.maprayLog2(y),F=-Math.maprayLog2(m);return{min:D,max:F,mid:(D+F)/2}}},{key:"_calcLOD",value:function(e,t){var r=Math.sin(e),n=Math.cos(e),i=Math.exp(t),a=i*i,o=(a-1)/(a+1),u=2*i/(a+1),_=s.default.EARTH_RADIUS,l=this._view_dir_N;l[0]=u*n,l[1]=u*r,l[2]=o;var c=this._view_dir_V,f=this._view_pos_Q;c[0]=_*l[0]-f[0],c[1]=_*l[1]-f[1],c[2]=_*l[2]-f[2];var h=this._view_dir_wU,d=s.default.dot3(h,c),v=_*u/d;return Math.maprayLog2(v)}},{key:"_setCornerLODs",value:function(e){var t=Math.PI,r=e.flake,n=r.z,i=r.x,a=r.y,o=Math.pow(2,1-n)*t,s=-t+i*o,u=-t+(i+1)*o,_=t-(a+1)*o,l=t-a*o;e.lod_00=this._calcLOD(s,_),e.lod_10=this._calcLOD(u,_),e.lod_01=this._calcLOD(s,l),e.lod_11=this._calcLOD(u,l)}},{key:"_addRenderFlake",value:function(e,t){var r=new _.default(e);r.lod=t.mid,this._setCornerLODs(r),this._rflake_list.push(r)}}]),e}();l.MAX_LOD_INTERVAL=.5,t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=function(){function e(t,r,n,a){i(this,e);var o=t.context;this._center=this._createCenter(r),this._vertices=null,this._num_vertices=0,this._num_quads_x=0,this._num_quads_y=0,this._createVertices(o,r,n,a),this._index_type=this._num_vertices<65536?o.UNSIGNED_SHORT:o.UNSIGNED_INT,this._indices=null,this._num_indices=0,this._wire_indices=null,this._num_wire_indices=0,this._gl=o}return a(e,[{key:"_createCenter",value:function(e){var t=e.z,r=e.x,n=e.y,i=s.default.createVector3();switch(t){case 0:return this._getCenter_0(i);case 1:return this._getCenter_1(r,n,i);default:return this._getCenter_N(t,r,n,i)}}},{key:"_getCenter_0",value:function(e){return e[0]=0,e[1]=0,e[2]=0,e}},{key:"_getCenter_1",value:function(e,t,r){var n=s.default.EARTH_RADIUS;return r[0]=0,r[1]=n*(e-.5),r[2]=n*(.5-t),r}},{key:"_getCenter_N",value:function(e,t,r,n){var i=Math.PI,a=Math.pow(2,1-e)*i,o=-i+t*a,u=-i+(t+1)*a,_=i-(r+1)*a,l=i-r*a,c=o,f=u,h=Math.exp(_),d=Math.exp(l),v=h*h,p=d*d,m=s.default.EARTH_RADIUS/2,y=2*h/(v+1),g=2*d/(p+1);return _+l<0?c+f<-i?(n[0]=m*(g*Math.cos(c)+y*Math.cos(f)),n[1]=m*(g*Math.sin(f)+y*Math.sin(c))):c+f<0?(n[0]=m*(y*Math.cos(c)+g*Math.cos(f)),n[1]=m*(g*Math.sin(c)+y*Math.sin(f))):c+f<i?(n[0]=m*(y*Math.cos(f)+g*Math.cos(c)),n[1]=m*(y*Math.sin(c)+g*Math.sin(f))):(n[0]=m*(g*Math.cos(f)+y*Math.cos(c)),n[1]=m*(y*Math.sin(f)+g*Math.sin(c))):c+f<-i?(n[0]=m*(y*Math.cos(c)+g*Math.cos(f)),n[1]=m*(y*Math.sin(f)+g*Math.sin(c))):c+f<0?(n[0]=m*(g*Math.cos(c)+y*Math.cos(f)),n[1]=m*(y*Math.sin(c)+g*Math.sin(f))):c+f<i?(n[0]=m*(g*Math.cos(f)+y*Math.cos(c)),n[1]=m*(g*Math.sin(c)+y*Math.sin(f))):(n[0]=m*(y*Math.cos(f)+g*Math.cos(c)),n[1]=m*(g*Math.sin(f)+y*Math.sin(c))),n[2]=2*m*(p/(p+1)-1/(v+1)),n}},{key:"_createVertices",value:function(e,t,r,n){var i=e.ARRAY_BUFFER,a=e.createBuffer(),o=this._createVerticesData(t,r,n);e.bindBuffer(i,a),e.bufferData(i,o.array,e.STATIC_DRAW),e.bindBuffer(i,null),this._vertices=a,this._num_vertices=o.num_vertices,this._num_quads_x=o.num_quads_x,this._num_quads_y=o.num_quads_y}},{key:"_createVerticesData",value:function(t,r,n){for(var i=Math.pow(2,1-t.z)*Math.PI,a=t.x*i-Math.PI,o=Math.PI-(t.y+1)*i,u=1<<r[0],_=1<<r[1],l=1/u,c=1/_,f=i/u,h=i/_,d=this._center,v=n.newSampler(t),p=(u+1)*(_+1),m=new Float32Array(e.VERTEX_SIZE*p),y=0,g=0,b=o;g<_+1;++g,b+=h)for(var w=Math.exp(b),E=w*w,x=(E-1)/(E+1),k=2*w/(E+1),M=0,T=a;M<u+1;++M,T+=f){var A=Math.sin(T),P=Math.cos(T),O=v.sample(T,b),R=s.default.EARTH_RADIUS+O,I=k*P,D=k*A,F=x,L=R*I,N=R*D,j=R*F;m[y++]=L-d[0],m[y++]=N-d[1],m[y++]=j-d[2],m[y++]=I,m[y++]=D,m[y++]=F,m[y++]=M*l,m[y++]=g*c}return{array:m,num_vertices:p,num_quads_x:u,num_quads_y:_}}},{key:"_createIndices",value:function(){for(var e=this._gl,t=this._num_quads_x*this._num_quads_y,r=6*t,n=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,i=new n(r),a=0,o=0;o<this._num_quads_y;++o)for(var s=0;s<this._num_quads_x;++s){var u=(this._num_quads_x+1)*o+s,_=u+1,l=u+this._num_quads_x+1,c=l+1;i[a++]=u,i[a++]=_,i[a++]=l,i[a++]=l,i[a++]=_,i[a++]=c}var f=e.ELEMENT_ARRAY_BUFFER,h=e.createBuffer();e.bindBuffer(f,h),e.bufferData(f,i,e.STATIC_DRAW),e.bindBuffer(f,null),this._indices=h,this._num_indices=r}},{key:"_createWireIndices",value:function(){for(var e=this._gl,t=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,r=2*(2*this._num_quads_x*this._num_quads_y+this._num_quads_x+this._num_quads_y),n=new t(r),i=0,a=0;a<this._num_quads_y+1;++a)for(var o=0;o<this._num_quads_x;++o){var s=(this._num_quads_x+1)*a+o,u=s+1;n[i++]=s,n[i++]=u}for(o=0;o<this._num_quads_x+1;++o)for(a=0;a<this._num_quads_y;++a){var _=(this._num_quads_x+1)*a+o,l=_+this._num_quads_x+1;n[i++]=_,n[i++]=l}var c=e.ELEMENT_ARRAY_BUFFER,f=e.createBuffer();e.bindBuffer(c,f),e.bufferData(c,n,e.STATIC_DRAW),e.bindBuffer(c,null),this._wire_indices=f,this._num_wire_indices=r}},{key:"dispose",value:function(){var e=this._gl;e.deleteBuffer(this._vertices),this._vertices=null,this._indices&&(e.deleteBuffer(this._indices),this._indices=null),this._wire_indices&&(e.deleteBuffer(this._wire_indices),this._wire_indices=null)}},{key:"mul_flake_to_gocs",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],_=e[13],l=e[2],c=e[6],f=e[10],h=e[14],d=e[3],v=e[7],p=e[11],m=e[15],y=this._center[0],g=this._center[1],b=this._center[2];return t[0]=r,t[1]=o,t[2]=l,t[3]=d,t[4]=n,t[5]=s,t[6]=c,t[7]=v,t[8]=i,t[9]=u,t[10]=f,t[11]=p,t[12]=r*y+n*g+i*b+a,t[13]=o*y+s*g+u*b+_,t[14]=l*y+c*g+f*b+h,t[15]=d*y+v*g+p*b+m,t}},{key:"draw",value:function(t){var r=this._gl,n=e.VERTEX_BYTES,i=t.isWireframe();r.bindBuffer(r.ARRAY_BUFFER,this._vertices),t.bindVertexAttrib("a_position",3,n,e.OFFSET_P),t.bindVertexAttrib("a_normal",3,n,e.OFFSET_N),t.bindVertexAttrib("a_uv",2,n,e.OFFSET_UV),r.bindBuffer(r.ARRAY_BUFFER,null);var a=i?this.wire_indices:this.indices;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a);var o=i?r.LINES:r.TRIANGLES,s=i?this.num_wire_indices:this.num_indices;r.drawElements(o,s,this._index_type,0)}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"indices",get:function(){return null===this._indices&&this._createIndices(),this._indices}},{key:"num_indices",get:function(){return null===this._indices&&this._createIndices(),this._num_indices}},{key:"wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._wire_indices}},{key:"num_wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._num_wire_indices}}]),e}();u.VERTEX_SIZE=8,u.VERTEX_BYTES=4*u.VERTEX_SIZE,u.OFFSET_P=0,u.OFFSET_N=12,u.OFFSET_UV=24,t.default=u,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e);var n={depth:!0,antialias:!0},i=this._getContextWebGL(t,n);if(!i)throw new Error("It doesn't appear your computer can support WebGL.");this._canvas=t,this._context=i,this._setupExtensions(i)}return n(e,[{key:"_getContextWebGL",value:function(e,t){for(var r=["webgl","experimental-webgl"],n=0;n<r.length;++n){var i=e.getContext(r[n],t);if(i)return i}return null}},{key:"_setupExtensions",value:function(e){this.OES_element_index_uint=e.getExtension("OES_element_index_uint"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(6),_=n(u),l=r(1),c=n(l),f=r(51),h=n(f),d=r(50),v=n(d),p=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default))}return o(t,e),s(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties,i=n.opacity||t.DEFAULT_OPACITY;return i<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,i[2]=e._height/e._width,this.setVector3("u_sparam",i);var a=n.width||t.DEFAULT_WIDTH,o=t._thickness;o[0]=a/2,o[1]=a/2,this.setVector2("u_thickness",o);var s=n.color||t.DEFAULT_COLOR,u=n.opacity||t.DEFAULT_OPACITY,_=t._color;c.default.copyVector3(s,_),_[3]=u,this.setVector4("u_color",_)}}]),t}(_.default);p.DEFAULT_WIDTH=1,p.DEFAULT_COLOR=c.default.createVector3f([1,1,1]),p.DEFAULT_OPACITY=1,p._sparam=c.default.createVector3f(),p._thickness=c.default.createVector2f(),p._color=c.default.createVector4f(),t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=r(20),u=n(s),_=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),t}(u.default);t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this.flake=t}return n(e,[{key:"findMesh",value:function(){return this.flake.findMesh(this.lod)}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),s=n(o),u=r(14),_=n(u),l=r(36),c=n(l),f=r(44),h=n(f),d=r(47),v=n(d),p=r(27),m=n(p),y=function(){function e(t){i(this,e),this._viewer=t,this._glenv=t.glenv;var r=t.canvas_element;if(this._width=r.width,this._height=r.height,0===this._width||0===this._height)return void(this._rendering_cancel=!0);var n=t.camera,a=n.createRenderInfo();this._setupBasicMatrices(a,n),this._volume_planes=a.volume_planes,this._pixel_step=a.pixel_step,this._scene=t.scene,this._globe=t.globe,this._tile_texture_cache=t.tile_texture_cache,t._render_cache||(t._render_cache={surface_material:new h.default(t),wireframe_material:new v.default(t)}),this._flake_material=t.render_mode===m.default.RenderMode.WIREFRAME?t._render_cache.wireframe_material:t._render_cache.surface_material,this._debug_stats=t.debug_stats}return a(e,[{key:"_setupBasicMatrices",value:function(e,t){this._view_to_gocs=t.view_to_gocs,this._gocs_to_view=s.default.createMatrix(),s.default.inverse_A(this._view_to_gocs,this._gocs_to_view),this._view_to_clip=e.view_to_clip,this._gocs_to_clip=s.default.createMatrix(),s.default.mul_PzA(this._view_to_clip,this._gocs_to_view,this._gocs_to_clip)}},{key:"render",value:function(){if(!this._rendering_cancel){var e=this._glenv.context;if(e.viewport(0,0,this._width,this._height),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.depthFunc(e.LEQUAL),this._globe.status===_.default.Status.READY){var t=new c.default(this),r=t.traverse();e.enable(e.BLEND),e.depthMask(!0);for(var n=0;n<r.length;++n)this._drawFlake(r[n]);var i=this._scene;null!==i&&i.draw(this);var a=this._debug_stats;null!==a&&(a.num_drawing_flakes=r.length),this._globe.endFrame(),this._tile_texture_cache.endFrame(),this._viewer.layers.endFrame()}}}},{key:"_drawFlake",value:function(e){for(var t=e.findMesh(),r=this._flake_material,n=r.numDrawings(),i=0;i<n;++i)r.bindProgram(),r.setFlakeParameter(this,e,t,i)&&t.draw(r);var a=this._debug_stats;null!==a&&(a.num_drawing_flake_vertices+=t.num_vertices)}}]),e}();t.default=y,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t;try{this.vs_object=this._compile_shader("VERTEX_SHADER",n),this.fs_object=this._compile_shader("FRAGMENT_SHADER",i)}catch(e){var a=t.context;throw this.vs_object&&a.deleteShader(this.vs_object),this.fs_object&&a.deleteShader(this.fs_object),e}}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;this.vs_object&&(e.deleteShader(this.vs_object),this.vs_object=null),this.fs_object&&(e.deleteShader(this.fs_object),this.fs_object=null)}},{key:"_compile_shader",value:function(e,t){var r=this._glenv.context,n=r.createShader(r[e]);if(!n)throw new Error(e+" オブジェクトの生成に失敗しました");try{if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw new Error(e+" のコンパイルに失敗: "+i)}}catch(e){throw r.deleteShader(n),e}return n}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(12),_=n(u),l=r(1),c=(n(l),r(9)),f=(n(c),r(53)),h=n(f),d=r(52),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image_hi",t.TEXUNIT_IMAGE_HI),r.setInteger("u_image_lo",t.TEXUNIT_IMAGE_LO),r._tile_texture_cache=e.tile_texture_cache,r._layers=e.layers,r._dummy_tile_texture=r._createDummyTileTexture(e.glenv),r._image_zbias=0,r}return o(t,e),s(t,[{key:"numDrawings",value:function(){return 1+this._layers.numDrawingLayers()}},{key:"setFlakeParameter",value:function(e,r,n,i){this.setCommonParameter(e,n);var a=this._getMaterialParamater(r,i);return null!==a&&(this.setVector4("u_corner_lod",a.corner_lod),this.setVector4("u_texcoord_rect_hi",a.image_hi.texcoord_rect),this.setVector4("u_texcoord_rect_lo",a.image_lo.texcoord_rect),this.setVector2("u_image_param",[a.image_lo.lod,a.image_hi.lod==a.image_lo.lod?0:1/(a.image_hi.lod-a.image_lo.lod)]),this.setFloat("u_opacity",0==i?1:this._layers.getDrawingLayer(i-1).opacity),this.bindTexture2D(t.TEXUNIT_IMAGE_HI,a.image_hi.texture),this.bindTexture2D(t.TEXUNIT_IMAGE_LO,a.image_lo.texture),!0)}},{key:"_getMaterialParamater",value:function(e,t){var r=0==t?this._tile_texture_cache:this._layers.getDrawingLayer(t-1).tile_cache;this._image_zbias=r.getImageZBias();var n=e.flake,i=n.z;if(i<r.getImageZMin())return null;var a=n.x,o=n.y,s=Math.ceil(e.lod+this._image_zbias);if(i<s)return null;var u=r.findNearestAncestors(i,a,o,s);return t>=1&&null===u[0]?null:{corner_lod:[e.lod_00,e.lod_10,e.lod_01,e.lod_11],image_hi:this._getImageParamater(u[0],i,a,o,s),image_lo:this._getImageParamater(u[1],i,a,o,s-1)}}},{key:"_getImageParamater",value:function(e,t,r,n,i){var a;return null!==e?(a=Math.pow(2,e.z-t),{lod:e.z-this._image_zbias,texture:e.texture,texcoord_rect:[r*a-e.x,1-(n+1)*a+e.y,a,a]}):(a=Math.pow(2,-t),{lod:-this._image_zbias,texture:this._dummy_tile_texture,texcoord_rect:[r*a-Math.floor(a*(r+.5)),1-(n+1)*a+Math.floor(a*(n+.5)),a,a]})}},{key:"_createDummyTileTexture",value:function(e){var t=e.context,r=t.TEXTURE_2D,n=t.createTexture(),i=[128,128,128,255];return t.bindTexture(r,n),t.texImage2D(r,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(i)),t.bindTexture(r,null),n}}]),t}(_.default);p.TEXUNIT_IMAGE_HI=0,p.TEXUNIT_IMAGE_LO=1,t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){
if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(6),_=n(u),l=r(1),c=n(l),f=r(55),h=n(f),d=r(54),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),s(t,[{key:"isTranslucent",value:function(e,t){return!0}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(_.default);p.TEXUNIT_IMAGE=0,p._sparam=c.default.createVector2f(),t.default=p,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a){r(this,e),this.z=t,this.x=n,this.y=i,this.texture=a}return n(e,[{key:"dispose",value:function(e){e.deleteTexture(this.texture),this.texture=null}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(12),_=n(u),l=r(57),c=n(l),f=r(56),h=n(f),d=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.default,h.default))}return o(t,e),s(t,[{key:"isWireframe",value:function(){return!0}},{key:"setFlakeParameter",value:function(e,t,r,n){return this.setCommonParameter(e,r),!0}}]),t}(_.default);t.default=d,e.exports=t.default},function(e,t){e.exports="precision mediump float;\n\nvarying vec2  v_texcoord;    // テクスチャ座標\n\nuniform sampler2D u_image;   // テクスチャ画像\n\nvoid main()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}\n"},function(e,t){e.exports="attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\n\nvarying vec2  v_texcoord;     // テクスチャ座標\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_texcoord  = a_texcoord;\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nuniform vec4 u_color;  // 線の基本色と不透明度\n\nvoid\nmain()\n{\n    gl_FragColor = vec4( u_color.xyz * u_color.w, u_color.w );\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分の頂点シェーダ\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec3 a_direction;   // 線分方向 (モデル座標系) = 終点位置 - 始点位置\nattribute vec2 a_where;       // 線分の4隅指定: 始点左: {-1, 1}, 始点右: {-1, -1}, 終点左: {1, 1}, 終点右: {1, -1}\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec3 u_sparam;        // 画面パラメータ: {2/w, 2/h, h/w}\nuniform vec2 u_thickness;     // 線の太さの半分: {u, v}\n\nvec2\noffset( vec4 cpos )\n{\n    vec4 q0 = cpos;\n    q0.y *= u_sparam.z;  // q0 = A * q0\n    vec4 q1 = cpos + u_obj_to_clip * vec4( a_direction, 0 );\n    q1.y *= u_sparam.z;  // q1 = A * q1\n\n    vec2 ds = normalize( q1.xy / q1.w - q0.xy / q0.w );\n    vec2 wt = a_where * u_thickness;\n    return mat2( ds.x, ds.y, -ds.y, ds.x ) * wt;\n}\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += offset( gl_Position ) * u_sparam.xy * gl_Position.w;\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2  v_texcoord_hi;    // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;    // 低レベル画像のテクスチャ座標\nvarying float v_lod;            // 補間された LOD\n\nuniform sampler2D u_image_hi;   // 高レベル画像\nuniform sampler2D u_image_lo;   // 低レベル画像\nuniform float     u_opacity;    // 不透明度\n\n/** 画像パラメータ\n *\n *  x = u_image_lo の LOD\n *  y = 1 / (u_image_hi の LOD - x)\n *\n *  ただし u_image_hi と u_image_lo が同じ画像のときは y = 0\n */\nuniform vec2 u_image_param;\n\n\nvoid main()\n{\n    vec4 color_hi = texture2D( u_image_hi, v_texcoord_hi );\n    vec4 color_lo = texture2D( u_image_lo, v_texcoord_lo );\n\n    // 画像の混合率\n    float lo_lod = u_image_param.x;\n    float  delta = u_image_param.y;\n    float  ratio = clamp( (v_lod - lo_lod) * delta, 0.0, 1.0 );\n\n    gl_FragColor = mix( color_lo, color_hi, ratio );\n    gl_FragColor.a *= u_opacity;  // 不透明度を適用\n}\n"},function(e,t){e.exports="attribute vec4 a_position;         // 位置 (地表断片座標系)\nattribute vec2 a_uv;               // uv 座標\n\nuniform mat4  u_obj_to_clip;       // 地表断片座標系からクリップ座標系への変換\n\nuniform vec4  u_texcoord_rect_hi;  // 高レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_texcoord_rect_lo;  // 低レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_corner_lod;        // uv = (0,0), (1,0), (0,1), (1,1) の LOD\n\nvarying vec2  v_texcoord_hi;       // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;       // 低レベル画像のテクスチャ座標\nvarying float v_lod;               // 補間された LOD\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    // uv 座標をテクスチャ座標に変換\n    v_texcoord_hi = u_texcoord_rect_hi.xy + u_texcoord_rect_hi.zw * a_uv;\n    v_texcoord_lo = u_texcoord_rect_lo.xy + u_texcoord_rect_lo.zw * a_uv;\n\n    // LOD の補間\n    float u = a_uv.x;\n    float v = a_uv.y;\n\n    float lod_00 = u_corner_lod.x;  // uv = (0,0) の LOD\n    float lod_10 = u_corner_lod.y;  // uv = (1,0) の LOD\n    float lod_01 = u_corner_lod.z;  // uv = (0,1) の LOD\n    float lod_11 = u_corner_lod.w;  // uv = (1,1) の LOD\n\n    float lod_u0 = mix( lod_00, lod_10, u );  // uv = (u, 0) の LOD\n    float lod_u1 = mix( lod_01, lod_11, u );  // uv = (u, 1) の LOD\n    float lod_uv = mix( lod_u0, lod_u1, v );  // uv = (u, v) の LOD\n\n    v_lod = lod_uv;\n}\n"},function(e,t){e.exports="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;     // テキストのテクスチャ座標\nvarying vec4 v_color;        // テキストの色と不透明度\n\nuniform sampler2D u_image;   // テキスト画像\n\nvoid\nmain()\n{\n    float level = texture2D( u_image, v_texcoord ).w;  // 輝度\n    float alpha = v_color.w * level;\n    gl_FragColor = vec4( v_color.xyz * alpha, alpha );\n}\n"},function(e,t){e.exports="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\nattribute vec4 a_color;       // テキストの色と不透明度\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\nvarying vec4 v_color;         // テキストの色と不透明度\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_color    = a_color;\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    vec4 color = (v_uv.x < 0.005 || v_uv.y < 0.005 || v_uv.x > 0.995 || v_uv.y > 0.995) ?\n                 vec4( 1, 1, 0, 1 ) : vec4( 0.5, 0.5, 0.5, 1 );\n    gl_FragColor = color;\n}\n"},function(e,t){e.exports="attribute vec4 a_position;\nattribute vec2 a_uv;\n\nuniform mat4 u_obj_to_clip;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_uv  = a_uv;\n}\n"}])});