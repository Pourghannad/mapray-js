!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("maprayui",[],t):"object"==typeof exports?exports.maprayui=t():e.maprayui=t()}(this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var i=a[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t,a){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i=a(1),o=r(i),_={StandardUIViewer:o.default};t.default=_,e.exports=t.default},function(e,t){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_=mapray.GeoMath,n=mapray.GeoPoint,s=function(e){function t(e,i,o){a(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.createViewer(e,i,o),n._camera_parameter={latitude:0,longitude:0,height:0,pitch:0,yaw:0,fov:0,near:0,far:0},n._initCameraParameter(o),n._operation_mode=t.OperationMode.NONE,n._mouse_down_position=_.createVector2f(),n._pre_mouse_position=_.createVector2f(),n._rotate_center=_.createVector3(),n._translate_drag=_.createVector2f(),n._rotate_drag=_.createVector2f(),n._free_rotate_drag=_.createVector2f(),n._height_drag=_.createVector2f(),n._zoom_wheel=0,n._fovy_key=0,n._default_fov=t.DEFAULT_CAMERA_PARAMETER.fov,n._key_mode=!1,n}return i(t,e),o(t,[{key:"createViewer",value:function(e,t,a){this._viewer&&this.destroy(),this._viewer=new mapray.Viewer(e,{dem_provider:this._createDemProvider(t,a),image_provider:this._createImageProvider(a),layers:a&&a.layers||null,render_callback:this,render_mode:a&&a.render_mode||mapray.Viewer.RenderMode.SURFACE,debug_stats:a&&a.debug_stats||null,attribution_controller:a&&a.attribution_controller||null});var r=this._viewer._canvas_element;r.setAttribute("oncontextmenu","return false;"),this._addEventListener()}},{key:"destroy",value:function(){this._viewer&&(this._removeEventListener(),this._viewer.destroy(),this._viewer=null)}},{key:"_createDemProvider",value:function(e,t){return t&&t.dem_provider||new mapray.CloudDemProvider(e)}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider||new mapray.StandardImageProvider("https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/",".jpg",256,2,18)}},{key:"_initCameraParameter",value:function(e){var a=e&&e.camera_position||t.DEFAULT_CAMERA_POSITION,r=e&&e.lookat_position||t.DEFAULT_LOOKAT_POSITION,i=e&&e.camera_parameter||t.DEFAULT_CAMERA_PARAMETER;this.setCameraPosition(a),this.setLookAtPosition(r),this.setCameraParameter(i),this._updateViewerCamera()}},{key:"_addEventListener",value:function(){var e=this._viewer._canvas_element,t=this;window.addEventListener("blur",function(e){t._onBlur(e)},{passive:!1}),e.addEventListener("mousedown",function(e){t._onMouseDown(e)},{passive:!1}),document.addEventListener("mousemove",function(e){t._onMouseMove(e)},{passive:!1}),document.addEventListener("mouseup",function(e){t._onMouseUp(e)},{passive:!1}),document.addEventListener("wheel",function(e){t._onMouseWheel(e)},{passive:!1}),document.addEventListener("keydown",function(e){t._onKeyDown(e)},{passive:!1}),document.addEventListener("keyup",function(e){t._onKeyUp(e)},{passive:!1})}},{key:"_removeEventListener",value:function(){var e=this._viewer._canvas_element,t=this;window.removeEventListener("blur",function(e){t._onBlur(e)},{passive:!1}),e.removeEventListener("mousedown",function(e){t._onMouseDown(e)},{passive:!1}),document.removeEventListener("mousemove",function(e){t._onMouseMove(e)},{passive:!1}),document.removeEventListener("mouseup",function(e){t._onMouseUp(e)},{passive:!1}),document.removeEventListener("wheel",function(e){t._onMouseWheel(e)},{passive:!1}),document.removeEventListener("keydown",function(e){t._onKeyDown(e)},{passive:!1}),document.removeEventListener("keyup",function(e){t._onKeyUp(e)},{passive:!1})}},{key:"onStart",value:function(){}},{key:"onStop",value:function(){}},{key:"onUpdateFrame",value:function(e){this._translation(e),this._rotation(),this._freeRotation(e),this._translationOfHeight(),this._translationOfEyeDirection(),this._changeFovy(),this._correctAltitude(),this._updateClipPlane(),this._updateViewerCamera()}},{key:"_updateViewerCamera",value:function(){var e=this._viewer.camera,t=new n(this._camera_parameter.longitude,this._camera_parameter.latitude,this._camera_parameter.height),a=t.getMlocsToGocsMatrix(_.createMatrix()),r=_.rotation_matrix([1,0,0],this._camera_parameter.pitch,_.createMatrix()),i=_.rotation_matrix([0,0,1],this._camera_parameter.yaw,_.createMatrix()),o=_.mul_AA(i,r,_.createMatrix());e.view_to_gocs=_.mul_AA(a,o,_.createMatrix()),e.fov=this._camera_parameter.fov,e.near=this._camera_parameter.near,e.far=this._camera_parameter.far}},{key:"_updateClipPlane",value:function(){var e=this._viewer.getElevation(this._camera_parameter.latitude,this._camera_parameter.longitude),a=Math.max(this._camera_parameter.height-e,t.MINIMUM_HEIGHT);this._camera_parameter.near=Math.max(a*t.NEAR_FACTOR,t.MINIMUM_NEAR),this._camera_parameter.far=Math.max(this._camera_parameter.near*t.FAR_FACTOR,t.MINIMUM_FAR)}},{key:"_correctAltitude",value:function(){var e=this._viewer.getElevation(this._camera_parameter.latitude,this._camera_parameter.longitude);this._camera_parameter.height=Math.max(this._camera_parameter.height,e+t.MINIMUM_HEIGHT)}},{key:"_onBlur",value:function(e){e.preventDefault(),this._resetEventParameter()}},{key:"_onMouseDown",value:function(e){e.preventDefault();var a=[e.clientX,e.clientY];if(this._mouse_down_position=a,this._pre_mouse_position=a,0==e.button)if(e.shiftKey){this._operation_mode=t.OperationMode.ROTATE;var r=this._viewer.camera,i=r.getCanvasRay(this._mouse_down_position);this._rotate_center=this._viewer.getRayIntersection(i)}else e.ctrlKey?this._operation_mode=t.OperationMode.FREE_ROTATE:this._operation_mode=t.OperationMode.TRANSLATE;else if(1==e.button){this._operation_mode=t.OperationMode.ROTATE;var r=this._viewer.camera,i=r.getCanvasRay(this._mouse_down_position);this._rotate_center=this._viewer.getRayIntersection(i)}else 2==e.button&&(this._operation_mode=t.OperationMode.HEIGHT_TRANSLATE)}},{key:"_onMouseMove",value:function(e){e.preventDefault();var a=[e.clientX,e.clientY];this._operation_mode==t.OperationMode.TRANSLATE?(this._translate_drag[0]+=a[0]-this._pre_mouse_position[0],this._translate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==t.OperationMode.ROTATE?(this._rotate_drag[0]+=a[0]-this._pre_mouse_position[0],this._rotate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==t.OperationMode.FREE_ROTATE?(this._free_rotate_drag[0]+=a[0]-this._pre_mouse_position[0],this._free_rotate_drag[1]+=a[1]-this._pre_mouse_position[1]):this._operation_mode==t.OperationMode.HEIGHT_TRANSLATE&&(this._translate_drag[0]+=a[0]-this._pre_mouse_position[0],this._height_drag[1]+=a[1]-this._pre_mouse_position[1]),this._pre_mouse_position=a}},{key:"_onMouseUp",value:function(e){e.preventDefault(),this._resetEventParameter()}},{key:"_onMouseWheel",value:function(e){e.preventDefault();var t=[e.clientX,e.clientY];this._mouse_down_position=t;var a=0;a=-1*Math.sign(e.deltaY)*Math.ceil(Math.abs(e.deltaY)/100),this._zoom_wheel+=a}},{key:"_onKeyDown",value:function(e){switch(e.preventDefault(),e.key){case"c":case"C":this._operation_mode=t.OperationMode.CHANGE_FOVY,this._fovy_key=1;break;case"z":case"Z":this._operation_mode=t.OperationMode.CHANGE_FOVY,this._fovy_key=-1;break;case"x":case"X":this._camera_parameter.fov=this._default_fov;break;case"ArrowUp":var a=this._viewer.canvas_element,r=[a.width/2,a.height/2];this._mouse_down_position=r,this._translate_drag[1]=100,this._key_mode=!0;break;case"ArrowDown":var a=this._viewer.canvas_element,r=[a.width/2,a.height/2];this._mouse_down_position=r,this._translate_drag[1]=-100,this._key_mode=!0;break;case"ArrowLeft":this._free_rotate_drag[0]=100,this._key_mode=!0;break;case"ArrowRight":this._free_rotate_drag[0]=-100,this._key_mode=!0}}},{key:"_onKeyUp",value:function(e){switch(e.preventDefault(),e.key){case"c":case"C":this._operation_mode=t.OperationMode.NONE,this._fovy_key=0;break;case"z":case"Z":this._operation_mode=t.OperationMode.NONE,this._fovy_key=0;break;case"ArrowUp":this._operation_mode=t.OperationMode.NONE,this._translate_drag[1]=0,this._key_mode=!1;break;case"ArrowDown":this._operation_mode=t.OperationMode.NONE,this._translate_drag[1]=0,this._key_mode=!1;break;case"ArrowLeft":this._operation_mode=t.OperationMode.NONE,this._free_rotate_drag[0]=0,this._key_mode=!1;break;case"ArrowRight":this._operation_mode=t.OperationMode.NONE,this._free_rotate_drag[0]=0,this._key_mode=!1}}},{key:"_resetEventParameter",value:function(){this._translate_drag[0]=0,this._translate_drag[1]=0,this._rotate_drag[0]=0,this._rotate_drag[1]=0,this._free_rotate_drag[0]=0,this._free_rotate_drag[1]=0,this._height_drag[0]=0,this._height_drag[1]=0,this._operation_mode=t.OperationMode.NONE}},{key:"_translation",value:function(e){if(0!=this._translate_drag[0]||0!=this._translate_drag[1]){this._key_mode&&(this._translate_drag[0]*=e,this._translate_drag[1]*=e);var t=this._viewer.camera,a=t.getCanvasRay(this._mouse_down_position),r=this._viewer.getRayIntersection(a),i=[this._mouse_down_position[0]+this._translate_drag[0],this._mouse_down_position[1]+this._translate_drag[1]];a=t.getCanvasRay(i);var o=this._viewer.getRayIntersection(a);if(null==r||null==o)return;var n=new mapray.GeoPoint;n.setFromGocs(r);var s=new mapray.GeoPoint;s.setFromGocs(o);var h=Math.pow(this._getVectorLength(a.direction),2),c=2*_.dot3(a.position,a.direction),u=Math.pow(this._getVectorLength(a.position),2)-Math.pow(n.altitude+_.EARTH_RADIUS,2),m=c*c-4*h*u;if(n.altitude<this._camera_parameter.height&&s.altitude<this._camera_parameter.height&&m>0){var d=(-c+Math.sqrt(m))/2*h,p=(-c-Math.sqrt(m))/2*h,l=Math.min(d,p);o[0]=a.position[0]+l*a.direction[0],o[1]=a.position[1]+l*a.direction[1],o[2]=a.position[2]+l*a.direction[2],s.setFromGocs(o)}var v=s.latitude-n.latitude,f=s.longitude-n.longitude;this._camera_parameter.latitude-=v,this._camera_parameter.longitude-=f,this._translate_drag[0]=0,this._translate_drag[1]=0,this._mouse_down_position=this._pre_mouse_position}}},{key:"_rotation",value:function(){if(0!=this._rotate_drag[0]||0!=this._rotate_drag[1]){if(null==this._rotate_center)return this._rotate_drag[0]=0,void(this._rotate_drag[1]=0);var e=this._viewer.camera,t=_.createVector3();t[0]=e.view_to_gocs[12]-this._rotate_center[0],t[1]=e.view_to_gocs[13]-this._rotate_center[1],t[2]=e.view_to_gocs[14]-this._rotate_center[2];var a=new mapray.GeoPoint;a.setFromGocs(this._rotate_center);var r=a.getMlocsToGocsMatrix(_.createMatrix()),i=_.createVector3();i[0]=r[8],i[1]=r[9],i[2]=r[10],i=_.normalize3(i,_.createVector3());var o=-this._rotate_drag[0]/10,n=-this._rotate_drag[1]/10,s=this._rotateVector(t,i,o),h=_.clamp(this._camera_parameter.pitch+n,0,90);h!=this._camera_parameter.pitch&&(i[0]=e.view_to_gocs[0],i[1]=e.view_to_gocs[1],i[2]=e.view_to_gocs[2],s=this._rotateVector(s,i,n));var c=_.createVector3();c[0]=this._rotate_center[0]+s[0],c[1]=this._rotate_center[1]+s[1],c[2]=this._rotate_center[2]+s[2];var u=new mapray.GeoPoint;u.setFromGocs(c),this._camera_parameter.latitude=u.latitude,this._camera_parameter.longitude=u.longitude,this._camera_parameter.height=u.altitude,this._camera_parameter.yaw+=o,this._camera_parameter.pitch=h,this._rotate_drag[0]=0,this._rotate_drag[1]=0}}},{key:"_freeRotation",value:function(e){if(0!=this._free_rotate_drag[0]||0!=this._free_rotate_drag[1]){this._key_mode&&(this._free_rotate_drag[0]*=e,this._free_rotate_drag[1]*=e);var t=this._free_rotate_drag[0]/10,a=this._free_rotate_drag[1]/10,r=_.clamp(this._camera_parameter.pitch+a,0,90);this._camera_parameter.yaw+=t,this._camera_parameter.pitch=r,this._free_rotate_drag[0]=0,this._free_rotate_drag[1]=0}}},{key:"_translationOfHeight",value:function(){if(0!=this._height_drag[0]||0!=this._height_drag[1]){var e=this._height_drag[1],t=_.gudermannian((this._camera_parameter.height-5e4)/1e4)+Math.PI/2,a=100*e*t;this._camera_parameter.height+=a,this._height_drag[0]=0,this._height_drag[1]=0}}},{key:"_translationOfEyeDirection",value:function(){if(0!=this._zoom_wheel){var e=this._viewer.camera,t=e.getCanvasRay(this._mouse_down_position),a=this._viewer.getRayIntersection(t);if(null==a)return void(this._zoom_wheel=0);var r=new mapray.GeoPoint;r.setFromGocs(a);var i=1;if(this._camera_parameter.height>3e4)i=Math.abs(this._camera_parameter.height-r.altitude)/3e4;else{var o=3/Math.pow(r.altitude/1e3-30,2),n=this._camera_parameter.height/1e3-30,s=o*Math.pow(n,2)*n/Math.abs(n);i=_.gudermannian(s)+Math.PI/2}var h=this._zoom_wheel*this._camera_parameter.speed_factor*i,c=_.createVector3();c[0]=a[0]-e.view_to_gocs[12],c[1]=a[1]-e.view_to_gocs[13],c[2]=a[2]-e.view_to_gocs[14];var u=_.createVector3();_.normalize3(c,u);var m=_.createVector3();m[0]=e.view_to_gocs[12]+h*u[0],m[1]=e.view_to_gocs[13]+h*u[1],m[2]=e.view_to_gocs[14]+h*u[2];var d=_.createVector3();if(d[0]=m[0]-e.view_to_gocs[12],d[1]=m[1]-e.view_to_gocs[13],d[2]=m[2]-e.view_to_gocs[14],this._zoom_wheel<0||this._getVectorLength(c)>this._getVectorLength(d)){var p=new mapray.GeoPoint;p.setFromGocs(m),this._camera_parameter.latitude=p.latitude,this._camera_parameter.longitude=p.longitude,this._camera_parameter.height=p.altitude}this._zoom_wheel=0}}},{key:"_changeFovy",value:function(){var e=Math.tan(.5*this._camera_parameter.fov*_.DEGREE),a=2*Math.atan(e*Math.pow(t.FOV_FACTOR,-this._fovy_key)),r=t.FOV_RANGE;this._camera_parameter.fov=_.clamp(a/_.DEGREE,r.min,r.max),this._fovy_key=0}},{key:"setCameraPosition",value:function(e){this._camera_parameter.latitude=e.latitude,this._camera_parameter.longitude=e.longitude,this._camera_parameter.height=e.height,this._camera_parameter.height<t.MINIMUM_HEIGHT&&(this._camera_parameter.height=t.MINIMUM_HEIGHT)}},{key:"setLookAtPosition",value:function(e){var t=new n(this._camera_parameter.longitude,this._camera_parameter.latitude,this._camera_parameter.height),a=t.getMlocsToGocsMatrix(_.createMatrix()),r=_.createVector3();r[0]=a[4],r[1]=a[5],r[2]=a[6];var i=new n(e.longitude,e.latitude,e.height),o=i.getMlocsToGocsMatrix(_.createMatrix()),s=_.createVector3();s[0]=o[12]-a[12],s[1]=o[13]-a[13],s[2]=o[14]-a[14],r=_.normalize3(r,_.createVector3()),s=_.normalize3(s,_.createVector3());var h=_.createVector3();h[0]=a[8],h[1]=a[9],h[2]=a[10];var c=this._calculateAngle(h,r,s);this._camera_parameter.yaw=c;var u=_.createVector3();u[0]=a[8],u[1]=a[9],u[2]=a[10],h[0]=a[0],h[1]=a[1],h[2]=a[2],s[0]=-1*s[0],s[1]=-1*s[1],s[2]=-1*s[2],this._camera_parameter.pitch=_.clamp(Math.abs(this._calculateAngle(h,u,s)),0,90)}},{key:"setCameraParameter",value:function(e){e.fov&&(this._camera_parameter.fov=e.fov,this._default_fov=e.fov),e.near&&(this._camera_parameter.near=e.near),e.far&&(this._camera_parameter.far=e.far),e.speed_factor&&(this._camera_parameter.speed_factor=e.speed_factor)}},{key:"getLayer",value:function(e){return this._viewer.layers.getLayer(e)}},{key:"getLayerNum",value:function(){return this._viewer.layers.num_layers()}},{key:"addLayer",value:function(e){this._viewer.layers.add(e)}},{key:"insertLayer",value:function(e,t){this._viewer.layers.insert(e,t)}},{key:"removeLayer",value:function(e){this._viewer.layers.remove(e)}},{key:"clearLayer",value:function(){this._viewer.layers.clear()}},{key:"getEntity",value:function(e){return this._viewer.scene.getEntity(e)}},{key:"getEntityNum",value:function(){return this._viewer.scene.num_entities()}},{key:"addEntity",value:function(e){this._viewer.scene.addEntity(e)}},{key:"removeEntity",value:function(e){this._viewer.scene.removeEntity(e)}},{key:"clearEntity",value:function(){this._viewer.scene.clearEntity()}},{key:"_getVectorLength",value:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2))}},{key:"_rotateVector",value:function(e,t,a){var r=_.rotation_matrix(t,a,_.createMatrix()),i=_.createVector3();return i[0]=e[0]*r[0]+e[1]*r[4]+e[2]*r[8]+r[12],i[1]=e[0]*r[1]+e[1]*r[5]+e[2]*r[9]+r[13],i[2]=e[0]*r[2]+e[1]*r[6]+e[2]*r[10]+r[14],i}},{key:"_calculateAngle",value:function(e,t,a){for(var r=_.createVector3(),i=_.dot3(e,t),o=0;o<3;o++)r[o]=t[o]-i*e[o];var n=_.createVector3();i=_.dot3(e,a);for(var o=0;o<3;o++)n[o]=a[o]-i*e[o];if(_.normalize3(r,r),_.normalize3(n,n),Math.abs(this._getVectorLength(r)<1e-6)||Math.abs(this._getVectorLength(n)<1e-6))s=0;else{var s=Math.acos(_.clamp(_.dot3(r,n)/(this._getVectorLength(r)*this._getVectorLength(n)),-1,1))/_.DEGREE,h=_.cross3(r,n,_.createVector3());h=_.normalize3(h,_.createVector3()),_.dot3(e,h)<0&&(s*=-1)}return s}},{key:"viewer",get:function(){return this._viewer}}]),t}(mapray.RenderCallback),h={NONE:"NONE",TRANSLATE:"TRANSLATE",ROTATE:"ROTATE",FREE_ROTATE:"FREE_ROTATE",EYE_TRANSLATE:"EYE_TRANSLATE",HEIGHT_TRANSLATE:"HEIGHT_TRANSLATE",CHANGE_FOVY:"CHANGE_FOVY"};s.OperationMode=h,s.DEFAULT_CAMERA_POSITION={latitude:35.475968,longitude:138.573161,height:2e3},s.DEFAULT_LOOKAT_POSITION={latitude:35.360626,longitude:138.727363,height:2e3},s.DEFAULT_CAMERA_PARAMETER={fov:60,near:30,far:5e5,speed_factor:5e3},s.MINIMUM_HEIGHT=15,s.MINIMUM_NEAR=1,s.MINIMUM_FAR=5e5,s.NEAR_FACTOR=.5,s.FAR_FACTOR=1e4,s.FOV_RANGE={min:5,max:120},s.FOV_FACTOR=1.148698354997035,t.default=s,e.exports=t.default}])});