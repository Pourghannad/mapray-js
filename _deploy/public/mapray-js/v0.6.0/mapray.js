!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mapray",[],t):"object"==typeof exports?exports.mapray=t():e.mapray=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0});var a,o=r(29),u=n(o),s=r(12),_=n(s),l=r(1),c=n(l),f=r(22),h=n(f),d=r(3),v=n(d),y=r(17),p=n(y),m=r(18),g=n(m),b=r(9),w=n(b),x=r(26),E=n(x),k=r(37),T=n(k),M=r(2),O=n(M),A=r(23),P=n(A),I=r(27),R=n(I),N=r(24),F=n(N),L=r(4),D=n(L),S=r(15),j=n(S),C=r(19),U=n(C),V=r(28),z=n(V),B=r(25),q=n(B),G=r(38),Y=n(G),X=(a={Viewer:u.default,Camera:_.default,GeoMath:c.default,Ray:h.default,CredentialMode:v.default,Layer:p.default,LayerCollection:g.default,DemProvider:w.default,StandardDemProvider:E.default,CloudDemProvider:T.default,ImageProvider:O.default,RenderCallback:P.default,StandardImageProvider:R.default,Scene:F.default,Entity:D.default,GenericEntity:j.default,MarkerLineEntity:U.default},i(a,"MarkerLineEntity",U.default),i(a,"TextEntity",z.default),i(a,"TextEntity",z.default),i(a,"SceneLoader",q.default),i(a,"SceneLoader",q.default),i(a,"DebugStats",Y.default),a);window.maprayRequestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,window.maprayCancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame;var H=window.performance,Z=H&&(H.now||H.mozNow||H.msNow||H.oNow||H.webkitNow),W=new Date;window.maprayNow=Z?function(){return Z.call(H)}:function(){return W.getTime()},Math.maprayLog2=Math.log2||function(e){return 1.4426950408889634*Math.log(e)},t.default=X,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,null,[{key:"createMatrix",value:function(e){return new Float64Array(e||16)}},{key:"createMatrixf",value:function(e){return new Float32Array(e||16)}},{key:"createVector4",value:function(e){return new Float64Array(e||4)}},{key:"createVector4f",value:function(e){return new Float32Array(e||4)}},{key:"createVector3",value:function(e){return new Float64Array(e||3)}},{key:"createVector3f",value:function(e){return new Float32Array(e||3)}},{key:"createVector2f",value:function(e){return new Float32Array(e||2)}},{key:"copyMatrix",value:function(e,t){for(var r=0;r<16;++r)t[r]=e[r];return t}},{key:"copyVector4",value:function(e,t){for(var r=0;r<4;++r)t[r]=e[r];return t}},{key:"copyVector3",value:function(e,t){for(var r=0;r<3;++r)t[r]=e[r];return t}},{key:"setIdentity",value:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"dot3",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"cross3",value:function(e,t,r){var n=e[1]*t[2]-e[2]*t[1],i=e[2]*t[0]-e[0]*t[2],a=e[0]*t[1]-e[1]*t[0];return r[0]=n,r[1]=i,r[2]=a,r}},{key:"normalize3",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=1/Math.sqrt(r*r+n*n+i*i);return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}},{key:"mul_AA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],u=e[1],s=e[5],_=e[9],l=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=t[0],y=t[4],p=t[8],m=t[12],g=t[1],b=t[5],w=t[9],x=t[13],E=t[2],k=t[6],T=t[10],M=t[14];return r[0]=n*v+i*g+a*E,r[1]=u*v+s*g+_*E,r[2]=c*v+f*g+h*E,r[3]=0,r[4]=n*y+i*b+a*k,r[5]=u*y+s*b+_*k,r[6]=c*y+f*b+h*k,r[7]=0,r[8]=n*p+i*w+a*T,r[9]=u*p+s*w+_*T,r[10]=c*p+f*w+h*T,r[11]=0,r[12]=n*m+i*x+a*M+o,r[13]=u*m+s*x+_*M+l,r[14]=c*m+f*x+h*M+d,r[15]=1,r}},{key:"mul_GA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],u=e[1],s=e[5],_=e[9],l=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=e[3],y=e[7],p=e[11],m=e[15],g=t[0],b=t[4],w=t[8],x=t[12],E=t[1],k=t[5],T=t[9],M=t[13],O=t[2],A=t[6],P=t[10],I=t[14];return r[0]=n*g+i*E+a*O,r[1]=u*g+s*E+_*O,r[2]=c*g+f*E+h*O,r[3]=v*g+y*E+p*O,r[4]=n*b+i*k+a*A,r[5]=u*b+s*k+_*A,r[6]=c*b+f*k+h*A,r[7]=v*b+y*k+p*A,r[8]=n*w+i*T+a*P,r[9]=u*w+s*T+_*P,r[10]=c*w+f*T+h*P,r[11]=v*w+y*T+p*P,r[12]=n*x+i*M+a*I+o,r[13]=u*x+s*M+_*I+l,r[14]=c*x+f*M+h*I+d,r[15]=v*x+y*M+p*I+m,r}},{key:"mul_PzA",value:function(e,t,r){var n=e[0],i=e[8],a=e[12],o=e[5],u=e[9],s=e[13],_=e[10],l=e[14],c=e[11],f=e[15],h=t[0],d=t[4],v=t[8],y=t[12],p=t[1],m=t[5],g=t[9],b=t[13],w=t[2],x=t[6],E=t[10],k=t[14];return r[0]=n*h+i*w,r[1]=o*p+u*w,r[2]=_*w,r[3]=c*w,r[4]=n*d+i*x,r[5]=o*m+u*x,r[6]=_*x,r[7]=c*x,r[8]=n*v+i*E,r[9]=o*g+u*E,r[10]=_*E,r[11]=c*E,r[12]=n*y+i*k+a,r[13]=o*b+u*k+s,r[14]=_*k+l,r[15]=c*k+f,r}},{key:"inverse_A",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],u=e[5],s=e[9],_=e[13],l=e[2],c=e[6],f=e[10],h=e[14],d=u*f-c*s,v=l*s-o*f,y=o*c-l*u,p=c*i-n*f,m=r*f-l*i,g=l*n-r*c,b=n*s-u*i,w=o*i-r*s,x=r*u-o*n,E=-(a*d+_*p+h*b),k=-(a*v+_*m+h*w),T=-(a*y+_*g+h*x),M=1/(r*d+n*v+i*y);return t[0]=d*M,t[1]=v*M,t[2]=y*M,t[3]=0,t[4]=p*M,t[5]=m*M,t[6]=g*M,t[7]=0,t[8]=b*M,t[9]=w*M,t[10]=x*M,t[11]=0,t[12]=E*M,t[13]=k*M,t[14]=T*M,t[15]=1,t}},{key:"transformPlane_A",value:function(e,t,r){var n=e,i=t[0],a=t[1],o=t[2],u=t[3];return r[0]=i*n[0]+a*n[1]+o*n[2],r[1]=i*n[4]+a*n[5]+o*n[6],r[2]=i*n[8]+a*n[9]+o*n[10],r[3]=i*n[12]+a*n[13]+o*n[14]+u,r}},{key:"iscs_to_gocs_matrix",value:function(t,r){var n=t.longitude*e.DEGREE,i=t.latitude*e.DEGREE,a=Math.sin(n),o=Math.cos(n),u=Math.sin(i),s=Math.cos(i),_=e.EARTH_RADIUS+t.height;return r[0]=-a,r[1]=o,r[2]=0,r[3]=0,r[4]=-o*u,r[5]=-a*u,r[6]=s,r[7]=0,r[8]=s*o,r[9]=s*a,r[10]=u,r[11]=0,r[12]=_*s*o,r[13]=_*s*a,r[14]=_*u,r[15]=1,r}},{key:"gocs_to_iscs",value:function(t,r){var n=t[0],i=t[1],a=t[2],o=n*n,u=i*i,s=a*a;return 0!=n||0!=i?(r.latitude=Math.atan(a/Math.sqrt(o+u))/e.DEGREE,r.longitude=Math.atan2(i,n)/e.DEGREE):(a>0?r.latitude=90:a<0?r.latitude=-90:r.latitude=0,r.longitude=0),r.height=Math.sqrt(o+u+s)-e.EARTH_RADIUS,r}},{key:"frustum_matrix",value:function(e,t,r,n,i,a,o){return o[0]=2*i/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/(n-r),o[6]=0,o[7]=0,o[8]=(t+e)/(t-e),o[9]=(n+r)/(n-r),o[10]=(a+i)/(i-a),o[11]=-1,o[12]=0,o[13]=0,o[14]=2*a*i/(i-a),o[15]=0,o}},{key:"lookat_matrix",value:function(t,r,n,i){var a=e._xaxis,o=e._yaxis,u=e._zaxis;return u[0]=t[0]-r[0],u[1]=t[1]-r[1],u[2]=t[2]-r[2],e.normalize3(u,u),e.cross3(n,u,a),e.normalize3(a,a),e.cross3(u,a,o),i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=u[0],i[9]=u[1],i[10]=u[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}},{key:"rotation_matrix",value:function(t,r,n){var i=r*e.DEGREE,a=Math.sin(i),o=Math.cos(i),u=t[0],s=t[1],_=t[2];return n[0]=u*u*(1-o)+o,n[1]=u*s*(1-o)+_*a,n[2]=u*_*(1-o)-s*a,n[3]=0,n[4]=u*s*(1-o)-_*a,n[5]=s*s*(1-o)+o,n[6]=s*_*(1-o)+u*a,n[7]=0,n[8]=u*_*(1-o)+s*a,n[9]=s*_*(1-o)-u*a,n[10]=_*_*(1-o)+o,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}},{key:"kml_model_matrix",value:function(t,r,n,i,a){var o=t*e.DEGREE,u=r*e.DEGREE,s=n*e.DEGREE,_=Math.sin(o),l=Math.cos(o),c=Math.sin(u),f=Math.cos(u),h=Math.sin(s),d=Math.cos(s),v=i[0],y=i[1],p=i[2];return a[0]=v*(_*h*c+l*d),a[1]=v*(l*h*c-_*d),a[2]=v*h*f,a[3]=0,a[4]=y*_*f,a[5]=y*l*f,a[6]=-y*c,a[7]=0,a[8]=p*(_*d*c-l*h),a[9]=p*(l*d*c+_*h),a[10]=p*d*f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}},{key:"gudermannian",value:function(e){return 2*Math.atan(Math.exp(e))-Math.PI/2}},{key:"invGudermannian",value:function(e){return Math.log(Math.tan(e/2+Math.PI/4))}},{key:"clamp",value:function(e,t,r){return Math.min(Math.max(e,t),r)}}]),e}();i.EARTH_RADIUS=6378137,i.DEGREE=.017453292519943295,i.LOG2PI=1.6514961294723187,i._xaxis=i.createVector3(),i._yaxis=i.createVector3(),i._zaxis=i.createVector3(),t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"status",value:function(e){return o.READY}},{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.ImageProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.ImageProvider#cancelRequest() method has not been overridden.")}},{key:"getImageSize",value:function(){throw new Error("mapray.ImageProvider#getImageSize() method has not been overridden.")}},{key:"getZoomLevelRange",value:function(){throw new Error("mapray.ImageProvider#getZoomLevelRange() method has not been overridden.")}}]),e}(),a=function(){function e(t,n){r(this,e),this._min=t,this._max=n}return n(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();i.Range=a;var o={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};i.Status=o,t.default=i,e.exports=t.default},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}};t.default=r,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(t){i(this,e),this.scene=t}return a(e,[{key:"getPrimitives",value:function(e){throw new Error("mapray.Entity#getPrimitives() method has not been overridden.")}},{key:"loadProperties",value:function(e,t,r){for(var n=e.properties||{},i=r||{},a=Object.keys(n),o=0;o<a.length;++o){var u=a[o],s=n[u];"tex-2d"==s.type?i[u]=t[s.ref_texture]:Array.isArray(s)?i[u]=new Float32Array(s):i[u]=s}return i}},{key:"parseTransform",value:function(e){var t=u.default.createMatrix();if(e.matrix)return u.default.copyMatrix(e.matrix,t);var r={longitude:e.cartographic[0],latitude:e.cartographic[1],height:e.cartographic[2]},n=u.default.iscs_to_gocs_matrix(r,u.default.createMatrix()),i=e.heading||0,a=e.tilt||0,o=e.roll||0,s=void 0!==e.scale?e.scale:[1,1,1];return"number"==typeof s&&(s=[s,s,s]),u.default.kml_model_matrix(i,a,o,s,t),u.default.mul_AA(n,t,t)}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(20),_=n(s),l=r(1),c=n(l),f=function(e){function t(e,r,n){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n))}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,t){}},{key:"setObjToClip",value:function(e,r){var n=r.transform,i=t._obj_to_clip;c.default.mul_GA(e._gocs_to_clip,n,i),this.setMatrix("u_obj_to_clip",i)}},{key:"setObjToView",value:function(e,r){var n=r.transform,i=t._obj_to_view;c.default.mul_AA(e._gocs_to_view,n,i),this.setMatrix("u_obj_to_view",i)}}]),t}(_.default);f._obj_to_clip=c.default.createMatrixf(),f._obj_to_view=c.default.createMatrixf(),t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(21),u=n(o),s=function(){function e(t,r){i(this,e),this._glenv=t,this._draw_mode=void 0,this._num_vertices=0,this._attrib_data={},this._index_data=null,r instanceof _?this._initByInitializer(r):r instanceof ArrayBuffer?this._initByInitializer(new h(t,r).initializer):this._initByInitializer(new f(t,r).initializer)}return a(e,[{key:"_initByInitializer",value:function(e){this._draw_mode=this._convertDrawMode(e.draw_mode),this._num_vertices=e.num_vertices;for(var t=e.attribute_data,r=0;r<t.length;++r){var n=t[r];this._attrib_data[n.id]={mesh_buffer:n.buffer,buffer:n.buffer.handle,num_components:n.num_components,component_type:this._convertComponentType(n.component_type),normalized:n.normalized,byte_stride:n.byte_stride,byte_offset:n.byte_offset}}if(e.index_data){var i=e.index_data;this._index_data={mesh_buffer:i.buffer,buffer:i.buffer.handle,num_indices:i.num_indices,type:this._convertComponentType(i.type),byte_offset:i.byte_offset}}}},{key:"_convertDrawMode",value:function(e){var t=this._glenv.context;switch(e){case l.POINTS:return t.POINTS;case l.LINES:return t.LINES;case l.TRIANGLES:return t.TRIANGLES;case l.LINE_LOOP:return t.LINE_LOOP;case l.LINE_STRIP:return t.LINE_STRIP;case l.TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case l.TRIANGLE_FAN:return t.TRIANGLE_FAN;default:throw new Error("mapray: invalid Mesh.DrawMode: "+e)}}},{key:"_convertComponentType",value:function(e){var t=this._glenv.context;switch(e){case c.BYTE:return t.BYTE;case c.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case c.SHORT:return t.SHORT;case c.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;case c.UNSIGNED_INT:return t.UNSIGNED_INT;case c.FLOAT:return t.FLOAT;default:throw new Error("mapray: invalid Mesh.ComponentType: "+e)}}},{key:"dispose",value:function(){this._attrib_data={},this._index_data=null}},{key:"draw",value:function(e){var t=this._glenv.context;e.bindVertexAttribs(this._attrib_data);var r=this._index_data;null!==r?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.buffer),t.drawElements(this._draw_mode,r.num_indices,r.type,r.byte_offset)):t.drawArrays(this._draw_mode,0,this._num_vertices)}}]),e}(),_=function(){function e(t,r){i(this,e),this.draw_mode=t,this.num_vertices=r,this.index_data=null,this.attribute_data=[]}return a(e,[{key:"addIndex",value:function(e,t,r,n){var i=n||{};this.index_data={buffer:e,num_indices:t,type:r,byte_offset:void 0!==i.byte_offset?i.byte_offset:0}}},{key:"addAttribute",value:function(e,t,r,n,i){var a=i||{},o={id:e,buffer:t,num_components:r,component_type:n,normalized:void 0!==a.normalized&&a.normalized,byte_stride:void 0!==a.byte_stride?a.byte_stride:0,byte_offset:void 0!==a.byte_offset?a.byte_offset:0};this.attribute_data.push(o)}}]),e}(),l={POINTS:{id:"POINTS"},LINES:{id:"LINES"},TRIANGLES:{id:"TRIANGLES"},LINE_LOOP:{id:"LINE_LOOP"},LINE_STRIP:{id:"LINE_STRIP"},TRIANGLE_STRIP:{id:"TRIANGLE_STRIP"},TRIANGLE_FAN:{id:"TRIANGLE_FAN"}},c={BYTE:{id:"BYTE"},UNSIGNED_BYTE:{id:"UNSIGNED_BYTE"},SHORT:{id:"SHORT"},UNSIGNED_SHORT:{id:"UNSIGNED_SHORT"},UNSIGNED_INT:{id:"UNSIGNED_INT"},FLOAT:{id:"FLOAT"}},f=function(){function e(t,r){i(this,e);var n=d.createVertexInfo(r.vtype),a=d.numVertexComponents(n),o=r.vertices.length/a;this._initializer=new _(e._toDrawMode(r),o),this._addIndex(t,r.indices,o);for(var s=4,l=new u.default(t,d.toTypedArray(r.vertices,c.FLOAT)),f=a*s,h=0,v=0;v<n.length;++v){var y=n[v].size;this._initializer.addAttribute(n[v].name,l,y,c.FLOAT,{byte_stride:f,byte_offset:h}),h+=y*s}}return a(e,[{key:"_addIndex",value:function(e,t,r){var n=r<65536?c.UNSIGNED_SHORT:c.UNSIGNED_INT,i=new u.default(e,d.toTypedArray(t,n),{target:u.default.Target.INDEX});this._initializer.addIndex(i,t.length,n)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(e){switch(e.ptype){case"triangles":return l.TRIANGLES;case"lines":return l.LINES;default:return l.TRIANGLES}}}]),e}(),h=function(){function e(t,r){i(this,e);var n=new DataView(r,0),a=n.getUint8(e.OFFSET_VTYPE),o=n.getUint8(e.OFFSET_ITYPE),s=n.getUint8(e.OFFSET_PTYPE),l=n.getUint32(e.OFFSET_NUM_VERTICES,!0),f=n.getUint32(e.OFFSET_NUM_INDICES,!0);this._initializer=new _(e._toDrawMode(s),l);var h=d.createVertexInfo(a),v=this._createIndexArray(t,r,o,f,h,l);this._addIndex(t,o,v);for(var y=4,p=new u.default(t,this._createVertexArray(r,h,l)),m=d.numVertexComponents(h)*y,g=0,b=0;b<h.length;++b){var w=h[b].size;this._initializer.addAttribute(h[b].name,p,w,c.FLOAT,{byte_stride:m,byte_offset:g}),g+=w*y}}return a(e,[{key:"_createIndexArray",value:function(t,r,n,i,a,o){var u,s,_,l=4,c=d.numVertexComponents(a)*o*l,f=new DataView(r,e.OFFSET_BODY+c);switch(n){case e.ENUM_ITYPE_UINT16:for(s=new Uint16Array(i),_=2,u=0;u<i;++u)s[u]=f.getUint16(_*u,!0);break;case e.ENUM_ITYPE_UINT32:for(s=new Uint32Array(i),_=4,u=0;u<i;++u)s[u]=f.getUint32(_*u,!0);break;default:throw new Error("mapray: unknown itype: "+n)}return s}},{key:"_createVertexArray",value:function(t,r,n){for(var i=4,a=d.numVertexComponents(r)*n,o=new DataView(t,e.OFFSET_BODY),u=new Float32Array(a),s=0;s<a;++s)u[s]=o.getFloat32(s*i,!0);return u}},{key:"_addIndex",value:function(t,r,n){var i=new u.default(t,n,{target:u.default.Target.INDEX}),a=e._indexTypeToComponentType(r);this._initializer.addIndex(i,n.length,a)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(t){switch(t){case e.ENUM_PTYPE_TRIANGLES:return l.TRIANGLES;case e.ENUM_PTYPE_LINES:return l.LINES;default:throw new Error("mapray: invalid ptype: "+t)}}},{key:"_indexTypeToComponentType",value:function(t){switch(t){case e.ENUM_ITYPE_UINT16:return c.UNSIGNED_SHORT;case e.ENUM_ITYPE_UINT32:default:return c.UNSIGNED_INT}}}]),e}();h.OFFSET_VTYPE=0,h.OFFSET_ITYPE=1,h.OFFSET_PTYPE=2,h.OFFSET_NUM_VERTICES=4,h.OFFSET_NUM_INDICES=8,h.OFFSET_BODY=12,h.ENUM_ITYPE_UINT16=0,h.ENUM_ITYPE_UINT32=1,h.ENUM_PTYPE_TRIANGLES=0,h.ENUM_PTYPE_LINES=1;var d=function(){function e(){i(this,e)}return a(e,null,[{key:"createVertexInfo",value:function(t){if(Array.isArray(t))return t;var r=null;switch(t){case"P":case e.ENUM_VTYPE_P:r=[{name:e.ANAME_P,size:e.FSIZE_P}];break;case"PN":case e.ENUM_VTYPE_PN:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N}];break;case"PT":case e.ENUM_VTYPE_PT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_T,size:e.FSIZE_T}];break;case"PNT":case e.ENUM_VTYPE_PNT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N},{name:e.ANAME_T,size:e.FSIZE_T}];break;default:throw new Error("mapray: unknown vtype: "+t)}return r}},{key:"numVertexComponents",value:function(e){for(var t=e.length,r=0,n=0;n<t;++n)r+=e[n].size;return r}},{key:"toTypedArray",value:function(e,t){switch(t){case c.UNSIGNED_SHORT:return e instanceof Uint16Array?e:new Uint16Array(e);case c.UNSIGNED_INT:return e instanceof Uint32Array?e:new Uint32Array(e);case c.FLOAT:return e instanceof Float32Array?e:new Float32Array(e);default:throw new Error("mapray: invalid component type: "+t)}}}]),e}();d.ENUM_VTYPE_P=0,d.ENUM_VTYPE_PN=1,d.ENUM_VTYPE_PT=2,d.ENUM_VTYPE_PNT=3,d.ANAME_P="a_position",d.ANAME_N="a_normal",d.ANAME_T="a_texcoord",d.FSIZE_P=3,d.FSIZE_N=3,d.FSIZE_T=2,s.Initializer=_,s.DrawMode=l,s.ComponentType=c,t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(t,r,n,a){i(this,e),this._glenv=t,this.mesh=r,this.material=n,this.transform=a,this.pivot=null,this.bbox=null,this.properties=null,this.sort_z=void 0}return a(e,[{key:"fastClone",value:function(){var t=new e(this._glenv,this.mesh,this.material,u.default.createMatrix(this.transform));return this.pivot&&(t.pivot=u.default.createVector3(this.pivot)),this.bbox&&(t.bbox=this.bbox.map(function(e){return u.default.createVector3(e)})),t.properties=this.properties,t}},{key:"isVisible",value:function(t){var r=e._obj_to_view;u.default.mul_AA(t._gocs_to_view,this.transform,r);var n=this.bbox;if(n){e._transformBBox(n,r);for(var i=t._volume_planes,a=0;a<i.length;++a)if(e._isBBoxBackSide(i[a]))return!1}var o=this.pivot;return o?this.sort_z=r[2]*o[0]+r[6]*o[1]+r[10]*o[2]+r[14]:this.sort_z=r[14],!0}},{key:"isTranslucent",value:function(e){return this.material.isTranslucent(e,this)}},{key:"draw",value:function(e){var t=this.material;t.bindProgram(),t.setParameters(e,this),this.mesh.draw(t)}}],[{key:"_transformBBox",value:function(t,r){for(var n=0;n<2;++n)for(var i=t[n][2],a=0;a<2;++a)for(var o=t[a][1],u=0;u<2;++u){var s=t[u][0],_=e._bbox_points[u+2*a+4*n];_[0]=r[0]*s+r[4]*o+r[8]*i+r[12],_[1]=r[1]*s+r[5]*o+r[9]*i+r[13],_[2]=r[2]*s+r[6]*o+r[10]*i+r[14]}}},{key:"_isBBoxBackSide",value:function(t){for(var r=e._bbox_points,n=0;n<r.length;++n){var i=r[n],a=i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+t[3];if(a>=0)return!1}return!0}}]),e}();s._obj_to_view=u.default.createMatrix(),s._bbox_points=[];for(var _=0;_<8;++_)s._bbox_points.push(u.default.createVector3());t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e);var a=i||{};this._glenv=t,this._handle=this._createTexture(n,a)}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;e.deleteTexture(this._handle),this._handle=null}},{key:"_createTexture",value:function(t,r){var n=this._glenv.context,i=n.TEXTURE_2D,a=n.createTexture(),o=e._getParameters(n,r);n.bindTexture(i,a);var u=void 0===r.flip_y||r.flip_y;return n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,u),r.usage===e.Usage.COLOR?n.texImage2D(i,0,o.format,1,1,0,o.format,o.type,e._getColorArray(r)):n.texImage2D(i,0,o.format,o.format,o.type,t),u&&n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),e._generateMipmapQ(n,o)&&n.generateMipmap(i),n.texParameteri(i,n.TEXTURE_MAG_FILTER,o.mag_filter),n.texParameteri(i,n.TEXTURE_MIN_FILTER,o.min_filter),n.texParameteri(i,n.TEXTURE_WRAP_S,o.wrap_s),n.texParameteri(i,n.TEXTURE_WRAP_T,o.wrap_t),n.bindTexture(i,null),a}},{key:"handle",get:function(){return this._handle}}],[{key:"_getParameters",value:function(t,r){var n={format:t.RGBA,type:t.UNSIGNED_BYTE,mag_filter:t.LINEAR,min_filter:t.LINEAR_MIPMAP_LINEAR,wrap_s:t.REPEAT,wrap_t:t.REPEAT};return r.usage===e.Usage.TEXT?(n.format=t.ALPHA,n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.COLOR&&(n.mag_filter=t.NEAREST,n.min_filter=t.NEAREST),void 0!==r.mag_filter&&(n.mag_filter=r.mag_filter),void 0!==r.min_filter&&(n.min_filter=r.min_filter),void 0!==r.wrap_s&&(n.wrap_s=r.wrap_s),void 0!==r.wrap_t&&(n.wrap_t=r.wrap_t),n}},{key:"_getColorArray",value:function(e){var t=e.color||[1,1,1,1],r=t.map(function(e){return Math.round(255*e)});return new Uint8Array(r)}},{key:"_generateMipmapQ",value:function(e,t){var r=t.min_filter;return r==e.NEAREST_MIPMAP_NEAREST||r==e.LINEAR_MIPMAP_NEAREST||r==e.NEAREST_MIPMAP_LINEAR||r==e.LINEAR_MIPMAP_LINEAR}}]),e}(),a={GENERAL:{id:"GENERAL"},COLOR:{id:"COLOR"},TEXT:{id:"TEXT"}};i.Usage=a,t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.DemProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.DemProvider#cancelRequest() method has not been overridden.")}},{key:"getResolutionPower",value:function(){return 8}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(2),u=n(o),s=r(42),_=n(s),l=r(56),c=n(l),f=r(1),h=n(f),d=function(){function e(t,r){var n=this;i(this,e),this._glenv=t,this._provider=null,this._min_image_z=0,this._max_image_z=0,this._image_zbias=0;var a=function(e){e===u.default.Status.READY?(n._flush(),n._resetImageProvider(r)):e===u.default.Status.FAILED&&console.error("ImageProvider.Status.FAILED in TileTextureCache")};this._resetImageProvider(r.status(a)===u.default.Status.READY?r:new _.default),this._croot=new v,this._max_accesses=0,this._frame_counter=0,this._lower_bound=1,this._upper_bound=1.2,this._num_requesteds=0,this._max_requesteds=75,this._new_requesteds=[];var o=t.context,s=t.EXT_texture_filter_anisotropic;s&&(this._aniso_ext=s,this._max_aniso=o.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this._use_mipmap=!1}return a(e,[{key:"_resetImageProvider",value:function(e){this._provider=e;var t=e.getZoomLevelRange();this._min_image_z=t.min,this._max_image_z=t.max,this._image_zbias=Math.maprayLog2(2*Math.PI/e.getImageSize())}},{key:"cancel",value:function(){this._flush()}},{key:"_flush",value:function(){new m(this,this._croot),this._croot=new v,this._max_accesses=0}},{key:"getImageZBias",value:function(){return this._image_zbias}},{key:"getImageZMin",value:function(){return this._min_image_z}},{key:"getNumWaitingRequests",value:function(){return this._num_requesteds}},{key:"findNearestAncestors",value:function(t,r,n,i){for(var a,o,u,s,_,l=0,c=this._min_image_z,f=Math.pow(2,1-t),d=(r+.5)*f,y=(n+.5)*f,p=this._croot;l<c;++l)a=Math.floor(d)%2,o=Math.floor(y)%2,u=a+2*o,s=p.children,_=s[u],null===_&&(_=new v,s[u]=_),d*=2,y*=2,p=_;var m=this._max_image_z,b=h.default.clamp(i-1,c,m),w=h.default.clamp(i,c,m),x=null,E=null;if(b<w){for(;l<=b;++l)p.state===g.LOADED?x=p:p.state===g.NONE?(p.state=g.REQUESTED,p.req_power=i-l,this._new_requesteds.push([p,l,Math.floor(.5*d),Math.floor(.5*y)])):p.state===g.REQUESTED&&p.updateRequestPower(i-l),a=Math.floor(d)%2,o=Math.floor(y)%2,u=a+2*o,s=p.children,_=s[u],null===_&&(_=new v,s[u]=_),d*=2,y*=2,p=_;E=x,p.state===g.LOADED?E=p:p.state===g.NONE?(p.state=g.REQUESTED,p.req_power=i-l,this._new_requesteds.push([p,l,Math.floor(.5*d),Math.floor(.5*y)])):p.state===g.REQUESTED&&p.updateRequestPower(i-l)}else for(;;++l){if(p.state===g.LOADED?x=p:p.state===g.NONE?(p.state=g.REQUESTED,p.req_power=i-l,this._new_requesteds.push([p,l,Math.floor(.5*d),Math.floor(.5*y)])):p.state===g.REQUESTED&&p.updateRequestPower(i-l),l==b){E=x;break}a=Math.floor(d)%2,o=Math.floor(y)%2,u=a+2*o,s=p.children,_=s[u],null===_&&(_=new v,s[u]=_),d*=2,y*=2,p=_}p.touch();var k=e._findNearestAncestors_result;return k[0]=null!==E?E.data:null,k[1]=null!==x?x.data:null,k}},{key:"endFrame",value:function(){this._performNewRequests();var e=new y(this._croot,this._frame_counter);if(this._max_accesses=Math.max(e.num_accesses,this._max_accesses),e.num_loadeds>this._upper_bound*this._max_accesses){var t=Math.floor(this._lower_bound*this._max_accesses);this._reduceCache(t)}++this._frame_counter}},{key:"_performNewRequests",value:function(){var e=Math.min(this._max_requesteds-this._num_requesteds,this._new_requesteds.length);this._new_requesteds.sort(function(e,t){var r=e[0],n=t[0];return n.req_power-r.req_power});var t=this;this._new_requesteds.slice(0,e).forEach(function(e){var r=e[0],n=e[1],i=e[2],a=e[3];t._requestTileTexture(n,i,a,r)}),this._new_requesteds.slice(e).forEach(function(e){var t=e[0];t.state=g.NONE}),this._new_requesteds.length=0}},{key:"_requestTileTexture",value:function(e,t,r,n){var i=this;n.data=this._provider.requestTile(e,t,r,function(a){n.state===g.REQUESTED&&(a?(n.data=new c.default(e,t,r,i._createTexture(a)),n.state=g.LOADED):(n.data=null,n.state=g.FAILED),--i._num_requesteds)}),++this._num_requesteds}},{key:"_createTexture",value:function(e){var t=this._glenv.context,r=this._aniso_ext,n=t.TEXTURE_2D,i=t.createTexture();return t.bindTexture(n,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(n,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._use_mipmap&&t.generateMipmap(n),t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,this._use_mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texParameterf(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._max_aniso),t.bindTexture(n,null),i}},{key:"_reduceCache",value:function(e){var t=new p(this._croot);t.nodes.sort(function(e,t){var r=t.aframe-e.aframe;return 0==r&&e.state===g.LOADED&&t.state===g.LOADED?e.data.z-t.data.z:r});var r=this._glenv.context;t.nodes.slice(e).forEach(function(e){e.state===g.LOADED&&e.data.dispose(r),e.state=g.NONE,e.data=null}),t.clean()}}]),e}();d._findNearestAncestors_result=new Array(2);var v=function(){function e(){i(this,e),this.children=[null,null,null,null],this.state=g.NONE,this.data=null,this.req_power=-1,this.aframe=-1}return a(e,[{key:"updateRequestPower",value:function(e){e>this.req_power&&(this.req_power=e)}},{key:"touch",value:function(){this.aframe=!0}}]),e}(),y=function(){function e(t,r){i(this,e),this.num_loadeds=0,this.num_accesses=0,this._frame=r,this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=e.aframe===!0,n=0;n<4;++n){var i=t[n];null!==i&&(r=this._traverse(i)||r)}return e.state===g.LOADED&&(++this.num_loadeds,r&&++this.num_accesses),r&&(e.aframe=this._frame),r}}]),e}(),p=function(){function e(t){i(this,e),this._root=t,this.nodes=[],this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){var t=e.state;t!==g.LOADED&&t!==g.FAILED||this.nodes.push(e);for(var r=e.children,n=0;n<4;++n){var i=r[n];
null!==i&&this._traverse(i)}}},{key:"clean",value:function(){this._clean_recur(this._root)}},{key:"_clean_recur",value:function(e){for(var t=e.state===g.NONE,r=e.children,n=0;n<4;++n){var i=r[n];if(null!==i){var a=this._clean_recur(i);a===!0&&(r[n]=null),t=a&&t}}return t}}]),e}(),m=function(){function e(t,r){i(this,e),this._owner=t,this._traverse(r)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=0;r<4;++r){var n=t[r];null!==n&&this._traverse(n)}if(e.state===g.REQUESTED){var i=this._owner;e.state=g.NONE,i._provider.cancelRequest(e.data),--i._num_requesteds}}}]),e}(),g={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(71),u=n(o),s=function(){function e(t,r){i(this,e),this._texture=new u.default(r,t.index),this._texCoord=void 0!==t.texCoord?t.texCoord:0}return a(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}},{key:"texCoord",get:function(){return this._texCoord}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(22),_=n(s),l=function(){function e(t){i(this,e),this._canvas=t,this.fov=46,this.near=1,this.far=1e3,this.view_to_gocs=u.default.createMatrix(),u.default.setIdentity(this.view_to_gocs)}return a(e,[{key:"getCanvasToView",value:function(e){var t=e||u.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*u.default.DEGREE/2,s=n/r,_=i*Math.tan(o)/Math.sqrt(1+s*s),l=_*s;return t[0]=2*_/(i*r),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l/(i*n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=(i-a)/(i*a),t[12]=-_/i,t[13]=l/i,t[14]=-1,t[15]=1/i,t}},{key:"getCanvasToGocs",value:function(e){var t=this.getCanvasToView(e),r=t[0],n=t[5],i=t[11],a=t[12],o=t[13],u=t[15],s=this.view_to_gocs,_=s[0],l=s[1],c=s[2],f=s[4],h=s[5],d=s[6],v=s[8],y=s[9],p=s[10],m=s[12],g=s[13],b=s[14],w=t;return w[0]=_*r,w[1]=l*r,w[2]=c*r,w[4]=f*n,w[5]=h*n,w[6]=d*n,w[8]=m*i,w[9]=g*i,w[10]=b*i,w[12]=_*a+f*o-v+m*u,w[13]=l*a+h*o-y+g*u,w[14]=c*a+d*o-p+b*u,w}},{key:"getViewToCanvas",value:function(e){var t=e||u.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*u.default.DEGREE/2,s=n/r,_=i*Math.tan(o)/Math.sqrt(1+s*s),l=_*s;return t[0]=i*r/(2*_),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-i*n/(2*l),t[6]=0,t[7]=0,t[8]=-r/2,t[9]=-n/2,t[10]=a/(i-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*a/(i-a),t[15]=0,t}},{key:"getCanvasRay",value:function(t,r){var n=t[0],i=t[1],a=r||new _.default,o=this.getCanvasToGocs(e._temp_mat),s=n*o[0]+i*o[4]+o[12],l=n*o[1]+i*o[5]+o[13],c=n*o[2]+i*o[6]+o[14],f=n*o[3]+i*o[7]+o[15],h=a.position;h[0]=s/f,h[1]=l/f,h[2]=c/f;var d=this.view_to_gocs,v=a.direction;return v[0]=h[0]-d[12],v[1]=h[1]-d[13],v[2]=h[2]-d[14],u.default.normalize3(v,v),a}},{key:"createRenderInfo",value:function(){var e=this._canvas;return new c(this,e.width,e.height)}}]),e}();l._temp_mat=u.default.createMatrix();var c=function(){function e(t,r,n){i(this,e),this._view_to_clip=u.default.createMatrix(),this._volume_planes=[];for(var a=0;a<6;++a)this._volume_planes.push(u.default.createVector4());this._pixel_step=0,this._setup_view_to_clip(t,r,n),this._setup_volume_planes(),this._setup_pixel_step(r,n)}return a(e,[{key:"_setup_view_to_clip",value:function(e,t,r){var n=e.fov*u.default.DEGREE/2,i=r/t,a=e.near*Math.tan(n)/Math.sqrt(1+i*i),o=-a,s=a,_=-a*i,l=a*i;u.default.frustum_matrix(o,s,_,l,e.near,e.far,this._view_to_clip)}},{key:"_setup_volume_planes",value:function(){var e=this._view_to_clip,t=this._volume_planes;this._add_matrix_rows(e,3,2,t[0]),this._sub_matrix_rows(e,3,2,t[1]),this._add_matrix_rows(e,3,0,t[2]),this._sub_matrix_rows(e,3,0,t[3]),this._add_matrix_rows(e,3,1,t[4]),this._sub_matrix_rows(e,3,1,t[5]);for(var r=0;r<6;++r){var n=t[r],i=n[0],a=n[1],o=n[2],u=1/Math.sqrt(i*i+a*a+o*o);n[0]*=u,n[1]*=u,n[2]*=u,n[3]*=u}}},{key:"_setup_pixel_step",value:function(e,t){var r=this._view_to_clip,n=r[0],i=r[5],a=r[11],o=r[15],u=2*(o-a),s=u/(n*e),_=u/(i*t);this._pixel_step=Math.sqrt(s*s+_*_)*Math.SQRT1_2}},{key:"_add_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]+e[r],n[1]=e[t+4]+e[r+4],n[2]=e[t+8]+e[r+8],n[3]=e[t+12]+e[r+12],n}},{key:"_sub_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]-e[r],n[1]=e[t+4]-e[r+4],n[2]=e[t+8]-e[r+8],n[3]=e[t+12]-e[r+12],n}},{key:"view_to_clip",get:function(){return this._view_to_clip}},{key:"volume_planes",get:function(){return this._volume_planes}},{key:"pixel_step",get:function(){return this._pixel_step}}]),e}();t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a,o){r(this,e);var u=4,s=Math.pow(2,t-1),_=1<<a;this._sx=s/Math.PI*_,this._sy=-this._sx,this._ox=(s-n)*_,this._oy=(s-i)*_,this._body=o,this._pitch=u*(_+1),this._max=_}return n(e,[{key:"sample",value:function(e,t){return 0}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(20),_=n(s),l=r(1),c=n(l),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.glenv,r,n));return o._flake_to_clip=c.default.createMatrixf(),o}return o(t,e),u(t,[{key:"numDrawings",value:function(){return 1}},{key:"isWireframe",value:function(){return!1}},{key:"setFlakeParameter",value:function(e,t,r){return!1}},{key:"setCommonParameter",value:function(e,t){t.mul_flake_to_gocs(e._gocs_to_clip,this._flake_to_clip),this.setMatrix("u_obj_to_clip",this._flake_to_clip)}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),_=n(s),l=r(7),c=n(l),f=r(35),h=n(f),d=r(1),v=n(d),y=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(n._transform=v.default.setIdentity(v.default.createMatrix()),n._primitives=[],r&&r.json){var o=r.json,u=r.refs||{};n._transform=n.parseTransform(o.transform);var s=u[o.ref_mesh],_=n._getJsonMaterial(o),l=new c.default(e.glenv,s,_,n._transform);l.properties=n.loadProperties(o,u),n._primitives.push(l)}return n}return o(t,e),u(t,[{key:"getPrimitives",value:function(e){return this._primitives}},{key:"setTransform",value:function(e){v.default.copyMatrix(e,this._transform)}},{key:"_getJsonMaterial",value:function(e){var t=e.mode||"basic";switch(t){case"basic":return this._getBasicMaterial();default:return console.error("mapray: unknown GenericEntity mode: "+t),null}}},{key:"_getBasicMaterial",value:function(){var e=this.scene;return e._GenericEntity_basic_material||(e._GenericEntity_basic_material=new h.default(e.glenv)),e._GenericEntity_basic_material}}]),t}(_.default);t.default=y,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(39),_=n(s),l=r(44),c=n(l),f=function(){function e(t,r){i(this,e),this._glenv=t,this._dem_provider=r,this._status=h.NOT_READY,this._ρ=r.getResolutionPower(),this._dem_zbias=u.default.LOG2PI-this._ρ+1,this._hist_stats=new v,this._flake_reduce_thresh=1.5,this._flake_reduce_factor=1.2,this._num_cache_flakes=0,this._num_touch_flakes=0,this._mesh_reduce_lower=300,this._mesh_reduce_thresh=1.5,this._mesh_reduce_factor=1.2,this._num_cache_meshes=0,this._num_touch_meshes=0,this._max_dem_requesteds=10,this._num_dem_requesteds=0,this._frame_counter=0,this._root_flake=null,this._avg_height=null,this._root_cancel_id=null,this._requestRoot()}return a(e,[{key:"cancel",value:function(){if(this._status===h.READY)for(var e=this._root_flake._children,t=0;t<4;++t)e[t].dispose();else this._status===h.NOT_READY&&(this._dem_provider.cancelRequest(this._root_cancel_id),this._root_cancel_id=null)}},{key:"getNumDemWaitingRequests",value:function(){return this._num_dem_requesteds}},{key:"findHighestAccuracy",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=u.default.clamp(Math.floor(i),0,n-1)%2,_=u.default.clamp(Math.floor(a),0,n-1)%2,l=r._children[s+2*_];if(r.touch(),null===l)break;r._dem_state===p.LOADED&&(o=r),r=l,n*=2,i*=2,a*=2}return o._requestHighestAccuracy(e,t),o._dem_data}},{key:"endFrame",value:function(){var e=this._hist_stats.getMaxValue(this._num_touch_flakes);this._num_cache_flakes>this._flake_reduce_thresh*e&&this._reduceFlakes(e),this._num_cache_meshes>this._mesh_reduce_lower&&this._num_cache_meshes>this._mesh_reduce_thresh*this._num_touch_meshes&&this._reduceMeshes(),this._num_touch_flakes=0,this._num_touch_meshes=0,++this._frame_counter}},{key:"_requestRoot",value:function(){var e=this,t=0,r=0,n=0;this._root_cancel_id=this._dem_provider.requestTile(t,r,n,function(i){if(i){var a=new _.default(t,r,n,e._ρ,i);e._avg_height=a.newAvgHeightMaps(),e._root_flake=new d(null,t,r,n),e._root_flake.setupRoot(e,a),e._status=h.READY}else e._status=h.FAILED;e._root_cancel_id=null,--e._num_dem_requesteds}),++this._num_dem_requesteds}},{key:"_reduceFlakes",value:function(e){var t=this._root_flake.flattenFlakes();t.sort(function(e,t){return e.compareForReduce(t)});var r=Math.floor(this._flake_reduce_factor*e);t.slice(r).forEach(function(e){return e.dispose()})}},{key:"_reduceMeshes",value:function(){var e=this._root_flake.flattenMeshes();e.sort(function(e,t){return e.compareForReduce(t)});var t=Math.floor(this._mesh_reduce_factor*this._num_touch_meshes);e.slice(t).forEach(function(e){return e.dispose()})}},{key:"glenv",get:function(){return this._glenv}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"status",get:function(){return this._status}},{key:"root_flake",get:function(){var e=this._root_flake;return e.touch(),e}}]),e}(),h={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};f.Status=h;var d=function(){function e(t,r,n,a){i(this,e),this.z=r,this.x=n,this.y=a,this._parent=t,this._children=[null,null,null,null],this._globe=null!==t?t._globe:null,this._dem_data=null,this._dem_state=p.NONE,this._meshes=[],this._prev_Za_dem=null,this._prev_Zr_dem=null,this._base_height=0,this._height_min=0,this._height_max=0,this._dem_zlimit=0,this._gocs_x_min=0,this._gocs_x_max=0,this._gocs_y_min=0,this._gocs_y_max=0,this._gocs_z_min=0,this._gocs_z_max=0,this._aframe=-1,null!==this._globe&&(this._globe._num_cache_flakes+=1)}return a(e,[{key:"setupRoot",value:function(e,t){this._globe=e,this._dem_data=t,this._dem_state=p.LOADED,this._estimate(),e._num_cache_flakes+=1}},{key:"newChild",value:function(t,r){var n=t+2*r,i=this._children[n];return null===i&&(i=new e(this,this.z+1,2*this.x+t,2*this.y+r),this._children[n]=i),i._estimate(),i.touch(),i}},{key:"isInvisible",value:function(e){switch(this.z){case 0:return this._isInvisible_0(e);default:return this._isInvisible_N(e)}}},{key:"findMesh",value:function(t){var r,n=Math.pow(2,-t)*e.ε;r=n<=2?Math.max(Math.ceil(u.default.LOG2PI-this.z-Math.maprayLog2(Math.acos(1-n))),0):0;var i,a=this._getCosφ();i=n*a<=2?Math.max(Math.ceil(u.default.LOG2PI-this.z+Math.maprayLog2(a/Math.acos(1-n*a))),0):0;var o=this._getMeshNode(t,r,i);return o.touch(),o.mesh}},{key:"findRayDistance",value:function(e,t){var r;for(r=this;r._dem_state!==p.LOADED;r=r._parent);if(this.z-r.z===this._globe._ρ)return this._findQuadRayDistance(e,t,r);if(this._cullForRayDistance(e,t))return t;for(var n=t,i=0;i<2;++i)for(var a=0;a<2;++a)n=this.newChild(a,i).findRayDistance(e,n);return n}},{key:"dispose",value:function(){var e,t=this._parent;if(null!==t){for(var r=this._globe,n=this._meshes;n.length>0;)n[0].dispose();var i=this._children;for(e=0;e<4;++e){var a=i[e];null!==a&&a.dispose()}var o=t._children;for(e=0;e<4;++e)if(o[e]===this){o[e]=null;break}this._parent=null,this._dem_state===p.REQUESTED&&(r._dem_provider.cancelRequest(this._dem_data),--r._num_dem_requesteds),r._num_cache_flakes-=1}}},{key:"flattenFlakes",value:function(){var e=[];return this._flattenFlakes(e),e}},{key:"flattenMeshes",value:function(){var e=[];return this._flattenMeshes(e),e}},{key:"compareForReduce",value:function(e){var t=this,r=e,n=r._aframe-t._aframe;return 0!==n?n:t.z-r.z}},{key:"_flattenFlakes",value:function(e){e.push(this);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenFlakes(e)}}},{key:"_flattenMeshes",value:function(e){Array.prototype.push.apply(e,this._meshes);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenMeshes(e)}}},{key:"touch",value:function(){var e=this._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_flakes+=1)}},{key:"_getMeshNode",value:function(e,t,r){for(var n=this._getMeshDemBinary(e),i=n.getDivisionPowers(this,e,t,r),a=this._meshes,o=a.length,u=0;u<o;++u){var s=a[u];if(s.match(n,i))return s}var _=new y(this,n,i);return a.unshift(_),_}},{key:"_getMeshDemBinary",value:function(e){var t=u.default.clamp(Math.round(e+this._globe._dem_zbias),0,this._dem_zlimit),r=this._findNearestDemTile(t);if(r.z<t){var n=r.getQuadLevel(this.z,this.x,this.y);n>0&&this._requestAncestorDemTile(Math.min(r.z+n,t))}return r}},{key:"_findNearestDemTile",value:function(e){for(var t=this,r=this.z-e,n=0;n<r;++n)t=t._parent;for(;t._dem_state!==p.LOADED;)t=t._parent;return t._dem_data}},{key:"_requestAncestorDemTile",value:function(e){var t=this._globe;if(!(t._num_dem_requesteds>=t._max_dem_requesteds)){for(var r=this,n=this.z-e,i=0;i<n;++i)r=r._parent;for(;;){var a=r._dem_state;if(a===p.LOADED||a===p.REQUESTED)break;{if(a!==p.FAILED){var o=t._dem_provider;r._dem_data=o.requestTile(r.z,r.x,r.y,function(e){null!==r._parent&&(e?(r._dem_data=new _.default(r.z,r.x,r.y,t._ρ,e),r._dem_state=p.LOADED):(r._dem_data=null,r._dem_state=p.FAILED),--t._num_dem_requesteds)}),r._dem_state=p.REQUESTED,++t._num_dem_requesteds;break}r=r._parent}}}}},{key:"_isInvisible_0",value:function(e){for(var t=u.default.EARTH_RADIUS+this._height_max,r=0;r<e.length;++r){var n=e[r][3];if(n<-t)return!0}return!1}},{key:"_isInvisible_N",value:function(e){for(var t=this._gocs_x_min,r=this._gocs_x_max,n=this._gocs_y_min,i=this._gocs_y_max,a=this._gocs_z_min,o=this._gocs_z_max,u=0;u<e.length;++u){var s=e[u],_=s[0],l=s[1],c=s[2],f=s[3],h=_*t+l*n,d=_*r+l*n,v=_*t+l*i,y=_*r+l*i,p=-c*a-f,m=-c*o-f;if(h<p&&d<p&&v<p&&y<p&&h<m&&d<m&&v<m&&y<m)return!0}return!1}},{key:"_getCosφ",value:function(){var e=this.z;if(e>0){var t=this.y,r=Math.pow(2,1-e),n=Math.abs(1-r*t),i=Math.abs(1-r*(t+1)),a=Math.exp(Math.PI*Math.min(n,i));return 2*a/(a*a+1)}return 1}},{key:"_estimate",value:function(){if(this._prev_Za_dem!==this){var e,t=this.z,r=this._globe._ρ;if(t<r){if(e=this._findNearestDemTile(t),e===this._prev_Zr_dem)return;this._prev_Zr_dem=e,this._estimate_low(e),this._dem_zlimit=t}else{var n=this._findNearestDemTile(t-r);if(n.isLeaf(t,this.x,this.y))this._estimate_leaf(n);else{if(e=this._findNearestDemTile(n.z+r),n===this._prev_Za_dem&&e===this._prev_Zr_dem)return;this._prev_Za_dem=n,this._prev_Zr_dem=e,this._estimate_high(n,e)}this._dem_zlimit=n.z+r}switch(t){case 0:this._updataBoundingBox_0();break;case 1:this._updataBoundingBox_1();break;default:this._updataBoundingBox_N()}}}},{key:"_estimate_low",value:function(t){var r=this.z,n=this.x,i=this.y,a=this._calcAlpha();this._base_height=this._globe._avg_height.sample(r,n,i),this._height_min=Math.max(this._base_height+a*e.Fm,t.height_min),this._height_max=Math.min(this._base_height+a*e.Fp,t.height_max),(t.z==r||t.isLeaf(r,n,i))&&(this._prev_Za_dem=this)}},{key:"_estimate_high",value:function(t,r){var n=this._globe,i=this.z,a=this.x,o=this.y,u=t.z,s=t.x,_=t.y,l=n._ρ,c=Math.pow(2,u-i),f=1<<l,h=Math.floor(f*((a+.5)*c-s)),d=Math.floor(f*((o+.5)*c-_)),v=f*(a*c-s)-h,y=f*((a+1)*c-s)-h,p=f*(o*c-_)-d,m=f*((o+1)*c-_)-d,g=t.getHeights(h,d),b=g[0],w=g[1],x=g[2],E=g[3],k=(b*(1-v)+w*v)*(1-p)+(x*(1-v)+E*v)*p,T=(b*(1-y)+w*y)*(1-p)+(x*(1-y)+E*y)*p,M=(b*(1-v)+w*v)*(1-m)+(x*(1-v)+E*v)*m,O=(b*(1-y)+w*y)*(1-m)+(x*(1-y)+E*y)*m,A=this._calcAlpha();if(this._base_height=.25*(k+T+M+O),this._height_min=Math.max(this._base_height+A*e.Fm,r.height_min),this._height_max=Math.min(this._base_height+A*e.Fp,r.height_max),u<i-l){var P=t.getQuadLevel(i,a,o);this._requestAncestorDemTile(Math.min(u+P,i-l))}else(r.z==i||r.isLeaf(i,a,o))&&(this._prev_Za_dem=this)}},{key:"_estimate_leaf",value:function(e){var t=this.z,r=this.x,n=this.y,i=e.z,a=e.x,o=e.y,u=Math.pow(2,i-t),s=1<<this._globe._ρ,_=Math.floor(s*((r+.5)*u-a)),l=Math.floor(s*((n+.5)*u-o)),c=s*(r*u-a)-_,f=s*((r+1)*u-a)-_,h=s*(n*u-o)-l,d=s*((n+1)*u-o)-l,v=e.getHeights(_,l),y=v[0],p=v[1],m=v[2],g=v[3],b=(y*(1-c)+p*c)*(1-h)+(m*(1-c)+g*c)*h,w=(y*(1-f)+p*f)*(1-h)+(m*(1-f)+g*f)*h,x=(y*(1-c)+p*c)*(1-d)+(m*(1-c)+g*c)*d,E=(y*(1-f)+p*f)*(1-d)+(m*(1-f)+g*f)*d;this._base_height=.25*(b+w+x+E),this._height_min=Math.min(b,w,x,E),this._height_max=Math.max(b,w,x,E),this._prev_Za_dem=this}},{key:"_calcAlpha",value:function(){var t=Math.pow(2,1-this.z);return t*e.πr/Math.cosh((1-t*(this.y+.5))*Math.PI)}},{key:"_updataBoundingBox_0",value:function(){var e=u.default.EARTH_RADIUS+this._height_max;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=-e,this._gocs_y_max=e,this._gocs_z_min=-e,this._gocs_z_max=e}},{key:"_updataBoundingBox_1",value:function(){var e=u.default.EARTH_RADIUS+this._height_max,t=this.x,r=this.y;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=e*(t-1),this._gocs_y_max=e*t,this._gocs_z_min=-e*r,this._gocs_z_max=e*(1-r)}},{key:"_updataBoundingBox_N",value:function(){var e=Math.PI,t=this.z,r=this.x,n=this.y,i=Math.pow(2,1-t)*e,a=-e+r*i,o=-e+(r+1)*i,s=e-(n+1)*i,_=e-n*i,l=a,c=o,f=Math.exp(s),h=Math.exp(_),d=f*f,v=h*h,y=u.default.EARTH_RADIUS+this._height_min,p=u.default.EARTH_RADIUS+this._height_max,m=2*f/(d+1),g=2*h/(v+1);s+_<0?(l+c<-e?(this._gocs_x_min=p*g*Math.cos(l),this._gocs_x_max=y*m*Math.cos(c),this._gocs_y_min=p*g*Math.sin(c),this._gocs_y_max=y*m*Math.sin(l)):l+c<0?(this._gocs_x_min=y*m*Math.cos(l),this._gocs_x_max=p*g*Math.cos(c),this._gocs_y_min=p*g*Math.sin(l),this._gocs_y_max=y*m*Math.sin(c)):l+c<e?(this._gocs_x_min=y*m*Math.cos(c),this._gocs_x_max=p*g*Math.cos(l),this._gocs_y_min=y*m*Math.sin(l),this._gocs_y_max=p*g*Math.sin(c)):(this._gocs_x_min=p*g*Math.cos(c),this._gocs_x_max=y*m*Math.cos(l),this._gocs_y_min=y*m*Math.sin(c),this._gocs_y_max=p*g*Math.sin(l)),this._gocs_z_min=p*(d-1)/(d+1),this._gocs_z_max=y*(v-1)/(v+1)):(l+c<-e?(this._gocs_x_min=p*m*Math.cos(l),this._gocs_x_max=y*g*Math.cos(c),this._gocs_y_min=p*m*Math.sin(c),this._gocs_y_max=y*g*Math.sin(l)):l+c<0?(this._gocs_x_min=y*g*Math.cos(l),this._gocs_x_max=p*m*Math.cos(c),this._gocs_y_min=p*m*Math.sin(l),this._gocs_y_max=y*g*Math.sin(c)):l+c<e?(this._gocs_x_min=y*g*Math.cos(c),this._gocs_x_max=p*m*Math.cos(l),this._gocs_y_min=y*g*Math.sin(l),this._gocs_y_max=p*m*Math.sin(c)):(this._gocs_x_min=p*m*Math.cos(c),this._gocs_x_max=y*g*Math.cos(l),this._gocs_y_min=y*g*Math.sin(c),this._gocs_y_max=p*m*Math.sin(l)),this._gocs_z_min=y*(d-1)/(d+1),this._gocs_z_max=p*(v-1)/(v+1))}},{key:"_requestHighestAccuracy",value:function(e,t){var r=this._dem_data.getQuadLevelDirect(e,t);if(0!=r){for(var n=this,i=Math.round(Math.pow(2,this.z+1)),a=i*e,o=i*t,s=0;s<r;++s){var _=u.default.clamp(Math.floor(a),0,i-1)%2,l=u.default.clamp(Math.floor(o),0,i-1)%2;n=n.newChild(_,l),i*=2,a*=2,o*=2}n._requestAncestorDemTile(n.z)}}},{key:"_findQuadRayDistance",value:function(t,r,n){var i=this._getQuadPositions(n,e._temp_positions),a=e._findTriRayDistance(t,r,i[0],i[2],i[1]);return a===r?e._findTriRayDistance(t,r,i[1],i[2],i[3]):a}},{key:"_getQuadPositions",value:function(e,t){for(var r=this.x,n=this.y,i=e.x,a=e.y,o=1<<this._globe._ρ,s=e._dem_data.getHeights(r-o*i,n-o*a),_=Math.pow(2,1-this.z)*Math.PI,l=r*_-Math.PI,c=Math.PI-n*_,f=0,h=c;f<2;++f,h-=_)for(var d=Math.exp(h),v=d*d,y=(v-1)/(v+1),p=2*d/(v+1),m=0,g=l;m<2;++m,g+=_){var b=m+2*f,w=u.default.EARTH_RADIUS+s[b],x=Math.sin(g),E=Math.cos(g),k=t[b];k[0]=w*p*E,k[1]=w*p*x,k[2]=w*y}return t}},{key:"_cullForRayDistance",value:function(e,t){var r=e.position,n=r[0],i=r[1],a=r[2],o=this._gocs_x_min,u=this._gocs_x_max,s=this._gocs_y_min,_=this._gocs_y_max,l=this._gocs_z_min,c=this._gocs_z_max;if(o<=n&&n<=u&&s<=i&&i<=_&&l<=a&&a<=c)return!1;var f,h,d,v,y=e.direction,p=y[0],m=y[1],g=y[2];if(n<o&&p>0){if(f=(o-n)/p,f<t&&(d=i+f*m,v=a+f*g,s<=d&&d<=_&&l<=v&&v<=c))return!1}else if(n>u&&p<0&&(f=(u-n)/p,f<t&&(d=i+f*m,v=a+f*g,s<=d&&d<=_&&l<=v&&v<=c)))return!1;if(i<s&&m>0){if(f=(s-i)/m,f<t&&(h=n+f*p,v=a+f*g,o<=h&&h<=u&&l<=v&&v<=c))return!1}else if(i>_&&m<0&&(f=(_-i)/m,f<t&&(h=n+f*p,v=a+f*g,o<=h&&h<=u&&l<=v&&v<=c)))return!1;if(a<l&&g>0){if(f=(l-a)/g,f<t&&(h=n+f*p,d=i+f*m,o<=h&&h<=u&&s<=d&&d<=_))return!1}else if(a>c&&g<0&&(f=(c-a)/g,f<t&&(h=n+f*p,d=i+f*m,o<=h&&h<=u&&s<=d&&d<=_)))return!1;return!0}},{key:"base_height",get:function(){return this._base_height}},{key:"height_min",get:function(){return this._height_min}},{key:"height_max",get:function(){return this._height_max}}],[{key:"_findTriRayDistance",value:function(t,r,n,i,a){var o=t.direction,s=e._temp_ray_1;s[0]=i[0]-n[0],s[1]=i[1]-n[1],s[2]=i[2]-n[2];var _=e._temp_ray_2;_[0]=a[0]-n[0],_[1]=a[1]-n[1],_[2]=a[2]-n[2];var l=u.default.cross3(s,_,e._temp_ray_3),c=u.default.dot3(l,o);if(c<0){var f=t.position,h=e._temp_ray_4;h[0]=n[0]-f[0],h[1]=n[1]-f[1],h[2]=n[2]-f[2];var d=u.default.dot3(l,h)/c;if(d>=0&&d<r){var v=e._temp_ray_5;v[0]=f[0]+d*o[0],v[1]=f[1]+d*o[1],v[2]=f[2]+d*o[2];var y=e._temp_ray_6;y[0]=n[0]-v[0],y[1]=n[1]-v[1],y[2]=n[2]-v[2];var p=e._temp_ray_7;p[0]=i[0]-v[0],p[1]=i[1]-v[1],p[2]=i[2]-v[2];var m=e._temp_ray_8;if(m[0]=a[0]-v[0],m[1]=a[1]-v[1],m[2]=a[2]-v[2],u.default.dot3(u.default.cross3(y,p,e._temp_ray_9),l)>=0&&u.default.dot3(u.default.cross3(p,m,e._temp_ray_10),l)>=0&&u.default.dot3(u.default.cross3(m,y,e._temp_ray_11),l)>=0)return d}}return r}}]),e}();d.ε=.0625,d.Fm=-2,d.Fp=2,d.πr=Math.PI*u.default.EARTH_RADIUS,d._temp_positions=function(){for(var e=[],t=0;t<4;++t)e.push(u.default.createVector3());return e}(),d._temp_ray_1=u.default.createVector3(),d._temp_ray_2=u.default.createVector3(),d._temp_ray_3=u.default.createVector3(),d._temp_ray_4=u.default.createVector3(),d._temp_ray_5=u.default.createVector3(),d._temp_ray_6=u.default.createVector3(),d._temp_ray_7=u.default.createVector3(),d._temp_ray_8=u.default.createVector3(),d._temp_ray_9=u.default.createVector3(),d._temp_ray_10=u.default.createVector3(),d._temp_ray_11=u.default.createVector3();var v=function(){function e(){i(this,e),this._history=[],this._max_value=0,this._hsize=200}return a(e,[{key:"getMaxValue",value:function(t){var r=this._history,n=this._max_value;return r.length<this._hsize?t>n&&(this._max_value=t):t>=n?(this._max_value=t,r.shift()):r[0]<n?r.shift():(r.shift(),this._max_value=e._find_max(r)),r.push(t),this._max_value}}],[{key:"_find_max",value:function(e){for(var t=e[0],r=e.length,n=1;n<r;++n){var i=e[n];i>t&&(t=i)}return t}}]),e}(),y=function(){function e(t,r,n){i(this,e),this._flake=t,this._dem=r,this._pow_u=n[0],this._pow_v=n[1],this._aframe=-1,this.mesh=new c.default(t._globe.glenv,t,n,r),t._globe._num_cache_meshes+=1}return a(e,[{key:"match",value:function(e,t){return this._dem===e&&this._pow_u===t[0]&&this._pow_v===t[1]}},{key:"touch",value:function(){var e=this._flake._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_meshes+=1)}},{key:"dispose",value:function(){if(null!==this.mesh){for(var e=this._flake,t=e._meshes,r=t.length,n=0;n<r;++n)if(t[n]===this){t.splice(n,1);break}this.mesh.dispose(),this.mesh=null,e._globe._num_cache_meshes-=1}}},{key:"compareForReduce",value:function(e){var t=this,r=e;return r._aframe-t._aframe}}]),e}(),p={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(2),u=n(o),s=r(10),_=n(s),l=function(){function e(t,r){i(this,e),this._owner=t,this._glenv=t.glenv;var n=r instanceof u.default?{image_provider:r}:r;this._image_provider=n.image_provider,this._visibility=n.visibility||!0,this._opacity=n.opacity||1,this._tile_cache=new _.default(this._glenv,this._image_provider),this._image_provider.status(function(e){t.dirtyDrawingLayers()})}return a(e,[{key:"setImageProvider",value:function(e){var t=this;this._image_provider!==e&&(this._owner.dirtyDrawingLayers(),e.status(function(e){t._owner.dirtyDrawingLayers()})),this._image_provider=e,this._tile_cache.cancel(),this._tile_cache=new _.default(this._glenv,e)}},{key:"setVisibility",value:function(e){this._visibility!=e&&this._owner.dirtyDrawingLayers(),this._visibility=e}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"image_provider",get:function(){return this._image_provider}},{key:"visibility",get:function(){return this._visibility}},{key:"opacity",get:function(){return this._opacity}},{key:"tile_cache",get:function(){return this._tile_cache}}]),e}();t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(17),u=n(o),s=r(2),_=n(s),l=function(){function e(t,r){i(this,e),this._glenv=t,this._layers=[],this._draw_layers=null;for(var n=0;n<r.length;++n)this.add(r[n])}return a(e,[{key:"getLayer",value:function(e){return this._layers[e]}},{key:"clear",value:function(){for(;this.num_layers()>0;)this.remove(0)}},{key:"add",value:function(e){this.insert(this.num_layers,e)}},{key:"insert",value:function(e,t){this._layers.splice(e,0,new u.default(this,t)),this.dirtyDrawingLayers()}},{key:"remove",value:function(e){this._layers.splice(e,1),this.dirtyDrawingLayers()}},{key:"numDrawingLayers",value:function(){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers.length}},{key:"getDrawingLayer",value:function(e){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers[e]}},{key:"endFrame",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.endFrame()}},{key:"cancel",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.cancel()}},{key:"dirtyDrawingLayers",value:function(){this._draw_layers=null}},{key:"_updataDrawingLayers",value:function(){for(var e=this.num_layers,t=[],r=0;r<e;++r){var n=this._layers[r];n.image_provider.status()===_.default.Status.READY&&n.visibility===!0&&t.push(n)}this._draw_layers=t}},{key:"glenv",get:function(){return this._glenv}},{key:"num_layers",get:function(){return this._layers.length}}]),e}();t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),_=n(s),l=r(7),c=n(l),f=r(6),h=n(f),d=r(46),v=n(d),y=r(1),p=n(y),m=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n._buffer=new Float64Array(1),n._num_floats=0,n._geom_dirty=!0,n._transform=p.default.setIdentity(p.default.createMatrix()),n._pivot=p.default.createVector3(),n._bbox=[p.default.createVector3(),p.default.createVector3()],n._properties={width:1,color:p.default.createVector3f([1,1,1]),opacity:1};var o=new c.default(e.glenv,null,n._getMarkerLineMaterial(),n._transform);return o.pivot=n._pivot,o.bbox=n._bbox,o.properties=n._properties,
n._primitive=o,n._empty=[],n._primitives=[o],r&&r.json&&n._setupByJson(r.json),n}return o(t,e),u(t,[{key:"getPrimitives",value:function(e){return this._num_floats<2?this._empty:(this._updatePrimitive(),this._primitives)}},{key:"setLineWidth",value:function(e){this._properties.width=e}},{key:"setColor",value:function(e){p.default.copyVector3(e,this._properties.color)}},{key:"setOpacity",value:function(e){this._properties.opacity=e}},{key:"addPoints",value:function(e){var t=e.length;if(0!=t){var r=this._num_floats+t,n=this._buffer.length;if(r>n){for(var i=new Float64Array(Math.max(r,2*n)),a=this._buffer,o=this._num_floats,u=0;u<o;++u)i[u]=a[u];this._buffer=i}for(var s=this._buffer,_=this._num_floats,l=0;l<t;++l)s[_+l]=e[l];this._num_floats=r,this._geom_dirty=!0}}},{key:"_getMarkerLineMaterial",value:function(){var e=this.scene;return e._MarkerLineEntity_markerline_material||(e._MarkerLineEntity_markerline_material=new v.default(e.glenv)),e._MarkerLineEntity_markerline_material}},{key:"_updatePrimitive",value:function(){if(this._geom_dirty){this._updateTransformPivotBBox();var e={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(),indices:this._createIndices()},t=new h.default(this.scene.glenv,e),r=this._primitive;r.mesh&&r.mesh.dispose(),r.mesh=t,this._geom_dirty=!1}}},{key:"_updateTransformPivotBBox",value:function(){var e=this._buffer,t=e[0],r=e[1],n=e[2],i=this._transform;i[12]=t,i[13]=r,i[14]=n;for(var a=this._num_floats/3,o=0,u=0,s=0,_=Number.MAX_VALUE,l=Number.MAX_VALUE,c=Number.MAX_VALUE,f=-Number.MAX_VALUE,h=-Number.MAX_VALUE,d=-Number.MAX_VALUE,v=0;v<a;++v){var y=3*v,p=e[y]-t,m=e[y+1]-r,g=e[y+2]-n;o+=p,u+=m,s+=g,p<_&&(_=p),m<l&&(l=m),g<c&&(c=g),p>f&&(f=p),m>h&&(h=m),g>d&&(d=g)}var b=this._pivot;b[0]=o/a,b[1]=u/a,b[2]=s/a;var w=this._bbox,x=w[0],E=w[1];x[0]=_,x[1]=l,x[2]=c,E[0]=f,E[1]=h,E[2]=d}},{key:"_createVertices",value:function(){for(var e=this._buffer,t=e[0],r=e[1],n=e[2],i=this._num_floats/3,a=i-1,o=4*a,u=new Float32Array(8*o),s=0;s<a;++s){var _=3*s,l=e[_]-t,c=e[_+1]-r,f=e[_+2]-n,h=e[_+3]-t,d=e[_+4]-r,v=e[_+5]-n,y=e[_+3]-e[_],p=e[_+4]-e[_+1],m=e[_+5]-e[_+2],g=32*s;u[g]=l,u[g+1]=c,u[g+2]=f,u[g+3]=y,u[g+4]=p,u[g+5]=m,u[g+6]=-1,u[g+7]=1,u[g+8]=l,u[g+9]=c,u[g+10]=f,u[g+11]=y,u[g+12]=p,u[g+13]=m,u[g+14]=-1,u[g+15]=-1,u[g+16]=h,u[g+17]=d,u[g+18]=v,u[g+19]=y,u[g+20]=p,u[g+21]=m,u[g+22]=1,u[g+23]=1,u[g+24]=h,u[g+25]=d,u[g+26]=v,u[g+27]=y,u[g+28]=p,u[g+29]=m,u[g+30]=1,u[g+31]=-1}return u}},{key:"_createIndices",value:function(){for(var e=this._num_floats/3,t=e-1,r=6*t,n=new Uint32Array(r),i=0;i<t;++i){var a=6*i,o=4*i;n[a]=o,n[a+1]=o+1,n[a+2]=o+2,n[a+3]=o+2,n[a+4]=o+1,n[a+5]=o+3}return n}},{key:"_setupByJson",value:function(e){this.addPoints(t._toCartesianPoints(e.points));var r=this._properties;e.line_width&&(r.width=e.line_width),e.color&&p.default.copyVector3(e.color,r.color),e.opacity&&(r.opacity=e.opacity)}}],[{key:"_toCartesianPoints",value:function(e){var t=e.type||"cartesian",r=e.coords,n=null;if("cartesian"==t)n=r;else if("cartographic"==t){var i=p.default.DEGREE,a=p.default.EARTH_RADIUS,o=r.length;n=new Float64Array(o);for(var u=0;u<o;u+=3){var s=r[u]*i,_=r[u+1]*i,l=r[u+2]+a,c=Math.sin(s),f=Math.cos(s),h=Math.sin(_),d=Math.cos(_);n[u]=l*d*f,n[u+1]=l*d*c,n[u+2]=l*h}}else console.error("mapray: unknown points type: "+t),n=[];return n}}]),t}(_.default);t.default=m,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(53),u=n(o),s=function(){function e(t,r,n){i(this,e);var a=new u.default(t,r,n);this._gl=t.context,this._program=this._link_shaders(a.vs_object,a.fs_object),this._vertex_attribs=this._create_vertex_attribs(),this._uniform_location=this._create_uniform_location(),a.dispose()}return a(e,[{key:"_link_shaders",value:function(e,t){var r=this._gl,n=r.createProgram();if(!n)throw new Error("プログラムオブジェクトの生成に失敗しました");try{if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){var i=r.getProgramInfoLog(n);throw r.detachShader(n,t),r.detachShader(n,e),new Error("シェーダのリンクに失敗: "+i)}}catch(e){throw r.deleteProgram(n),e}return n}},{key:"_create_vertex_attribs",value:function(){for(var e=this._gl,t=this._program,r=[],n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i),o={name:a.name,location:e.getAttribLocation(t,a.name)};r.push(o)}return r}},{key:"_create_uniform_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[a.name]=e.getUniformLocation(t,a.name)}return r}},{key:"dispose",value:function(){var e=this._gl;e.deleteProgram(this._program),this._program=null}},{key:"bindProgram",value:function(){var e=this._gl;e.useProgram(this._program)}},{key:"setInteger",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1i(r,t)}}},{key:"setFloat",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1f(r,t)}}},{key:"setVector2",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform2fv(r,t)}}},{key:"setVector3",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform3fv(r,t)}}},{key:"setVector4",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform4fv(r,t)}}},{key:"setMatrix",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniformMatrix4fv(r,!1,t)}}},{key:"bindVertexAttribs",value:function(e){for(var t=this._gl,r=this._vertex_attribs,n=r.length,i=0;i<n;++i){var a=r[i],o=e[a.name],u=a.location;void 0!==o?(t.bindBuffer(t.ARRAY_BUFFER,o.buffer),t.enableVertexAttribArray(u),t.vertexAttribPointer(u,o.num_components,o.component_type,o.normalized,o.byte_stride,o.byte_offset)):t.disableVertexAttribArray(u)}}},{key:"bindTexture2D",value:function(e,t){var r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t)}}]),e}();t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t;var a=i||{},o=t.context,u=e._getBindingPoint(o,a.target),s=o.createBuffer();o.bindBuffer(u,s),o.bufferData(u,n,o.STATIC_DRAW),o.bindBuffer(u,null),this._handle=s}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;e.deleteBuffer(this._handle),this._handle=null}},{key:"handle",get:function(){return this._handle}}],[{key:"_getBindingPoint",value:function(e,t){switch(t){default:case a.ATTRIBUTE:return e.ARRAY_BUFFER;case a.INDEX:return e.ELEMENT_ARRAY_BUFFER}}}]),e}(),a={ATTRIBUTE:{id:"ATTRIBUTE"},INDEX:{id:"INDEX"}};i.Target=a,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=r(1),o=n(a),u=function e(t,r){i(this,e),this.position=t||o.default.createVector3(),this.direction=r||o.default.createVector3([0,0,-1])};t.default=u,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this._viewer=null,this._is_started_=!1}return n(e,[{key:"attach",value:function(e){if(this._viewer)throw new Error("RenderCallback instance is already attached");this._viewer=e,this._is_started_=!1}},{key:"detach",value:function(){this._is_started_&&(this.onStop(),this._is_started_=!1),this._viewer=null}},{key:"onUpdateFrameInner",value:function(e){this._is_started_||(this.onStart(),this._is_started_=!0),this.onUpdateFrame(e)}},{key:"onStart",value:function(){}},{key:"onUpdateFrame",value:function(e){}},{key:"onStop",value:function(){}},{key:"viewer",get:function(){return this._viewer}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._glenv=t,this._entity_list=[],this._loaders=[]}return n(e,[{key:"clearEntities",value:function(){this._entity_list=[]}},{key:"addEntity",value:function(e){if(e.scene!==this)throw new Error("invalid entity");this._entity_list.push(e)}},{key:"removeEntity",value:function(e){var t=this._entity_list,r=t.indexOf(e);r>=0&&t.splice(r,1)}},{key:"getEntity",value:function(e){return this._entity_list[e]}},{key:"draw",value:function(e){for(var t=[],r=[],n=0;n<this._entity_list.length;++n){var i=this._entity_list[n];this._add_primitives(e,i,t,r)}this._draw_opaque_primitives(e,t),this._draw_translucent_primitives(e,r)}},{key:"_add_primitives",value:function(e,t,r,n){for(var i=t.getPrimitives(e),a=0;a<i.length;++a){var o=i[a];if(o.isVisible(e)){var u=o.isTranslucent(e)?n:r;u.push(o)}}}},{key:"_draw_opaque_primitives",value:function(e,t){t.sort(function(e,t){return t.sort_z-e.sort_z});var r=this._glenv.context;r.disable(r.BLEND),r.depthMask(!0);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"_draw_translucent_primitives",value:function(e,t){t.sort(function(e,t){return e.sort_z-t.sort_z});var r=this._glenv.context;r.enable(r.BLEND),r.depthMask(!1);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"cancelLoaders",value:function(){for(var e=this._loaders.concat(),t=0;t<e.length;++t)e[t].cancel()}},{key:"addLoader",value:function(e){this._loaders.push(e)}},{key:"removeLoader",value:function(e){var t=this._loaders.indexOf(e);t>=0&&this._loaders.splice(t,1)}},{key:"glenv",get:function(){return this._glenv}},{key:"num_entities",get:function(){return this._entity_list.length}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){}function o(e,t){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(1),_=n(s),l=r(3),c=n(l),f=r(6),h=n(f),d=r(8),v=n(d),y=r(47),p=n(y),m=r(15),g=n(m),b=r(19),w=n(b),x=r(28),E=n(x),k=r(48),T=n(k),M=r(72),O=n(M),A=function(){function e(t,r,n){i(this,e);var u=n||{};this._scene=t,this._url=r,this._callback=u.callback||a,this._transform=u.transform||o,this._glenv=t.glenv,this._references={},this._cancelled=!1,this._finished=!1,this._abort_ctrl=new AbortController,this._loadFile(),t.addLoader(this)}return u(e,[{key:"cancel",value:function(){var e=this;this._cancelled||(this._abort_ctrl.abort(),this._cancelled=!0,this._scene.removeLoader(this),Promise.resolve().then(function(){e._cancel_callback()}))}},{key:"getReference",value:function(e){var t=this._references[e];return void 0!==t?t:null}},{key:"_setReference",value:function(e,t){this._references[e]=t}},{key:"_loadFile",value:function(){var e=this,t=this._transform(this._url,P.SCENE);fetch(t.url,this._make_fetch_params(t)).then(function(t){return e._check_cancel(),t.ok?t.json():Promise.reject(Error(t.statusText))}).then(function(t){e._check_cancel(),e._load_object(t)}).catch(function(r){e._fail_callback("mapray: failed to retrieve: "+t.url)})}},{key:"_load_object",value:function(e){e.req_count=0,e.req_ended=!1,this._load_mesh_register(e),this._load_texture_register(e),this._load_model_register(e),0==e.req_count&&this._postload_object(e),e.req_ended=!0}},{key:"_postload_object",value:function(e){this._cancelled||(this._load_entity_list(e),this._success_callback())}},{key:"_postload_object_ifNoReq",value:function(e){--e.req_count,0==e.req_count&&e.req_ended&&this._postload_object(e)}},{key:"_load_mesh_register",value:function(e){var t=e.mesh_register;if(t)for(var r=Object.keys(t),n=0;n<r.length;++n){var i=r[n],a=t[i];a.binary?this._load_mesh_binary(e,i,a.binary):a.vertices&&this._setReference(i,new h.default(this._glenv,a))}}},{key:"_load_model_register",value:function(e){var t=e.model_register;if(t)for(var r=Object.keys(t),n=0;n<r.length;++n){var i=r[n],a=t[i];this._load_model_container(e,i,a)}}},{key:"_load_model_container",value:function(t,r,n){var i=this,a=n.link,o=this._transform(a,P.MODEL);fetch(o.url,this._make_fetch_params(o)).then(function(e){return i._check_cancel(),e.ok?e.json():Promise.reject(Error(e.statusText))}).then(function(e){return i._check_cancel(),O.default.load(e,{base_uri:a,transform_binary:function(e){return i._transform(e,P.BINARY)},transform_image:function(e){return i._transform(e,P.IMAGE)}})}).then(function(t){var a=new p.default(i._scene,t);if(n.offset_transform){var o=e.parseOffsetTransform(n.offset_transform);a.setOffsetTransform(o)}i._setReference(r,a)}).catch(function(){console.error("mapray: failed to retrieve: "+o.url)}).then(function(){i._postload_object_ifNoReq(t)}),++t.req_count}},{key:"_load_mesh_binary",value:function(e,t,r){var n=this,i=this._transform(r,P.MESH);fetch(i.url,this._make_fetch_params(i)).then(function(e){return n._check_cancel(),e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(e){n._check_cancel(),n._setReference(t,new h.default(n._glenv,e))}).catch(function(){console.error("mapray: failed to retrieve: "+i.url)}).then(function(){n._postload_object_ifNoReq(e)}),++e.req_count}},{key:"_load_texture_register",value:function(e){var t=e.texture_register;if(t)for(var r=Object.keys(t),n=0;n<r.length;++n){var i=r[n],a=t[i];a.image&&this._load_texture_image(e,i,a.image)}}},{key:"_load_texture_image",value:function(e,t,r){var n=this,i=new Image,a=this._transform(r,P.IMAGE);i.onload=function(){n._cancelled||n._setReference(t,new v.default(n._glenv,i)),n._postload_object_ifNoReq(e)},i.onerror=function(){console.error("mapray: failed to retrieve: "+a.url),n._postload_object_ifNoReq(e)},a.credentials===c.default.SAME_ORIGIN?i.crossOrigin="anonymous":a.credentials===c.default.INCLUDE&&(i.crossOrigin="use-credentials"),++e.req_count,i.src=a.url}},{key:"_load_entity_list",value:function(e){var t=e.entity_list;if(t)for(var r=this._scene,n=0;n<t.length;++n){var i=t[n],a=i.type||"generic",o=null;switch(a){case"generic":o=new g.default(r,{json:i,refs:this._references});break;case"markerline":o=new w.default(r,{json:i,refs:this._references});break;case"text":o=new E.default(r,{json:i,refs:this._references});break;case"model":o=new T.default(r,{json:i,refs:this._references});break;default:console.error("mapray: unknown entity type: "+a)}if(o){r.addEntity(o);var u=i.id;u&&this._setReference(u,o)}}}},{key:"_make_fetch_params",value:function(t){var r={signal:this._abort_ctrl.signal,credentials:(t.credentials||c.default.OMIT).credentials};return t.headers&&(r.headers=t.headers||e._defaultHeaders),r}},{key:"_check_cancel",value:function(){if(this._cancelled)throw new Error("canceled")}},{key:"_cancel_callback",value:function(){this._finished||this._callback(this,!1)}},{key:"_success_callback",value:function(){this._cancelled||(this._finished=!0,this._scene.removeLoader(this),this._callback(this,!0))}},{key:"_fail_callback",value:function(e){this._cancelled||(console.error(e),this._finished=!0,this._scene.removeLoader(this),this._callback(this,!1))}},{key:"scene",get:function(){return this._scene}},{key:"url",get:function(){return this._url}}],[{key:"parseOffsetTransform",value:function(e){var t=e,r=_.default.createMatrix();if(t.matrix)return _.default.copyMatrix(t.matrix,r);var n=t.translate||[0,0,0],i=t.heading||0,a=t.tilt||0,o=t.roll||0,u=void 0!==t.scale?t.scale:[1,1,1];return"number"==typeof u&&(u=[u,u,u]),_.default.kml_model_matrix(i,a,o,u,r),r[12]=n[0],r[13]=n[1],r[14]=n[2],r}}]),e}(),P={SCENE:{id:"SCENE"},IMAGE:{id:"IMAGE"},MESH:{id:"MESH"},MODEL:{id:"MODEL"},BINARY:{id:"BINARY"}};A.ResourceType=P,A._defaultHeaders={},t.default=A,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(9),_=n(s),l=r(3),c=n(l),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),u=n||{};return o._prefix=e,o._suffix=r,o._credentials=(u.credentials||c.default.OMIT).credentials,o._headers=Object.assign({},u.headers),o}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{credentials:this._credentials,headers:this._headers,signal:i.signal}).then(function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return this._prefix+e+"/"+t+"/"+r+this._suffix}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(2),_=n(s),l=r(3),c=n(l),f=function(e){function t(e,r,n,o,u,s){i(this,t);var _=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));_._prefix=e,_._suffix=r,_._size=n,_._min_level=o,_._max_level=u;var l;s&&s.coord_order&&(s.coord_order===h.ZYX?l=function(e,t,r){return e+"/"+r+"/"+t}:s.coord_order===h.XYZ&&(l=function(e,t,r){return t+"/"+r+"/"+e})),l||(l=function(e,t,r){return e+"/"+t+"/"+r});var f;return s&&s.coord_system&&s.coord_system===d.LOWER_LEFT&&(f=function(e,t,r){var n=Math.round(Math.pow(2,e));return l(e,t,n-r-1)}),f||(f=l),_._coords_part=f,_._crossOrigin="anonymous",s&&s.credentials&&(s.credentials===c.default.OMIT?_._crossOrigin=null:s.credentials===c.default.INCLUDE&&(_._crossOrigin="use-credentials")),_}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new Image;return i.onload=function(){n(i)},i.onerror=function(){n(null)},null!==this._crossOrigin&&(i.crossOrigin=this._crossOrigin),i.src=this._makeURL(e,t,r),i}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return this._size}},{key:"getZoomLevelRange",value:function(){return new _.default.Range(this._min_level,this._max_level)}},{key:"_makeURL",value:function(e,t,r){return this._prefix+this._coords_part(e,t,r)+this._suffix}}]),t}(_.default),h={ZXY:{id:"ZXY"},ZYX:{id:"ZYX"},XYZ:{id:"XYZ"}},d={UPPER_LEFT:{id:"UPPER_LEFT"},LOWER_LEFT:{id:"LOWER_LEFT"}};f.CoordOrder=h,f.CoordSystem=d,t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),_=n(s),l=r(7),c=n(l),f=r(6),h=n(f),d=r(8),v=n(d),y=r(55),p=n(y),m=r(1),g=n(m),b=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n._entries=[],n._dirty=!0,n._text_parent_props={font_style:"normal",font_weight:"normal",font_size:t.DEFAULT_FONT_SIZE,font_family:t.DEFAULT_FONT_FAMILY,color:g.default.createVector3f(t.DEFAULT_COLOR)},n._transform=g.default.setIdentity(g.default.createMatrix()),n._properties={image:null};var o=new c.default(e.glenv,null,n._getTextMaterial(),n._transform);return o.properties=n._properties,n._primitive=o,n._primitives=[],n._text_upper=t.DEFAULT_TEXT_UPPER,n._text_lower=t.DEFAULT_TEXT_LOWER,r&&r.json&&n._setupByJson(r.json),n}return o(t,e),u(t,[{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"setColor",value:function(e){this._setVector3Property("color",e)}},{key:"addText",value:function(e,t,r){this._entries.push(new w(this,e,t,r)),this._dirty=!0}},{key:"_getTextMaterial",value:function(){var e=this.scene;return e._TextEntity_text_material||(e._TextEntity_text_material=new p.default(e.glenv)),e._TextEntity_text_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._dirty=!0)}},{key:"_setVector3Property",value:function(e,t){var r=this._text_parent_props[e];r[0]==t[0]&&r[1]==t[1]&&r[2]==t[2]||(g.default.copyVector3(t,r),this._dirty=!0)}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;this._updateTransform();var e=new x(this);if(!e.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var t=this._properties;t.image&&t.image.dispose(),t.image=e.texture;var r={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_color",size:4}],vertices:e.vertices,indices:e.indices},n=new h.default(this.scene.glenv,r),i=this._primitive;return i.mesh&&i.mesh.dispose(),i.mesh=n,this._primitives=[i],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(){for(var e=this._entries.length,t=0,r=0,n=0,i=0;i<e;++i){var a=this._entries[i].position;t+=a[0],r+=a[1],n+=a[2]}var o=this._transform;o[12]=t/e,o[13]=r/e,o[14]=n/e}},{key:"_setupByJson",value:function(e){for(var r=e.entries,n=0;n<r.length;++n){var i=r[n];this.addText(i.text,t._toCartesian(i.position),i)}var a=this._text_parent_props;e.font_style&&(a.font_style=e.font_style),e.font_weight&&(a.font_weight=e.font_weight),e.font_size&&(a.font_size=e.font_size),e.font_family&&(a.font_family=e.font_family),e.color&&g.default.copyVector3(e.color,a.color)}}],[{key:"_toCartesian",value:function(e){var t=null;if(e.cartesian)t=e.cartesian;else if(e.cartographic){t=g.default.createVector3();var r=e.cartographic,n=g.default.DEGREE,i=r[0]*n,a=r[1]*n,o=r[2]+g.default.EARTH_RADIUS,u=Math.sin(i),s=Math.cos(i),_=Math.sin(a),l=Math.cos(a);t[0]=o*l*s,t[1]=o*l*u,t[2]=o*_}return t}}]),t}(_.default);b.DEFAULT_FONT_SIZE=16,b.DEFAULT_FONT_FAMILY="sans-serif",b.DEFAULT_COLOR=g.default.createVector3f([1,1,1]),b.DEFAULT_TEXT_UPPER=1.1,b.DEFAULT_TEXT_LOWER=.38,b.SAFETY_PIXEL_MARGIN=1,b.MAX_IMAGE_WIDTH=4096;var w=function(){function e(t,r,n,a){i(this,e),this._owner=t,this._text=r,this._position=g.default.createVector3f(n),this._props=Object.assign({},a),this._copyPropertyVector3f("color")}return u(e,[{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=g.default.createVector3f(t[e]))}},{key:"text",get:function(){return this._text}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.font_size||t.font_size}},{key:"color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.color||t.color}},{key:"font",get:function(){var e=this._props,t=this._owner._text_parent_props,r=e.font_style||t.font_style,n="normal",i=e.font_weight||t.font_weight,a=e.font_family||t.font_family;return r+" "+n+" "+i+" "+this.size+"px "+a}}]),e}(),x=function(){function e(t){i(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var r=this._createRowLayouts();if(0==r.length)return void(this._is_valid=!1);var n=this._setupLocation(r);this._texture=this._createTexture(n.width,n.height),this._vertices=this._createVertices(n.width,n.height),this._indices=this._createIndices()}return u(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){for(var t=this._owner._entries,r=e._createCanvasContext(1,1),n=[],i=0;i<t.length;++i)n.push(new E(this,t[i],r));return n}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort(function(e,t){return e.height_pixel-t.height_pixel});for(var t=[];e.length>0;){var r=new k(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(t,r){var n=e._createCanvasContext(t,r);n.textAlign="left",n.textBaseline="alphabetic",n.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var i=this._items,a=0;a<i.length;++a){var o=i[a];o.is_canceled||o.drawText(n)}var u=this._owner.scene.glenv,s={usage:v.default.Usage.TEXT};return new v.default(u,n.canvas,s)}},{key:"_createVertices",value:function(e,t){for(var r=[],n=this._owner._transform,i=n[12],a=n[13],o=n[14],u=this._items,s=0;s<u.length;++s){var _=u[s];if(!_.is_canceled){var l=_.entry,c=l.position,f=l.color,h=c[0]-i,d=c[1]-a,v=c[2]-o,y=_.pos_x,p=_.pos_y,m=_.upper,g=_.lower,b=_.width,w=1/e,x=1/t;r.push(h,d,v),r.push(-b/2,-g),r.push(y*w,1-(p+g)*x),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(b/2,-g),r.push((y+b)*w,1-(p+g)*x),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(-b/2,m),r.push(y*w,1-(p-m)*x),r.push(f[0],f[1],f[2],1),r.push(h,d,v),r.push(b/2,m),r.push((y+b)*w,1-(p-m)*x),r.push(f[0],f[1],f[2],1)}}return r}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled){var i=4*r;e.push(i,i+1,i+2,i+2,i+1,i+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=b.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+b.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}],[{key:"_createCanvasContext",value:function(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}}]),e}(),E=function(){function e(t,r,n){i(this,e),this._entry=r,this._pos_x=0,this._pos_y=0,n.font=r.font,this._width=n.measureText(r.text).width;var a=t._owner;this._upper=r.size*a._text_upper,this._lower=r.size*a._text_lower,this._is_canceled=!1}return u(e,[{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t+Math.ceil(this._upper)}},{key:"drawText",value:function(e){var t=this._entry;e.font=t.font,e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"entry",get:function(){return this._entry}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"upper",get:function(){return this._upper}},{key:"lower",get:function(){return this._lower}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._upper)+Math.ceil(this._lower)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),k=function(){function e(t){i(this,e);var r=0,n=0,a=[];for(r+=b.SAFETY_PIXEL_MARGIN;t.length>0;){var o=t.shift(),u=o.width_pixel+b.SAFETY_PIXEL_MARGIN;if(r+u<=b.MAX_IMAGE_WIDTH)a.push(o),r+=u,n=Math.max(o.height_pixel,n);else{if(0!=a.length){t.unshift(o);break}o.cancel()}}this._items=a,this._width_assumed=r,this._height_pixel=n}return u(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=b.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+b.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}();t.default=b,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(12),u=n(o),s=r(45),_=n(s),l=r(52),c=n(l),f=r(27),h=n(f),d=r(26),v=n(d),y=r(18),p=n(y),m=r(16),g=n(m),b=r(10),w=n(b),x=r(50),E=n(x),k=r(1),T=n(k),M=r(24),O=n(M),A=r(25),P=(n(A),function(){function e(t,r){i(this,e);var n;n="string"==typeof t?document.getElementById(t):t;var a=this._createCanvas(n);this._container_element=n,this._canvas_element=a,this._glenv=new _.default(a),this._camera=new u.default(a),this._dem_provider=this._createDemProvider(r),this._image_provider=this._createImageProvider(r),
this._layers=this._createLayerCollection(r),this._globe=new g.default(this._glenv,this._dem_provider),this._tile_texture_cache=new w.default(this._glenv,this._image_provider),this._scene=new O.default(this._glenv),this._ground_visibility=e._getBoolOption(r,"ground_visibility",!0),this._entity_visibility=e._getBoolOption(r,"entity_visibility",!0),this._render_mode=r&&r.render_mode||R.SURFACE,this._debug_stats=r&&r.debug_stats||null,this._render_callback=this._createRenderCallback(r),this._frame_req_id=0,this._previous_time=void 0,this._is_destroyed=!1,this._requestNextFrame(),this._updateCanvasSize()}return a(e,[{key:"destroy",value:function(){this._is_destroyed||(0!=this._frame_req_id&&(window.maprayCancelAnimationFrame(this._frame_req_id),this._frame_req_id=0),this._render_callback.detach(),this._render_callback=this._createRenderCallback(),this._container_element.removeChild(this._canvas_element),this._globe.cancel(),this._tile_texture_cache.cancel(),this._layers.cancel(),this._scene.cancelLoaders(),this._is_destroyed=!0)}},{key:"_createCanvas",value:function(e){var t=document.createElement("canvas");return t.className="mapray-canvas",t.style.width="100%",t.style.height="100%",e.appendChild(t),t}},{key:"_createDemProvider",value:function(e){return e&&e.dem_provider?e.dem_provider:new v.default("/dem/",".bin")}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider?e.image_provider:new h.default("http://cyberjapandata.gsi.go.jp/xyz/std/",".png",256,0,18)}},{key:"_createLayerCollection",value:function(e){var t=e&&e.layers?e.layers:{};return new p.default(this._glenv,t)}},{key:"_createRenderCallback",value:function(e){var t;return t=e&&e.render_callback?e.render_callback:new E.default,t.attach(this),t}},{key:"setVisibility",value:function(e,t){switch(e){case I.GROUND:this._ground_visibility=t;break;case I.ENTITY:this._entity_visibility=t;break;default:throw new Error("invalid target: "+e)}}},{key:"getVisibility",value:function(e,t){switch(e){case I.GROUND:return this._ground_visibility;case I.ENTITY:return this._entity_visibility;default:throw new Error("invalid target: "+e)}}},{key:"getElevation",value:function(e,t){var r=t+180*Math.floor((90-e)/360+Math.floor((90+e)/360)),n=90-Math.abs(90-e+360*Math.floor((90+e)/360)),i=r-360-360*Math.floor((r-180)/360),a=i*T.default.DEGREE,o=T.default.invGudermannian(n*T.default.DEGREE),u=2*Math.PI,s=a/u+.5,_=.5-o/u;if(_<0||_>1)return 0;var l=this._globe,c=l.findHighestAccuracy(s,_);if(null===c)return 0;var f=l.dem_provider.getResolutionPower(),h=1<<f,d=Math.pow(2,c.z),v=h*(d*s-c.x),y=h*(d*_-c.y),p=T.default.clamp(Math.floor(v),0,h-1),m=T.default.clamp(Math.floor(y),0,h-1),g=c.getHeights(p,m),b=g[0],w=g[1],x=g[2],E=g[3],k=v-p,M=y-m;return(b*(1-k)+w*k)*(1-M)+(x*(1-k)+E*k)*M}},{key:"getRayIntersection",value:function(e){var t=this._globe;if(t.status!==g.default.Status.READY)return null;var r=t.root_flake.findRayDistance(e,Number.MAX_VALUE);if(r===Number.MAX_VALUE)return null;var n=T.default.createVector3(),i=e.position,a=e.direction;return n[0]=i[0]+r*a[0],n[1]=i[1]+r*a[1],n[2]=i[2]+r*a[2],n}},{key:"_requestNextFrame",value:function(){var e=this;this._frame_req_id=window.maprayRequestAnimationFrame(function(){return e._updateFrame()})}},{key:"_updateFrame",value:function(){var e=this._updateTime();this._requestNextFrame(),this._updateCanvasSize(),this._render_callback.onUpdateFrameInner(e),null!==this._debug_stats&&this._debug_stats.clearStats();var t=new c.default(this);t.render(),this._finishDebugStats()}},{key:"_updateTime",value:function(){var e=window.maprayNow(),t=void 0!==this._previous_time?(e-this._previous_time)/1e3:0;return this._previous_time=e,t}},{key:"_updateCanvasSize",value:function(){var e=this._canvas_element;e.width!=e.clientWidth&&(e.width=e.clientWidth),e.height!=e.clientHeight&&(e.height=e.clientHeight)}},{key:"_finishDebugStats",value:function(){var e=this._debug_stats;null!==e&&(e.num_wait_reqs_dem=this._globe.getNumDemWaitingRequests(),e.num_wait_reqs_img=this._tile_texture_cache.getNumWaitingRequests(),e.onUpdate())}},{key:"container_element",get:function(){return this._container_element}},{key:"canvas_element",get:function(){return this._canvas_element}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"image_provider",get:function(){return this._image_provider}},{key:"layers",get:function(){return this._layers}},{key:"render_callback",get:function(){return this._render_callback}},{key:"render_mode",get:function(){return this._render_mode},set:function(e){this._render_mode=e}},{key:"debug_stats",get:function(){return this._debug_stats}},{key:"camera",get:function(){return this._camera}},{key:"scene",get:function(){return this._scene}},{key:"glenv",get:function(){return this._glenv}},{key:"globe",get:function(){return this._globe}},{key:"tile_texture_cache",get:function(){return this._tile_texture_cache}}],[{key:"_getBoolOption",value:function(e,t,r){return e&&void 0!==e[t]?e[t]:r}}]),e}()),I={GROUND:{id:"GROUND"},ENTITY:{id:"ENTITY"}},R={SURFACE:{id:"SURFACE"},WIREFRAME:{id:"WIREFRAME"}};P.Category=I,P.RenderMode=R,t.default=P,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e);var i=t.gjson.bufferViews[n];this._buffer=t.findBuffer(i.buffer),this._byteLength=i.byteLength,this._target=i.target,this._byteOffset=void 0!==i.byteOffset?i.byteOffset:0,this._byteStride=void 0!==i.byteStride?i.byteStride:0}return n(e,[{key:"rebuildBySplitter",value:function(e){this._buffer=e,this._byteLength=e.byteLength,this._byteOffset=0}},{key:"buffer",get:function(){return this._buffer}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"byteStride",get:function(){return this._byteStride}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e),this._scene=t,this._default_scene_index=n}return n(e,[{key:"scenes",get:function(){return this._scene}},{key:"default_scene_index",get:function(){return this._default_scene_index}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(11),_=n(s),l=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._scale=void 0!==e.scale?e.scale:1,n}return o(t,e),u(t,[{key:"texCoord",get:function(){return this._scale}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(11),_=n(s),l=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._strength=void 0!==e.strength?e.strength:1,n}return o(t,e),u(t,[{key:"strength",get:function(){return this._strength}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){if(r(this,e),this._ρ=t,this._maps=[],t>=1){var i=this._create_first_map(n);this._maps.push(i);for(var a=i,o=-2;o>=-t;--o){var u=this._create_next_map(o,a);this._maps.push(u),a=u}}}return n(e,[{key:"_create_first_map",value:function(e){for(var t=4,r=1<<this._ρ-1,n=new Float32Array(r*r),i=(2*r+1)*t,a=r,o=0;o<r;++o)for(var u=2*o*i,s=o*a,_=0;_<r;++_){var l=e.getFloat32(u,!0),c=e.getFloat32(u+t,!0),f=e.getFloat32(u+2*t,!0),h=e.getFloat32(u+i,!0),d=e.getFloat32(u+i+t,!0),v=e.getFloat32(u+i+2*t,!0),y=e.getFloat32(u+2*i,!0),p=e.getFloat32(u+2*i+t,!0),m=e.getFloat32(u+2*(i+t),!0);n[s]=(l+2*c+f+2*h+4*d+2*v+y+2*p+m)/16,u+=2*t,s+=1}return n}},{key:"_create_next_map",value:function(e,t){for(var r=1<<this._ρ+e,n=new Float32Array(r*r),i=2*r,a=r,o=0;o<r;++o)for(var u=2*o*i,s=o*a,_=0;_<r;++_){var l=t[u],c=t[u+1],f=t[u+i],h=t[u+i+1];n[s]=(l+c+f+h)/4,u+=2,s+=1}return n}},{key:"sample",value:function(e,t,r){var n=this._maps[this._ρ-e-1],i=1<<e;return n[r*i+t]}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(5),_=n(s),l=r(74),c=n(l),f=r(73),h=n(f),d=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.default,h.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),u(t,[{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=n["diffuse-map"];this.bindTexture2D(t.TEXUNIT_IMAGE,i.handle)}}]),t}(_.default);d.TEXUNIT_IMAGE=0,t.default=d,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._length=t,this._array=new Uint32Array(Math.ceil(t/32))}return n(e,[{key:"setBit",value:function(e,t){var r=Math.floor(e/32),n=this._array[r],i=1<<e%32;this._array[r]=t?n|i:n&~i}},{key:"getBit",value:function(e){var t=Math.floor(e/32),r=this._array[t],n=1<<e%32;return 0!=(r&n)}},{key:"length",get:function(){return this._length}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(9),_=n(s),l=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._headers={"X-Api-Key":e},r}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{headers:this._headers,signal:i.signal}).then(function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return"https://tiles.mapray.com/dem/"+e+"/"+t+"/"+r+".bin"}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this.clearStats()}return n(e,[{key:"clearStats",value:function(){this.num_wait_reqs_dem=0,this.num_wait_reqs_img=0,this.num_drawing_flakes=0,this.num_drawing_flake_vertices=0,this.num_procA_flakes=0,this.num_procB_flakes=0}},{key:"onUpdate",value:function(){}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(40),_=n(s),l=r(41),c=n(l),f=r(34),h=n(f),d=function(){function e(t,r,n,a,o){i(this,e),this._z=t,this._x=r,this._y=n,this._ρ=a;var u=new DataView(o);this._qlevels=[u.getUint8(e.OFFSET_QLEVEL_00),u.getUint8(e.OFFSET_QLEVEL_10),u.getUint8(e.OFFSET_QLEVEL_01),u.getUint8(e.OFFSET_QLEVEL_11)],this._hmin=u.getFloat32(e.OFFSET_HMIN,!0),this._hmax=u.getFloat32(e.OFFSET_HMAX,!0),this._ω=this._createωArray(u),this._body=new DataView(o,e.HEADER_BYTES),this._size=(1<<a)+1}return a(e,[{key:"isLeaf",value:function(e,t,r){if(e>this._z)return 0==this.getQuadLevel(e,t,r);var n=this._qlevels;return 0==n[0]||0==n[1]||0==n[2]||0==n[3]}},{key:"getQuadLevel",value:function(e,t,r){var n=Math.pow(2,this._z-e),i=Math.floor(2*((t+.5)*n-this._x)),a=Math.floor(2*((r+.5)*n-this._y));return this._qlevels[2*a+i]}},{key:"getQuadLevelDirect",value:function(e,t){var r=Math.round(Math.pow(2,this._z+1)),n=u.default.clamp(Math.floor(e*r),0,r-1)%2,i=u.default.clamp(Math.floor(t*r),0,r-1)%2;return this._qlevels[2*i+n]}},{key:"getHeights",value:function(t,r){var n=4,i=n*(r*this._size+t),a=n*this._size,o=e._getHeights_result;return o[0]=this._body.getFloat32(i,!0),o[1]=this._body.getFloat32(i+n,!0),o[2]=this._body.getFloat32(i+a,!0),o[3]=this._body.getFloat32(i+a+n,!0),o}},{key:"getDivisionPowers",value:function(t,r,n,i){var a=t.z,o=this._z,s=u.default.LOG2PI-this._ρ+1,_=this._getComplexity(a,t.x,t.y),l=Math.min(o+this._ρ,Math.round(r+s+_))-a,c=e._getDivisionPowers_result;return c[0]=Math.max(n,l),c[1]=Math.max(i,l),c}},{key:"newSampler",value:function(e){var t=e.z-this._z>this._ρ?_.default:c.default;return new t(this._z,this._x,this._y,this._ρ,this._body)}},{key:"newAvgHeightMaps",value:function(){return new h.default(this._ρ,this._body)}},{key:"_createωArray",value:function(t){for(var r=4,n=[],i=0,a=0;a<3;++a){for(var o=1<<2*a,u=new Float32Array(o),s=0;s<o;++s)u[s]=t.getFloat32(e.OFFSET_ω+i,!0),i+=r;n.push(u)}return n}},{key:"_getComplexity",value:function(t,r,n){var i,a,o=t-this._z,u=Math.round(Math.pow(2,o)),s=2,_=4;o<=s?(i=r-u*this._x,a=n-u*this._y):(i=Math.floor(_*((r+.5)/u-this._x)),a=Math.floor(_*((n+.5)/u-this._y)));var l=Math.min(o,s),c=this._ω[l];return Math.min(c[a*(1<<l)+i],e.ω_limit)}},{key:"z",get:function(){return this._z}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"height_min",get:function(){return this._hmin}},{key:"height_max",get:function(){return this._hmax}}]),e}();d.OFFSET_QLEVEL_00=0,d.OFFSET_QLEVEL_10=1,d.OFFSET_QLEVEL_01=2,d.OFFSET_QLEVEL_11=3,d.OFFSET_HMIN=4,d.OFFSET_HMAX=8,d.OFFSET_ω=12,d.HEADER_BYTES=96,d.ω_limit=6,d._getHeights_result=new Array(4),d._getDivisionPowers_result=new Array(2),t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(13),_=n(s),l=r(1),c=n(l),f=function(e){function t(e,r,n,o,u){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,u))}return o(t,e),u(t,[{key:"sample",value:function(e,t){var r=this._sx*e+this._ox,n=Math.floor(r),i=n+1,a=this._sy*t+this._oy,o=Math.floor(a),u=o+1,s=this._sampleInt(n,o),_=this._sampleInt(i,o),l=this._sampleInt(n,u),c=this._sampleInt(i,u),f=r-n,h=a-o;return(s*(1-f)+_*f)*(1-h)+(l*(1-f)+c*f)*h}},{key:"_sampleInt",value:function(e,t){var r=4,n=c.default.clamp(e,0,this._max),i=c.default.clamp(t,0,this._max),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(13),_=n(s),l=function(e){function t(e,r,n,o,u){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,u))}return o(t,e),u(t,[{key:"sample",value:function(e,t){var r=4,n=Math.round(this._sx*e+this._ox),i=Math.round(this._sy*t+this._oy),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(2),_=n(s),l=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){return this}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return 4096}},{key:"getZoomLevelRange",value:function(){return new _.default.Range(0,0)}}]),t}(_.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(51),_=n(s),l=function(){function e(t){i(this,e),this._setupViewVectors(t),this._setupClipPlanes(t);var r=t._viewer,n=r.dem_provider,a=r.tile_texture_cache;this._min_image_z=a.getImageZMin();var o=u.default.LOG2PI-n.getResolutionPower()+1;this._max_zbias=Math.max(a.getImageZBias(),o),this._globe=r.globe,this._rflake_list=[],this._debug_stats=r.debug_stats,this._debug_stats&&(this._num_procA_flakes=0,this._num_procB_flakes=0),this._view_dir_N=u.default.createVector3(),this._view_dir_V=u.default.createVector3()}return a(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=u.default.createVector3(),i=u.default.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view,n=e._volume_planes,i=[],a=e._viewer._globe.root_flake,o=u.default.EARTH_RADIUS+a.height_min,s=u.default.EARTH_RADIUS+a.height_max,_=t[12],l=t[13],c=t[14],f=_*_+l*l+c*c,h=o*o,d=s*s,v=Math.sqrt((f-h)*(d-h))-h,y=u.default.createVector4(),p=1/Math.sqrt(f);y[0]=_*p,y[1]=l*p,y[2]=c*p,y[3]=v*p,i.push(y);for(var m=Math.sqrt(f+d+2*v),g=0;g<6;++g){var b=n[g],w=u.default.createVector4();1==g&&b[3]>m&&(b=u.default.createVector4(b),b[3]=m),u.default.transformPlane_A(r,b,w),i.push(w)}this._clip_planes=i}},{key:"traverse",value:function(){return this._collectFlakes(this._globe.root_flake),this._debug_stats&&(this._debug_stats.num_procA_flakes=this._num_procA_flakes,this._debug_stats.num_procB_flakes=this._num_procB_flakes),this._rflake_list}},{key:"_collectFlakes",value:function(t){if(null!==this._debug_stats&&(this._num_procA_flakes+=1),!t.isInvisible(this._clip_planes)){if(t.z<this._min_image_z)return void this._collectNextLevelFlakes(t);null!==this._debug_stats&&(this._num_procB_flakes+=1);var r=this._getLevelOfDetailRange(t),n=r.mid+this._max_zbias;return r.max-r.min>e.MAX_LOD_INTERVAL||n>t.z?void this._collectNextLevelFlakes(t):void this._addRenderFlake(t,r)}}},{key:"_collectNextLevelFlakes",value:function(e){for(var t=0;t<2;++t)for(var r=0;r<2;++r)this._collectFlakes(e.newChild(r,t))}},{key:"_getLevelOfDetailRange",value:function(e){for(var t=Math.PI,r=e.z,n=e.x,i=e.y,a=Math.pow(2,1-r)*t,o=-t+n*a,s=t-(i+1)*a,_=t/32,l=Math.ceil(a/_),c=a/l,f=u.default.EARTH_RADIUS+e.base_height,h=this._view_pos_Q,d=this._view_dir_wU,v=this._view_dir_N,y=this._view_dir_V,p=Number.MAX_VALUE,m=-Number.MAX_VALUE,g=0,b=s;g<l+1;++g,b+=c)for(var w=Math.exp(b),x=w*w,E=(x-1)/(x+1),k=2*w/(x+1),T=1/(f*k),M=0,O=o;M<l+1;++M,O+=c){var A=Math.sin(O),P=Math.cos(O);v[0]=k*P,v[1]=k*A,v[2]=E,y[0]=f*v[0]-h[0],y[1]=f*v[1]-h[1],y[2]=f*v[2]-h[2];var I=u.default.dot3(d,y);if(I<=0)return{min:-1e3,max:1e3,mid:0};var R=I*T;p=Math.min(p,R),m=Math.max(m,R)}var N=-Math.maprayLog2(m),F=-Math.maprayLog2(p);return{min:N,max:F,mid:(N+F)/2}}},{key:"_calcLOD",value:function(e,t){var r=Math.sin(e),n=Math.cos(e),i=Math.exp(t),a=i*i,o=(a-1)/(a+1),s=2*i/(a+1),_=u.default.EARTH_RADIUS,l=this._view_dir_N;l[0]=s*n,l[1]=s*r,l[2]=o;var c=this._view_dir_V,f=this._view_pos_Q;c[0]=_*l[0]-f[0],c[1]=_*l[1]-f[1],c[2]=_*l[2]-f[2];var h=this._view_dir_wU,d=u.default.dot3(h,c),v=_*s/d;return Math.maprayLog2(v)}},{key:"_setCornerLODs",value:function(e){var t=Math.PI,r=e.flake,n=r.z,i=r.x,a=r.y,o=Math.pow(2,1-n)*t,u=-t+i*o,s=-t+(i+1)*o,_=t-(a+1)*o,l=t-a*o;e.lod_00=this._calcLOD(u,_),e.lod_10=this._calcLOD(s,_),e.lod_01=this._calcLOD(u,l),e.lod_11=this._calcLOD(s,l)}},{key:"_addRenderFlake",value:function(e,t){var r=new _.default(e);r.lod=t.mid,this._setCornerLODs(r),this._rflake_list.push(r)}}]),e}();l.MAX_LOD_INTERVAL=.5,t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(t,r,n,a){i(this,e);var o=t.context;this._center=this._createCenter(r),this._vertices=null,this._num_vertices=0,this._vertex_attribs={},this._num_quads_x=0,this._num_quads_y=0,this._createVertices(o,r,n,a),this._setupVertexAttribs(o),this._index_type=this._num_vertices<65536?o.UNSIGNED_SHORT:o.UNSIGNED_INT,this._indices=null,this._num_indices=0,this._wire_indices=null,this._num_wire_indices=0,this._gl=o}return a(e,[{key:"_createCenter",value:function(e){var t=e.z,r=e.x,n=e.y,i=u.default.createVector3();switch(t){case 0:return this._getCenter_0(i);case 1:return this._getCenter_1(r,n,i);default:return this._getCenter_N(t,r,n,i)}}},{key:"_getCenter_0",value:function(e){return e[0]=0,e[1]=0,e[2]=0,e}},{key:"_getCenter_1",value:function(e,t,r){var n=u.default.EARTH_RADIUS;return r[0]=0,r[1]=n*(e-.5),r[2]=n*(.5-t),r}},{key:"_getCenter_N",value:function(e,t,r,n){var i=Math.PI,a=Math.pow(2,1-e)*i,o=-i+t*a,s=-i+(t+1)*a,_=i-(r+1)*a,l=i-r*a,c=o,f=s,h=Math.exp(_),d=Math.exp(l),v=h*h,y=d*d,p=u.default.EARTH_RADIUS/2,m=2*h/(v+1),g=2*d/(y+1);return _+l<0?c+f<-i?(n[0]=p*(g*Math.cos(c)+m*Math.cos(f)),n[1]=p*(g*Math.sin(f)+m*Math.sin(c))):c+f<0?(n[0]=p*(m*Math.cos(c)+g*Math.cos(f)),n[1]=p*(g*Math.sin(c)+m*Math.sin(f))):c+f<i?(n[0]=p*(m*Math.cos(f)+g*Math.cos(c)),n[1]=p*(m*Math.sin(c)+g*Math.sin(f))):(n[0]=p*(g*Math.cos(f)+m*Math.cos(c)),n[1]=p*(m*Math.sin(f)+g*Math.sin(c))):c+f<-i?(n[0]=p*(m*Math.cos(c)+g*Math.cos(f)),n[1]=p*(m*Math.sin(f)+g*Math.sin(c))):c+f<0?(n[0]=p*(g*Math.cos(c)+m*Math.cos(f)),n[1]=p*(m*Math.sin(c)+g*Math.sin(f))):c+f<i?(n[0]=p*(g*Math.cos(f)+m*Math.cos(c)),n[1]=p*(g*Math.sin(c)+m*Math.sin(f))):(n[0]=p*(m*Math.cos(f)+g*Math.cos(c)),n[1]=p*(g*Math.sin(f)+m*Math.sin(c))),n[2]=2*p*(y/(y+1)-1/(v+1)),n}},{key:"_createVertices",value:function(e,t,r,n){var i=e.ARRAY_BUFFER,a=e.createBuffer(),o=this._createVerticesData(t,r,n);e.bindBuffer(i,a),e.bufferData(i,o.array,e.STATIC_DRAW),e.bindBuffer(i,null),this._vertices=a,this._num_vertices=o.num_vertices,this._num_quads_x=o.num_quads_x,this._num_quads_y=o.num_quads_y}},{key:"_createVerticesData",value:function(t,r,n){for(var i=Math.pow(2,1-t.z)*Math.PI,a=t.x*i-Math.PI,o=Math.PI-(t.y+1)*i,s=1<<r[0],_=1<<r[1],l=1/s,c=1/_,f=i/s,h=i/_,d=this._center,v=n.newSampler(t),y=(s+1)*(_+1),p=new Float32Array(e.VERTEX_SIZE*y),m=0,g=0,b=o;g<_+1;++g,b+=h)for(var w=Math.exp(b),x=w*w,E=(x-1)/(x+1),k=2*w/(x+1),T=0,M=a;T<s+1;++T,M+=f){var O=Math.sin(M),A=Math.cos(M),P=v.sample(M,b),I=u.default.EARTH_RADIUS+P,R=k*A,N=k*O,F=E,L=I*R,D=I*N,S=I*F;p[m++]=L-d[0],p[m++]=D-d[1],p[m++]=S-d[2],p[m++]=R,p[m++]=N,p[m++]=F,p[m++]=T*l,p[m++]=g*c}return{array:p,num_vertices:y,num_quads_x:s,num_quads_y:_}}},{key:"_setupVertexAttribs",value:function(t){var r=t.FLOAT,n=e.VERTEX_BYTES;this._vertex_attribs={a_position:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_P},a_normal:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_N},a_uv:{buffer:this._vertices,num_components:2,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_UV}}}},{key:"_createIndices",value:function(){for(var e=this._gl,t=this._num_quads_x*this._num_quads_y,r=6*t,n=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,i=new n(r),a=0,o=0;o<this._num_quads_y;++o)for(var u=0;u<this._num_quads_x;++u){var s=(this._num_quads_x+1)*o+u,_=s+1,l=s+this._num_quads_x+1,c=l+1;i[a++]=s,i[a++]=_,i[a++]=l,i[a++]=l,i[a++]=_,i[a++]=c}var f=e.ELEMENT_ARRAY_BUFFER,h=e.createBuffer();e.bindBuffer(f,h),e.bufferData(f,i,e.STATIC_DRAW),e.bindBuffer(f,null),this._indices=h,this._num_indices=r}},{key:"_createWireIndices",value:function(){for(var e=this._gl,t=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,r=2*(2*this._num_quads_x*this._num_quads_y+this._num_quads_x+this._num_quads_y),n=new t(r),i=0,a=0;a<this._num_quads_y+1;++a)for(var o=0;o<this._num_quads_x;++o){var u=(this._num_quads_x+1)*a+o,s=u+1;n[i++]=u,n[i++]=s}for(o=0;o<this._num_quads_x+1;++o)for(a=0;a<this._num_quads_y;++a){var _=(this._num_quads_x+1)*a+o,l=_+this._num_quads_x+1;n[i++]=_,n[i++]=l}var c=e.ELEMENT_ARRAY_BUFFER,f=e.createBuffer();e.bindBuffer(c,f),e.bufferData(c,n,e.STATIC_DRAW),e.bindBuffer(c,null),this._wire_indices=f,this._num_wire_indices=r}},{key:"dispose",value:function(){var e=this._gl;this._vertex_attribs={},e.deleteBuffer(this._vertices),this._vertices=null,this._indices&&(e.deleteBuffer(this._indices),
this._indices=null),this._wire_indices&&(e.deleteBuffer(this._wire_indices),this._wire_indices=null)}},{key:"mul_flake_to_gocs",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],u=e[5],s=e[9],_=e[13],l=e[2],c=e[6],f=e[10],h=e[14],d=e[3],v=e[7],y=e[11],p=e[15],m=this._center[0],g=this._center[1],b=this._center[2];return t[0]=r,t[1]=o,t[2]=l,t[3]=d,t[4]=n,t[5]=u,t[6]=c,t[7]=v,t[8]=i,t[9]=s,t[10]=f,t[11]=y,t[12]=r*m+n*g+i*b+a,t[13]=o*m+u*g+s*b+_,t[14]=l*m+c*g+f*b+h,t[15]=d*m+v*g+y*b+p,t}},{key:"draw",value:function(e){var t=this._gl,r=e.isWireframe();e.bindVertexAttribs(this._vertex_attribs);var n=r?this.wire_indices:this.indices;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);var i=r?t.LINES:t.TRIANGLES,a=r?this.num_wire_indices:this.num_indices;t.drawElements(i,a,this._index_type,0)}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"indices",get:function(){return null===this._indices&&this._createIndices(),this._indices}},{key:"num_indices",get:function(){return null===this._indices&&this._createIndices(),this._num_indices}},{key:"wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._wire_indices}},{key:"num_wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._num_wire_indices}}]),e}();s.VERTEX_SIZE=8,s.VERTEX_BYTES=4*s.VERTEX_SIZE,s.OFFSET_P=0,s.OFFSET_N=12,s.OFFSET_UV=24,t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e);var n={depth:!0,antialias:!0},i=this._getContextWebGL(t,n);if(!i)throw new Error("It doesn't appear your computer can support WebGL.");this._canvas=t,this._context=i,this._setupExtensions(i)}return n(e,[{key:"_getContextWebGL",value:function(e,t){for(var r=["webgl","experimental-webgl"],n=0;n<r.length;++n){var i=e.getContext(r[n],t);if(i)return i}return null}},{key:"_setupExtensions",value:function(e){this.OES_element_index_uint=e.getExtension("OES_element_index_uint"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(5),_=n(s),l=r(1),c=n(l),f=r(76),h=n(f),d=r(75),v=n(d),y=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default))}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties,i=n.opacity||t.DEFAULT_OPACITY;return i<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,i[2]=e._height/e._width,this.setVector3("u_sparam",i);var a=n.width||t.DEFAULT_WIDTH,o=t._thickness;o[0]=a/2,o[1]=a/2,this.setVector2("u_thickness",o);var u=n.color||t.DEFAULT_COLOR,s=n.opacity||t.DEFAULT_OPACITY,_=t._color;c.default.copyVector3(u,_),_[3]=s,this.setVector4("u_color",_)}}]),t}(_.default);y.DEFAULT_WIDTH=1,y.DEFAULT_COLOR=c.default.createVector3f([1,1,1]),y.DEFAULT_OPACITY=1,y._sparam=c.default.createVector3f(),y._thickness=c.default.createVector2f(),y._color=c.default.createVector4f(),t.default=y,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(31),u=(n(o),r(1)),s=n(u),_=r(7),l=n(_),c=r(6),f=n(c),h=r(21),d=n(h),v=r(8),y=n(v),p=r(49),m=n(p),g=r(32),b=n(g),w=r(33),x=n(w),E=function(){function e(t,r){i(this,e),this._entries=[],this._name_map={},this._default=null,this._offset_transform=s.default.setIdentity(s.default.createMatrix());var n={},a=!0,o=!1,u=void 0;try{for(var _,l=r.scenes[Symbol.iterator]();!(a=(_=l.next()).done);a=!0){var c=_.value,f=new k(t,c,n);this._entries.push(f),null!==c.name&&(this._name_map[c.name]=f)}}catch(e){o=!0,u=e}finally{try{!a&&l.return&&l.return()}finally{if(o)throw u}}if(r.default_scene_index>=0){if(!(r.default_scene_index<this._entries.length))throw new Error("default_scene_index is out of range");this._default=this._entries[r.default_scene_index]}else this._entries.length>=1&&(this._default=this._entries[0])}return a(e,[{key:"setOffsetTransform",value:function(e){s.default.copyMatrix(e,this._offset_transform)}},{key:"createPrimitives",value:function(e){var t=this._getEntry(e);if(null===t)return null;var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=t.primitives[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var _=o.value,l=_.fastClone();s.default.mul_AA(this._offset_transform,l.transform,l.transform),l.properties=T.fastCloneProperties(l.properties),r.push(l)}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}},{key:"_getEntry",value:function(e){if("number"==typeof e){if(0<=e&&e<this._entries.length)return this._entries[e]}else if("string"==typeof e){if(this._name_map.hasOwnProperty(e))return this._name_map[e]}else if(this._entries.length>0)return this._entries[0];return null}}]),e}(),k=function(){function e(t,r,n){i(this,e);var a=new T(t,r,n);this._primitives=a.primitives}return a(e,[{key:"primitives",get:function(){return this._primitives}}]),e}(),T=function(){function e(t,r,n){i(this,e),n.buffer_map||(n.buffer_map=new Map,n.texture_map=new Map),this._mr_scene=t,this._glenv=t.glenv,this._primitives=[],this._buffer_map=n.buffer_map,this._texture_map=n.texture_map;var a=s.default.setIdentity(s.default.createMatrix()),o=!0,u=!1,_=void 0;try{for(var l,c=r.root_nodes[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var f=l.value;this._addNode(f,a)}}catch(e){u=!0,_=e}finally{try{!o&&c.return&&c.return()}finally{if(u)throw _}}}return a(e,[{key:"_addNode",value:function(t,r){var n=e._getNodeToScene(t,r);if(null!==t.mesh){var i=!0,a=!1,o=void 0;try{for(var u,s=t.mesh.primitives[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var _=u.value;this._primitives.push(this._createPrimitive(_,n))}}catch(e){a=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(a)throw o}}}var l=!0,c=!1,f=void 0;try{for(var h,d=t.children[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var v=h.value;this._addNode(v,n)}}catch(e){c=!0,f=e}finally{try{!l&&d.return&&d.return()}finally{if(c)throw f}}}},{key:"_createPrimitive",value:function(e,t){var r=this._createMesh(e),n=this._createMaterial(e),i=new l.default(this._glenv,r,n,s.default.createMatrix(t));return i.pivot=this._createMeshPivot(e),i.bbox=this._createBoundingBox(e),i.properties=this._createProperties(e),i}},{key:"_createMesh",value:function(t){var r=new f.default.Initializer(e._convertPrimitiveMode(t),e._calcNumVertices(t)),n=t.attributes;for(var i in n)this._addAttribToInit(r,i,n[i]);var a=t.indices;return null!==a&&this._addIndexToInit(r,a),new f.default(this._glenv,r)}},{key:"_addAttribToInit",value:function(t,r,n){var i=this._findMeshBuffer(n.bufferView.buffer,d.default.Target.ATTRIBUTE),a=e._NumComponents[n.type],o=e._ComponentType[n.componentType],u={normalized:n.normalized,byte_stride:n.bufferView.byteStride,byte_offset:n.bufferView.byteOffset+n.byteOffset},s=e._VertexAttribId[r]||r;t.addAttribute(s,i,a,o,u)}},{key:"_addIndexToInit",value:function(t,r){var n=this._findMeshBuffer(r.bufferView.buffer,d.default.Target.INDEX),i=r.count,a=e._ComponentType[r.componentType],o={byte_offset:r.bufferView.byteOffset+r.byteOffset};t.addIndex(n,i,a,o)}},{key:"_findMeshBuffer",value:function(e,t){var r=this._buffer_map.get(e);return void 0===r&&(r=new d.default(this._glenv,e.binary,{target:t}),this._buffer_map.set(e,r)),r}},{key:"_createMaterial",value:function(e){var t=this._mr_scene;return t._ModelEntity_model_material||(t._ModelEntity_model_material=new m.default(t.glenv)),t._ModelEntity_model_material}},{key:"_createMeshPivot",value:function(e){var t=null,r=this._createBoundingBox(e);if(null!==r){t=s.default.createVector3();for(var n=0;n<3;++n)t[n]=(r[0][n]+r[1][n])/2}return t}},{key:"_createBoundingBox",value:function(e){var t=null,r=e.attributes.POSITION;if(void 0!==r){var n=r.min,i=r.max;null!==n&&null!==i&&(t=[s.default.createVector3(n),s.default.createVector3(i)])}return t}},{key:"_createProperties",value:function(e){var t=e.material;if(null===t)return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector4f([1,1,1,1]),baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},doubleSided:!1,alphaMode:"OPAQUE",alphaCutoff:.5,emissiveFactor:s.default.createVector3f([0,0,0]),emissiveTexture:null,normalTexture:null,occlusionTexture:null};var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector4f(r.baseColorFactor),baseColorTexture:this._createTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:this._createTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:s.default.createVector3f(t.emissiveFactor),emissiveTexture:this._createTextureParam(t.emissiveTexture),normalTexture:this._createTextureParam(t.normalTexture),occlusionTexture:this._createTextureParam(t.occlusionTexture)}}},{key:"_createTextureParam",value:function(e){if(null===e)return null;var t={texture:this._findTexture(e.texture),texCoord:e.texCoord};return e instanceof b.default?t.scale=e.scale:e instanceof x.default&&(t.strength=e.strength),t}},{key:"_findTexture",value:function(e){var t=this._texture_map.get(e);if(void 0===t){var r=e.sampler,n=this._glenv.context,i={mag_filter:void 0!==r.magFilter?r.magFilter:n.LINEAR,min_filter:void 0!==r.minFilter?r.minFilter:n.LINEAR_MIPMAP_LINEAR,wrap_s:r.wrapS,wrap_t:r.wrapT,flip_y:!1};t=new y.default(this._glenv,e.source.image,i),this._texture_map.set(e,t)}return t}},{key:"primitives",get:function(){return this._primitives}}],[{key:"_getNodeToScene",value:function(e,t){var r=t,n=e.matrix;return null!==n&&(r=s.default.createMatrix(),s.default.mul_AA(t,n,r)),r}},{key:"_convertPrimitiveMode",value:function(t){return e._DrawMode[t.mode]}},{key:"_calcNumVertices",value:function(e){var t=e.attributes,r=[];for(var n in t){var i=t[n];r.push(i.count)}return Math.min.apply(null,r)}},{key:"fastCloneProperties",value:function(t){var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector3f(r.baseColorFactor),baseColorTexture:e._fastCloneTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:e._fastCloneTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:s.default.createVector3f(t.emissiveFactor),emissiveTexture:e._fastCloneTextureParam(t.emissiveTexture),normalTexture:e._fastCloneTextureParam(t.normalTexture),occlusionTexture:e._fastCloneTextureParam(t.occlusionTexture)}}},{key:"_fastCloneTextureParam",value:function(e){if(null===e)return null;var t={texture:e.texture,texCoord:e.texCoord};return"scale"in e?t.scale=e.scale:"strength"in e&&(t.strength=e.strength),t}}]),e}();T._DrawMode={0:f.default.DrawMode.POINTS,1:f.default.DrawMode.LINES,2:f.default.DrawMode.LINE_LOOP,3:f.default.DrawMode.LINE_STRIP,4:f.default.DrawMode.TRIANGLES,5:f.default.DrawMode.TRIANGLE_STRIP,6:f.default.DrawMode.TRIANGLE_FAN},T._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},T._ComponentType={5120:f.default.ComponentType.BYTE,5121:f.default.ComponentType.UNSIGNED_BYTE,5122:f.default.ComponentType.SHORT,5123:f.default.ComponentType.UNSIGNED_SHORT,5125:f.default.ComponentType.UNSIGNED_INT,5126:f.default.ComponentType.FLOAT},T._VertexAttribId={POSITION:"a_position",NORMAL:"a_normal",TANGENT:"a_tangent",TEXCOORD_0:"a_texcoord",TEXCOORD_1:"a_texcoord1",COLOR_0:"a_color"},t.default=E,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),_=n(s),l=r(1),c=n(l),f=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(n._transform=c.default.setIdentity(c.default.createMatrix()),n._primitives=[],n._ptoe_array=[],r&&r.json){var o=r.json,u=r.refs||{};n._transform=n.parseTransform(o.transform),n._setupPrimitives(o,u)}return n}return o(t,e),u(t,[{key:"getPrimitives",value:function(e){for(var t=this._primitives,r=this._ptoe_array,n=0;n<t.length;++n){var i=t[n],a=r[n];c.default.mul_AA(this._transform,a,i.transform)}return this._primitives}},{key:"setTransform",value:function(e){c.default.copyMatrix(e,this._transform)}},{key:"_setupPrimitives",value:function(e,t){var r=t[e.ref_model],n=r.createPrimitives(e.index);if(!n)throw new Error("model is not found in ModelContiner");this._primitives=n,this._ptoe_array=n.map(function(e){return c.default.createMatrix(e.transform)})}}]),t}(_.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(5),_=n(s),l=r(8),c=n(l),f=r(78),h=n(f),d=r(77),v=n(d),y=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r._white_texture=new c.default(e,null,{usage:c.default.Usage.COLOR,color:[1,1,1,1]}),r.bindProgram(),r.setInteger("u_base_image",t.TEXUNIT_BASE_IMAGE),r}return o(t,e),u(t,[{key:"setParameters",value:function(e,r){var n=r.properties,i=n.pbrMetallicRoughness;this.setObjToClip(e,r),this.setObjToView(e,r),this.setVector4("u_base_color",i.baseColorFactor),this.setVector3("u_light_dir",[0,0,1]);var a=this._selectTexture(i.baseColorTexture,this._white_texture);this.bindTexture2D(t.TEXUNIT_BASE_IMAGE,a.handle)}},{key:"_selectTexture",value:function(e,t){return null!==e?e.texture:t}}]),t}(_.default);y.TEXUNIT_BASE_IMAGE=0,t.default=y,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=r(23),s=n(u),_=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),t}(s.default);t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this.flake=t}return n(e,[{key:"findMesh",value:function(){return this.flake.findMesh(this.lod)}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(16),_=n(s),l=r(43),c=n(l),f=r(54),h=n(f),d=r(57),v=n(d),y=r(29),p=n(y),m=function(){function e(t){i(this,e),this._viewer=t,this._glenv=t.glenv;var r=t.canvas_element;if(this._width=r.width,this._height=r.height,0===this._width||0===this._height)return void(this._rendering_cancel=!0);var n=t.camera,a=n.createRenderInfo();this._setupBasicMatrices(a,n),this._volume_planes=a.volume_planes,this._pixel_step=a.pixel_step,this._scene=t.scene,this._globe=t.globe,this._tile_texture_cache=t.tile_texture_cache,t._render_cache||(t._render_cache={surface_material:new h.default(t),wireframe_material:new v.default(t)}),this._flake_material=t.render_mode===p.default.RenderMode.WIREFRAME?t._render_cache.wireframe_material:t._render_cache.surface_material,this._debug_stats=t.debug_stats}return a(e,[{key:"_setupBasicMatrices",value:function(e,t){this._view_to_gocs=t.view_to_gocs,this._gocs_to_view=u.default.createMatrix(),u.default.inverse_A(this._view_to_gocs,this._gocs_to_view),this._view_to_clip=e.view_to_clip,this._gocs_to_clip=u.default.createMatrix(),u.default.mul_PzA(this._view_to_clip,this._gocs_to_view,this._gocs_to_clip)}},{key:"render",value:function(){if(!this._rendering_cancel){var e=this._glenv.context;if(e.viewport(0,0,this._width,this._height),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.depthFunc(e.LEQUAL),this._globe.status===_.default.Status.READY){var t;if(this._viewer.getVisibility(p.default.Category.GROUND)){var r=new c.default(this);t=r.traverse()}else t=[];e.enable(e.BLEND),e.depthMask(!0);for(var n=0;n<t.length;++n)this._drawFlake(t[n]);this._viewer.getVisibility(p.default.Category.ENTITY)&&this._scene.draw(this);var i=this._debug_stats;null!==i&&(i.num_drawing_flakes=t.length),this._globe.endFrame(),this._tile_texture_cache.endFrame(),this._viewer.layers.endFrame()}}}},{key:"_drawFlake",value:function(e){for(var t=e.findMesh(),r=this._flake_material,n=r.numDrawings(),i=0;i<n;++i)r.bindProgram(),r.setFlakeParameter(this,e,t,i)&&t.draw(r);var a=this._debug_stats;null!==a&&(a.num_drawing_flake_vertices+=t.num_vertices)}}]),e}();t.default=m,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t;try{this.vs_object=this._compile_shader("VERTEX_SHADER",n),this.fs_object=this._compile_shader("FRAGMENT_SHADER",i)}catch(e){var a=t.context;throw this.vs_object&&a.deleteShader(this.vs_object),this.fs_object&&a.deleteShader(this.fs_object),e}}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;this.vs_object&&(e.deleteShader(this.vs_object),this.vs_object=null),this.fs_object&&(e.deleteShader(this.fs_object),this.fs_object=null)}},{key:"_compile_shader",value:function(e,t){var r=this._glenv.context,n=r.createShader(r[e]);if(!n)throw new Error(e+" オブジェクトの生成に失敗しました");try{if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw new Error(e+" のコンパイルに失敗: "+i)}}catch(e){throw r.deleteShader(n),e}return n}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(14),_=n(s),l=r(1),c=(n(l),r(10)),f=(n(c),r(80)),h=n(f),d=r(79),v=n(d),y=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image_hi",t.TEXUNIT_IMAGE_HI),r.setInteger("u_image_lo",t.TEXUNIT_IMAGE_LO),r._tile_texture_cache=e.tile_texture_cache,r._layers=e.layers,r._dummy_tile_texture=r._createDummyTileTexture(e.glenv),r._image_zbias=0,r}return o(t,e),u(t,[{key:"numDrawings",value:function(){return 1+this._layers.numDrawingLayers()}},{key:"setFlakeParameter",value:function(e,r,n,i){this.setCommonParameter(e,n);var a=this._getMaterialParamater(r,i);return null!==a&&(this.setVector4("u_corner_lod",a.corner_lod),this.setVector4("u_texcoord_rect_hi",a.image_hi.texcoord_rect),this.setVector4("u_texcoord_rect_lo",a.image_lo.texcoord_rect),this.setVector2("u_image_param",[a.image_lo.lod,a.image_hi.lod==a.image_lo.lod?0:1/(a.image_hi.lod-a.image_lo.lod)]),this.setFloat("u_opacity",0==i?1:this._layers.getDrawingLayer(i-1).opacity),this.bindTexture2D(t.TEXUNIT_IMAGE_HI,a.image_hi.texture),this.bindTexture2D(t.TEXUNIT_IMAGE_LO,a.image_lo.texture),!0)}},{key:"_getMaterialParamater",value:function(e,t){var r=0==t?this._tile_texture_cache:this._layers.getDrawingLayer(t-1).tile_cache;this._image_zbias=r.getImageZBias();var n=e.flake,i=n.z;if(i<r.getImageZMin())return null;var a=n.x,o=n.y,u=Math.ceil(e.lod+this._image_zbias);if(i<u)return null;var s=r.findNearestAncestors(i,a,o,u);return t>=1&&null===s[0]?null:{corner_lod:[e.lod_00,e.lod_10,e.lod_01,e.lod_11],image_hi:this._getImageParamater(s[0],i,a,o,u),image_lo:this._getImageParamater(s[1],i,a,o,u-1)}}},{key:"_getImageParamater",value:function(e,t,r,n,i){var a;return null!==e?(a=Math.pow(2,e.z-t),{lod:e.z-this._image_zbias,texture:e.texture,texcoord_rect:[r*a-e.x,1-(n+1)*a+e.y,a,a]}):(a=Math.pow(2,-t),{lod:-this._image_zbias,texture:this._dummy_tile_texture,texcoord_rect:[r*a-Math.floor(a*(r+.5)),1-(n+1)*a+Math.floor(a*(n+.5)),a,a]})}},{key:"_createDummyTileTexture",value:function(e){var t=e.context,r=t.TEXTURE_2D,n=t.createTexture(),i=[128,128,128,255];return t.bindTexture(r,n),t.texImage2D(r,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(i)),t.bindTexture(r,null),n}}]),t}(_.default);y.TEXUNIT_IMAGE_HI=0,y.TEXUNIT_IMAGE_LO=1,t.default=y,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(5),_=n(s),l=r(1),c=n(l),f=r(82),h=n(f),d=r(81),v=n(d),y=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!0}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(_.default);y.TEXUNIT_IMAGE=0,y._sparam=c.default.createVector2f(),t.default=y,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a){r(this,e),this.z=t,this.x=n,this.y=i,this.texture=a}return n(e,[{key:"dispose",value:function(e){e.deleteTexture(this.texture),this.texture=null}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(14),_=n(s),l=r(84),c=n(l),f=r(83),h=n(f),d=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.default,h.default))}return o(t,e),u(t,[{key:"isWireframe",value:function(){return!0}},{key:"setFlakeParameter",value:function(e,t,r,n){return this.setCommonParameter(e,r),!0}}]),t}(_.default);t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(30),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.accessors[r];this._type=n.type,this._componentType=n.componentType,this._count=n.count,this._bufferView=new u.default(t,n.bufferView),this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._normalized=n.normalized||!1,this._min=n.min?n.min.slice():null,this._max=n.max?n.max.slice():null,this._index=r}return a(e,[{key:"getRangeInBuffer",value:function(){var t=this._bufferView,r=e._ComponentData[this._componentType].bytes,n=r*e._NumComponents[this._type],i=0==t.byteStride?n:t.byteStride,a=this._byteOffset+t.byteOffset;return{first:a,last:a+i*(this._count-1)+n}}},{key:"modifyByteOrder",value:function(t){var r=e._ComponentData[this._componentType],n=r.bytes;if(1!=n)for(var i=e._NumComponents[this._type],a=this._byteOffset+this._bufferView.byteOffset,o=0==this._bufferView.byteStride?i:this._bufferView.byteStride/n,u=this._bufferView.buffer.binary,s=new DataView(u,a),_=new r.typedarray(u,a),l=r.getcompo,c=n/2,f=a/2,h=o*c,d=0;d<this._count;++d)for(var v=f+d*h,y=d*o,p=0;p<i;++p){var m=v+p*c;if(!t.getBit(m)){var g=y+p,b=l.call(s,g*n,!0);_[g]=b,t.setBit(m,!0)}}}},{key:"isIncluded",value:function(e,t){var r=this._byteOffset+this._bufferView.byteOffset;return e<=r&&r<t}},{key:"rebuildBySplitter",value:function(e,t){this._index=-1;var r=this._byteOffset+this._bufferView.byteOffset;this._byteOffset=r-t,this._bufferView.rebuildBySplitter(e)}},{key:"index",get:function(){return this._index}},{key:"bufferView",get:function(){return this._bufferView}},{key:"type",get:function(){return this._type}},{key:"componentType",get:function(){return this._componentType}},{key:"count",get:function(){return this._count}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"normalized",get:function(){return this._normalized}},{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();s._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},s._ComponentData={
5120:{bytes:1,getcompo:DataView.prototype.getInt8,typedarray:Int8Array},5121:{bytes:1,getcompo:DataView.prototype.getUint8,typedarray:Uint8Array},5122:{bytes:2,getcompo:DataView.prototype.getInt16,typedarray:Int16Array},5123:{bytes:2,getcompo:DataView.prototype.getUint16,typedarray:Uint16Array},5125:{bytes:4,getcompo:DataView.prototype.getUint32,typedarray:Uint32Array},5126:{bytes:4,getcompo:DataView.prototype.getFloat32,typedarray:Float32Array}},t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){if(r(this,e),void 0===t)this._index=-1,this._byteLength=0,this._uri=null,this._binary=null;else{this._index=n;var i=t.gjson.buffers[n];this._byteLength=i.byteLength,void 0!==i.uri?(this._uri=t.solveResourceUri(i.uri),this._load_binary(t,this._uri)):this._uri=null,this._binary=null}}return n(e,[{key:"createSubBuffer",value:function(t,r){var n=new e;return n._byteLength=r-t,n._binary=this._binary.slice(t,r),n}},{key:"_load_binary",value:function(e,t){var r=this,n=e.makeBinaryFetchParams(t);fetch(n.url,n.init).then(function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(t){r._binary=t,e.onFinishLoadBuffer()}).catch(function(t){e.onFinishLoadBuffer(new Error("Failed to load binary in glTF"))}),e.onStartLoadBuffer()}},{key:"index",get:function(){return this._index}},{key:"binary",get:function(){return this._binary}},{key:"byteLength",get:function(){return this._byteLength}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(61),u=n(o),s=r(36),_=n(s),l=function(){function e(t){i(this,e),this._buffer=t,this._attrib_accessors=[],this._index_accessors=[]}return a(e,[{key:"addAttributeAccessor",value:function(e){this._attrib_accessors.push(e)}},{key:"addIndexAccessor",value:function(e){this._index_accessors.push(e)}},{key:"rewriteByteOrder",value:function(){var e=new _.default(Math.ceil(this._buffer.byteLength/2)),t=!0,r=!1,n=void 0;try{for(var i,a=this._getUnitedOriginalAccessors()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;o.modifyByteOrder(e)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}}},{key:"splitBufferAndRebuildAccessors",value:function(){this._splitBufferAndRebuildAccessors(this._attrib_accessors),this._splitBufferAndRebuildAccessors(this._index_accessors)}},{key:"_splitBufferAndRebuildAccessors",value:function(t){var r=new u.default,n=!0,i=!1,a=void 0;try{for(var o,s=e._getOriginalAccessors(t)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var _=o.value;r.update(_)}}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}r.close(this._buffer);var l=!0,c=!1,f=void 0;try{for(var h,d=t[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var v=h.value;r.rebuildAccessor(v)}}catch(e){c=!0,f=e}finally{try{!l&&d.return&&d.return()}finally{if(c)throw f}}}},{key:"_getUnitedOriginalAccessors",value:function(){return e._getOriginalAccessors(this._attrib_accessors.concat(this._index_accessors))}},{key:"buffer",get:function(){return this._buffer}}],[{key:"_getOriginalAccessors",value:function(e){var t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value,s=u.index;t.has(s)||t.set(s,u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return t.values()}}]),e}();t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e);var t=new a(-2,-1),n=new a(Math.pow(2,32)+1,Math.pow(2,32)+2);t.next=n,n.prev=t,this._fragments=t}return n(e,[{key:"update",value:function(t){var r=t.getRangeInBuffer();this._updateByRange({first:e._floor4(r.first),last:r.last})}},{key:"close",value:function(e){this._fragments=this._fragments.next;for(var t=this._fragments;;t=t.next){if(null===t.next){t.prev.next=null;break}t.buffer=e.createSubBuffer(t.first,t.last)}}},{key:"rebuildAccessor",value:function(e){for(var t=this._fragments;null!==t;t=t.next)if(e.isIncluded(t.first,t.last)){e.rebuildBySplitter(t.buffer,t.first);break}}},{key:"_updateByRange",value:function(e){for(var t=this._fragments;null!==t.next;){if(t.isInside(e)){var r=t,n=t.next,i=new a(e.first,e.last);r.next=i,n.prev=i,i.prev=r,i.next=n;break}if(t.isTouch(e)){var o=t.prev,u=t.next;o.next=u,u.prev=o,e=t.mergeRange(e),t=o}else t=t.next}}}],[{key:"_floor4",value:function(e){return 4*Math.floor(e/4)}}]),e}(),a=function(){function e(t,n){r(this,e),this.first=t,this.last=n,this.buffer=null,this.prev=null,this.next=null}return n(e,[{key:"isInside",value:function(e){return this.last<e.first&&e.last<this.next.first}},{key:"isTouch",value:function(e){return this.last>=e.first&&e.last>=this.first}},{key:"mergeRange",value:function(e){return{first:Math.min(this.first,e.first),last:Math.max(this.last,e.last)}}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(31),s=n(u),_=r(70),l=n(_),c=r(60),f=n(c),h=r(64),d=n(h),v=r(59),y=n(v),p=r(63),m=n(p),g=r(3),b=n(g),w=function(){function e(t,r){i(this,e);var n=r||{};this._transform_binary=n.transform_binary||a,this._transform_image=n.transform_image||a,this._gjson=t,this._base_uri=void 0!==n.base_uri?n.base_uri:"",this._resolve=null,this._reject=null,this._scenes=[],this._default_scene_index=-1,this._buffer_entries=[],this._image_entries=[],this._body_finished=!1,this._load_count=0,this._load_error=null,this._settled=!1}return o(e,[{key:"load",value:function(){var e=this;return new Promise(function(t,r){e._resolve=t,e._reject=r;var n=e._loadVersion();n.major<2&&e._reject(new Error("glTF version error")),e._loadScenes(),e._loadDefaultSceneIndex(),e._onFinishLoadBody()})}},{key:"_loadVersion",value:function(){var e=this._gjson.asset,t=e.version,r=/^(\d+)\.(\d+)/.exec(t),n=Number(r[1]),i=Number(r[2]);return{major:n,minor:i}}},{key:"_loadScenes",value:function(){for(var e=(this._gjson.scenes||[]).length,t=[],r=0;r<e;++r)t.push(new l.default(this,r));this._scenes=t}},{key:"_loadDefaultSceneIndex",value:function(){"number"==typeof this._gjson.scene&&(this._default_scene_index=this._gjson.scene)}},{key:"solveResourceUri",value:function(e){var t=/^data:/,r=/^[a-z][-+.0-9a-z]*:\/\//;if(t.test(e)||r.test(e))return e;var n=this._base_uri.lastIndexOf("/"),i=n>=0?this._base_uri.substr(0,n+1):"";return i+e}},{key:"makeBinaryFetchParams",value:function(e){var t=this._transform_binary(e),r={credentials:(t.credentials||b.default.OMIT).credentials};return t.headers&&(r.headers=t.headers),{url:t.url,init:r}}},{key:"makeImageLoadParams",value:function(e){var t=this._transform_image(e),r={url:t.url};return t.credentials===b.default.SAME_ORIGIN?r.crossOrigin="anonymous":t.credentials===b.default.INCLUDE&&(r.crossOrigin="use-credentials"),r}},{key:"findBuffer",value:function(e){return void 0===this._buffer_entries[e]&&(this._buffer_entries[e]=new f.default(new y.default(this,e))),this._buffer_entries[e].buffer}},{key:"findImage",value:function(e){return void 0===this._image_entries[e]&&(this._image_entries[e]=new d.default(new m.default(this,e))),this._image_entries[e].image}},{key:"addAccessor",value:function(e,t){var r=this._buffer_entries[e.bufferView.buffer.index];switch(t){case"ATTRIBUTE":r.addAttributeAccessor(e);break;case"INDEX":r.addIndexAccessor(e)}}},{key:"addTextureInfo",value:function(e){var t=e.texture.source,r=this._image_entries[t.index];r.addTextureInfo(e)}},{key:"onStartLoadBuffer",value:function(){this._load_count+=1}},{key:"onFinishLoadBuffer",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"onStartLoadImage",value:function(){this._load_count+=1}},{key:"onFinishLoadImage",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"_onFinishLoadBody",value:function(){this._body_finished=!0,this._onFinishLoadSomething()}},{key:"_onFinishLoadSomething",value:function(){this._settled||(null!==this._load_error?(this._reject(this._load_error),this._settled=!0):this._body_finished&&0==this._load_count&&(this._rewriteBuffersForByteOrder(),this._splitBuffersAndRebuildAccessors(),this._rebuildTextureInfo(),this._resolve(new s.default(this._scenes,this._default_scene_index)),this._settled=!0))}},{key:"_rewriteBuffersForByteOrder",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rewriteByteOrder()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"_splitBuffersAndRebuildAccessors",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.splitBufferAndRebuildAccessors()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"_rebuildTextureInfo",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._image_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rebuildTextureInfo()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"gjson",get:function(){return this._gjson}}]),e}();t.default=w,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(30),u=n(o),s=function(){function e(t,r){i(this,e),this._index=r;var n=t.gjson.images[r];void 0!==n.uri?(this._uri=t.solveResourceUri(n.uri),this._load_image(t,this._uri)):void 0!==n.bufferView&&(this._bufferView=new u.default(t,n.bufferView)),this._mimeType=n.mimeType,this._image=null}return a(e,[{key:"_load_image",value:function(e,t){var r=this,n=document.createElement("img");n.onload=function(){r._image=n,e.onFinishLoadImage()},n.onerror=function(){e.onFinishLoadImage(new Error("Failed to load image in glTF"))};var i=e.makeImageLoadParams(t);i.crossOrigin&&(n.crossOrigin=i.crossOrigin),n.src=i.url,e.onStartLoadImage()}},{key:"index",get:function(){return this._index}},{key:"image",get:function(){return this._image}}]),e}();t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._image=t,this._texinfo_objects=[]}return n(e,[{key:"addTextureInfo",value:function(e){this._texinfo_objects.push(e)}},{key:"rebuildTextureInfo",value:function(){var e=this._texinfo_objects;if(!(e.length<=1))for(var t=e[0].texture,r=1;r<e.length;++r)e[r].texture=t}},{key:"image",get:function(){return this._image}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(11),u=n(o),s=r(32),_=n(s),l=r(33),c=n(l),f=function(){function e(t,r){i(this,e),this._pbrMetallicRoughness={baseColorFactor:[1,1,1,1],baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},this._doubleSided=!1,this._alphaMode="OPAQUE",this._alphaCutoff=.5,this._emissiveFactor=[0,0,0],this._emissiveTexture=null,this._normalTexture=null,this._occlusionTexture=null;var n=t.gjson.materials[r];this._setupPbrMetallicRoughness(n,t),this._setupGenericParameters(n,t)}return a(e,[{key:"_setupPbrMetallicRoughness",value:function(e,t){if(void 0!==e.pbrMetallicRoughness){var r=e.pbrMetallicRoughness,n=this._pbrMetallicRoughness;void 0!==r.baseColorFactor&&(n.baseColorFactor=r.baseColorFactor.slice()),void 0!==r.baseColorTexture&&(n.baseColorTexture=new u.default(r.baseColorTexture,t),t.addTextureInfo(n.baseColorTexture)),void 0!==r.metallicFactor&&(n.metallicFactor=r.metallicFactor),void 0!==r.roughnessFactor&&(n.roughnessFactor=r.roughnessFactor),void 0!==r.metallicRoughnessTexture&&(n.metallicRoughnessTexture=new u.default(r.metallicRoughnessTexture,t),t.addTextureInfo(n.metallicRoughnessTexture))}}},{key:"_setupGenericParameters",value:function(e,t){void 0!==e.doubleSided&&(this._doubleSided=e.doubleSided),void 0!==e.alphaMode&&(this._alphaMode=e.alphaMode),void 0!==e.alphaCutoff&&(this._alphaCutoff=e.alphaCutoff),void 0!==e.emissiveFactor&&(this._emissiveFactor=e.emissiveFactor.slice()),void 0!==e.emissiveTexture&&(this._emissiveTexture=new u.default(e.emissiveTexture,t),t.addTextureInfo(this._emissiveTexture)),void 0!==e.normalTexture&&(this._normalTexture=new _.default(e.normalTexture,t),t.addTextureInfo(this._normalTexture)),void 0!==e.occlusionTexture&&(this._occlusionTexture=new c.default(e.occlusionTexture,t),t.addTextureInfo(this._occlusionTexture))}},{key:"pbrMetallicRoughness",get:function(){return this._pbrMetallicRoughness}},{key:"doubleSided",get:function(){return this._doubleSided}},{key:"alphaMode",get:function(){return this._alphaMode}},{key:"alphaCutoff",get:function(){return this._alphaCutoff}},{key:"emissiveFactor",get:function(){return this._emissiveFactor}},{key:"emissiveTexture",get:function(){return this._emissiveTexture}},{key:"normalTexture",get:function(){return this._normalTexture}},{key:"occlusionTexture",get:function(){return this._occlusionTexture}}]),e}();t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(68),u=n(o),s=function(){function e(t,r){i(this,e),this._primitives=[];for(var n=t.gjson.meshes[r],a=n.primitives,o=0;o<a.length;++o){var s=a[o];this._primitives.push(new u.default(s,t))}}return a(e,[{key:"primitives",get:function(){return this._primitives}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(1),s=n(u),_=r(66),l=n(_),c=function(){function e(t,r){i(this,e);var n=t.gjson.nodes[r];this._children=[],this._matrix=null,this._mesh=null,this._setupChildren(n,t),this._setupMatrix(n),this._setupMesh(n,t)}return o(e,[{key:"_setupChildren",value:function(t,r){var n=t.children;if(void 0!==n)for(var i=0;i<n.length;++i){var a=n[i];this._children.push(new e(r,a))}}},{key:"_setupMatrix",value:function(e){if(e.matrix)this._matrix=s.default.createMatrix(e.matrix);else if(e.scale||e.rotation||e.translation){var t=e.scale||[1,1,1],r=a(t,3),n=r[0],i=r[1],o=r[2],u=e.rotation||[0,0,0,1],_=a(u,4),l=_[0],c=_[1],f=_[2],h=_[3],d=e.translation||[0,0,0],v=a(d,3),y=v[0],p=v[1],m=v[2];this._matrix=s.default.createMatrix([(1-2*(c*c+f*f))*n,2*(l*c+f*h)*n,2*(l*f-c*h)*n,0,2*(l*c-f*h)*i,(1-2*(l*l+f*f))*i,2*(l*h+c*f)*i,0,2*(c*h+l*f)*o,2*(c*f-l*h)*o,(1-2*(l*l+c*c))*o,0,y,p,m,1])}}},{key:"_setupMesh",value:function(e,t){var r=e.mesh;void 0!==r&&(this._mesh=new l.default(t,r))}},{key:"children",get:function(){return this._children}},{key:"matrix",get:function(){return this._matrix}},{key:"mesh",get:function(){return this._mesh}}]),e}();t.default=c,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(58),u=n(o),s=r(65),_=n(s),l=function(){function e(t,r){i(this,e),this._mode=void 0!==t.mode?t.mode:4,this._attributes={},this._indices=null,this._material=null,this._setupAttributes(t.attributes,r),this._setupIndices(t,r),this._setupMaterial(t,r)}return a(e,[{key:"_setupAttributes",value:function(e,t){for(var r in e){var n=new u.default(t,e[r]);this._attributes[r]=n,t.addAccessor(n,"ATTRIBUTE")}}},{key:"_setupIndices",value:function(e,t){if(void 0!==e.indices){var r=new u.default(t,e.indices);this._indices=r,t.addAccessor(r,"INDEX")}}},{key:"_setupMaterial",value:function(e,t){void 0!==e.material&&(this._material=new _.default(t,e.material))}},{key:"mode",get:function(){return this._mode}},{key:"attributes",get:function(){return this._attributes}},{key:"indices",get:function(){return this._indices}},{key:"material",get:function(){return this._material}}]),e}();t.default=l,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e);var i="number"==typeof n?t.gjson.samplers[n]:{};this._magFilter=i.magFilter,this._minFilter=i.minFilter,this._wrapS=void 0!==i.wrapS?i.wrapS:e.WRAP_DEFAULT,this._wrapT=void 0!==i.wrapT?i.wrapT:e.WRAP_DEFAULT}return n(e,[{key:"magFilter",get:function(){return this._magFilter}},{key:"minFilter",get:function(){return this._minFilter}},{key:"wrapS",get:function(){return this._wrapS}},{key:"wrapT",get:function(){return this._wrapT}}]),e}();i.WRAP_DEFAULT=10497,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(67),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.scenes[r];this._root_nodes=[],this._name=null;var a=!0,o=!1,s=void 0;try{for(var _,l=(n.nodes||[])[Symbol.iterator]();!(a=(_=l.next()).done);a=!0){var c=_.value;this._root_nodes.push(new u.default(t,c))}}catch(e){o=!0,s=e}finally{try{!a&&l.return&&l.return()}finally{if(o)throw s}}"string"==typeof n.name&&(this._name=n.name)}return a(e,[{key:"root_nodes",get:function(){return this._root_nodes}},{key:"name",get:function(){return this._name}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(69),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.textures[r];this._sampler=new u.default(t,n.sampler),this._source=t.findImage(n.source)}return a(e,[{key:"source",get:function(){return this._source}},{key:"sampler",get:function(){return this._sampler}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(62),u=n(o),s=function(){function e(){i(this,e)}return a(e,null,[{key:"load",value:function(e,t){var r=new u.default(e,t);return r.load()}}]),e}();t.default=s,e.exports=t.default},function(e,t){e.exports="precision mediump float;\n\nvarying vec2  v_texcoord;    // テクスチャ座標\n\nuniform sampler2D u_image;   // テクスチャ画像\n\nvoid main()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}\n"},function(e,t){e.exports="attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\n\nvarying vec2  v_texcoord;     // テクスチャ座標\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_texcoord  = a_texcoord;\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nuniform vec4 u_color;  // 線の基本色と不透明度\n\nvoid\nmain()\n{\n    gl_FragColor = vec4( u_color.xyz * u_color.w, u_color.w );\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分の頂点シェーダ\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec3 a_direction;   // 線分方向 (モデル座標系) = 終点位置 - 始点位置\nattribute vec2 a_where;       // 線分の4隅指定: 始点左: {-1, 1}, 始点右: {-1, -1}, 終点左: {1, 1}, 終点右: {1, -1}\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec3 u_sparam;        // 画面パラメータ: {2/w, 2/h, h/w}\nuniform vec2 u_thickness;     // 線の太さの半分: {u, v}\n\nvec2\noffset( vec4 cpos )\n{\n    vec4 q0 = cpos;\n    q0.y *= u_sparam.z;  // q0 = A * q0\n    vec4 q1 = cpos + u_obj_to_clip * vec4( a_direction, 0 );\n    q1.y *= u_sparam.z;  // q1 = A * q1\n\n    vec2 ds = normalize( q1.xy / q1.w - q0.xy / q0.w );\n    vec2 wt = a_where * u_thickness;\n    return mat2( ds.x, ds.y, -ds.y, ds.x ) * wt;\n}\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += offset( gl_Position ) * u_sparam.xy * gl_Position.w;\n}\n"},function(e,t){e.exports="precision highp float;\n\nvarying vec3  v_normal;    // 法線 (視点座標系)\nvarying vec2  v_texcoord;  // テクスチャ座標\n\nuniform vec3      u_light_dir;   // ライト逆方向 (視点座標系) と強さ\nuniform vec4      u_base_color;  // 基本色係数\nuniform sampler2D u_base_image;  // 基本色画像\n\n\nvoid\nmain()\n{\n    vec3 normal = normalize( v_normal );  // 法線 (視点座標系)\n\n    vec3 dlit = vec3( dot( normal, u_light_dir ) );  // 拡散光の強さ\n\n    gl_FragColor = u_base_color * texture2D( u_base_image, v_texcoord ) * vec4( dlit, 1.0 );\n}\n"},function(e,t){e.exports="attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec3 a_normal;      // 法線 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4  u_obj_to_view;  // モデル座標系から視点座標系への変換\n\nvarying vec3  v_normal;       // 法線 (視点座標系)\nvarying vec2  v_texcoord;     // テクスチャ座標\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    v_normal   =  normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );  // 法線 (視点座標系)\n    v_texcoord = a_texcoord;\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2  v_texcoord_hi;    // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;    // 低レベル画像のテクスチャ座標\nvarying float v_lod;            // 補間された LOD\n\nuniform sampler2D u_image_hi;   // 高レベル画像\nuniform sampler2D u_image_lo;   // 低レベル画像\nuniform float     u_opacity;    // 不透明度\n\n/** 画像パラメータ\n *\n *  x = u_image_lo の LOD\n *  y = 1 / (u_image_hi の LOD - x)\n *\n *  ただし u_image_hi と u_image_lo が同じ画像のときは y = 0\n */\nuniform vec2 u_image_param;\n\n\nvoid main()\n{\n    vec4 color_hi = texture2D( u_image_hi, v_texcoord_hi );\n    vec4 color_lo = texture2D( u_image_lo, v_texcoord_lo );\n\n    // 画像の混合率\n    float lo_lod = u_image_param.x;\n    float  delta = u_image_param.y;\n    float  ratio = clamp( (v_lod - lo_lod) * delta, 0.0, 1.0 );\n\n    gl_FragColor = mix( color_lo, color_hi, ratio );\n    gl_FragColor.a *= u_opacity;  // 不透明度を適用\n}\n"},function(e,t){e.exports="attribute vec4 a_position;         // 位置 (地表断片座標系)\nattribute vec2 a_uv;               // uv 座標\n\nuniform mat4  u_obj_to_clip;       // 地表断片座標系からクリップ座標系への変換\n\nuniform vec4  u_texcoord_rect_hi;  // 高レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_texcoord_rect_lo;  // 低レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_corner_lod;        // uv = (0,0), (1,0), (0,1), (1,1) の LOD\n\nvarying vec2  v_texcoord_hi;       // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;       // 低レベル画像のテクスチャ座標\nvarying float v_lod;               // 補間された LOD\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    // uv 座標をテクスチャ座標に変換\n    v_texcoord_hi = u_texcoord_rect_hi.xy + u_texcoord_rect_hi.zw * a_uv;\n    v_texcoord_lo = u_texcoord_rect_lo.xy + u_texcoord_rect_lo.zw * a_uv;\n\n    // LOD の補間\n    float u = a_uv.x;\n    float v = a_uv.y;\n\n    float lod_00 = u_corner_lod.x;  // uv = (0,0) の LOD\n    float lod_10 = u_corner_lod.y;  // uv = (1,0) の LOD\n    float lod_01 = u_corner_lod.z;  // uv = (0,1) の LOD\n    float lod_11 = u_corner_lod.w;  // uv = (1,1) の LOD\n\n    float lod_u0 = mix( lod_00, lod_10, u );  // uv = (u, 0) の LOD\n    float lod_u1 = mix( lod_01, lod_11, u );  // uv = (u, 1) の LOD\n    float lod_uv = mix( lod_u0, lod_u1, v );  // uv = (u, v) の LOD\n\n    v_lod = lod_uv;\n}\n"},function(e,t){e.exports="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;     // テキストのテクスチャ座標\nvarying vec4 v_color;        // テキストの色と不透明度\n\nuniform sampler2D u_image;   // テキスト画像\n\nvoid\nmain()\n{\n    float level = texture2D( u_image, v_texcoord ).w;  // 輝度\n    float alpha = v_color.w * level;\n    gl_FragColor = vec4( v_color.xyz * alpha, alpha );\n}\n"},function(e,t){e.exports="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\nattribute vec4 a_color;       // テキストの色と不透明度\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\nvarying vec4 v_color;         // テキストの色と不透明度\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_color    = a_color;\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    vec4 color = (v_uv.x < 0.005 || v_uv.y < 0.005 || v_uv.x > 0.995 || v_uv.y > 0.995) ?\n                 vec4( 1, 1, 0, 1 ) : vec4( 0.5, 0.5, 0.5, 1 );\n    gl_FragColor = color;\n}\n"},function(e,t){e.exports="attribute vec4 a_position;\nattribute vec2 a_uv;\n\nuniform mat4 u_obj_to_clip;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_uv  = a_uv;\n}\n"}])});