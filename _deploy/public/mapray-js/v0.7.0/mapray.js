!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mapray",[],t):"object"==typeof exports?exports.mapray=t():e.mapray=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i=r(40),a=n(i),o=r(21),u=n(o),s=r(1),l=n(s),_=r(3),c=n(_),f=r(17),h=n(f),d=r(34),v=n(d),p=r(2),y=n(p),m=r(5),g=n(m),b=r(27),w=n(b),E=r(28),x=n(E),k=r(15),T=n(k),M=r(37),P=n(M),O=r(47),A=n(O),I=r(8),R=n(I),L=r(35),D=n(L),S=r(38),N=n(S),C=r(36),F=n(C),j=r(4),V=n(j),U=r(16),G=n(U),z=r(39),B=n(z),Y=r(32),q=n(Y),X=r(18),H=n(X),W=r(33),Z=n(W),Q=r(57),J=n(Q),K=r(14),$=n(K),ee=r(56),te=n(ee),re=r(48),ne=n(re),ie=r(59),ae=n(ie),oe=r(12),ue=(n(oe),{Viewer:a.default,Camera:u.default,GeoMath:l.default,GeoPoint:c.default,Orientation:h.default,Ray:v.default,AltitudeMode:y.default,CredentialMode:g.default,Layer:w.default,LayerCollection:x.default,DemProvider:T.default,StandardDemProvider:P.default,CloudDemProvider:A.default,ImageProvider:R.default,RenderCallback:D.default,StandardImageProvider:N.default,Scene:F.default,Entity:V.default,MarkerLineEntity:G.default,TextEntity:B.default,ModelEntity:q.default,PolygonEntity:H.default,PinEntity:Z.default,ImageIconEntity:J.default,SceneLoader:$.default,GeoJSONLoader:te.default,URLResource:oe.URLResource,MaprayApi:ae.default,DebugStats:ne.default});window.maprayRequestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,window.maprayCancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame;var se=window.performance,le=se&&(se.now||se.mozNow||se.msNow||se.oNow||se.webkitNow),_e=new Date;window.maprayNow=le?function(){return le.call(se)}:function(){return _e.getTime()},Math.maprayLog2=Math.log2||function(e){return 1.4426950408889634*Math.log(e)},t.default=ue,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,null,[{key:"createMatrix",value:function(e){return new Float64Array(e||16)}},{key:"createMatrixf",value:function(e){return new Float32Array(e||16)}},{key:"createVector4",value:function(e){return new Float64Array(e||4)}},{key:"createVector4f",value:function(e){return new Float32Array(e||4)}},{key:"createVector3",value:function(e){return new Float64Array(e||3)}},{key:"createVector3f",value:function(e){return new Float32Array(e||3)}},{key:"createVector2f",value:function(e){return new Float32Array(e||2)}},{key:"copyMatrix",value:function(e,t){for(var r=0;r<16;++r)t[r]=e[r];return t}},{key:"copyVector4",value:function(e,t){for(var r=0;r<4;++r)t[r]=e[r];return t}},{key:"copyVector3",value:function(e,t){for(var r=0;r<3;++r)t[r]=e[r];return t}},{key:"setIdentity",value:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"dot3",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"cross3",value:function(e,t,r){var n=e[1]*t[2]-e[2]*t[1],i=e[2]*t[0]-e[0]*t[2],a=e[0]*t[1]-e[1]*t[0];return r[0]=n,r[1]=i,r[2]=a,r}},{key:"normalize3",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=1/Math.sqrt(r*r+n*n+i*i);return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}},{key:"mul_AA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],u=e[1],s=e[5],l=e[9],_=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=t[0],p=t[4],y=t[8],m=t[12],g=t[1],b=t[5],w=t[9],E=t[13],x=t[2],k=t[6],T=t[10],M=t[14];return r[0]=n*v+i*g+a*x,r[1]=u*v+s*g+l*x,r[2]=c*v+f*g+h*x,r[3]=0,r[4]=n*p+i*b+a*k,r[5]=u*p+s*b+l*k,r[6]=c*p+f*b+h*k,r[7]=0,r[8]=n*y+i*w+a*T,r[9]=u*y+s*w+l*T,r[10]=c*y+f*w+h*T,r[11]=0,r[12]=n*m+i*E+a*M+o,r[13]=u*m+s*E+l*M+_,r[14]=c*m+f*E+h*M+d,r[15]=1,r}},{key:"mul_GA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],u=e[1],s=e[5],l=e[9],_=e[13],c=e[2],f=e[6],h=e[10],d=e[14],v=e[3],p=e[7],y=e[11],m=e[15],g=t[0],b=t[4],w=t[8],E=t[12],x=t[1],k=t[5],T=t[9],M=t[13],P=t[2],O=t[6],A=t[10],I=t[14];return r[0]=n*g+i*x+a*P,r[1]=u*g+s*x+l*P,r[2]=c*g+f*x+h*P,r[3]=v*g+p*x+y*P,r[4]=n*b+i*k+a*O,r[5]=u*b+s*k+l*O,r[6]=c*b+f*k+h*O,r[7]=v*b+p*k+y*O,r[8]=n*w+i*T+a*A,r[9]=u*w+s*T+l*A,r[10]=c*w+f*T+h*A,r[11]=v*w+p*T+y*A,r[12]=n*E+i*M+a*I+o,r[13]=u*E+s*M+l*I+_,r[14]=c*E+f*M+h*I+d,r[15]=v*E+p*M+y*I+m,r}},{key:"mul_PzA",value:function(e,t,r){var n=e[0],i=e[8],a=e[12],o=e[5],u=e[9],s=e[13],l=e[10],_=e[14],c=e[11],f=e[15],h=t[0],d=t[4],v=t[8],p=t[12],y=t[1],m=t[5],g=t[9],b=t[13],w=t[2],E=t[6],x=t[10],k=t[14];return r[0]=n*h+i*w,r[1]=o*y+u*w,r[2]=l*w,r[3]=c*w,r[4]=n*d+i*E,r[5]=o*m+u*E,r[6]=l*E,r[7]=c*E,r[8]=n*v+i*x,r[9]=o*g+u*x,r[10]=l*x,r[11]=c*x,r[12]=n*p+i*k+a,r[13]=o*b+u*k+s,r[14]=l*k+_,r[15]=c*k+f,r}},{key:"inverse_A",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],u=e[5],s=e[9],l=e[13],_=e[2],c=e[6],f=e[10],h=e[14],d=u*f-c*s,v=_*s-o*f,p=o*c-_*u,y=c*i-n*f,m=r*f-_*i,g=_*n-r*c,b=n*s-u*i,w=o*i-r*s,E=r*u-o*n,x=-(a*d+l*y+h*b),k=-(a*v+l*m+h*w),T=-(a*p+l*g+h*E),M=1/(r*d+n*v+i*p);return t[0]=d*M,t[1]=v*M,t[2]=p*M,t[3]=0,t[4]=y*M,t[5]=m*M,t[6]=g*M,t[7]=0,t[8]=b*M,t[9]=w*M,t[10]=E*M,t[11]=0,t[12]=x*M,t[13]=k*M,t[14]=T*M,t[15]=1,t}},{key:"transformPlane_A",value:function(e,t,r){var n=e,i=t[0],a=t[1],o=t[2],u=t[3];return r[0]=i*n[0]+a*n[1]+o*n[2],r[1]=i*n[4]+a*n[5]+o*n[6],r[2]=i*n[8]+a*n[9]+o*n[10],r[3]=i*n[12]+a*n[13]+o*n[14]+u,r}},{key:"iscs_to_gocs_matrix",value:function(t,r){var n=t.longitude*e.DEGREE,i=t.latitude*e.DEGREE,a=Math.sin(n),o=Math.cos(n),u=Math.sin(i),s=Math.cos(i),l=e.EARTH_RADIUS+t.height;return r[0]=-a,r[1]=o,r[2]=0,r[3]=0,r[4]=-o*u,r[5]=-a*u,r[6]=s,r[7]=0,r[8]=s*o,r[9]=s*a,r[10]=u,r[11]=0,r[12]=l*s*o,r[13]=l*s*a,r[14]=l*u,r[15]=1,r}},{key:"gocs_to_iscs",value:function(t,r){var n=t[0],i=t[1],a=t[2],o=n*n,u=i*i,s=a*a;return 0!=n||0!=i?(r.latitude=Math.atan(a/Math.sqrt(o+u))/e.DEGREE,r.longitude=Math.atan2(i,n)/e.DEGREE):(a>0?r.latitude=90:a<0?r.latitude=-90:r.latitude=0,r.longitude=0),r.height=Math.sqrt(o+u+s)-e.EARTH_RADIUS,r}},{key:"frustum_matrix",value:function(e,t,r,n,i,a,o){return o[0]=2*i/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/(n-r),o[6]=0,o[7]=0,o[8]=(t+e)/(t-e),o[9]=(n+r)/(n-r),o[10]=(a+i)/(i-a),o[11]=-1,o[12]=0,o[13]=0,o[14]=2*a*i/(i-a),o[15]=0,o}},{key:"lookat_matrix",value:function(t,r,n,i){var a=e._xaxis,o=e._yaxis,u=e._zaxis;return u[0]=t[0]-r[0],u[1]=t[1]-r[1],u[2]=t[2]-r[2],e.normalize3(u,u),e.cross3(n,u,a),e.normalize3(a,a),e.cross3(u,a,o),i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=u[0],i[9]=u[1],i[10]=u[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}},{key:"rotation_matrix",value:function(t,r,n){var i=r*e.DEGREE,a=Math.sin(i),o=Math.cos(i),u=t[0],s=t[1],l=t[2];return n[0]=u*u*(1-o)+o,n[1]=u*s*(1-o)+l*a,n[2]=u*l*(1-o)-s*a,n[3]=0,n[4]=u*s*(1-o)-l*a,n[5]=s*s*(1-o)+o,n[6]=s*l*(1-o)+u*a,n[7]=0,n[8]=u*l*(1-o)+s*a,n[9]=s*l*(1-o)-u*a,n[10]=l*l*(1-o)+o,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}},{key:"kml_model_matrix",value:function(t,r,n,i,a){var o=t*e.DEGREE,u=r*e.DEGREE,s=n*e.DEGREE,l=Math.sin(o),_=Math.cos(o),c=Math.sin(u),f=Math.cos(u),h=Math.sin(s),d=Math.cos(s),v=i[0],p=i[1],y=i[2];return a[0]=v*(l*h*c+_*d),a[1]=v*(_*h*c-l*d),a[2]=v*h*f,a[3]=0,a[4]=p*l*f,a[5]=p*_*f,a[6]=-p*c,a[7]=0,a[8]=y*(l*d*c-_*h),a[9]=y*(_*d*c+l*h),a[10]=y*d*f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}},{key:"gudermannian",value:function(e){return 2*Math.atan(Math.exp(e))-Math.PI/2}},{key:"invGudermannian",value:function(e){return Math.log(Math.tan(e/2+Math.PI/4))}},{key:"clamp",value:function(e,t,r){return Math.min(Math.max(e,t),r)}}]),e}();i.EARTH_RADIUS=6378137,i.DEGREE=.017453292519943295,i.LOG2PI=1.6514961294723187,i._xaxis=i.createVector3(),i._yaxis=i.createVector3(),i._zaxis=i.createVector3();var a=function(){function e(t,n,i){r(this,e),this.longitude=void 0!==t?t:0,this.latitude=void 0!==n?n:0,this.altitude=void 0!==i?i:0}return n(e,[{key:"clone",value:function(){return new e(this.longitude,this.latitude,this.altitude)}},{key:"assign",value:function(e){return this.longitude=e.longitude,this.latitude=e.latitude,this.altitude=e.altitude,this}},{key:"setFromArray",value:function(e){return this.longitude=e[0],this.latitude=e[1],this.altitude=e.length>2?e[2]:0,this}},{key:"setFromGocs",value:function(e){var t=e[0],r=e[1],n=e[2],a=t*t,o=r*r,u=n*n;return 0!=t||0!=r?(this.latitude=Math.atan(n/Math.sqrt(a+o))/i.DEGREE,this.longitude=Math.atan2(r,t)/i.DEGREE):(n>0?this.latitude=90:n<0?this.latitude=-90:this.latitude=0,this.longitude=0),this.height=Math.sqrt(a+o+u)-i.EARTH_RADIUS,this}},{key:"getAsGocs",value:function(e){var t=this.longitude*i.DEGREE,r=this.latitude*i.DEGREE,n=i.EARTH_RADIUS+this.altitude,a=Math.cos(r);return e[0]=n*a*Math.cos(t),e[1]=n*a*Math.sin(t),e[2]=n*Math.sin(r),e}},{key:"getMlocsToGocsMatrix",value:function(e){var t=this.longitude*i.DEGREE,r=this.latitude*i.DEGREE,n=Math.sin(t),a=Math.cos(t),o=Math.sin(r),u=Math.cos(r),s=i.EARTH_RADIUS+this.altitude;return e[0]=-n,e[1]=a,e[2]=0,e[3]=0,e[4]=-a*o,e[5]=-n*o,e[6]=u,e[7]=0,e[8]=u*a,e[9]=u*n,e[10]=o,e[11]=0,e[12]=s*u*a,e[13]=s*u*n,e[14]=s*o,e[15]=1,e}}],[{key:"toGocsArray",value:function(e,t,r){for(var n=i.DEGREE,a=i.EARTH_RADIUS,o=0;o<t;++o){var u=3*o,s=e[u]*n,l=e[u+1]*n,_=a+e[u+2],c=Math.cos(l);r[u]=_*c*Math.cos(s),r[u+1]=_*c*Math.sin(s),r[u+2]=_*Math.sin(l)}return r}}]),e}(),o=function(){function e(t,n,i){r(this,e),this.heading=void 0!==t?t:0,this.tilt=void 0!==n?n:0,this.roll=void 0!==i?i:0}return n(e,[{key:"clone",value:function(){return new e(this.heading,this.tilt,this.roll)}},{key:"assign",value:function(e){return this.heading=e.heading,this.tilt=e.tilt,this.roll=e.roll,this}},{key:"getTransformMatrix",value:function(e,t){var r=this.heading*i.DEGREE,n=this.tilt*i.DEGREE,a=this.roll*i.DEGREE,o=Math.sin(r),u=Math.cos(r),s=Math.sin(n),l=Math.cos(n),_=Math.sin(a),c=Math.cos(a),f=e[0],h=e[1],d=e[2];return t[0]=f*(o*_*s+u*c),t[1]=f*(u*_*s-o*c),t[2]=f*_*l,t[3]=0,t[4]=h*o*l,t[5]=h*u*l,t[6]=-h*s,t[7]=0,t[8]=d*(o*c*s-u*_),t[9]=d*(u*c*s+o*_),t[10]=d*c*l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}}]),e}();t.default=i,t.GeoPoint=a,t.Orientation=o},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={ABSOLUTE:{id:"ABSOLUTE"},RELATIVE:{id:"RELATIVE"}};t.default=r,e.exports=t.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(1);t.default=n.GeoPoint,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(2),u=n(o),s=function(){function e(t,r){i(this,e),this.scene=t,this._altitude_mode=u.default.ABSOLUTE,this._need_to_create_regions=!1,r&&r.json&&this._setupEntityByJson(r.json)}return a(e,[{key:"onChangeAltitudeMode",value:function(e){}},{key:"getPrimitiveProducer",value:function(){return null}},{key:"_setupEntityByJson",value:function(e){if(e.altitude_mode)switch(e.altitude_mode){case"absolute":this._altitude_mode=u.default.ABSOLUTE;break;case"relative":this._altitude_mode=u.default.RELATIVE;break;default:console.error("unrecognized altitude_mode: "+e.altitude_mode)}}},{key:"altitude_mode",set:function(e){if(this._altitude_mode!==e){var t=this._altitude_mode;this._altitude_mode=e,this.onChangeAltitudeMode(t)}},get:function(){return this._altitude_mode}}]),e}(),l=function(){function e(t){i(this,e),this._entity=t,this._need_to_create_regions=!1}return a(e,[{key:"needToCreateRegions",value:function(){this._need_to_create_regions=!0}},{key:"checkToCreateRegions",value:function(){var e=this._need_to_create_regions;return this._need_to_create_regions=!1,e}},{key:"needsElevation",value:function(){return this._entity._altitude_mode!==u.default.ABSOLUTE}},{key:"createRegions",value:function(){return[]}},{key:"onChangeElevation",value:function(e){}},{key:"getPrimitives",value:function(e){throw new Error("mapray.Entity.PrimitiveProducer#getPrimitives() method has not been overridden.")}},{key:"entity",get:function(){return this._entity}}]),e}();s.PrimitiveProducer=l,t.default=s,e.exports=t.default},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}};t.default=r,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(30),l=n(s),_=r(1),c=n(_),f=function(e){function t(e,r,n){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n))}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,t){}},{key:"setObjToClip",value:function(e,r){var n=r.transform,i=t._obj_to_clip;c.default.mul_GA(e._gocs_to_clip,n,i),this.setMatrix("u_obj_to_clip",i)}},{key:"setObjToView",value:function(e,r){var n=r.transform,i=t._obj_to_view;c.default.mul_AA(e._gocs_to_view,n,i),this.setMatrix("u_obj_to_view",i)}}]),t}(l.default);f._obj_to_clip=c.default.createMatrixf(),f._obj_to_view=c.default.createMatrixf(),t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(){i(this,e),this._is_compiled=!1,this._point_array=new Float64Array(0),this._num_points=0,this._node_array=new Uint32Array(0),this._next_node=0}return a(e,[{key:"addPoint",value:function(e){this._checkNotCompiled(),this._ensurePointArrayCapacity(2);var t=2*this._num_points;this._point_array[t]=e.longitude,this._point_array[t+1]=e.latitude,this._num_points+=1}},{key:"addPoints",value:function(e,t,r,n){this._checkNotCompiled(),this._ensurePointArrayCapacity(2*n);for(var i=t,a=2*this._num_points,o=this._point_array,u=0;u<n;++u)o[a]=e[i],o[a+1]=e[i+1],i+=r,a+=2;this._num_points+=n}},{key:"compile",value:function(){this._is_compiled||(this._buildCollisionQuadTree(),this._node_array.length>this._next_node&&(this._node_array=new Uint32Array(this._node_array.slice(0,this._next_node))),this._point_array=null,this._is_compiled=!0)}},{key:"intersectsWith",value:function(e){if(0==this._node_array.length)return!1;for(var t=e.getFlatAreaList(),r=0;r<t.length;++r)if(this._intersectsWith(t[r]))return!0;return!1}},{key:"_intersectsWith",value:function(e){for(var t=0,r=this._node_array,n=0;n<e.length;++n){if(t=r[t+e[n]],t==c)return!0;if(t==_)return!1}return!0}},{key:"_checkNotCompiled",value:function(){if(this._is_compiled)throw new Error("EitityRegion is already compiled.")}},{key:"_ensurePointArrayCapacity",value:function(e){var t=2*this._num_points,r=t+e,n=this._point_array.length;if(r>n){var i=Math.max(r,Math.floor(1.5*n)),a=new Float64Array(i);a.set(this._point_array.slice(0,t)),this._point_array=a}}},{key:"_buildCollisionQuadTree",value:function(){for(var e=2*Math.PI,t=this._point_array,r=2*this._num_points,n=0;n<r;){var i=t[n++],a=t[n++],o=i+180*Math.floor((90-a)/360+Math.floor((90+a)/360)),s=o-360-360*Math.floor((o-180)/360),l=90-Math.abs(90-a+360*Math.floor((90+a)/360)),_=s*u.default.DEGREE,c=u.default.invGudermannian(l*u.default.DEGREE),f=_/e+.5,h=.5-c/e;this._addCollisionQuadTreeNode(f,h)}this._next_node>0&&(this._setFullNodeRecur(0),this._reduceNodeRecur(0))}},{key:"_addCollisionQuadTreeNode",value:function(e,t){if(!(t<0||t>1))for(var r=1<<l,n=u.default.clamp(Math.floor(e*r),0,r-1),i=Math.min(Math.floor(t*r),r-1),a=this._findRootNode(),o=r>>1;0!=o;o>>=1){var s=0==(n&o)?0:1,_=0==(i&o)?0:2;a=this._findChildNode(a,s+_)}}},{key:"_findRootNode",value:function(){if(0==this._next_node){this._ensureNodeArrayCapacity();for(var e=0;e<4;++e)this._node_array[e]=_;this._next_node=4}return 0}},{key:"_findChildNode",value:function(e,t){var r=this._node_array[e+t];if(0==r){this._ensureNodeArrayCapacity(),r=this._next_node;for(var n=0;n<4;++n)this._node_array[r+n]=_;this._next_node+=4,this._node_array[e+t]=r}return r}},{key:"_setFullNodeRecur",value:function(e){for(var t=this._node_array,r=!0,n=0;n<4;++n){var i=t[e+n];i!=_&&(this._setFullNodeRecur(i),r=!1)}if(r)for(n=0;n<4;++n)t[e+n]=c}},{key:"_reduceNodeRecur",value:function(e){for(var t=this._node_array,r=0,n=0;n<4;++n){var i=t[e+n];i==c?++r:i!=_&&this._reduceNodeRecur(i)&&(t[e+n]=c,++r)}return 4==r}},{key:"_ensureNodeArrayCapacity",value:function(){var e=this._next_node,t=e+4,r=this._node_array.length;if(t>r){var n=Math.max(t,Math.floor(1.5*r)),i=new Uint32Array(n);i.set(this._node_array.slice(0,e)),this._node_array=i}}}]),e}(),l=20,_=0,c=4294967295;t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"status",value:function(e){return o.READY}},{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.ImageProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.ImageProvider#cancelRequest() method has not been overridden.")}},{key:"getImageSize",value:function(){throw new Error("mapray.ImageProvider#getImageSize() method has not been overridden.")}},{key:"getZoomLevelRange",value:function(){throw new Error("mapray.ImageProvider#getZoomLevelRange() method has not been overridden.")}}]),e}(),a=function(){function e(t,n){r(this,e),this._min=t,this._max=n}return n(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();i.Range=a;var o={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};i.Status=o,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(31),u=n(o),s=function(){function e(t,r){i(this,e),this._glenv=t,this._draw_mode=void 0,this._num_vertices=0,this._attrib_data={},this._index_data=null,r instanceof l?this._initByInitializer(r):r instanceof ArrayBuffer?this._initByInitializer(new h(t,r).initializer):this._initByInitializer(new f(t,r).initializer)}return a(e,[{key:"_initByInitializer",value:function(e){this._draw_mode=this._convertDrawMode(e.draw_mode),this._num_vertices=e.num_vertices;for(var t=e.attribute_data,r=0;r<t.length;++r){var n=t[r];this._attrib_data[n.id]={mesh_buffer:n.buffer,buffer:n.buffer.handle,num_components:n.num_components,component_type:this._convertComponentType(n.component_type),normalized:n.normalized,byte_stride:n.byte_stride,byte_offset:n.byte_offset}}if(e.index_data){var i=e.index_data;this._index_data={mesh_buffer:i.buffer,buffer:i.buffer.handle,num_indices:i.num_indices,type:this._convertComponentType(i.type),byte_offset:i.byte_offset}}}},{key:"_convertDrawMode",value:function(e){var t=this._glenv.context;switch(e){case _.POINTS:return t.POINTS;case _.LINES:return t.LINES;case _.TRIANGLES:return t.TRIANGLES;case _.LINE_LOOP:return t.LINE_LOOP;case _.LINE_STRIP:return t.LINE_STRIP;case _.TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case _.TRIANGLE_FAN:return t.TRIANGLE_FAN;default:throw new Error("mapray: invalid Mesh.DrawMode: "+e)}}},{key:"_convertComponentType",value:function(e){var t=this._glenv.context;switch(e){case c.BYTE:return t.BYTE;case c.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case c.SHORT:return t.SHORT;case c.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;case c.UNSIGNED_INT:return t.UNSIGNED_INT;case c.FLOAT:return t.FLOAT;default:throw new Error("mapray: invalid Mesh.ComponentType: "+e)}}},{key:"dispose",value:function(){this._attrib_data={},this._index_data=null}},{key:"draw",value:function(e){var t=this._glenv.context;e.bindVertexAttribs(this._attrib_data);var r=this._index_data;null!==r?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.buffer),t.drawElements(this._draw_mode,r.num_indices,r.type,r.byte_offset)):t.drawArrays(this._draw_mode,0,this._num_vertices)}}]),e}(),l=function(){function e(t,r){i(this,e),this.draw_mode=t,this.num_vertices=r,this.index_data=null,this.attribute_data=[]}return a(e,[{key:"addIndex",value:function(e,t,r,n){var i=n||{};this.index_data={buffer:e,num_indices:t,type:r,byte_offset:void 0!==i.byte_offset?i.byte_offset:0}}},{key:"addAttribute",value:function(e,t,r,n,i){var a=i||{},o={id:e,buffer:t,num_components:r,component_type:n,normalized:void 0!==a.normalized&&a.normalized,byte_stride:void 0!==a.byte_stride?a.byte_stride:0,byte_offset:void 0!==a.byte_offset?a.byte_offset:0};this.attribute_data.push(o)}}]),e}(),_={POINTS:{id:"POINTS"},LINES:{id:"LINES"},TRIANGLES:{id:"TRIANGLES"},LINE_LOOP:{id:"LINE_LOOP"},LINE_STRIP:{id:"LINE_STRIP"},TRIANGLE_STRIP:{id:"TRIANGLE_STRIP"},TRIANGLE_FAN:{id:"TRIANGLE_FAN"}},c={BYTE:{id:"BYTE"},UNSIGNED_BYTE:{id:"UNSIGNED_BYTE"},SHORT:{id:"SHORT"},UNSIGNED_SHORT:{id:"UNSIGNED_SHORT"},UNSIGNED_INT:{id:"UNSIGNED_INT"},FLOAT:{id:"FLOAT"}},f=function(){function e(t,r){i(this,e);var n=d.createVertexInfo(r.vtype),a=d.numVertexComponents(n),o=r.vertices.length/a;this._initializer=new l(e._toDrawMode(r),o),this._addIndex(t,r.indices,o);for(var s=4,_=new u.default(t,d.toTypedArray(r.vertices,c.FLOAT)),f=a*s,h=0,v=0;v<n.length;++v){var p=n[v].size;this._initializer.addAttribute(n[v].name,_,p,c.FLOAT,{byte_stride:f,byte_offset:h}),h+=p*s}}return a(e,[{key:"_addIndex",value:function(e,t,r){var n=r<65536?c.UNSIGNED_SHORT:c.UNSIGNED_INT,i=new u.default(e,d.toTypedArray(t,n),{target:u.default.Target.INDEX});this._initializer.addIndex(i,t.length,n)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(e){switch(e.ptype){case"triangles":return _.TRIANGLES;case"lines":return _.LINES;default:return _.TRIANGLES}}}]),e}(),h=function(){function e(t,r){i(this,e);var n=new DataView(r,0),a=n.getUint8(e.OFFSET_VTYPE),o=n.getUint8(e.OFFSET_ITYPE),s=n.getUint8(e.OFFSET_PTYPE),_=n.getUint32(e.OFFSET_NUM_VERTICES,!0),f=n.getUint32(e.OFFSET_NUM_INDICES,!0);this._initializer=new l(e._toDrawMode(s),_);var h=d.createVertexInfo(a),v=this._createIndexArray(t,r,o,f,h,_);this._addIndex(t,o,v);for(var p=4,y=new u.default(t,this._createVertexArray(r,h,_)),m=d.numVertexComponents(h)*p,g=0,b=0;b<h.length;++b){var w=h[b].size;this._initializer.addAttribute(h[b].name,y,w,c.FLOAT,{byte_stride:m,byte_offset:g}),g+=w*p}}return a(e,[{key:"_createIndexArray",value:function(t,r,n,i,a,o){var u,s,l,_=4,c=d.numVertexComponents(a)*o*_,f=new DataView(r,e.OFFSET_BODY+c);switch(n){case e.ENUM_ITYPE_UINT16:for(s=new Uint16Array(i),l=2,u=0;u<i;++u)s[u]=f.getUint16(l*u,!0);break;case e.ENUM_ITYPE_UINT32:for(s=new Uint32Array(i),l=4,u=0;u<i;++u)s[u]=f.getUint32(l*u,!0);break;default:throw new Error("mapray: unknown itype: "+n)}return s}},{key:"_createVertexArray",value:function(t,r,n){for(var i=4,a=d.numVertexComponents(r)*n,o=new DataView(t,e.OFFSET_BODY),u=new Float32Array(a),s=0;s<a;++s)u[s]=o.getFloat32(s*i,!0);return u}},{key:"_addIndex",value:function(t,r,n){var i=new u.default(t,n,{target:u.default.Target.INDEX}),a=e._indexTypeToComponentType(r);this._initializer.addIndex(i,n.length,a)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(t){switch(t){case e.ENUM_PTYPE_TRIANGLES:return _.TRIANGLES;case e.ENUM_PTYPE_LINES:return _.LINES;default:throw new Error("mapray: invalid ptype: "+t)}}},{key:"_indexTypeToComponentType",value:function(t){switch(t){case e.ENUM_ITYPE_UINT16:return c.UNSIGNED_SHORT;case e.ENUM_ITYPE_UINT32:default:return c.UNSIGNED_INT}}}]),e}();h.OFFSET_VTYPE=0,h.OFFSET_ITYPE=1,h.OFFSET_PTYPE=2,h.OFFSET_NUM_VERTICES=4,h.OFFSET_NUM_INDICES=8,h.OFFSET_BODY=12,h.ENUM_ITYPE_UINT16=0,h.ENUM_ITYPE_UINT32=1,h.ENUM_PTYPE_TRIANGLES=0,h.ENUM_PTYPE_LINES=1;var d=function(){function e(){i(this,e)}return a(e,null,[{key:"createVertexInfo",value:function(t){if(Array.isArray(t))return t;var r=null;switch(t){case"P":case e.ENUM_VTYPE_P:r=[{name:e.ANAME_P,size:e.FSIZE_P}];break;case"PN":case e.ENUM_VTYPE_PN:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N}];break;case"PT":case e.ENUM_VTYPE_PT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_T,size:e.FSIZE_T}];break;case"PNT":case e.ENUM_VTYPE_PNT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N},{name:e.ANAME_T,size:e.FSIZE_T}];break;default:throw new Error("mapray: unknown vtype: "+t)}return r}},{key:"numVertexComponents",value:function(e){for(var t=e.length,r=0,n=0;n<t;++n)r+=e[n].size;return r}},{key:"toTypedArray",value:function(e,t){switch(t){case c.UNSIGNED_SHORT:return e instanceof Uint16Array?e:new Uint16Array(e);case c.UNSIGNED_INT:return e instanceof Uint32Array?e:new Uint32Array(e);case c.FLOAT:return e instanceof Float32Array?e:new Float32Array(e);default:throw new Error("mapray: invalid component type: "+t)}}}]),e}();d.ENUM_VTYPE_P=0,d.ENUM_VTYPE_PN=1,d.ENUM_VTYPE_PT=2,d.ENUM_VTYPE_PNT=3,d.ANAME_P="a_position",d.ANAME_N="a_normal",d.ANAME_T="a_texcoord",d.FSIZE_P=3,d.FSIZE_N=3,d.FSIZE_T=2,s.Initializer=l,s.DrawMode=_,s.ComponentType=c,t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(t,r,n,a){i(this,e),this._glenv=t,this.mesh=r,this.material=n,this.transform=a,this.pivot=null,this.bbox=null,this.properties=null,this.sort_z=void 0}return a(e,[{key:"fastClone",value:function(){var t=new e(this._glenv,this.mesh,this.material,u.default.createMatrix(this.transform));return this.pivot&&(t.pivot=u.default.createVector3(this.pivot)),this.bbox&&(t.bbox=this.bbox.map(function(e){return u.default.createVector3(e)})),t.properties=this.properties,t}},{key:"isVisible",value:function(t){var r=e._obj_to_view;u.default.mul_AA(t._gocs_to_view,this.transform,r);var n=this.bbox;if(n){e._transformBBox(n,r);for(var i=t._volume_planes,a=0;a<i.length;++a)if(e._isBBoxBackSide(i[a]))return!1}var o=this.pivot;return o?this.sort_z=r[2]*o[0]+r[6]*o[1]+r[10]*o[2]+r[14]:this.sort_z=r[14],!0}},{key:"isTranslucent",value:function(e){return this.material.isTranslucent(e,this)}},{key:"draw",value:function(e){var t=this.material;t.bindProgram(),t.setParameters(e,this),this.mesh.draw(t)}}],[{key:"_transformBBox",value:function(t,r){for(var n=0;n<2;++n)for(var i=t[n][2],a=0;a<2;++a)for(var o=t[a][1],u=0;u<2;++u){var s=t[u][0],l=e._bbox_points[u+2*a+4*n];l[0]=r[0]*s+r[4]*o+r[8]*i+r[12],l[1]=r[1]*s+r[5]*o+r[9]*i+r[13],l[2]=r[2]*s+r[6]*o+r[10]*i+r[14]}}},{key:"_isBBoxBackSide",value:function(t){for(var r=e._bbox_points,n=0;n<r.length;++n){var i=r[n],a=i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+t[3];if(a>=0)return!1}return!0}}]),e}();s._obj_to_view=u.default.createMatrix(),s._bbox_points=[];for(var l=0;l<8;++l)s._bbox_points.push(u.default.createVector3());t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=new RegExp("^data:"),a=new RegExp("^https?://"),o=function(){function e(){r(this,e)}return n(e,null,[{key:"createCanvasContext",value:function(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(r,n){var i=new Image;i.onload=function(e){return r(e.target)},i.onerror=function(e){return n(new Error("Failed to load image"))},void 0!==t.crossOrigin&&(i.crossOrigin=t.crossOrigin),e instanceof Blob?i.src=URL.createObjectURL(e):i.src=e})}},{key:"waitForLoad",value:function(e){return e.src?e.complete?Promise.resolve(e):new Promise(function(t,r){var n=e.onload,i=e.onerror;e.onload=function(e){n&&n(e),t(e.target)},e.onerror=function(e){i&&i(e),r(new Error("Failed to load image"))}}):Promise.reject(new Error("src was not set"))}},{key:"resolveUrl",value:function(e,t){return i.test(t)||a.test(t)?t:e+t}}]),e}();o.SYSTEM_FONT_FAMILY="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'",t.default=o,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function");
}function u(e,t){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.URLResource=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(25),_=n(l),c=r(11),f=n(c),h=r(5),d=n(h),v=r(14),p=n(v),y=function(){function e(){o(this,e)}return s(e,[{key:"load",value:function(e){return Promise.reject(new Error("Not Implemented"))}},{key:"cancel",value:function(){}},{key:"loadSubResourceSupported",value:function(e){return!1}},{key:"loadSubResource",value:function(e,t){return Promise.reject(new Error("Not Supported"))}},{key:"resolveResourceSupported",value:function(e){return!1}},{key:"resolveResource",value:function(e,t){return Promise.reject(new Error("Not Supported"))}}]),e}(),m=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n._url=e;var a=e.lastIndexOf("/");if(a===-1)throw new Error("invalid url");return n._base_url=n._url.substr(0,a+1),n._type=r.type||"json",n._transform=r.transform||u,n._abort_ctrl=new AbortController,n}return a(t,e),s(t,[{key:"load",value:function(e){var t=this,r=this._transform(this._url,e);return _.default.get(r.url,null,this._make_fetch_params(r)).then(function(e){if(!e.ok)throw new Error(e.statusText);if("json"!==t._type)throw new Error("unsupported type: "+t._type);return e.json()})}},{key:"cancel",value:function(){this._abort_ctrl.abort()}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=f.default.resolveUrl(this._base_url,e),n=this._transform(r,t);return t===p.default.ResourceType.BINARY?_.default.get(n.url,null,n.init).then(function(e){if(!e.ok)throw new Error(e.statusText);return e}).then(function(e){return e.arrayBuffer()}):t===p.default.ResourceType.IMAGE?f.default.loadImage(n.url,{crossOrigin:n.crossOrigin}):_.default.get(n.url,null,this._make_fetch_params(n)).then(function(e){if(!e.ok)throw new Error(e.statusText);return e.json()})}},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){var r=f.default.resolveUrl(this._base_url,e);return new t(r,{transform:this._transform})}},{key:"_make_fetch_params",value:function(e){var t={signal:this._abort_ctrl.signal,credentials:(e.credentials||_.default.CREDENTIAL_MODE.OMIT).credentials};return e.headers&&(t.headers=e.headers),t}},{key:"makeBinaryFetchParams",value:function(e,t){var r=this._transform(e,t),n={credentials:(r.credentials||d.default.OMIT).credentials};return r.headers&&(n.headers=r.headers),{url:r.url,init:n}}},{key:"_makeImageLoadParams",value:function(e,t){var r=this._transform(e,t),n={url:r.url};return r.credentials===d.default.SAME_ORIGIN?n.crossOrigin="anonymous":r.credentials===d.default.INCLUDE&&(n.crossOrigin="use-credentials"),n}}]),t}(y);t.URLResource=m,t.default=y},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e);var a=i||{};this._glenv=t,this._handle=this._createTexture(n,a)}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;e.deleteTexture(this._handle),this._handle=null}},{key:"_createTexture",value:function(t,r){var n=this._glenv.context,i=n.TEXTURE_2D,a=n.createTexture(),o=e._getParameters(n,r);n.bindTexture(i,a);var u=void 0===r.flip_y||r.flip_y;return n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,u),r.usage===e.Usage.COLOR?n.texImage2D(i,0,o.format,1,1,0,o.format,o.type,e._getColorArray(r)):n.texImage2D(i,0,o.format,o.format,o.type,t),u&&n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),e._generateMipmapQ(n,o)&&n.generateMipmap(i),n.texParameteri(i,n.TEXTURE_MAG_FILTER,o.mag_filter),n.texParameteri(i,n.TEXTURE_MIN_FILTER,o.min_filter),n.texParameteri(i,n.TEXTURE_WRAP_S,o.wrap_s),n.texParameteri(i,n.TEXTURE_WRAP_T,o.wrap_t),n.bindTexture(i,null),a}},{key:"handle",get:function(){return this._handle}}],[{key:"_getParameters",value:function(t,r){var n={format:t.RGBA,type:t.UNSIGNED_BYTE,mag_filter:t.LINEAR,min_filter:t.LINEAR_MIPMAP_LINEAR,wrap_s:t.REPEAT,wrap_t:t.REPEAT};return r.usage===e.Usage.TEXT?(n.format=t.ALPHA,n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.COLOR?(n.mag_filter=t.NEAREST,n.min_filter=t.NEAREST):r.usage===e.Usage.ICON&&(n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE),void 0!==r.mag_filter&&(n.mag_filter=r.mag_filter),void 0!==r.min_filter&&(n.min_filter=r.min_filter),void 0!==r.wrap_s&&(n.wrap_s=r.wrap_s),void 0!==r.wrap_t&&(n.wrap_t=r.wrap_t),n}},{key:"_getColorArray",value:function(e){var t=e.color||[1,1,1,1],r=t.map(function(e){return Math.round(255*e)});return new Uint8Array(r)}},{key:"_generateMipmapQ",value:function(e,t){var r=t.min_filter;return r==e.NEAREST_MIPMAP_NEAREST||r==e.LINEAR_MIPMAP_NEAREST||r==e.NEAREST_MIPMAP_LINEAR||r==e.LINEAR_MIPMAP_LINEAR}}]),e}(),a={GENERAL:{id:"GENERAL"},COLOR:{id:"COLOR"},TEXT:{id:"TEXT"},ICON:{id:"ICON"}};i.Usage=a,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e,t){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(29),_=n(l),c=r(1),f=n(c),h=r(17),d=n(h),v=r(5),p=(n(v),r(61)),y=n(p),m=r(16),g=n(m),b=r(39),w=n(b),E=r(32),x=n(E),k=r(18),T=n(k),M=r(89),P=n(M),O=r(12),A=n(O),I=function(e){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i(this,t),r instanceof A.default);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new O.URLResource(r,{type:"json",transform:n.transform})}var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,{onLoad:n.callback}));return o._transform=n.transform||u,o._glenv=e.glenv,o._references={},o._finished=!1,o}return o(t,e),s(t,[{key:"getReference",value:function(e){var t=this._references[e];return void 0!==t?t:null}},{key:"_setReference",value:function(e,t){this._references[e]=t}},{key:"_load",value:function(){var e=this;return this._resource.load(R.SCENE).then(function(t){return e._check_cancel(),e._load_object(t)})}},{key:"_load_object",value:function(e){var t=this;return Promise.resolve().then(function(){return t._load_model_register(e)}).then(function(){return t._postload_object(e)})}},{key:"_postload_object",value:function(e){this.status===_.default.Status.LOADING&&this._load_entity_list(e)}},{key:"_load_model_register",value:function(e){var t=e.model_register;if(t){for(var r=Object.keys(t),n=[],i=0;i<r.length;++i){var a=r[i],o=t[a];n.push(this._load_model_container(e,a,o))}return Promise.all(n)}}},{key:"_load_model_container",value:function(e,r,n){var i=this,a=n.link;if(!this._resource.resolveResourceSupported())return Promise.reject(new Error("Sub Resource is not supported"));var o=this._resource.resolveResource(a,R.MODEL);return o.load(a,R.MODEL).then(function(e){return i._check_cancel(),P.default.load(e,{base_resource:o,binary_type:R.BINARY,image_type:R.IMAGE})}).then(function(e){var a=new y.default(i._scene,e);if(n.offset_transform){var o=t.parseOffsetTransform(n.offset_transform);a.setOffsetTransform(o)}i._setReference(r,a)})}},{key:"_load_entity_list",value:function(e){var t=e.entity_list;if(t)for(var r=this._scene,n=0;n<t.length;++n){var i=t[n],a=i.type,o=null;switch(a){case"markerline":o=new g.default(r,{json:i,refs:this._references});break;case"text":o=new w.default(r,{json:i,refs:this._references});break;case"model":o=new x.default(r,{json:i,refs:this._references});break;case"polygon":o=new T.default(r,{json:i,refs:this._references});break;default:console.error("mapray: unknown entity type: "+a)}if(o){r.addEntity(o);var u=i.id;u&&this._setReference(u,o)}}}}],[{key:"parseOffsetTransform",value:function(e){var t=e,r=t.translate||[0,0,0],n=new d.default(t.heading,t.tilt,t.roll),i=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof i&&(i=[i,i,i]);var a=f.default.createMatrix();return n.getTransformMatrix(i,a),a[12]=r[0],a[13]=r[1],a[14]=r[2],a}}]),t}(_.default),R={SCENE:{id:"SCENE"},MODEL:{id:"MODEL"},BINARY:{id:"BINARY"},IMAGE:{id:"IMAGE"}};I.ResourceType=R,I._defaultHeaders={},t.default=I,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e)}return n(e,[{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.DemProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.DemProvider#cancelRequest() method has not been overridden.")}},{key:"getResolutionPower",value:function(){return 8}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),l=n(s),_=r(10),c=n(_),f=r(9),h=n(f),d=r(60),v=n(d),p=r(1),y=n(p),m=r(3),g=n(m),b=r(2),w=n(b),E=r(7),x=n(E),k=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._point_array=new Float64Array(0),n._num_floats=0,n._width=1,n._color=y.default.createVector3([1,1,1]),n._opacity=1,n._primitive_producer=new T(n),r&&r.json&&n._setupByJson(r.json),n}return o(t,e),u(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"setLineWidth",value:function(e){this._width=e}},{key:"setColor",value:function(e){y.default.copyVector3(e,this._color)}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"addPoints",value:function(e){var t=e.length;if(0!=t){var r=this._num_floats+t,n=this._point_array.length;if(r>n){for(var i=new Float64Array(Math.max(r,2*n)),a=this._point_array,o=this._num_floats,u=0;u<o;++u)i[u]=a[u];this._point_array=i}for(var s=this._point_array,l=this._num_floats,_=0;_<t;++_)s[l+_]=e[_];this._num_floats=r,this._primitive_producer.onChangePoints()}}},{key:"_getMarkerLineMaterial",value:function(){var e=this.scene;return e._MarkerLineEntity_markerline_material||(e._MarkerLineEntity_markerline_material=new v.default(e.glenv)),e._MarkerLineEntity_markerline_material}},{key:"_setupByJson",value:function(e){this.addPoints(e.points),void 0!==e.line_width&&this.setLineWidth(e.line_width),void 0!==e.color&&this.setColor(e.color),void 0!==e.opacity&&this.setOpacity(e.opacity)}}]),t}(l.default),T=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r._transform=y.default.setIdentity(y.default.createMatrix()),r._pivot=y.default.createVector3(),r._bbox=[y.default.createVector3(),y.default.createVector3()],r._properties={width:1,color:y.default.createVector3f(),opacity:1};var n=new c.default(e.scene.glenv,null,e._getMarkerLineMaterial(),r._transform);return n.pivot=r._pivot,n.bbox=r._bbox,n.properties=r._properties,r._primitive=n,r._primitives=[n],r._geom_dirty=!0,r}return o(t,e),u(t,[{key:"createRegions",value:function(){var e=new x.default;return e.addPoints(this.entity._point_array,0,3,this._numPoints()),[e]}},{key:"onChangeElevation",value:function(e){this._geom_dirty=!0}},{key:"getPrimitives",value:function(e){return this._num_floats<6?[]:(this._updatePrimitive(),this._primitives)}},{key:"onChangeAltitudeMode",value:function(){this._geom_dirty=!0}},{key:"onChangePoints",value:function(){this.needToCreateRegions(),this._geom_dirty=!0}},{key:"_updatePrimitive",value:function(){if(this._updateProperties(),this._geom_dirty){var e=this.entity,t=this._numPoints(),r=g.default.toGocsArray(this._getFlatGeoPoints_with_Absolute(),t,new Float64Array(e._num_floats));this._updateTransformPivotBBox(r,t);var n={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(r,t),indices:this._createIndices()},i=new h.default(e.scene.glenv,n),a=this._primitive;a.mesh&&a.mesh.dispose(),a.mesh=i,this._geom_dirty=!1}}},{key:"_updateProperties",value:function(){var e=this.entity,t=this._properties;t.width=e._width,y.default.copyVector3(e._color,t.color),t.opacity=e._opacity}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){var e=this.entity,t=e._point_array,r=e._num_floats,n=null;switch(e.altitude_mode){case w.default.RELATIVE:var i=this._numPoints();n=new Float64Array(r),e.scene.viewer.getExistingElevations(i,t,0,3,n,2,3);for(var a=0;a<r;a+=3)n[a]=t[a],n[a+1]=t[a+1],n[a+2]+=t[a+2];break;default:n=t}return n}},{key:"_updateTransformPivotBBox",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=this._transform;a[12]=r,a[13]=n,a[14]=i;for(var o=0,u=0,s=0,l=Number.MAX_VALUE,_=Number.MAX_VALUE,c=Number.MAX_VALUE,f=-Number.MAX_VALUE,h=-Number.MAX_VALUE,d=-Number.MAX_VALUE,v=0;v<t;++v){var p=3*v,y=e[p]-r,m=e[p+1]-n,g=e[p+2]-i;o+=y,u+=m,s+=g,y<l&&(l=y),m<_&&(_=m),g<c&&(c=g),y>f&&(f=y),m>h&&(h=m),g>d&&(d=g)}var b=this._pivot;b[0]=o/t,b[1]=u/t,b[2]=s/t;var w=this._bbox,E=w[0],x=w[1];E[0]=l,E[1]=_,E[2]=c,x[0]=f,x[1]=h,x[2]=d}},{key:"_createVertices",value:function(e,t){for(var r=e[0],n=e[1],i=e[2],a=t-1,o=4*a,u=new Float32Array(8*o),s=0;s<a;++s){var l=3*s,_=e[l]-r,c=e[l+1]-n,f=e[l+2]-i,h=e[l+3]-r,d=e[l+4]-n,v=e[l+5]-i,p=e[l+3]-e[l],y=e[l+4]-e[l+1],m=e[l+5]-e[l+2],g=32*s;u[g]=_,u[g+1]=c,u[g+2]=f,u[g+3]=p,u[g+4]=y,u[g+5]=m,u[g+6]=-1,u[g+7]=1,u[g+8]=_,u[g+9]=c,u[g+10]=f,u[g+11]=p,u[g+12]=y,u[g+13]=m,u[g+14]=-1,u[g+15]=-1,u[g+16]=h,u[g+17]=d,u[g+18]=v,u[g+19]=p,u[g+20]=y,u[g+21]=m,u[g+22]=1,u[g+23]=1,u[g+24]=h,u[g+25]=d,u[g+26]=v,u[g+27]=p,u[g+28]=y,u[g+29]=m,u[g+30]=1,u[g+31]=-1}return u}},{key:"_createIndices",value:function(){for(var e=this._numPoints(),t=e-1,r=6*t,n=new Uint32Array(r),i=0;i<t;++i){var a=6*i,o=4*i;n[a]=o,n[a+1]=o+1,n[a+2]=o+2,n[a+3]=o+2,n[a+4]=o+1,n[a+5]=o+3}return n}},{key:"_numPoints",value:function(){return Math.floor(this.entity._num_floats/3)}}]),t}(l.default.PrimitiveProducer);t.default=k,e.exports=t.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(1);t.default=n.Orientation,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e,t,r){r[0]=e[t],r[1]=e[t+1],r[2]=e[t+2]}function s(e,t,r){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2]}function l(e,t,r,n){for(var i=0;i<3;++i)D[i]=t[i]-e[i],S[i]=r[i]-e[i];return b.default.cross3(D,S,n),b.default.normalize3(n,n),n}Object.defineProperty(t,"__esModule",{value:!0});var _=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),c=r(4),f=n(c),h=r(10),d=n(h),v=r(9),p=n(v),y=r(65),m=n(y),g=r(1),b=n(g),w=r(3),E=n(w),x=r(2),k=n(x),T=r(7),M=n(T),P=r(72),O=n(P),A=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._extruded=!1,n._color=b.default.createVector3([1,1,1]),n._opacity=1,n._boundaries=[],n._position=null,n._primitive_producer=new I(n),r&&r.json&&n._setupByJson(r.json),n}return o(t,e),_(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer&&this._primitive_producer.onChangeAltitudeMode()}},{key:"setColor",value:function(e){b.default.copyVector3(e,this._color)}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"addOuterBoundary",value:function(e){this._addBoundary(e,!1)}},{key:"addInnerBoundary",value:function(e){this._addBoundary(e,!0)}},{key:"_addBoundary",value:function(e,t){this._boundaries.push(new R(e,t)),this._position=null,this._primitive_producer&&this._primitive_producer.onChangeBoundary()}},{key:"_getPolygonMaterial",value:function(){var e=this.scene;return e._PolygonEntity_material||(e._PolygonEntity_material=new m.default(e.glenv)),e._PolygonEntity_material}},{key:"_setupByJson",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e.boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;"inner"==o.type?this.addInnerBoundary(o.points):this.addOuterBoundary(o.points)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}void 0!==e.extruded&&(this.extruded=e.extruded),void 0!==e.color&&b.default.copyVector3(e.color,this._color),void 0!==e.opacity&&(this._opacity=e.opacity)}},{key:"_getPosition",value:function(){if(null!==this._position)return this._position;if(0==this._boundaries.length)return null;var e=Number.MAX_VALUE,t=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,i=!0,a=!1,o=void 0;try{for(var u,s=this._boundaries[Symbol.iterator]();!(i=(u=s.next()).done);i=!0)for(var l=u.value,_=l.num_points,c=l.points,f=0;f<_;++f){var h=c[3*f],d=c[3*f+1];h<e&&(e=h),h>t&&(t=h),d<r&&(r=d),d>n&&(n=d)}}catch(e){a=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(a)throw o}}return this._position=new E.default((e+t)/2,(r+n)/2),this._position}},{key:"_countNumPointsOnBoundaries",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;e+=o.num_points}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return e}},{key:"_createTriangles",value:function(){var e=this._boundaries,t=this._countNumPointsOnBoundaries(),r=new Float64Array(2*t),n=0,i=!0,a=!1,o=void 0;try{for(var u,s=e[Symbol.iterator]();!(i=(u=s.next()).done);i=!0)for(var l=u.value,_=3*l.num_points,c=l.points,f=0;f<_;f+=3)r[n++]=c[f],r[n++]=c[f+1]}catch(e){a=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(a)throw o}}var h=new O.default(r,0,2,t),d=0,v=!0,p=!1,y=void 0;try{for(var m,g=e[Symbol.iterator]();!(v=(m=g.next()).done);v=!0){for(var b=m.value,w=b.num_points,E=new Uint32Array(w),x=0;x<w;++x)E[x]=d++;h.addBoundary(E)}}catch(e){p=!0,y=e}finally{try{!v&&g.return&&g.return()}finally{if(p)throw y}}try{return h.run()}catch(e){return console.error(e.message),null}}},{key:"extruded",set:function(e){var t=this._extruded;(t&&!e||!t&&e)&&(this._extruded=e,this._primitive_producer&&this._primitive_producer.onChangeExtruded())},get:function(){return this._extruded}}]),t}(f.default),I=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r._status=N.INVALID,r._triangles=null,r._transform=b.default.setIdentity(b.default.createMatrix()),r._pivot=b.default.createVector3(),r._bbox=[b.default.createVector3(),b.default.createVector3()],r._properties={color:b.default.createVector3f(),opacity:1,lighting:!1};var n=new d.default(e.glenv,null,e._getPolygonMaterial(),r._transform);return n.pivot=r._pivot,n.bbox=r._bbox,n.properties=r._properties,r._primitive=n,r}return o(t,e),_(t,[{key:"needsElevation",value:function(){var e=this.entity;return e.altitude_mode!==k.default.ABSOLUTE||e._extruded}},{key:"createRegions",value:function(){var e=this.entity;if(this._status===N.INVALID)return[];var t=new M.default,r=!0,n=!1,i=void 0;try{for(var a,o=e._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;t.addPoints(u.points,0,3,u.num_points)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return t.addPoint(e._getPosition()),[t]}},{key:"onChangeElevation",value:function(e){this._status===N.NORMAL&&(this._status=N.MESH_DIRTY)}},{key:"getPrimitives",value:function(e){if(this._status===N.INVALID)return[];if(this._status===N.TRIANGLE_DIRTY){if(this._triangles=this.entity._createTriangles(),null===this._triangles)return this._primitive.mesh=null,this._status=N.INVALID,[];this._updatePrimitiveMesh()}else this._status===N.MESH_DIRTY&&this._updatePrimitiveMesh();return this._updatePrimitiveProperties(),this._status=N.NORMAL,[this._primitive]}},{key:"onChangeExtruded",value:function(){this._status===N.NORMAL&&(this._status=N.MESH_DIRTY)}},{key:"onChangeAltitudeMode",value:function(){this._status===N.NORMAL&&(this._status=N.MESH_DIRTY)}},{key:"onChangeBoundary",value:function(){this._status=N.TRIANGLE_DIRTY,this._triangles=null,this.needToCreateRegions()}},{key:"_updatePrimitiveMesh",value:function(){var e=new L(this.entity);this._updateTransformPivotBBox(e);var t={vtype:[{name:"a_position",size:3},{name:"a_normal",size:3}],vertices:this._createVertices(e),indices:this._createIndices(e)},r=new p.default(this.entity.scene.glenv,t);this._primitive.mesh=r}},{key:"_updateTransformPivotBBox",value:function(e){var t=this._transform;t[12]=e.origin[0],t[13]=e.origin[1],t[14]=e.origin[2];var r=Number.MAX_VALUE,n=Number.MAX_VALUE,i=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,u=-Number.MAX_VALUE,s=[e.upper];e.lower&&s.push(e.lower);for(var l=0;l<s.length;++l)for(var _=s[l],c=0;c<e.num_points;++c){var f=3*c,h=_[f],d=_[f+1],v=_[f+2];h<r&&(r=h),d<n&&(n=d),v<i&&(i=v),h>a&&(a=h),d>o&&(o=d),v>u&&(u=v)}var p=this._pivot;p[0]=(r+a)/2,p[1]=(n+o)/2,p[2]=(i+u)/2;var y=this._bbox,m=y[0],g=y[1];m[0]=r,m[1]=n,m[2]=i,g[0]=a,g[1]=o,g[2]=u}},{key:"_createVertices",value:function(e){for(var t=6,r=t*e.num_points,n=e.lower?t*(4*e.num_points):0,i=new Float32Array(r+n),a=b.default.normalize3(e.origin,b.default.createVector3()),o=0;o<e.num_points;++o){var _=3*o,c=e.upper[_],f=e.upper[_+1],h=e.upper[_+2],d=t*o;i[d]=c,i[d+1]=f,i[d+2]=h,s(a,i,d+3)}if(e.lower){var v=b.default.createVector3(),p=b.default.createVector3(),y=b.default.createVector3(),m=b.default.createVector3(),g=b.default.createVector3(),w=0,E=!0,x=!1,k=void 0;try{for(var T,M=this.entity._boundaries[Symbol.iterator]();!(E=(T=M.next()).done);E=!0){for(var P=T.value,O=w+P.num_points,A=w;A<O;++A){var I=A,R=A+1<O?A+1:w,L=3*I,D=3*R;u(e.lower,L,v),u(e.lower,D,p),u(e.upper,L,y),u(e.upper,D,m),l(v,p,y,g);var S=r+4*t*A;s(v,i,S),s(g,i,S+3),S+=t,s(p,i,S),s(g,i,S+3),S+=t,s(y,i,S),s(g,i,S+3),S+=t,s(m,i,S),s(g,i,S+3)}w=O}}catch(e){x=!0,k=e}finally{try{!E&&M.return&&M.return()}finally{if(x)throw k}}}return i}},{key:"_createIndices",value:function(e){var t=this._triangles.length/3,r=e.lower?2*e.num_points:0,n=new Uint32Array(3*(t+r));if(n.set(this._triangles),e.lower)for(var i=e.num_points,a=3*t,o=e.num_points,u=0;u<i;++u,a+=6,o+=4)n[a]=o,n[a+1]=o+1,n[a+2]=o+2,n[a+3]=o+2,n[a+4]=o+1,n[a+5]=o+3;return n}},{key:"_updatePrimitiveProperties",value:function(){var e=this.entity,t=this._properties;b.default.copyVector3(e._color,t.color),t.opacity=e._opacity,t.lighting=e._extruded}}]),t}(f.default.PrimitiveProducer),R=function(){function e(t,r){i(this,e);var n=Math.floor(t.length/3);this._points=new Float64Array(3*n),this._num_points=n;var a=e.isCCW(t,n),o=void 0,u=void 0;!r&&a||r&&!a?(o=0,u=3):(o=3*(n-1),u=-3);for(var s=0;s<n;++s)this._points[3*s]=t[o],this._points[3*s+1]=t[o+1],this._points[3*s+2]=t[o+2],o+=u}return _(e,[{key:"points",get:function(){return this._points}},{key:"num_points",get:function(){return this._num_points}}],[{key:"isCCW",value:function(e,t){for(var r=void 0,n=-Number.MAX_VALUE,i=-Number.MAX_VALUE,a=0;a<t;++a){var o=e[3*a],u=e[3*a+1];(u>i||u==i&&o<n)&&(r=a,n=o,i=u)}var s=r==t-1?0:r+1,l=e[3*s],_=e[3*s+1],c=0==r?t-1:r-1,f=e[3*c],h=e[3*c+1],d=l-n,v=_-i,p=f-n,y=h-i;return d*y-p*v>0}}]),e}(),L=function(){function e(t){i(this,e);var r=t.scene.viewer,n=t.altitude_mode,a=this._getCombinedSourcePoints(t),o=t._countNumPointsOnBoundaries(),u=null;(t._extruded||n!==k.default.ABSOLUTE)&&(u=Float64Array.from(a),r.getExistingElevations(o,u,0,3,u,2,3));var s=Float64Array.from(a);if(n===k.default.RELATIVE)if(t._extruded)for(var l=r.getExistingElevation(t._getPosition()),_=0;_<o;++_){var c=3*_+2;s[c]=l+a[c]}else for(var f=0;f<o;++f){var h=3*f+2;s[h]=u[h]+a[h]}for(var d=t._getPosition().getAsGocs(b.default.createVector3()),v=E.default.toGocsArray(s,o,new Float64Array(3*o)),p=0;p<o;++p){var y=3*p;v[y]-=d[0],v[y+1]-=d[1],v[y+2]-=d[2]}var m=null;if(t._extruded){m=E.default.toGocsArray(u,o,new Float64Array(3*o));for(var g=0;g<o;++g){var w=3*g;m[w]-=d[0],m[w+1]-=d[1],m[w+2]-=d[2]}}this.origin=d,this.num_points=o,this.upper=v,this.lower=m}return _(e,[{key:"_getCombinedSourcePoints",value:function(e){var t=new Float64Array(3*e._countNumPointsOnBoundaries()),r=0,n=!0,i=!1,a=void 0;try{for(var o,u=e._boundaries[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;t.set(s.points,r),r+=3*s.num_points}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return t}}]),e}(),D=b.default.createVector3(),S=b.default.createVector3(),N={INVALID:{id:"INVALID"},NORMAL:{id:"NORMAL"},TRIANGLE_DIRTY:{id:"TRIANGLE_DIRTY"},MESH_DIRTY:{id:"MESH_DIRTY"}};t.default=A,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(8),u=n(o),s=r(52),l=n(s),_=r(71),c=n(_),f=r(1),h=n(f),d=function(){function e(t,r){var n=this;i(this,e),this._glenv=t,this._provider=null,this._min_image_z=0,this._max_image_z=0,this._image_zbias=0;var a=function(e){e===u.default.Status.READY?(n._flush(),n._resetImageProvider(r)):e===u.default.Status.FAILED&&console.error("ImageProvider.Status.FAILED in TileTextureCache")};this._resetImageProvider(r.status(a)===u.default.Status.READY?r:new l.default),this._croot=new v,this._max_accesses=0,this._frame_counter=0,this._lower_bound=1,this._upper_bound=1.2,this._num_requesteds=0,this._max_requesteds=75,this._new_requesteds=[];var o=t.context,s=t.EXT_texture_filter_anisotropic;s&&(this._aniso_ext=s,this._max_aniso=o.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this._use_mipmap=!1}return a(e,[{key:"_resetImageProvider",value:function(e){this._provider=e;var t=e.getZoomLevelRange();this._min_image_z=t.min,this._max_image_z=t.max,this._image_zbias=Math.maprayLog2(2*Math.PI/e.getImageSize())}},{key:"cancel",value:function(){this._flush()}},{key:"_flush",value:function(){new m(this,this._croot),this._croot=new v,this._max_accesses=0}},{key:"getImageZBias",value:function(){return this._image_zbias}},{key:"getImageZMin",value:function(){return this._min_image_z}},{key:"getNumWaitingRequests",value:function(){return this._num_requesteds}},{key:"findNearestAncestors",value:function(t,r,n,i){for(var a,o,u,s,l,_=0,c=this._min_image_z,f=Math.pow(2,1-t),d=(r+.5)*f,p=(n+.5)*f,y=this._croot;_<c;++_)a=Math.floor(d)%2,o=Math.floor(p)%2,u=a+2*o,s=y.children,l=s[u],null===l&&(l=new v,s[u]=l),d*=2,p*=2,y=l;var m=this._max_image_z,b=h.default.clamp(i-1,c,m),w=h.default.clamp(i,c,m),E=null,x=null;if(b<w){for(;_<=b;++_)y.state===g.LOADED?E=y:y.state===g.NONE?(y.state=g.REQUESTED,y.req_power=i-_,this._new_requesteds.push([y,_,Math.floor(.5*d),Math.floor(.5*p)])):y.state===g.REQUESTED&&y.updateRequestPower(i-_),a=Math.floor(d)%2,o=Math.floor(p)%2,u=a+2*o,s=y.children,l=s[u],null===l&&(l=new v,s[u]=l),d*=2,p*=2,y=l;x=E,y.state===g.LOADED?x=y:y.state===g.NONE?(y.state=g.REQUESTED,y.req_power=i-_,this._new_requesteds.push([y,_,Math.floor(.5*d),Math.floor(.5*p)])):y.state===g.REQUESTED&&y.updateRequestPower(i-_)}else for(;;++_){if(y.state===g.LOADED?E=y:y.state===g.NONE?(y.state=g.REQUESTED,y.req_power=i-_,this._new_requesteds.push([y,_,Math.floor(.5*d),Math.floor(.5*p)])):y.state===g.REQUESTED&&y.updateRequestPower(i-_),_==b){x=E;break}a=Math.floor(d)%2,o=Math.floor(p)%2,u=a+2*o,s=y.children,l=s[u],null===l&&(l=new v,s[u]=l),d*=2,p*=2,y=l}y.touch();var k=e._findNearestAncestors_result;return k[0]=null!==x?x.data:null,k[1]=null!==E?E.data:null,k}},{key:"endFrame",value:function(){this._performNewRequests();var e=new p(this._croot,this._frame_counter);if(this._max_accesses=Math.max(e.num_accesses,this._max_accesses),e.num_loadeds>this._upper_bound*this._max_accesses){var t=Math.floor(this._lower_bound*this._max_accesses);this._reduceCache(t)}++this._frame_counter}},{key:"_performNewRequests",value:function(){var e=Math.min(this._max_requesteds-this._num_requesteds,this._new_requesteds.length);this._new_requesteds.sort(function(e,t){var r=e[0],n=t[0];return n.req_power-r.req_power});var t=this;this._new_requesteds.slice(0,e).forEach(function(e){var r=e[0],n=e[1],i=e[2],a=e[3];t._requestTileTexture(n,i,a,r)}),this._new_requesteds.slice(e).forEach(function(e){var t=e[0];t.state=g.NONE}),this._new_requesteds.length=0}},{key:"_requestTileTexture",value:function(e,t,r,n){var i=this;n.data=this._provider.requestTile(e,t,r,function(a){n.state===g.REQUESTED&&(a?(n.data=new c.default(e,t,r,i._createTexture(a)),n.state=g.LOADED):(n.data=null,n.state=g.FAILED),--i._num_requesteds)}),++this._num_requesteds}},{key:"_createTexture",value:function(e){var t=this._glenv.context,r=this._aniso_ext,n=t.TEXTURE_2D,i=t.createTexture();return t.bindTexture(n,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(n,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._use_mipmap&&t.generateMipmap(n),t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),
t.texParameteri(n,t.TEXTURE_MIN_FILTER,this._use_mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texParameterf(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._max_aniso),t.bindTexture(n,null),i}},{key:"_reduceCache",value:function(e){var t=new y(this._croot);t.nodes.sort(function(e,t){var r=t.aframe-e.aframe;return 0==r&&e.state===g.LOADED&&t.state===g.LOADED?e.data.z-t.data.z:r});var r=this._glenv.context;t.nodes.slice(e).forEach(function(e){e.state===g.LOADED&&e.data.dispose(r),e.state=g.NONE,e.data=null}),t.clean()}}]),e}();d._findNearestAncestors_result=new Array(2);var v=function(){function e(){i(this,e),this.children=[null,null,null,null],this.state=g.NONE,this.data=null,this.req_power=-1,this.aframe=-1}return a(e,[{key:"updateRequestPower",value:function(e){e>this.req_power&&(this.req_power=e)}},{key:"touch",value:function(){this.aframe=!0}}]),e}(),p=function(){function e(t,r){i(this,e),this.num_loadeds=0,this.num_accesses=0,this._frame=r,this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=e.aframe===!0,n=0;n<4;++n){var i=t[n];null!==i&&(r=this._traverse(i)||r)}return e.state===g.LOADED&&(++this.num_loadeds,r&&++this.num_accesses),r&&(e.aframe=this._frame),r}}]),e}(),y=function(){function e(t){i(this,e),this._root=t,this.nodes=[],this._traverse(t)}return a(e,[{key:"_traverse",value:function(e){var t=e.state;t!==g.LOADED&&t!==g.FAILED||this.nodes.push(e);for(var r=e.children,n=0;n<4;++n){var i=r[n];null!==i&&this._traverse(i)}}},{key:"clean",value:function(){this._clean_recur(this._root)}},{key:"_clean_recur",value:function(e){for(var t=e.state===g.NONE,r=e.children,n=0;n<4;++n){var i=r[n];if(null!==i){var a=this._clean_recur(i);a===!0&&(r[n]=null),t=a&&t}}return t}}]),e}(),m=function(){function e(t,r){i(this,e),this._owner=t,this._traverse(r)}return a(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=0;r<4;++r){var n=t[r];null!==n&&this._traverse(n)}if(e.state===g.REQUESTED){var i=this._owner;e.state=g.NONE,i._provider.cancelRequest(e.data),--i._num_requesteds}}}]),e}(),g={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(88),u=n(o),s=function(){function e(t,r){i(this,e),this._texture=new u.default(r,t.index),this._texCoord=void 0!==t.texCoord?t.texCoord:0}return a(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}},{key:"texCoord",get:function(){return this._texCoord}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(34),l=n(s),_=function(){function e(t){i(this,e),this._canvas=t,this.fov=46,this.near=1,this.far=1e3,this.view_to_gocs=u.default.createMatrix(),u.default.setIdentity(this.view_to_gocs)}return a(e,[{key:"getCanvasToView",value:function(e){var t=e||u.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*u.default.DEGREE/2,s=n/r,l=i*Math.tan(o)/Math.sqrt(1+s*s),_=l*s;return t[0]=2*l/(i*r),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*_/(i*n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=(i-a)/(i*a),t[12]=-l/i,t[13]=_/i,t[14]=-1,t[15]=1/i,t}},{key:"getCanvasToGocs",value:function(e){var t=this.getCanvasToView(e),r=t[0],n=t[5],i=t[11],a=t[12],o=t[13],u=t[15],s=this.view_to_gocs,l=s[0],_=s[1],c=s[2],f=s[4],h=s[5],d=s[6],v=s[8],p=s[9],y=s[10],m=s[12],g=s[13],b=s[14],w=t;return w[0]=l*r,w[1]=_*r,w[2]=c*r,w[4]=f*n,w[5]=h*n,w[6]=d*n,w[8]=m*i,w[9]=g*i,w[10]=b*i,w[12]=l*a+f*o-v+m*u,w[13]=_*a+h*o-p+g*u,w[14]=c*a+d*o-y+b*u,w}},{key:"getViewToCanvas",value:function(e){var t=e||u.default.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*u.default.DEGREE/2,s=n/r,l=i*Math.tan(o)/Math.sqrt(1+s*s),_=l*s;return t[0]=i*r/(2*l),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-i*n/(2*_),t[6]=0,t[7]=0,t[8]=-r/2,t[9]=-n/2,t[10]=a/(i-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*a/(i-a),t[15]=0,t}},{key:"getCanvasRay",value:function(t,r){var n=t[0],i=t[1],a=r||new l.default,o=this.getCanvasToGocs(e._temp_mat),s=n*o[0]+i*o[4]+o[12],_=n*o[1]+i*o[5]+o[13],c=n*o[2]+i*o[6]+o[14],f=n*o[3]+i*o[7]+o[15],h=a.position;h[0]=s/f,h[1]=_/f,h[2]=c/f;var d=this.view_to_gocs,v=a.direction;return v[0]=h[0]-d[12],v[1]=h[1]-d[13],v[2]=h[2]-d[14],u.default.normalize3(v,v),a}},{key:"createRenderInfo",value:function(){var e=this._canvas;return new c(this,e.width,e.height)}}]),e}();_._temp_mat=u.default.createMatrix();var c=function(){function e(t,r,n){i(this,e),this._view_to_clip=u.default.createMatrix(),this._volume_planes=[];for(var a=0;a<6;++a)this._volume_planes.push(u.default.createVector4());this._pixel_step=0,this._setup_view_to_clip(t,r,n),this._setup_volume_planes(),this._setup_pixel_step(r,n)}return a(e,[{key:"_setup_view_to_clip",value:function(e,t,r){var n=e.fov*u.default.DEGREE/2,i=r/t,a=e.near*Math.tan(n)/Math.sqrt(1+i*i),o=-a,s=a,l=-a*i,_=a*i;u.default.frustum_matrix(o,s,l,_,e.near,e.far,this._view_to_clip)}},{key:"_setup_volume_planes",value:function(){var e=this._view_to_clip,t=this._volume_planes;this._add_matrix_rows(e,3,2,t[0]),this._sub_matrix_rows(e,3,2,t[1]),this._add_matrix_rows(e,3,0,t[2]),this._sub_matrix_rows(e,3,0,t[3]),this._add_matrix_rows(e,3,1,t[4]),this._sub_matrix_rows(e,3,1,t[5]);for(var r=0;r<6;++r){var n=t[r],i=n[0],a=n[1],o=n[2],u=1/Math.sqrt(i*i+a*a+o*o);n[0]*=u,n[1]*=u,n[2]*=u,n[3]*=u}}},{key:"_setup_pixel_step",value:function(e,t){var r=this._view_to_clip,n=r[0],i=r[5],a=r[11],o=r[15],u=2*(o-a),s=u/(n*e),l=u/(i*t);this._pixel_step=Math.sqrt(s*s+l*l)*Math.SQRT1_2}},{key:"_add_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]+e[r],n[1]=e[t+4]+e[r+4],n[2]=e[t+8]+e[r+8],n[3]=e[t+12]+e[r+12],n}},{key:"_sub_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]-e[r],n[1]=e[t+4]-e[r+4],n[2]=e[t+8]-e[r+8],n[3]=e[t+12]-e[r+12],n}},{key:"view_to_clip",get:function(){return this._view_to_clip}},{key:"volume_planes",get:function(){return this._volume_planes}},{key:"pixel_step",get:function(){return this._pixel_step}}]),e}();t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a,o){r(this,e);var u=4,s=Math.pow(2,t-1),l=1<<a;this._sx=s/Math.PI*l,this._sy=-this._sx,this._ox=(s-n)*l,this._oy=(s-i)*l,this._body=o,this._pitch=u*(l+1),this._max=l}return n(e,[{key:"sample",value:function(e,t){return 0}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(30),l=n(s),_=r(1),c=n(_),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.glenv,r,n));return o._flake_to_clip=c.default.createMatrixf(),o}return o(t,e),u(t,[{key:"numDrawings",value:function(){return 1}},{key:"isWireframe",value:function(){return!1}},{key:"setFlakeParameter",value:function(e,t,r){return!1}},{key:"setCommonParameter",value:function(e,t){t.mul_flake_to_gocs(e._gocs_to_clip,this._flake_to_clip),this.setMatrix("u_obj_to_clip",this._flake_to_clip)}}]),t}(l.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(49),l=n(s),_=r(54),c=n(_),f=r(73),h=n(f),d=function(){function e(t,r){i(this,e),this._glenv=t,this._dem_provider=r,this._status=v.NOT_READY,this._dem_area_updated=new h.default,this._ρ=r.getResolutionPower(),this._dem_zbias=u.default.LOG2PI-this._ρ+1,this._hist_stats=new y,this._flake_reduce_thresh=1.5,this._flake_reduce_factor=1.2,this._num_cache_flakes=0,this._num_touch_flakes=0,this._mesh_reduce_lower=300,this._mesh_reduce_thresh=1.5,this._mesh_reduce_factor=1.2,this._num_cache_meshes=0,this._num_touch_meshes=0,this._max_dem_requesteds=10,this._num_dem_requesteds=0,this._frame_counter=0,this._root_flake=null,this._avg_height=null,this._root_cancel_id=null,this._requestRoot()}return a(e,[{key:"cancel",value:function(){if(this._status===v.READY)for(var e=this._root_flake._children,t=0;t<4;++t)e[t].dispose();else this._status===v.NOT_READY&&(this._dem_provider.cancelRequest(this._root_cancel_id),this._root_cancel_id=null)}},{key:"getNumDemWaitingRequests",value:function(){return this._num_dem_requesteds}},{key:"findHighestAccuracy",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=u.default.clamp(Math.floor(i),0,n-1)%2,l=u.default.clamp(Math.floor(a),0,n-1)%2,_=r._children[s+2*l];if(r.touch(),null===_)break;r._dem_state===g.LOADED&&(o=r),r=_,n*=2,i*=2,a*=2}return o._requestHighestAccuracy(e,t),o._dem_data}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){for(var s=2*Math.PI,l=1<<this._ρ,_=r,c=a,f=0;f<e;++f){var h=t[_],d=t[_+1],v=h+180*Math.floor((90-d)/360+Math.floor((90+d)/360)),p=v-360-360*Math.floor((v-180)/360),y=90-Math.abs(90-d+360*Math.floor((90+d)/360)),m=p*u.default.DEGREE,g=u.default.invGudermannian(y*u.default.DEGREE),b=m/s+.5,w=.5-g/s;if(w>=0&&w<=1){var E=this._findHighestAccuracy2(b,w);if(null!==E){var x=Math.pow(2,E.z),k=l*(x*b-E.x),T=l*(x*w-E.y),M=u.default.clamp(Math.floor(k),0,l-1),P=u.default.clamp(Math.floor(T),0,l-1),O=E.getHeights(M,P),A=O[0],I=O[1],R=O[2],L=O[3],D=k-M,S=T-P;i[c]=(A*(1-D)+I*D)*(1-S)+(R*(1-D)+L*D)*S}else i[c]=0}else i[c]=0;_+=n,c+=o}return i}},{key:"_findHighestAccuracy2",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=u.default.clamp(Math.floor(i),0,n-1)%2,l=u.default.clamp(Math.floor(a),0,n-1)%2,_=r._children[s+2*l];if(null===_)break;r._dem_state===g.LOADED&&(o=r),r=_,n*=2,i*=2,a*=2}return o._dem_data}},{key:"endFrame",value:function(){var e=this._hist_stats.getMaxValue(this._num_touch_flakes);this._num_cache_flakes>this._flake_reduce_thresh*e&&this._reduceFlakes(e),this._num_cache_meshes>this._mesh_reduce_lower&&this._num_cache_meshes>this._mesh_reduce_thresh*this._num_touch_meshes&&this._reduceMeshes(),this._dem_area_updated.clear(),this._num_touch_flakes=0,this._num_touch_meshes=0,++this._frame_counter}},{key:"_requestRoot",value:function(){var e=this,t=0,r=0,n=0;this._root_cancel_id=this._dem_provider.requestTile(t,r,n,function(i){if(i){var a=new l.default(t,r,n,e._ρ,i);e._avg_height=a.newAvgHeightMaps(),e._root_flake=new p(null,t,r,n),e._root_flake.setupRoot(e,a),e._status=v.READY,e._dem_area_updated.addTileArea(a)}else e._status=v.FAILED;e._root_cancel_id=null,--e._num_dem_requesteds}),++this._num_dem_requesteds}},{key:"_reduceFlakes",value:function(e){var t=this._root_flake.flattenFlakes();t.sort(function(e,t){return e.compareForReduce(t)});var r=Math.floor(this._flake_reduce_factor*e);t.slice(r).forEach(function(e){return e.dispose()})}},{key:"_reduceMeshes",value:function(){var e=this._root_flake.flattenMeshes();e.sort(function(e,t){return e.compareForReduce(t)});var t=Math.floor(this._mesh_reduce_factor*this._num_touch_meshes);e.slice(t).forEach(function(e){return e.dispose()})}},{key:"glenv",get:function(){return this._glenv}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"status",get:function(){return this._status}},{key:"dem_area_updated",get:function(){return this._dem_area_updated}},{key:"root_flake",get:function(){var e=this._root_flake;return e.touch(),e}}]),e}(),v={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};d.Status=v;var p=function(){function e(t,r,n,a){i(this,e),this.z=r,this.x=n,this.y=a,this._parent=t,this._children=[null,null,null,null],this._globe=null!==t?t._globe:null,this._dem_data=null,this._dem_state=g.NONE,this._meshes=[],this._prev_Za_dem=null,this._prev_Zr_dem=null,this._base_height=0,this._height_min=0,this._height_max=0,this._dem_zlimit=0,this._gocs_x_min=0,this._gocs_x_max=0,this._gocs_y_min=0,this._gocs_y_max=0,this._gocs_z_min=0,this._gocs_z_max=0,this._aframe=-1,null!==this._globe&&(this._globe._num_cache_flakes+=1)}return a(e,[{key:"setupRoot",value:function(e,t){this._globe=e,this._dem_data=t,this._dem_state=g.LOADED,this._estimate(),e._num_cache_flakes+=1}},{key:"newChild",value:function(t,r){var n=t+2*r,i=this._children[n];return null===i&&(i=new e(this,this.z+1,2*this.x+t,2*this.y+r),this._children[n]=i),i._estimate(),i.touch(),i}},{key:"isInvisible",value:function(e){switch(this.z){case 0:return this._isInvisible_0(e);default:return this._isInvisible_N(e)}}},{key:"findMesh",value:function(t){var r,n=Math.pow(2,-t)*e.ε;r=n<=2?Math.max(Math.ceil(u.default.LOG2PI-this.z-Math.maprayLog2(Math.acos(1-n))),0):0;var i,a=this._getCosφ();i=n*a<=2?Math.max(Math.ceil(u.default.LOG2PI-this.z+Math.maprayLog2(a/Math.acos(1-n*a))),0):0;var o=this._getMeshNode(t,r,i);return o.touch(),o.mesh}},{key:"findRayDistance",value:function(e,t){var r;for(r=this;r._dem_state!==g.LOADED;r=r._parent);if(this.z-r.z===this._globe._ρ)return this._findQuadRayDistance(e,t,r);if(this._cullForRayDistance(e,t))return t;for(var n=t,i=0;i<2;++i)for(var a=0;a<2;++a)n=this.newChild(a,i).findRayDistance(e,n);return n}},{key:"dispose",value:function(){var e,t=this._parent;if(null!==t){for(var r=this._globe,n=this._meshes;n.length>0;)n[0].dispose();var i=this._children;for(e=0;e<4;++e){var a=i[e];null!==a&&a.dispose()}var o=t._children;for(e=0;e<4;++e)if(o[e]===this){o[e]=null;break}this._parent=null,this._dem_state===g.REQUESTED&&(r._dem_provider.cancelRequest(this._dem_data),--r._num_dem_requesteds),r._num_cache_flakes-=1}}},{key:"flattenFlakes",value:function(){var e=[];return this._flattenFlakes(e),e}},{key:"flattenMeshes",value:function(){var e=[];return this._flattenMeshes(e),e}},{key:"compareForReduce",value:function(e){var t=this,r=e,n=r._aframe-t._aframe;return 0!==n?n:t.z-r.z}},{key:"_flattenFlakes",value:function(e){e.push(this);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenFlakes(e)}}},{key:"_flattenMeshes",value:function(e){Array.prototype.push.apply(e,this._meshes);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenMeshes(e)}}},{key:"touch",value:function(){var e=this._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_flakes+=1)}},{key:"_getMeshNode",value:function(e,t,r){for(var n=this._getMeshDemBinary(e),i=n.getDivisionPowers(this,e,t,r),a=this._meshes,o=a.length,u=0;u<o;++u){var s=a[u];if(s.match(n,i))return s}var l=new m(this,n,i);return a.unshift(l),l}},{key:"_getMeshDemBinary",value:function(e){var t=u.default.clamp(Math.round(e+this._globe._dem_zbias),0,this._dem_zlimit),r=this._findNearestDemTile(t);if(r.z<t){var n=r.getQuadLevel(this.z,this.x,this.y);n>0&&this._requestAncestorDemTile(Math.min(r.z+n,t))}return r}},{key:"_findNearestDemTile",value:function(e){for(var t=this,r=this.z-e,n=0;n<r;++n)t=t._parent;for(;t._dem_state!==g.LOADED;)t=t._parent;return t._dem_data}},{key:"_requestAncestorDemTile",value:function(e){var t=this._globe;if(!(t._num_dem_requesteds>=t._max_dem_requesteds)){for(var r=this,n=this.z-e,i=0;i<n;++i)r=r._parent;for(;;){var a=r._dem_state;if(a===g.LOADED||a===g.REQUESTED)break;{if(a!==g.FAILED){var o=t._dem_provider;r._dem_data=o.requestTile(r.z,r.x,r.y,function(e){null!==r._parent&&(e?(r._dem_data=new l.default(r.z,r.x,r.y,t._ρ,e),r._dem_state=g.LOADED,t._dem_area_updated.addTileArea(r)):(r._dem_data=null,r._dem_state=g.FAILED),--t._num_dem_requesteds)}),r._dem_state=g.REQUESTED,++t._num_dem_requesteds;break}r=r._parent}}}}},{key:"_isInvisible_0",value:function(e){for(var t=u.default.EARTH_RADIUS+this._height_max,r=0;r<e.length;++r){var n=e[r][3];if(n<-t)return!0}return!1}},{key:"_isInvisible_N",value:function(e){for(var t=this._gocs_x_min,r=this._gocs_x_max,n=this._gocs_y_min,i=this._gocs_y_max,a=this._gocs_z_min,o=this._gocs_z_max,u=0;u<e.length;++u){var s=e[u],l=s[0],_=s[1],c=s[2],f=s[3],h=l*t+_*n,d=l*r+_*n,v=l*t+_*i,p=l*r+_*i,y=-c*a-f,m=-c*o-f;if(h<y&&d<y&&v<y&&p<y&&h<m&&d<m&&v<m&&p<m)return!0}return!1}},{key:"_getCosφ",value:function(){var e=this.z;if(e>0){var t=this.y,r=Math.pow(2,1-e),n=Math.abs(1-r*t),i=Math.abs(1-r*(t+1)),a=Math.exp(Math.PI*Math.min(n,i));return 2*a/(a*a+1)}return 1}},{key:"_estimate",value:function(){if(this._prev_Za_dem!==this){var e,t=this.z,r=this._globe._ρ;if(t<r){if(e=this._findNearestDemTile(t),e===this._prev_Zr_dem)return;this._prev_Zr_dem=e,this._estimate_low(e),this._dem_zlimit=t}else{var n=this._findNearestDemTile(t-r);if(n.isLeaf(t,this.x,this.y))this._estimate_leaf(n);else{if(e=this._findNearestDemTile(n.z+r),n===this._prev_Za_dem&&e===this._prev_Zr_dem)return;this._prev_Za_dem=n,this._prev_Zr_dem=e,this._estimate_high(n,e)}this._dem_zlimit=n.z+r}switch(t){case 0:this._updataBoundingBox_0();break;case 1:this._updataBoundingBox_1();break;default:this._updataBoundingBox_N()}}}},{key:"_estimate_low",value:function(t){var r=this.z,n=this.x,i=this.y,a=this._calcAlpha();this._base_height=this._globe._avg_height.sample(r,n,i),this._height_min=Math.max(this._base_height+a*e.Fm,t.height_min),this._height_max=Math.min(this._base_height+a*e.Fp,t.height_max),(t.z==r||t.isLeaf(r,n,i))&&(this._prev_Za_dem=this)}},{key:"_estimate_high",value:function(t,r){var n=this._globe,i=this.z,a=this.x,o=this.y,u=t.z,s=t.x,l=t.y,_=n._ρ,c=Math.pow(2,u-i),f=1<<_,h=Math.floor(f*((a+.5)*c-s)),d=Math.floor(f*((o+.5)*c-l)),v=f*(a*c-s)-h,p=f*((a+1)*c-s)-h,y=f*(o*c-l)-d,m=f*((o+1)*c-l)-d,g=t.getHeights(h,d),b=g[0],w=g[1],E=g[2],x=g[3],k=(b*(1-v)+w*v)*(1-y)+(E*(1-v)+x*v)*y,T=(b*(1-p)+w*p)*(1-y)+(E*(1-p)+x*p)*y,M=(b*(1-v)+w*v)*(1-m)+(E*(1-v)+x*v)*m,P=(b*(1-p)+w*p)*(1-m)+(E*(1-p)+x*p)*m,O=this._calcAlpha();if(this._base_height=.25*(k+T+M+P),this._height_min=Math.max(this._base_height+O*e.Fm,r.height_min),this._height_max=Math.min(this._base_height+O*e.Fp,r.height_max),u<i-_){var A=t.getQuadLevel(i,a,o);this._requestAncestorDemTile(Math.min(u+A,i-_))}else(r.z==i||r.isLeaf(i,a,o))&&(this._prev_Za_dem=this)}},{key:"_estimate_leaf",value:function(e){var t=this.z,r=this.x,n=this.y,i=e.z,a=e.x,o=e.y,u=Math.pow(2,i-t),s=1<<this._globe._ρ,l=Math.floor(s*((r+.5)*u-a)),_=Math.floor(s*((n+.5)*u-o)),c=s*(r*u-a)-l,f=s*((r+1)*u-a)-l,h=s*(n*u-o)-_,d=s*((n+1)*u-o)-_,v=e.getHeights(l,_),p=v[0],y=v[1],m=v[2],g=v[3],b=(p*(1-c)+y*c)*(1-h)+(m*(1-c)+g*c)*h,w=(p*(1-f)+y*f)*(1-h)+(m*(1-f)+g*f)*h,E=(p*(1-c)+y*c)*(1-d)+(m*(1-c)+g*c)*d,x=(p*(1-f)+y*f)*(1-d)+(m*(1-f)+g*f)*d;this._base_height=.25*(b+w+E+x),this._height_min=Math.min(b,w,E,x),this._height_max=Math.max(b,w,E,x),this._prev_Za_dem=this}},{key:"_calcAlpha",value:function(){var t=Math.pow(2,1-this.z);return t*e.πr/Math.cosh((1-t*(this.y+.5))*Math.PI)}},{key:"_updataBoundingBox_0",value:function(){var e=u.default.EARTH_RADIUS+this._height_max;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=-e,this._gocs_y_max=e,this._gocs_z_min=-e,this._gocs_z_max=e}},{key:"_updataBoundingBox_1",value:function(){var e=u.default.EARTH_RADIUS+this._height_max,t=this.x,r=this.y;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=e*(t-1),this._gocs_y_max=e*t,this._gocs_z_min=-e*r,this._gocs_z_max=e*(1-r)}},{key:"_updataBoundingBox_N",value:function(){var e=Math.PI,t=this.z,r=this.x,n=this.y,i=Math.pow(2,1-t)*e,a=-e+r*i,o=-e+(r+1)*i,s=e-(n+1)*i,l=e-n*i,_=a,c=o,f=Math.exp(s),h=Math.exp(l),d=f*f,v=h*h,p=u.default.EARTH_RADIUS+this._height_min,y=u.default.EARTH_RADIUS+this._height_max,m=2*f/(d+1),g=2*h/(v+1);s+l<0?(_+c<-e?(this._gocs_x_min=y*g*Math.cos(_),this._gocs_x_max=p*m*Math.cos(c),this._gocs_y_min=y*g*Math.sin(c),this._gocs_y_max=p*m*Math.sin(_)):_+c<0?(this._gocs_x_min=p*m*Math.cos(_),this._gocs_x_max=y*g*Math.cos(c),this._gocs_y_min=y*g*Math.sin(_),this._gocs_y_max=p*m*Math.sin(c)):_+c<e?(this._gocs_x_min=p*m*Math.cos(c),this._gocs_x_max=y*g*Math.cos(_),this._gocs_y_min=p*m*Math.sin(_),this._gocs_y_max=y*g*Math.sin(c)):(this._gocs_x_min=y*g*Math.cos(c),this._gocs_x_max=p*m*Math.cos(_),this._gocs_y_min=p*m*Math.sin(c),this._gocs_y_max=y*g*Math.sin(_)),this._gocs_z_min=y*(d-1)/(d+1),this._gocs_z_max=p*(v-1)/(v+1)):(_+c<-e?(this._gocs_x_min=y*m*Math.cos(_),this._gocs_x_max=p*g*Math.cos(c),this._gocs_y_min=y*m*Math.sin(c),this._gocs_y_max=p*g*Math.sin(_)):_+c<0?(this._gocs_x_min=p*g*Math.cos(_),this._gocs_x_max=y*m*Math.cos(c),this._gocs_y_min=y*m*Math.sin(_),this._gocs_y_max=p*g*Math.sin(c)):_+c<e?(this._gocs_x_min=p*g*Math.cos(c),this._gocs_x_max=y*m*Math.cos(_),this._gocs_y_min=p*g*Math.sin(_),this._gocs_y_max=y*m*Math.sin(c)):(this._gocs_x_min=y*m*Math.cos(c),this._gocs_x_max=p*g*Math.cos(_),this._gocs_y_min=p*g*Math.sin(c),this._gocs_y_max=y*m*Math.sin(_)),this._gocs_z_min=p*(d-1)/(d+1),this._gocs_z_max=y*(v-1)/(v+1))}},{key:"_requestHighestAccuracy",value:function(e,t){var r=this._dem_data.getQuadLevelDirect(e,t);if(0!=r){for(var n=this,i=Math.round(Math.pow(2,this.z+1)),a=i*e,o=i*t,s=0;s<r;++s){var l=u.default.clamp(Math.floor(a),0,i-1)%2,_=u.default.clamp(Math.floor(o),0,i-1)%2;n=n.newChild(l,_),i*=2,a*=2,o*=2}n._requestAncestorDemTile(n.z)}}},{key:"_findQuadRayDistance",value:function(t,r,n){var i=this._getQuadPositions(n,e._temp_positions),a=e._findTriRayDistance(t,r,i[0],i[2],i[1]);return a===r?e._findTriRayDistance(t,r,i[1],i[2],i[3]):a}},{key:"_getQuadPositions",value:function(e,t){for(var r=this.x,n=this.y,i=e.x,a=e.y,o=1<<this._globe._ρ,s=e._dem_data.getHeights(r-o*i,n-o*a),l=Math.pow(2,1-this.z)*Math.PI,_=r*l-Math.PI,c=Math.PI-n*l,f=0,h=c;f<2;++f,h-=l)for(var d=Math.exp(h),v=d*d,p=(v-1)/(v+1),y=2*d/(v+1),m=0,g=_;m<2;++m,g+=l){var b=m+2*f,w=u.default.EARTH_RADIUS+s[b],E=Math.sin(g),x=Math.cos(g),k=t[b];k[0]=w*y*x,k[1]=w*y*E,k[2]=w*p}return t}},{key:"_cullForRayDistance",value:function(e,t){var r=e.position,n=r[0],i=r[1],a=r[2],o=this._gocs_x_min,u=this._gocs_x_max,s=this._gocs_y_min,l=this._gocs_y_max,_=this._gocs_z_min,c=this._gocs_z_max;if(o<=n&&n<=u&&s<=i&&i<=l&&_<=a&&a<=c)return!1;var f,h,d,v,p=e.direction,y=p[0],m=p[1],g=p[2];if(n<o&&y>0){if(f=(o-n)/y,f<t&&(d=i+f*m,v=a+f*g,s<=d&&d<=l&&_<=v&&v<=c))return!1}else if(n>u&&y<0&&(f=(u-n)/y,f<t&&(d=i+f*m,v=a+f*g,s<=d&&d<=l&&_<=v&&v<=c)))return!1;if(i<s&&m>0){if(f=(s-i)/m,f<t&&(h=n+f*y,v=a+f*g,o<=h&&h<=u&&_<=v&&v<=c))return!1}else if(i>l&&m<0&&(f=(l-i)/m,f<t&&(h=n+f*y,v=a+f*g,o<=h&&h<=u&&_<=v&&v<=c)))return!1;if(a<_&&g>0){if(f=(_-a)/g,f<t&&(h=n+f*y,d=i+f*m,o<=h&&h<=u&&s<=d&&d<=l))return!1}else if(a>c&&g<0&&(f=(c-a)/g,f<t&&(h=n+f*y,d=i+f*m,o<=h&&h<=u&&s<=d&&d<=l)))return!1;return!0}},{key:"base_height",get:function(){return this._base_height}},{key:"height_min",get:function(){return this._height_min}},{key:"height_max",get:function(){return this._height_max}}],[{key:"_findTriRayDistance",value:function(t,r,n,i,a){var o=t.direction,s=e._temp_ray_1;s[0]=i[0]-n[0],s[1]=i[1]-n[1],s[2]=i[2]-n[2];var l=e._temp_ray_2;l[0]=a[0]-n[0],l[1]=a[1]-n[1],l[2]=a[2]-n[2];var _=u.default.cross3(s,l,e._temp_ray_3),c=u.default.dot3(_,o);if(c<0){var f=t.position,h=e._temp_ray_4;h[0]=n[0]-f[0],h[1]=n[1]-f[1],h[2]=n[2]-f[2];var d=u.default.dot3(_,h)/c;if(d>=0&&d<r){var v=e._temp_ray_5;v[0]=f[0]+d*o[0],v[1]=f[1]+d*o[1],v[2]=f[2]+d*o[2];var p=e._temp_ray_6;p[0]=n[0]-v[0],p[1]=n[1]-v[1],p[2]=n[2]-v[2];var y=e._temp_ray_7;y[0]=i[0]-v[0],y[1]=i[1]-v[1],y[2]=i[2]-v[2];var m=e._temp_ray_8;if(m[0]=a[0]-v[0],m[1]=a[1]-v[1],m[2]=a[2]-v[2],u.default.dot3(u.default.cross3(p,y,e._temp_ray_9),_)>=0&&u.default.dot3(u.default.cross3(y,m,e._temp_ray_10),_)>=0&&u.default.dot3(u.default.cross3(m,p,e._temp_ray_11),_)>=0)return d}}return r}}]),e}();p.ε=.0625,p.Fm=-2,p.Fp=2,p.πr=Math.PI*u.default.EARTH_RADIUS,p._temp_positions=function(){for(var e=[],t=0;t<4;++t)e.push(u.default.createVector3());return e}(),p._temp_ray_1=u.default.createVector3(),p._temp_ray_2=u.default.createVector3(),p._temp_ray_3=u.default.createVector3(),p._temp_ray_4=u.default.createVector3(),p._temp_ray_5=u.default.createVector3(),p._temp_ray_6=u.default.createVector3(),p._temp_ray_7=u.default.createVector3(),p._temp_ray_8=u.default.createVector3(),p._temp_ray_9=u.default.createVector3(),p._temp_ray_10=u.default.createVector3(),p._temp_ray_11=u.default.createVector3();var y=function(){function e(){i(this,e),this._history=[],this._max_value=0,this._hsize=200}return a(e,[{key:"getMaxValue",value:function(t){var r=this._history,n=this._max_value;return r.length<this._hsize?t>n&&(this._max_value=t):t>=n?(this._max_value=t,r.shift()):r[0]<n?r.shift():(r.shift(),this._max_value=e._find_max(r)),r.push(t),this._max_value}}],[{key:"_find_max",value:function(e){for(var t=e[0],r=e.length,n=1;n<r;++n){var i=e[n];i>t&&(t=i)}return t}}]),e}(),m=function(){function e(t,r,n){i(this,e),this._flake=t,this._dem=r,this._pow_u=n[0],this._pow_v=n[1],this._aframe=-1,this.mesh=new c.default(t._globe.glenv,t,n,r),t._globe._num_cache_meshes+=1}return a(e,[{key:"match",value:function(e,t){return this._dem===e&&this._pow_u===t[0]&&this._pow_v===t[1]}},{key:"touch",value:function(){var e=this._flake._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_meshes+=1)}},{key:"dispose",value:function(){if(null!==this.mesh){for(var e=this._flake,t=e._meshes,r=t.length,n=0;n<r;++n)if(t[n]===this){t.splice(n,1);break}this.mesh.dispose(),this.mesh=null,e._globe._num_cache_meshes-=1}}},{key:"compareForReduce",value:function(e){var t=this,r=e;return r._aframe-t._aframe}}]),e}(),g={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}};t.default=d,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(){i(this,e)}return a(e,null,[{key:"get",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fetch(e.METHOD.GET,t,r,null,n)}},{key:"post",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.POST,t,r,n,i)}},{key:"patch",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.PATCH,t,r,n,i)}},{key:"put",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.PUT,t,r,n,i)}},{key:"delete",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fetch(e.METHOD.DELETE,t,r,null,n)}},{key:"fetch",value:function(e){function t(t,r,n,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=r?"?"+Object.keys(r).map(function(e){return e+"="+r[e]}).join("&"):"";return i.method=e,n&&(i.body=n),fetch(t+a,i).catch(function(e){throw new u("Failed to fetch",t,null,e)}).then(function(e){if(!e.ok)throw new u("Failed to fetch: "+e.statusText,t,e);return e})})},{key:"isJson",value:function(e){return e.startsWith("application/json")||"model/gltf+json"===e}}]),e}();o.METHOD={GET:"GET",POST:"POST",PATCH:"PATCH",PUT:"PUT",DELETE:"DELETE"},o.CONTENT_TYPE="Content-Type",o.RESPONSE_STATUS={NO_CONTENT:204},o.CREDENTIAL_MODE={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}};var u=function(e){function t(e,n,a,o){i(this,t);var u=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e+" "+n));return Error.captureStackTrace&&Error.captureStackTrace(u,t),u.name="FetchError",u.url=n,u.response=a,u.cause=o,o&&(u.stack+="\nCaused-By: "+o.stack),u}return n(t,e),t}(Error);t.FetchError=u,t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ImageIconLoader=t.TextIconLoader=t.URLTemplateIconLoader=void 0;var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(11),l=n(s),_=function(){function e(){o(this,e),this._cache=new Map}return u(e,[{key:"create",value:function(e){var t=this.getKey(e),r=this._cache.get(t);return r||this._cache.set(t,r=this.doCreate(e)),r}},{key:"doCreate",value:function(e){}},{key:"getKey",value:function(e){return e}},{key:"load",value:function(e){var t=this.create(e);return t.load(),t}}]),e}(),c=function(){function e(){
o(this,e),this._status=e.Status.NOT_LOADED,this.funcs=[]}return u(e,[{key:"isLoaded",value:function(){return this._status===e.Status.LOADED}},{key:"onEnd",value:function(t){var r=this._status===e.Status.LOADED||this._status===e.Status.ABORTED;r?t(this):this.funcs.push(t)}},{key:"load",value:function(){var t=this;if(this._status===e.Status.NOT_LOADED)return this._status=e.Status.LOADING,this.doLoad().then(function(r){t._icon=r,t._status=e.Status.LOADED;for(var n=0;n<t.funcs.length;n++)t.funcs[n](t);t.funcs.length=0}).catch(function(r){t._status=e.Status.ABORTED;for(var n=0;n<t.funcs.length;n++)t.funcs[n](t);t.funcs.length=0})}},{key:"doLoad",value:function(e,t){return Promise.reject(new Error("doLoad() is not implemented in: "+this.constructor.name))}},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}},{key:"status",get:function(){return this._status}},{key:"icon",get:function(){return this._icon}},{key:"width",get:function(){return this.icon?this.icon.width:-1}},{key:"height",get:function(){return this.icon?this.icon.height:-1}}]),e}();c.Status={NOT_LOADED:"not loaded",LOADING:"loading",LOADED:"loaded",ABORTED:"aborted"};var f=function(e){function t(e,r){o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.urlPrefix=e,n.urlSuffix=r,n}return a(t,e),u(t,[{key:"doCreate",value:function(e){return new h(this.urlPrefix+e+this.urlSuffix)}}]),t}(_),h=function(e){function t(e){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.url=e,r}return a(t,e),u(t,[{key:"doLoad",value:function(e,t){return l.default.loadImage(this.url,{crossOrigin:"Anonymous"})}}]),t}(c),d=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),u(t,[{key:"doCreate",value:function(e){return new v(e.text,e.props)}},{key:"getKey",value:function(e){return e.text}}]),t}(_),v=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.text=e,n.props=r,n}return a(t,e),u(t,[{key:"doLoad",value:function(e,t){var r=this.props,n=r.size?r.size[0]:20,i=r.font_family?"'"+r.font_family+"'":l.default.SYSTEM_FONT_FAMILY,a=l.default.createCanvasContext(n,n);return a.textAlign="center",a.textBaseline="alphabetic",a.font=.6756756757*n+"px "+i,a.fillText(this.text,.5*n,.7432432432*n),Promise.resolve(a.canvas)}},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}}]),t}(c),p=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),u(t,[{key:"doCreate",value:function(e){return new y(e)}}]),t}(_),y=function(e){function t(e){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._image_src=e,r}return a(t,e),u(t,[{key:"doLoad",value:function(e,t){var r=this._image_src;return"string"==typeof r?l.default.loadImage(r):r instanceof HTMLImageElement?l.default.waitForLoad(r):r instanceof HTMLCanvasElement?Promise.resolve(r):Promise.reject(new Error("not supported: "+r))}}]),t}(c);t.URLTemplateIconLoader=f,t.TextIconLoader=d,t.ImageIconLoader=p,t.default=_},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(8),u=n(o),s=r(19),l=n(s),_=function(){function e(t,r){i(this,e),this._owner=t,this._glenv=t.glenv;var n=r instanceof u.default?{image_provider:r}:r;this._image_provider=n.image_provider,this._visibility=n.visibility||!0,this._opacity=n.opacity||1,this._tile_cache=new l.default(this._glenv,this._image_provider),this._image_provider.status(function(e){t.dirtyDrawingLayers()})}return a(e,[{key:"setImageProvider",value:function(e){var t=this;this._image_provider!==e&&(this._owner.dirtyDrawingLayers(),e.status(function(e){t._owner.dirtyDrawingLayers()})),this._image_provider=e,this._tile_cache.cancel(),this._tile_cache=new l.default(this._glenv,e)}},{key:"setVisibility",value:function(e){this._visibility!=e&&this._owner.dirtyDrawingLayers(),this._visibility=e}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"image_provider",get:function(){return this._image_provider}},{key:"visibility",get:function(){return this._visibility}},{key:"opacity",get:function(){return this._opacity}},{key:"tile_cache",get:function(){return this._tile_cache}}]),e}();t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(27),u=n(o),s=r(8),l=n(s),_=function(){function e(t,r){i(this,e),this._glenv=t,this._layers=[],this._draw_layers=null;for(var n=0;n<r.length;++n)this.add(r[n])}return a(e,[{key:"getLayer",value:function(e){return this._layers[e]}},{key:"clear",value:function(){for(;this.num_layers()>0;)this.remove(0)}},{key:"add",value:function(e){this.insert(this.num_layers,e)}},{key:"insert",value:function(e,t){this._layers.splice(e,0,new u.default(this,t)),this.dirtyDrawingLayers()}},{key:"remove",value:function(e){this._layers.splice(e,1),this.dirtyDrawingLayers()}},{key:"numDrawingLayers",value:function(){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers.length}},{key:"getDrawingLayer",value:function(e){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers[e]}},{key:"endFrame",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.endFrame()}},{key:"cancel",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.cancel()}},{key:"dirtyDrawingLayers",value:function(){this._draw_layers=null}},{key:"_updataDrawingLayers",value:function(){for(var e=this.num_layers,t=[],r=0;r<e;++r){var n=this._layers[r];n.image_provider.status()===l.default.Status.READY&&n.visibility===!0&&t.push(n)}this._draw_layers=t}},{key:"glenv",get:function(){return this._glenv}},{key:"num_layers",get:function(){return this._layers.length}}]),e}();t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(12),s=n(u),l=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i(this,e),this._scene=t,!(r instanceof s.default))throw new Error("Unsupported Resource Type: "+r);this._resource=r,this._status=e.Status.NOT_LOADED,this._onLoad=n.onLoad||a}return o(e,[{key:"_setStatus",value:function(e){this._status=e}},{key:"load",value:function(){var t=this;return this.status!==e.Status.NOT_LOADED?Promise.reject(new Error("Illegal Status: "+this.status)):Promise.resolve().then(function(){return t._setStatus(e.Status.LOADING),t.scene.addLoader(t),t._load()}).catch(function(r){throw console.log(r),t._scene.removeLoader(t),t._onLoad(t,!1),t._status!==e.Status.CANCELED&&t._setStatus(e.Status.ABORTED),r}).then(function(r){if(t._scene.removeLoader(t),t._status===e.Status.CANCELED)throw t._onLoad(t,!1),new Error("canceled");return t._setStatus(e.Status.LOADED),t._onLoad(t,!0),r})}},{key:"_load",value:function(){throw new Error("_load() is not implemented in "+this.constructor.name)}},{key:"cancel",value:function(){this._status!==e.Status.LOADING&&this._status!==e.Status.LOADED||(this._setStatus(e.Status.CANCELED),this._resource.cancel(),this._cancel())}},{key:"_cancel",value:function(){}},{key:"_check_cancel",value:function(){if(this.status===e.Status.CANCELED)throw new Error("canceled")}},{key:"scene",get:function(){return this._scene}},{key:"resource",get:function(){return this._resource}},{key:"status",get:function(){return this._status}}]),e}();l.Status={NOT_LOADED:"Not Loaded",LOADING:"Loading",LOADED:"Loaded",CANCELED:"Canceled",ERROR:"ERROR"},t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(68),u=n(o),s=function(){function e(t,r,n){i(this,e);var a=new u.default(t,r,n);this._gl=t.context,this._program=this._link_shaders(a.vs_object,a.fs_object),this._vertex_attribs=this._create_vertex_attribs(),this._uniform_location=this._create_uniform_location(),a.dispose()}return a(e,[{key:"_link_shaders",value:function(e,t){var r=this._gl,n=r.createProgram();if(!n)throw new Error("プログラムオブジェクトの生成に失敗しました");try{if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){var i=r.getProgramInfoLog(n);throw r.detachShader(n,t),r.detachShader(n,e),new Error("シェーダのリンクに失敗: "+i)}}catch(e){throw r.deleteProgram(n),e}return n}},{key:"_create_vertex_attribs",value:function(){for(var e=this._gl,t=this._program,r=[],n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i),o={name:a.name,location:e.getAttribLocation(t,a.name)};r.push(o)}return r}},{key:"_create_uniform_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[a.name]=e.getUniformLocation(t,a.name)}return r}},{key:"dispose",value:function(){var e=this._gl;e.deleteProgram(this._program),this._program=null}},{key:"bindProgram",value:function(){var e=this._gl;e.useProgram(this._program)}},{key:"setBoolean",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1i(r,t?1:0)}}},{key:"setInteger",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1i(r,t)}}},{key:"setFloat",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform1f(r,t)}}},{key:"setVector2",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform2fv(r,t)}}},{key:"setVector3",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform3fv(r,t)}}},{key:"setVector4",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniform4fv(r,t)}}},{key:"setMatrix",value:function(e,t){var r=this._uniform_location[e];if(r){var n=this._gl;n.uniformMatrix4fv(r,!1,t)}}},{key:"bindVertexAttribs",value:function(e){for(var t=this._gl,r=this._vertex_attribs,n=r.length,i=0;i<n;++i){var a=r[i],o=e[a.name],u=a.location;void 0!==o?(t.bindBuffer(t.ARRAY_BUFFER,o.buffer),t.enableVertexAttribArray(u),t.vertexAttribPointer(u,o.num_components,o.component_type,o.normalized,o.byte_stride,o.byte_offset)):t.disableVertexAttribArray(u)}}},{key:"bindTexture2D",value:function(e,t){var r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t)}}]),e}();t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t;var a=i||{},o=t.context,u=e._getBindingPoint(o,a.target),s=o.createBuffer();o.bindBuffer(u,s),o.bufferData(u,n,o.STATIC_DRAW),o.bindBuffer(u,null),this._handle=s}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;e.deleteBuffer(this._handle),this._handle=null}},{key:"handle",get:function(){return this._handle}}],[{key:"_getBindingPoint",value:function(e,t){switch(t){default:case a.ATTRIBUTE:return e.ARRAY_BUFFER;case a.INDEX:return e.ELEMENT_ARRAY_BUFFER}}}]),e}(),a={ATTRIBUTE:{id:"ATTRIBUTE"},INDEX:{id:"INDEX"}};i.Target=a,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),l=n(s),_=r(1),c=n(_),f=r(3),h=n(f),d=r(17),v=n(d),p=r(2),y=n(p),m=r(7),g=n(m),b=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));if(n._position=new h.default(0,0,0),n._orientation=new v.default(0,0,0),n._scale=c.default.createVector3([1,1,1]),n._primitive_producer=new w(n),r&&r.json){var o=r.json,u=r.refs||{};n._setupTransform(o),n._setupModelObject(o,u)}return n}return o(t,e),u(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"_setupTransform",value:function(e){var t=e.transform;this.setPosition((new h.default).setFromArray(t.position)),this.setOrientation(new v.default(t.heading,t.tilt,t.roll));var r=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof r&&(r=[r,r,r]),this.setScale(r)}},{key:"_setupModelObject",value:function(e,t){var r=t[e.ref_model];this._primitive_producer.setModelObject(r,e.index)}},{key:"setPosition",value:function(e){var t=this._position;e.longitude==t.longitude&&e.latitude==t.latitude&&e.altitude==t.altitude||(this._position.assign(e),this._primitive_producer.onChangePosition())}},{key:"setOrientation",value:function(e){this._orientation.assign(e)}},{key:"setScale",value:function(e){c.default.copyVector3(e,this._scale)}}]),t}(l.default),w=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._primitives=[],r._ptoe_array=[],r._abs_position=null,r}return o(t,e),u(t,[{key:"setModelObject",value:function(e,t){var r=e.createPrimitives(t);if(!r)throw new Error("model is not found in ModelContainer");this._primitives=r,this._ptoe_array=r.map(function(e){return c.default.createMatrix(e.transform)})}},{key:"createRegions",value:function(){var e=new g.default;return e.addPoint(this.entity._position),[e]}},{key:"onChangeElevation",value:function(e){this._abs_position=null}},{key:"getPrimitives",value:function(e){var t=this.entity;this._updateAbsPosition();for(var r=this._abs_position.getMlocsToGocsMatrix(c.default.createMatrix()),n=t._orientation.getTransformMatrix(t._scale,c.default.createMatrix()),i=c.default.mul_AA(r,n,c.default.createMatrix()),a=this._primitives,o=this._ptoe_array,u=0;u<a.length;++u){var s=a[u],l=o[u];c.default.mul_AA(i,l,s.transform)}return this._primitives}},{key:"onChangeAltitudeMode",value:function(){this._abs_position=null}},{key:"onChangePosition",value:function(){this.needToCreateRegions(),this._abs_position=null}},{key:"_updateAbsPosition",value:function(){if(null===this._abs_position){var e=this.entity;switch(this._abs_position=e._position.clone(),e.altitude_mode){case y.default.RELATIVE:this._abs_position.altitude+=e.scene.viewer.getExistingElevation(e._position)}}}}]),t}(l.default.PrimitiveProducer);t.default=b,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(4),_=n(l),c=r(10),f=n(c),h=r(9),d=n(h),v=r(13),p=n(v),y=r(64),m=n(y),g=r(1),b=n(g),w=r(3),E=n(w),x=r(2),k=n(x),T=r(7),M=n(T),P=r(26),O=(n(P),r(11)),A=n(O),I=function(e){function t(e,r){a(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._entries=[],n._parent_props={fg_color:null,bg_color:null,size:null,font_family:null},n._primitive_producer=new R(n),r&&r.json&&n._setupByJson(r.json),n}return u(t,e),s(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setFGColor",value:function(e){this._setVector3Property("fg_color",e)}},{key:"setBGColor",value:function(e){this._setVector3Property("bg_color",e)}},{key:"setBGColor",value:function(e){this._setValueProperty("font_family",e)}},{key:"addPin",value:function(e,t){this.addTextPin("",e,t)}},{key:"addMakiIconPin",value:function(e,t,r){this._entries.push(new D(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"addTextPin",value:function(e,t,r){this._entries.push(new S(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"_getMaterial",value:function(){var e=this.scene;return e._PinEntity_pin_material||(e._PinEntity_pin_material=new m.default(e.glenv)),e._PinEntity_pin_material}},{key:"_setValueProperty",value:function(e,t){var r=this._parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector3Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]||(b.default.copyVector3(t,r),this._primitive_producer.onChangeParentProperty()):r=this._parent_props[e]=b.default.createVector2f(t)}},{key:"_setVector2Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]||(b.default.copyVector3(t,r),this._primitive_producer.onChangeParentProperty()):r=this._parent_props[e]=b.default.createVector2f(t)}},{key:"_setupByJson",value:function(e){var t=new E.default,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;t.setFromArray(u.position),this.addPin(t,u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.fg_color&&this.setFGColor(e.fg_color),e.bg_color&&this.setBGColor(e.bg_color),e.font_family&&this.setBGColor(e.font_family)}}]),t}(_.default);I.SAFETY_PIXEL_MARGIN=1,I.MAX_IMAGE_WIDTH=4096,I.CIRCLE_SEP_LENGTH=32,I.DEFAULT_SIZE=b.default.createVector2f([30,30]),I.DEFAULT_FONT_FAMILY="sans-serif",I.DEFAULT_FG_COLOR=b.default.createVector3f([1,1,1]),I.DEFAULT_BG_COLOR=b.default.createVector3f([.35,.61,.81]),I.SAFETY_PIXEL_MARGIN=1,I.MAX_IMAGE_WIDTH=4096;var R=function(e){function t(e){a(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r._glenv=e.scene.glenv,r._dirty=!0,r._transform=b.default.setIdentity(b.default.createMatrix()),r._properties={image:null,image_mask:null};var n=new f.default(r._glenv,null,e._getMaterial(),r._transform);return n.properties=r._properties,r._primitive=n,r._primitives=[],r}return u(t,e),s(t,[{key:"createRegions",value:function(){var e=new M.default,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,u=o.position;e.addPoint(u)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new N(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture,r.image_mask&&r.image_mask.dispose(),r.image_mask=t.texture_mask;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_texmaskcoord",size:2},{name:"a_fg_color",size:3},{name:"a_bg_color",size:3}],vertices:t.vertices,indices:t.indices},i=new d.default(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var u=this._transform;u[12]=r/t,u[13]=n/t,u[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return E.default.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case k.default.RELATIVE:e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3);for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var u=0;u<r;++u)n[3*u+2]=t[u].position.altitude}return n}}]),t}(_.default.PrimitiveProducer),L=function(){function e(t,r,n){a(this,e),this._owner=t,this._position=r.clone(),this._props=Object.assign({},n),this._copyPropertyVector3f("fg_color"),this._copyPropertyVector3f("bg_color"),this._copyPropertyVector2f("size")}return s(e,[{key:"_loadIcon",value:function(){throw new Error("loadIcon() is not implemented: "+this.constructor.name)}},{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=b.default.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=b.default.createVector2f([t[e],t[e]]):t[e]=b.default.createVector2f(t[e]))}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||(this.icon?b.default.createVector2f([this.icon.width,this.icon.height]):I.DEFAULT_SIZE)}},{key:"fg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.fg_color||t.fg_color||I.DEFAULT_FG_COLOR}},{key:"bg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.bg_color||t.bg_color||I.DEFAULT_BG_COLOR}},{key:"icon",get:function(){return this._icon}}]),e}(),D=function(e){function t(e,r,n,i){a(this,t);var u=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i));return u._id=r,u._icon=t.makiIconLoader.load(r),u._icon.onEnd(function(e){u._owner.getPrimitiveProducer()._dirty=!0}),u}return u(t,e),t}(L);D.makiIconLoader=new P.URLTemplateIconLoader("https://resource.mapray.com/styles/v1/icons/maki/",".svg");var S=function(e){function t(e,r,n,i){a(this,t);var u=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i));return u._text=r,u._icon=t.textIconLoader.load({text:u._text,props:{size:u.size,font_family:u.font_family}}),u._icon.onEnd(function(e){u._owner.getPrimitiveProducer()._dirty=!0}),u}return u(t,e),s(t,[{key:"font_family",get:function(){var e=this._props,t=this._owner._parent_props;return e.font_family||t.font_family||I.DEFAULT_FONT_FAMILY}}]),t}(L);S.textIconLoader=new P.TextIconLoader;var N=function(){function e(t,r){a(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0==n.length)return void(this._is_valid=!1);var i=this._setupLocation(n);this._texture=this._createTexture(i.width,i.height),this._texture_mask=this._createTextureMask(),this._vertices=this._createVertices(i.width,i.height,r),this._indices=this._createIndices()}return s(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,u=this._owner.entity._entries[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;if(s.isLoaded()){var l=e.get(s.icon);l||(e.set(s.icon,l=new C(this)),t.push(l)),l.add(r++,s)}}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort(function(e,t){return e.height_pixel-t.height_pixel});for(var t=[];e.length>0;){var r=new F(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=A.default.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,u={usage:p.default.Usage.ICON};return new p.default(o,r.canvas,u)}},{key:"_createTextureMask",value:function(){var e=A.default.createCanvasContext(3,3);e.fillRect(1,1,1,1);var t=this._owner._glenv,r={usage:p.default.Usage.ICON,mag_filter:t.context.NEAREST};return new p.default(t,e.canvas,r)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],a=this._owner._transform,o=a[12],u=a[13],s=a[14],l=1/e,_=1/t,c=this._items,f=0;f<c.length;++f){var h=c[f];if(!h.is_canceled)for(var d=0;d<h.entries.length;d++){var v=h.entries[d],p=v.entry,y=p.size,m=1.5*y[0]/2,g=1.5*y[1]/2,b=2*g,w=Math.max(2,m/10),E=3*v.index,x=r[E]-o,k=r[E+1]-u,T=r[E+2]-s,M=p.fg_color,P=p.bg_color,O=h.pos_x,A=h.pos_y,R=h.width,L=h.height,D=function(e,t){n.push((O+R*e)*l,1-(A+L*t)*_)};n.push(x,k,T),n.push(-w/2,b-g),D(.5-w/2/m,1.25),n.push(.25,.25),n.push.apply(n,i(M)),n.push.apply(n,i(P)),n.push(x,k,T),n.push(-w/2,0),D(.5-w/2/m,1.25),n.push(.25,.25),n.push.apply(n,i(M)),n.push.apply(n,i(P)),n.push(x,k,T),n.push(w/2,0),D(.5+w/2/m,1.25),n.push(.25,.25),n.push.apply(n,i(M)),n.push.apply(n,i(P)),n.push(x,k,T),n.push(w/2,b-g),D(.5+w/2/m,1.25),n.push(.25,.25),n.push.apply(n,i(M)),n.push.apply(n,i(P)),n.push(x,k,T),n.push(0,b),D(.5,.5),n.push(.5,.5),n.push.apply(n,i(M)),n.push.apply(n,i(P));for(var S=1;S<I.CIRCLE_SEP_LENGTH;S++){var N=(S/I.CIRCLE_SEP_LENGTH*2-.5)*Math.PI,C=Math.cos(N),F=Math.sin(N);n.push(x,k,T),n.push(m*C,g*F+b),D(1.5*C/2+.5,-1.5*F/2+.5),n.push(.25*C+.5,.25*F+.5),n.push.apply(n,i(M)),n.push.apply(n,i(P))}}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=n.entries[i],o=(5+I.CIRCLE_SEP_LENGTH-1)*a.index,u=o,s=u,l=u+3;e.push(u,u+1,u+2),e.push(u,u+2,u+3),u+=4;var _=u++;e.push(_,s,l),e.push(_,l,u);for(var c=1;c<I.CIRCLE_SEP_LENGTH-1;c++)e.push(_,u++,u);e.push(_,u++,s)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=I.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+I.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"texture_mask",get:function(){return this._texture_mask}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),C=function(){function e(t){a(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return s(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height);var t=!1;t&&(e.beginPath(),e.moveTo(this._pos_x,this._pos_y),e.lineTo(this._pos_x+this.width,this._pos_y),e.lineTo(this._pos_x+this.width,this._pos_y+this.height),e.lineTo(this._pos_x,this._pos_y+this.height),e.closePath(),e.stroke())}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),F=function(){function e(t){a(this,e);var r=0,n=0,i=[];for(r+=I.SAFETY_PIXEL_MARGIN;t.length>0;){var o=t.shift(),u=o.width_pixel+I.SAFETY_PIXEL_MARGIN;if(r+u<=I.MAX_IMAGE_WIDTH)i.push(o),r+=u,n=Math.max(o.height_pixel,n);else{if(0!=i.length){t.unshift(o);break}o.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return s(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=I.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+I.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}();t.default=I,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=r(1),o=n(a),u=function e(t,r){i(this,e),this.position=t||o.default.createVector3(),this.direction=r||o.default.createVector3([0,0,-1])};t.default=u,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){
function e(){r(this,e),this._viewer=null,this._is_started_=!1}return n(e,[{key:"attach",value:function(e){if(this._viewer)throw new Error("RenderCallback instance is already attached");this._viewer=e,this._is_started_=!1}},{key:"detach",value:function(){this._is_started_&&(this.onStop(),this._is_started_=!1),this._viewer=null}},{key:"onUpdateFrameInner",value:function(e){this._is_started_||(this.onStart(),this._is_started_=!0),this.onUpdateFrame(e)}},{key:"onStart",value:function(){}},{key:"onUpdateFrame",value:function(e){}},{key:"onStop",value:function(){}},{key:"viewer",get:function(){return this._viewer}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e),this._viewer=t,this._glenv=n,this._enode_list=[],this._loaders=[]}return n(e,[{key:"clearEntities",value:function(){this._enode_list=[]}},{key:"addEntity",value:function(e){if(e.scene!==this)throw new Error("invalid entity");this._enode_list.push(new a(e))}},{key:"removeEntity",value:function(e){for(var t=this._enode_list,r=0;r<t.length;++r)if(t[r].entity===e){t.splice(r,1);break}}},{key:"getEntity",value:function(e){return this._enode_list[e].entity}},{key:"draw",value:function(e){this._prepare_entities();var t=[],r=[],n=!0,i=!1,a=void 0;try{for(var o,u=this._enode_list[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value,l=s.entity;this._add_primitives(e,l,t,r)}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}this._draw_opaque_primitives(e,t),this._draw_translucent_primitives(e,r)}},{key:"_prepare_entities",value:function(){var e=this._viewer.globe.dem_area_updated,t=!0,r=!1,n=void 0;try{for(var i,a=this._enode_list[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,u=o.entity.getPrimitiveProducer();if(null!==u&&u.needsElevation())if(u.checkToCreateRegions()||null===o.regions)o.regions=u.createRegions(),o.regions.length>0&&(o.regions.forEach(function(e){e.compile()}),u.onChangeElevation(o.regions));else{if(e.isEmpty())continue;var s=[];o.regions.forEach(function(t){t.intersectsWith(e)&&s.push(t)}),s.length>0&&u.onChangeElevation(s)}}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}}},{key:"_add_primitives",value:function(e,t,r,n){var i=t.getPrimitiveProducer();if(null!==i){var a=!0,o=!1,u=void 0;try{for(var s,l=i.getPrimitives(e)[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var _=s.value;if(_.isVisible(e)){var c=_.isTranslucent(e)?n:r;c.push(_)}}}catch(e){o=!0,u=e}finally{try{!a&&l.return&&l.return()}finally{if(o)throw u}}}}},{key:"_draw_opaque_primitives",value:function(e,t){t.sort(function(e,t){return t.sort_z-e.sort_z});var r=this._glenv.context;r.disable(r.BLEND),r.depthMask(!0);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"_draw_translucent_primitives",value:function(e,t){t.sort(function(e,t){return e.sort_z-t.sort_z});var r=this._glenv.context;r.enable(r.BLEND),r.depthMask(!1);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"cancelLoaders",value:function(){for(var e=this._loaders.concat(),t=0;t<e.length;++t)e[t].cancel()}},{key:"addLoader",value:function(e){this._loaders.push(e)}},{key:"removeLoader",value:function(e){var t=this._loaders.indexOf(e);t>=0&&this._loaders.splice(t,1)}},{key:"glenv",get:function(){return this._glenv}},{key:"viewer",get:function(){return this._viewer}},{key:"num_entities",get:function(){return this._enode_list.length}}]),e}(),a=function e(t){r(this,e),this.entity=t,this.regions=null};t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(15),l=n(s),_=r(5),c=n(_),f=function(e){function t(e,r,n){i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),u=n||{};return o._prefix=e,o._suffix=r,o._credentials=(u.credentials||c.default.OMIT).credentials,o._headers=Object.assign({},u.headers),o}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{credentials:this._credentials,headers:this._headers,signal:i.signal}).then(function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return this._prefix+e+"/"+t+"/"+r+this._suffix}}]),t}(l.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(8),l=n(s),_=r(5),c=n(_),f=function(e){function t(e,r,n,o,u,s){i(this,t);var l=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));l._prefix=e,l._suffix=r,l._size=n,l._min_level=o,l._max_level=u;var _;s&&s.coord_order&&(s.coord_order===h.ZYX?_=function(e,t,r){return e+"/"+r+"/"+t}:s.coord_order===h.XYZ&&(_=function(e,t,r){return t+"/"+r+"/"+e})),_||(_=function(e,t,r){return e+"/"+t+"/"+r});var f;return s&&s.coord_system&&s.coord_system===d.LOWER_LEFT&&(f=function(e,t,r){var n=Math.round(Math.pow(2,e));return _(e,t,n-r-1)}),f||(f=_),l._coords_part=f,l._crossOrigin="anonymous",s&&s.credentials&&(s.credentials===c.default.OMIT?l._crossOrigin=null:s.credentials===c.default.INCLUDE&&(l._crossOrigin="use-credentials")),l}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new Image;return i.onload=function(){n(i)},i.onerror=function(){n(null)},null!==this._crossOrigin&&(i.crossOrigin=this._crossOrigin),i.src=this._makeURL(e,t,r),i}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return this._size}},{key:"getZoomLevelRange",value:function(){return new l.default.Range(this._min_level,this._max_level)}},{key:"_makeURL",value:function(e,t,r){return this._prefix+this._coords_part(e,t,r)+this._suffix}}]),t}(l.default),h={ZXY:{id:"ZXY"},ZYX:{id:"ZYX"},XYZ:{id:"XYZ"}},d={UPPER_LEFT:{id:"UPPER_LEFT"},LOWER_LEFT:{id:"LOWER_LEFT"}};f.CoordOrder=h,f.CoordSystem=d,t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),l=n(s),_=r(10),c=n(_),f=r(9),h=n(f),d=r(13),v=n(d),p=r(70),y=n(p),m=r(1),g=n(m),b=r(3),w=n(b),E=r(2),x=n(E),k=r(7),T=n(k),M=r(11),P=n(M),O=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._entries=[],n._text_parent_props={font_style:"normal",font_weight:"normal",font_size:t.DEFAULT_FONT_SIZE,font_family:t.DEFAULT_FONT_FAMILY,color:g.default.createVector3f(t.DEFAULT_COLOR)},n._primitive_producer=new A(n),r&&r.json&&n._setupByJson(r.json),n}return o(t,e),u(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"setColor",value:function(e){this._setVector3Property("color",e)}},{key:"addText",value:function(e,t,r){this._entries.push(new I(this,e,t,r)),this._primitive_producer.onAddTextEntry()}},{key:"_getTextMaterial",value:function(){var e=this.scene;return e._TextEntity_text_material||(e._TextEntity_text_material=new y.default(e.glenv)),e._TextEntity_text_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector3Property",value:function(e,t){var r=this._text_parent_props[e];r[0]==t[0]&&r[1]==t[1]&&r[2]==t[2]||(g.default.copyVector3(t,r),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new w.default,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;t.setFromArray(u.position),this.addText(u.text,t,u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}void 0!==e.font_style&&this.setFontStyle(e.font_style),void 0!==e.font_weight&&this.setFontWeight(e.font_weight),void 0!==e.font_size&&this.setFontSize(e.font_size),void 0!==e.font_family&&this.setFontFamily(e.font_family),void 0!==e.color&&this.setColor(e.color)}}]),t}(l.default);O.DEFAULT_FONT_SIZE=16,O.DEFAULT_FONT_FAMILY="sans-serif",O.DEFAULT_COLOR=g.default.createVector3f([1,1,1]),O.DEFAULT_TEXT_UPPER=1.1,O.DEFAULT_TEXT_LOWER=.38,O.SAFETY_PIXEL_MARGIN=1,O.MAX_IMAGE_WIDTH=4096;var A=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r._glenv=e.scene.glenv,r._dirty=!0,r._transform=g.default.setIdentity(g.default.createMatrix()),r._properties={image:null};var n=new c.default(r._glenv,null,e._getTextMaterial(),r._transform);return n.properties=r._properties,r._primitive=n,r._primitives=[],r}return o(t,e),u(t,[{key:"createRegions",value:function(){var e=new T.default,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,u=o.position;e.addPoint(u)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddTextEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new R(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_color",size:4}],vertices:t.vertices,indices:t.indices},i=new h.default(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var u=this._transform;u[12]=r/t,u[13]=n/t,u[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return w.default.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case x.default.RELATIVE:e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3);for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var u=0;u<r;++u)n[3*u+2]=t[u].position.altitude}return n}}]),t}(l.default.PrimitiveProducer),I=function(){function e(t,r,n,a){i(this,e),this._owner=t,this._text=r,this._position=n.clone(),this._props=Object.assign({},a),this._copyPropertyVector3f("color")}return u(e,[{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=g.default.createVector3f(t[e]))}},{key:"text",get:function(){return this._text}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.font_size||t.font_size}},{key:"color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.color||t.color}},{key:"font",get:function(){var e=this._props,t=this._owner._text_parent_props,r=e.font_style||t.font_style,n="normal",i=e.font_weight||t.font_weight,a=e.font_family||t.font_family;return r+" "+n+" "+i+" "+this.size+"px "+a}}]),e}(),R=function(){function e(t,r){i(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0==n.length)return void(this._is_valid=!1);var a=this._setupLocation(n);this._texture=this._createTexture(a.width,a.height),this._vertices=this._createVertices(a.width,a.height,r),this._indices=this._createIndices()}return u(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=P.default.createCanvasContext(1,1),t=[],r=!0,n=!1,i=void 0;try{for(var a,o=this._owner.entity._entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;t.push(new L(this,u,e))}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort(function(e,t){return e.height_pixel-t.height_pixel});for(var t=[];e.length>0;){var r=new D(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){var r=P.default.createCanvasContext(e,t);r.textAlign="left",r.textBaseline="alphabetic",r.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.drawText(r)}var o=this._owner._glenv,u={usage:v.default.Usage.TEXT};return new v.default(o,r.canvas,u)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],u=i[14],s=this._items,l=0;l<s.length;++l){var _=s[l];if(!_.is_canceled){var c=_.entry,f=c.color,h=3*l,d=r[h]-a,v=r[h+1]-o,p=r[h+2]-u,y=_.pos_x,m=_.pos_y,g=_.upper,b=_.lower,w=_.width,E=1/e,x=1/t;n.push(d,v,p),n.push(-w/2,-b),n.push(y*E,1-(m+b)*x),n.push(f[0],f[1],f[2],1),n.push(d,v,p),n.push(w/2,-b),n.push((y+w)*E,1-(m+b)*x),n.push(f[0],f[1],f[2],1),n.push(d,v,p),n.push(-w/2,g),n.push(y*E,1-(m-g)*x),n.push(f[0],f[1],f[2],1),n.push(d,v,p),n.push(w/2,g),n.push((y+w)*E,1-(m-g)*x),n.push(f[0],f[1],f[2],1)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled){var i=4*r;e.push(i,i+1,i+2,i+2,i+1,i+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=O.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+O.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),L=function(){function e(t,r,n){i(this,e),this._entry=r,this._pos_x=0,this._pos_y=0,n.font=r.font,this._width=n.measureText(r.text).width,this._upper=r.size*O.DEFAULT_TEXT_UPPER,this._lower=r.size*O.DEFAULT_TEXT_LOWER,this._is_canceled=!1}return u(e,[{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t+Math.ceil(this._upper)}},{key:"drawText",value:function(e){var t=this._entry;e.font=t.font,e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"entry",get:function(){return this._entry}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"upper",get:function(){return this._upper}},{key:"lower",get:function(){return this._lower}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._upper)+Math.ceil(this._lower)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),D=function(){function e(t){i(this,e);var r=0,n=0,a=[];for(r+=O.SAFETY_PIXEL_MARGIN;t.length>0;){var o=t.shift(),u=o.width_pixel+O.SAFETY_PIXEL_MARGIN;if(r+u<=O.MAX_IMAGE_WIDTH)a.push(o),r+=u,n=Math.max(o.height_pixel,n);else{if(0!=a.length){t.unshift(o);break}o.cancel()}}this._items=a,this._width_assumed=r,this._height_pixel=n}return u(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=O.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+O.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}();t.default=O,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(21),u=n(o),s=r(55),l=n(s),_=r(67),c=n(_),f=r(38),h=n(f),d=r(37),v=n(d),p=r(28),y=n(p),m=r(24),g=n(m),b=r(19),w=n(b),E=r(63),x=n(E),k=r(1),T=n(k),M=r(36),P=n(M),O=r(14),A=(n(O),function(){function e(t,r){i(this,e);var n;n="string"==typeof t?document.getElementById(t):t;var a=this._createCanvas(n);this._container_element=n,this._canvas_element=a,this._glenv=new l.default(a),this._camera=new u.default(a),this._dem_provider=this._createDemProvider(r),this._image_provider=this._createImageProvider(r),this._layers=this._createLayerCollection(r),this._globe=new g.default(this._glenv,this._dem_provider),this._tile_texture_cache=new w.default(this._glenv,this._image_provider),this._scene=new P.default(this,this._glenv),this._ground_visibility=e._getBoolOption(r,"ground_visibility",!0),this._entity_visibility=e._getBoolOption(r,"entity_visibility",!0),this._render_mode=r&&r.render_mode||R.SURFACE,this._debug_stats=r&&r.debug_stats||null,this._render_callback=this._createRenderCallback(r),this._frame_req_id=0,this._previous_time=void 0,this._is_destroyed=!1,this._requestNextFrame(),this._updateCanvasSize()}return a(e,[{key:"destroy",value:function(){this._is_destroyed||(0!=this._frame_req_id&&(window.maprayCancelAnimationFrame(this._frame_req_id),this._frame_req_id=0),this._render_callback.detach(),this._render_callback=this._createRenderCallback(),this._container_element.removeChild(this._canvas_element),this._globe.cancel(),this._tile_texture_cache.cancel(),this._layers.cancel(),this._scene.cancelLoaders(),this._is_destroyed=!0)}},{key:"_createCanvas",value:function(e){var t=document.createElement("canvas");return t.className="mapray-canvas",t.style.width="100%",t.style.height="100%",e.appendChild(t),t}},{key:"_createDemProvider",value:function(e){return e&&e.dem_provider?e.dem_provider:new v.default("/dem/",".bin")}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider?e.image_provider:new h.default("http://cyberjapandata.gsi.go.jp/xyz/std/",".png",256,0,18)}},{key:"_createLayerCollection",value:function(e){var t=e&&e.layers?e.layers:{};return new y.default(this._glenv,t)}},{key:"_createRenderCallback",value:function(e){var t;return t=e&&e.render_callback?e.render_callback:new x.default,t.attach(this),t}},{key:"setVisibility",value:function(e,t){switch(e){case I.GROUND:this._ground_visibility=t;break;case I.ENTITY:this._entity_visibility=t;break;default:throw new Error("invalid target: "+e)}}},{key:"getVisibility",value:function(e,t){switch(e){case I.GROUND:return this._ground_visibility;case I.ENTITY:return this._entity_visibility;default:throw new Error("invalid target: "+e)}}},{key:"getElevation",value:function(e,t){var r=t+180*Math.floor((90-e)/360+Math.floor((90+e)/360)),n=90-Math.abs(90-e+360*Math.floor((90+e)/360)),i=r-360-360*Math.floor((r-180)/360),a=i*T.default.DEGREE,o=T.default.invGudermannian(n*T.default.DEGREE),u=2*Math.PI,s=a/u+.5,l=.5-o/u;if(l<0||l>1)return 0;var _=this._globe,c=_.findHighestAccuracy(s,l);if(null===c)return 0;var f=_.dem_provider.getResolutionPower(),h=1<<f,d=Math.pow(2,c.z),v=h*(d*s-c.x),p=h*(d*l-c.y),y=T.default.clamp(Math.floor(v),0,h-1),m=T.default.clamp(Math.floor(p),0,h-1),g=c.getHeights(y,m),b=g[0],w=g[1],E=g[2],x=g[3],k=v-y,M=p-m;return(b*(1-k)+w*k)*(1-M)+(E*(1-k)+x*k)*M}},{key:"getExistingElevation",value:function(e){var t=[e.longitude,e.latitude,0];return this._globe.getExistingElevations(1,t,0,3,t,2,3),t[2]}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){return this._globe.getExistingElevations(e,t,r,n,i,a,o)}},{key:"getRayIntersection",value:function(e){var t=this._globe;if(t.status!==g.default.Status.READY)return null;var r=t.root_flake.findRayDistance(e,Number.MAX_VALUE);if(r===Number.MAX_VALUE)return null;var n=T.default.createVector3(),i=e.position,a=e.direction;return n[0]=i[0]+r*a[0],n[1]=i[1]+r*a[1],n[2]=i[2]+r*a[2],n}},{key:"_requestNextFrame",value:function(){var e=this;this._frame_req_id=window.maprayRequestAnimationFrame(function(){return e._updateFrame()})}},{key:"_updateFrame",value:function(){var e=this._updateTime();this._requestNextFrame(),this._updateCanvasSize(),this._render_callback.onUpdateFrameInner(e),null!==this._debug_stats&&this._debug_stats.clearStats();var t=new c.default(this);t.render(),this._finishDebugStats()}},{key:"_updateTime",value:function(){var e=window.maprayNow(),t=void 0!==this._previous_time?(e-this._previous_time)/1e3:0;return this._previous_time=e,t}},{key:"_updateCanvasSize",value:function(){var e=this._canvas_element;e.width!=e.clientWidth&&(e.width=e.clientWidth),e.height!=e.clientHeight&&(e.height=e.clientHeight)}},{key:"_finishDebugStats",value:function(){var e=this._debug_stats;null!==e&&(e.num_wait_reqs_dem=this._globe.getNumDemWaitingRequests(),e.num_wait_reqs_img=this._tile_texture_cache.getNumWaitingRequests(),e.onUpdate())}},{key:"container_element",get:function(){return this._container_element}},{key:"canvas_element",get:function(){return this._canvas_element}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"image_provider",get:function(){return this._image_provider}},{key:"layers",get:function(){return this._layers}},{key:"render_callback",get:function(){return this._render_callback}},{key:"render_mode",get:function(){return this._render_mode},set:function(e){this._render_mode=e}},{key:"debug_stats",get:function(){return this._debug_stats}},{key:"camera",get:function(){return this._camera}},{key:"scene",get:function(){return this._scene}},{key:"glenv",get:function(){return this._glenv}},{key:"globe",get:function(){return this._globe}},{key:"tile_texture_cache",get:function(){return this._tile_texture_cache}}],[{key:"_getBoolOption",value:function(e,t,r){return e&&void 0!==e[t]?e[t]:r}}]),e}()),I={GROUND:{id:"GROUND"},ENTITY:{id:"ENTITY"}},R={SURFACE:{id:"SURFACE"},WIREFRAME:{id:"WIREFRAME"}};A.Category=I,A.RenderMode=R,t.default=A,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e);var i=t.gjson.bufferViews[n];this._buffer=t.findBuffer(i.buffer),this._byteLength=i.byteLength,this._target=i.target,this._byteOffset=void 0!==i.byteOffset?i.byteOffset:0,this._byteStride=void 0!==i.byteStride?i.byteStride:0}return n(e,[{key:"rebuildBySplitter",value:function(e){this._buffer=e,this._byteLength=e.byteLength,this._byteOffset=0}},{key:"buffer",get:function(){return this._buffer}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"byteStride",get:function(){return this._byteStride}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e),this._scene=t,this._default_scene_index=n}return n(e,[{key:"scenes",get:function(){return this._scene}},{key:"default_scene_index",get:function(){return this._default_scene_index}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(20),l=n(s),_=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._scale=void 0!==e.scale?e.scale:1,n}return o(t,e),u(t,[{key:"texCoord",get:function(){return this._scale}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(20),l=n(s),_=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._strength=void 0!==e.strength?e.strength:1,n}return o(t,e),u(t,[{key:"strength",get:function(){return this._strength}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){if(r(this,e),this._ρ=t,this._maps=[],t>=1){var i=this._create_first_map(n);this._maps.push(i);for(var a=i,o=-2;o>=-t;--o){var u=this._create_next_map(o,a);this._maps.push(u),a=u}}}return n(e,[{key:"_create_first_map",value:function(e){for(var t=4,r=1<<this._ρ-1,n=new Float32Array(r*r),i=(2*r+1)*t,a=r,o=0;o<r;++o)for(var u=2*o*i,s=o*a,l=0;l<r;++l){var _=e.getFloat32(u,!0),c=e.getFloat32(u+t,!0),f=e.getFloat32(u+2*t,!0),h=e.getFloat32(u+i,!0),d=e.getFloat32(u+i+t,!0),v=e.getFloat32(u+i+2*t,!0),p=e.getFloat32(u+2*i,!0),y=e.getFloat32(u+2*i+t,!0),m=e.getFloat32(u+2*(i+t),!0);n[s]=(_+2*c+f+2*h+4*d+2*v+p+2*y+m)/16,u+=2*t,s+=1}return n}},{key:"_create_next_map",value:function(e,t){for(var r=1<<this._ρ+e,n=new Float32Array(r*r),i=2*r,a=r,o=0;o<r;++o)for(var u=2*o*i,s=o*a,l=0;l<r;++l){var _=t[u],c=t[u+1],f=t[u+i],h=t[u+i+1];n[s]=(_+c+f+h)/4,u+=2,s+=1}return n}},{key:"sample",value:function(e,t,r){var n=this._maps[this._ρ-e-1],i=1<<e;return n[r*i+t]}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._length=t,this._array=new Uint32Array(Math.ceil(t/32))}return n(e,[{key:"setBit",value:function(e,t){var r=Math.floor(e/32),n=this._array[r],i=1<<e%32;this._array[r]=t?n|i:n&~i}},{key:"getBit",value:function(e){var t=Math.floor(e/32),r=this._array[t],n=1<<e%32;return 0!=(r&n)}},{key:"length",get:function(){
return this._length}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(15),l=n(s),_=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._headers={"X-Api-Key":e},r}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{headers:this._headers,signal:i.signal}).then(function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))}).then(function(e){n(e)}).catch(function(){n(null)}),i}},{key:"cancelRequest",value:function(e){var t=e;t.abort()}},{key:"_makeURL",value:function(e,t,r){return"https://tiles.mapray.com/dem/"+e+"/"+t+"/"+r+".bin"}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this.clearStats()}return n(e,[{key:"clearStats",value:function(){this.num_wait_reqs_dem=0,this.num_wait_reqs_img=0,this.num_drawing_flakes=0,this.num_drawing_flake_vertices=0,this.num_procA_flakes=0,this.num_procB_flakes=0}},{key:"onUpdate",value:function(){}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(50),l=n(s),_=r(51),c=n(_),f=r(45),h=n(f),d=function(){function e(t,r,n,a,o){i(this,e),this._z=t,this._x=r,this._y=n,this._ρ=a;var u=new DataView(o);this._qlevels=[u.getUint8(e.OFFSET_QLEVEL_00),u.getUint8(e.OFFSET_QLEVEL_10),u.getUint8(e.OFFSET_QLEVEL_01),u.getUint8(e.OFFSET_QLEVEL_11)],this._hmin=u.getFloat32(e.OFFSET_HMIN,!0),this._hmax=u.getFloat32(e.OFFSET_HMAX,!0),this._ω=this._createωArray(u),this._body=new DataView(o,e.HEADER_BYTES),this._size=(1<<a)+1}return a(e,[{key:"isLeaf",value:function(e,t,r){if(e>this._z)return 0==this.getQuadLevel(e,t,r);var n=this._qlevels;return 0==n[0]||0==n[1]||0==n[2]||0==n[3]}},{key:"getQuadLevel",value:function(e,t,r){var n=Math.pow(2,this._z-e),i=Math.floor(2*((t+.5)*n-this._x)),a=Math.floor(2*((r+.5)*n-this._y));return this._qlevels[2*a+i]}},{key:"getQuadLevelDirect",value:function(e,t){var r=Math.round(Math.pow(2,this._z+1)),n=u.default.clamp(Math.floor(e*r),0,r-1)%2,i=u.default.clamp(Math.floor(t*r),0,r-1)%2;return this._qlevels[2*i+n]}},{key:"getHeights",value:function(t,r){var n=4,i=n*(r*this._size+t),a=n*this._size,o=e._getHeights_result;return o[0]=this._body.getFloat32(i,!0),o[1]=this._body.getFloat32(i+n,!0),o[2]=this._body.getFloat32(i+a,!0),o[3]=this._body.getFloat32(i+a+n,!0),o}},{key:"getDivisionPowers",value:function(t,r,n,i){var a=t.z,o=this._z,s=u.default.LOG2PI-this._ρ+1,l=this._getComplexity(a,t.x,t.y),_=Math.min(o+this._ρ,Math.round(r+s+l))-a,c=e._getDivisionPowers_result;return c[0]=Math.max(n,_),c[1]=Math.max(i,_),c}},{key:"newSampler",value:function(e){var t=e.z-this._z>this._ρ?l.default:c.default;return new t(this._z,this._x,this._y,this._ρ,this._body)}},{key:"newAvgHeightMaps",value:function(){return new h.default(this._ρ,this._body)}},{key:"_createωArray",value:function(t){for(var r=4,n=[],i=0,a=0;a<3;++a){for(var o=1<<2*a,u=new Float32Array(o),s=0;s<o;++s)u[s]=t.getFloat32(e.OFFSET_ω+i,!0),i+=r;n.push(u)}return n}},{key:"_getComplexity",value:function(t,r,n){var i,a,o=t-this._z,u=Math.round(Math.pow(2,o)),s=2,l=4;o<=s?(i=r-u*this._x,a=n-u*this._y):(i=Math.floor(l*((r+.5)/u-this._x)),a=Math.floor(l*((n+.5)/u-this._y)));var _=Math.min(o,s),c=this._ω[_];return Math.min(c[a*(1<<_)+i],e.ω_limit)}},{key:"z",get:function(){return this._z}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"height_min",get:function(){return this._hmin}},{key:"height_max",get:function(){return this._hmax}}]),e}();d.OFFSET_QLEVEL_00=0,d.OFFSET_QLEVEL_10=1,d.OFFSET_QLEVEL_01=2,d.OFFSET_QLEVEL_11=3,d.OFFSET_HMIN=4,d.OFFSET_HMAX=8,d.OFFSET_ω=12,d.HEADER_BYTES=96,d.ω_limit=6,d._getHeights_result=new Array(4),d._getDivisionPowers_result=new Array(2),t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(22),l=n(s),_=r(1),c=n(_),f=function(e){function t(e,r,n,o,u){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,u))}return o(t,e),u(t,[{key:"sample",value:function(e,t){var r=this._sx*e+this._ox,n=Math.floor(r),i=n+1,a=this._sy*t+this._oy,o=Math.floor(a),u=o+1,s=this._sampleInt(n,o),l=this._sampleInt(i,o),_=this._sampleInt(n,u),c=this._sampleInt(i,u),f=r-n,h=a-o;return(s*(1-f)+l*f)*(1-h)+(_*(1-f)+c*f)*h}},{key:"_sampleInt",value:function(e,t){var r=4,n=c.default.clamp(e,0,this._max),i=c.default.clamp(t,0,this._max),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(l.default);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(22),l=n(s),_=function(e){function t(e,r,n,o,u){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,u))}return o(t,e),u(t,[{key:"sample",value:function(e,t){var r=4,n=Math.round(this._sx*e+this._ox),i=Math.round(this._sy*t+this._oy),a=this._pitch*i+r*n;return this._body.getFloat32(a,!0)}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(8),l=n(s),_=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),u(t,[{key:"requestTile",value:function(e,t,r,n){return this}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return 4096}},{key:"getZoomLevelRange",value:function(){return new l.default.Range(0,0)}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(66),l=n(s),_=function(){function e(t){i(this,e),this._setupViewVectors(t),this._setupClipPlanes(t);var r=t._viewer,n=r.dem_provider,a=r.tile_texture_cache;this._min_image_z=a.getImageZMin();var o=u.default.LOG2PI-n.getResolutionPower()+1;this._max_zbias=Math.max(a.getImageZBias(),o),this._globe=r.globe,this._rflake_list=[],this._debug_stats=r.debug_stats,this._debug_stats&&(this._num_procA_flakes=0,this._num_procB_flakes=0),this._view_dir_N=u.default.createVector3(),this._view_dir_V=u.default.createVector3()}return a(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=u.default.createVector3(),i=u.default.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view,n=e._volume_planes,i=[],a=e._viewer._globe.root_flake,o=u.default.EARTH_RADIUS+a.height_min,s=u.default.EARTH_RADIUS+a.height_max,l=t[12],_=t[13],c=t[14],f=l*l+_*_+c*c,h=o*o,d=s*s,v=Math.sqrt((f-h)*(d-h))-h,p=u.default.createVector4(),y=1/Math.sqrt(f);p[0]=l*y,p[1]=_*y,p[2]=c*y,p[3]=v*y,i.push(p);for(var m=Math.sqrt(f+d+2*v),g=0;g<6;++g){var b=n[g],w=u.default.createVector4();1==g&&b[3]>m&&(b=u.default.createVector4(b),b[3]=m),u.default.transformPlane_A(r,b,w),i.push(w)}this._clip_planes=i}},{key:"traverse",value:function(){return this._collectFlakes(this._globe.root_flake),this._debug_stats&&(this._debug_stats.num_procA_flakes=this._num_procA_flakes,this._debug_stats.num_procB_flakes=this._num_procB_flakes),this._rflake_list}},{key:"_collectFlakes",value:function(t){if(null!==this._debug_stats&&(this._num_procA_flakes+=1),!t.isInvisible(this._clip_planes)){if(t.z<this._min_image_z)return void this._collectNextLevelFlakes(t);null!==this._debug_stats&&(this._num_procB_flakes+=1);var r=this._getLevelOfDetailRange(t),n=r.mid+this._max_zbias;return r.max-r.min>e.MAX_LOD_INTERVAL||n>t.z?void this._collectNextLevelFlakes(t):void this._addRenderFlake(t,r)}}},{key:"_collectNextLevelFlakes",value:function(e){for(var t=0;t<2;++t)for(var r=0;r<2;++r)this._collectFlakes(e.newChild(r,t))}},{key:"_getLevelOfDetailRange",value:function(e){for(var t=Math.PI,r=e.z,n=e.x,i=e.y,a=Math.pow(2,1-r)*t,o=-t+n*a,s=t-(i+1)*a,l=t/32,_=Math.ceil(a/l),c=a/_,f=u.default.EARTH_RADIUS+e.base_height,h=this._view_pos_Q,d=this._view_dir_wU,v=this._view_dir_N,p=this._view_dir_V,y=Number.MAX_VALUE,m=-Number.MAX_VALUE,g=0,b=s;g<_+1;++g,b+=c)for(var w=Math.exp(b),E=w*w,x=(E-1)/(E+1),k=2*w/(E+1),T=1/(f*k),M=0,P=o;M<_+1;++M,P+=c){var O=Math.sin(P),A=Math.cos(P);v[0]=k*A,v[1]=k*O,v[2]=x,p[0]=f*v[0]-h[0],p[1]=f*v[1]-h[1],p[2]=f*v[2]-h[2];var I=u.default.dot3(d,p);if(I<=0)return{min:-1e3,max:1e3,mid:0};var R=I*T;y=Math.min(y,R),m=Math.max(m,R)}var L=-Math.maprayLog2(m),D=-Math.maprayLog2(y);return{min:L,max:D,mid:(L+D)/2}}},{key:"_calcLOD",value:function(e,t){var r=Math.sin(e),n=Math.cos(e),i=Math.exp(t),a=i*i,o=(a-1)/(a+1),s=2*i/(a+1),l=u.default.EARTH_RADIUS,_=this._view_dir_N;_[0]=s*n,_[1]=s*r,_[2]=o;var c=this._view_dir_V,f=this._view_pos_Q;c[0]=l*_[0]-f[0],c[1]=l*_[1]-f[1],c[2]=l*_[2]-f[2];var h=this._view_dir_wU,d=u.default.dot3(h,c),v=l*s/d;return Math.maprayLog2(v)}},{key:"_setCornerLODs",value:function(e){var t=Math.PI,r=e.flake,n=r.z,i=r.x,a=r.y,o=Math.pow(2,1-n)*t,u=-t+i*o,s=-t+(i+1)*o,l=t-(a+1)*o,_=t-a*o;e.lod_00=this._calcLOD(u,l),e.lod_10=this._calcLOD(s,l),e.lod_01=this._calcLOD(u,_),e.lod_11=this._calcLOD(s,_)}},{key:"_addRenderFlake",value:function(e,t){var r=new l.default(e);r.lod=t.mid,this._setCornerLODs(r),this._rflake_list.push(r)}}]),e}();_.MAX_LOD_INTERVAL=.5,t.default=_,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=function(){function e(t,r,n,a){i(this,e);var o=t.context;this._center=this._createCenter(r),this._vertices=null,this._num_vertices=0,this._vertex_attribs={},this._num_quads_x=0,this._num_quads_y=0,this._createVertices(o,r,n,a),this._setupVertexAttribs(o),this._index_type=this._num_vertices<65536?o.UNSIGNED_SHORT:o.UNSIGNED_INT,this._indices=null,this._num_indices=0,this._wire_indices=null,this._num_wire_indices=0,this._gl=o}return a(e,[{key:"_createCenter",value:function(e){var t=e.z,r=e.x,n=e.y,i=u.default.createVector3();switch(t){case 0:return this._getCenter_0(i);case 1:return this._getCenter_1(r,n,i);default:return this._getCenter_N(t,r,n,i)}}},{key:"_getCenter_0",value:function(e){return e[0]=0,e[1]=0,e[2]=0,e}},{key:"_getCenter_1",value:function(e,t,r){var n=u.default.EARTH_RADIUS;return r[0]=0,r[1]=n*(e-.5),r[2]=n*(.5-t),r}},{key:"_getCenter_N",value:function(e,t,r,n){var i=Math.PI,a=Math.pow(2,1-e)*i,o=-i+t*a,s=-i+(t+1)*a,l=i-(r+1)*a,_=i-r*a,c=o,f=s,h=Math.exp(l),d=Math.exp(_),v=h*h,p=d*d,y=u.default.EARTH_RADIUS/2,m=2*h/(v+1),g=2*d/(p+1);return l+_<0?c+f<-i?(n[0]=y*(g*Math.cos(c)+m*Math.cos(f)),n[1]=y*(g*Math.sin(f)+m*Math.sin(c))):c+f<0?(n[0]=y*(m*Math.cos(c)+g*Math.cos(f)),n[1]=y*(g*Math.sin(c)+m*Math.sin(f))):c+f<i?(n[0]=y*(m*Math.cos(f)+g*Math.cos(c)),n[1]=y*(m*Math.sin(c)+g*Math.sin(f))):(n[0]=y*(g*Math.cos(f)+m*Math.cos(c)),n[1]=y*(m*Math.sin(f)+g*Math.sin(c))):c+f<-i?(n[0]=y*(m*Math.cos(c)+g*Math.cos(f)),n[1]=y*(m*Math.sin(f)+g*Math.sin(c))):c+f<0?(n[0]=y*(g*Math.cos(c)+m*Math.cos(f)),n[1]=y*(m*Math.sin(c)+g*Math.sin(f))):c+f<i?(n[0]=y*(g*Math.cos(f)+m*Math.cos(c)),n[1]=y*(g*Math.sin(c)+m*Math.sin(f))):(n[0]=y*(m*Math.cos(f)+g*Math.cos(c)),n[1]=y*(g*Math.sin(f)+m*Math.sin(c))),n[2]=2*y*(p/(p+1)-1/(v+1)),n}},{key:"_createVertices",value:function(e,t,r,n){var i=e.ARRAY_BUFFER,a=e.createBuffer(),o=this._createVerticesData(t,r,n);e.bindBuffer(i,a),e.bufferData(i,o.array,e.STATIC_DRAW),e.bindBuffer(i,null),this._vertices=a,this._num_vertices=o.num_vertices,this._num_quads_x=o.num_quads_x,this._num_quads_y=o.num_quads_y}},{key:"_createVerticesData",value:function(t,r,n){for(var i=Math.pow(2,1-t.z)*Math.PI,a=t.x*i-Math.PI,o=Math.PI-(t.y+1)*i,s=1<<r[0],l=1<<r[1],_=1/s,c=1/l,f=i/s,h=i/l,d=this._center,v=n.newSampler(t),p=(s+1)*(l+1),y=new Float32Array(e.VERTEX_SIZE*p),m=0,g=0,b=o;g<l+1;++g,b+=h)for(var w=Math.exp(b),E=w*w,x=(E-1)/(E+1),k=2*w/(E+1),T=0,M=a;T<s+1;++T,M+=f){var P=Math.sin(M),O=Math.cos(M),A=v.sample(M,b),I=u.default.EARTH_RADIUS+A,R=k*O,L=k*P,D=x,S=I*R,N=I*L,C=I*D;y[m++]=S-d[0],y[m++]=N-d[1],y[m++]=C-d[2],y[m++]=R,y[m++]=L,y[m++]=D,y[m++]=T*_,y[m++]=g*c}return{array:y,num_vertices:p,num_quads_x:s,num_quads_y:l}}},{key:"_setupVertexAttribs",value:function(t){var r=t.FLOAT,n=e.VERTEX_BYTES;this._vertex_attribs={a_position:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_P},a_normal:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_N},a_uv:{buffer:this._vertices,num_components:2,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_UV}}}},{key:"_createIndices",value:function(){for(var e=this._gl,t=this._num_quads_x*this._num_quads_y,r=6*t,n=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,i=new n(r),a=0,o=0;o<this._num_quads_y;++o)for(var u=0;u<this._num_quads_x;++u){var s=(this._num_quads_x+1)*o+u,l=s+1,_=s+this._num_quads_x+1,c=_+1;i[a++]=s,i[a++]=l,i[a++]=_,i[a++]=_,i[a++]=l,i[a++]=c}var f=e.ELEMENT_ARRAY_BUFFER,h=e.createBuffer();e.bindBuffer(f,h),e.bufferData(f,i,e.STATIC_DRAW),e.bindBuffer(f,null),this._indices=h,this._num_indices=r}},{key:"_createWireIndices",value:function(){for(var e=this._gl,t=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,r=2*(2*this._num_quads_x*this._num_quads_y+this._num_quads_x+this._num_quads_y),n=new t(r),i=0,a=0;a<this._num_quads_y+1;++a)for(var o=0;o<this._num_quads_x;++o){var u=(this._num_quads_x+1)*a+o,s=u+1;n[i++]=u,n[i++]=s}for(o=0;o<this._num_quads_x+1;++o)for(a=0;a<this._num_quads_y;++a){var l=(this._num_quads_x+1)*a+o,_=l+this._num_quads_x+1;n[i++]=l,n[i++]=_}var c=e.ELEMENT_ARRAY_BUFFER,f=e.createBuffer();e.bindBuffer(c,f),e.bufferData(c,n,e.STATIC_DRAW),e.bindBuffer(c,null),this._wire_indices=f,this._num_wire_indices=r}},{key:"dispose",value:function(){var e=this._gl;this._vertex_attribs={},e.deleteBuffer(this._vertices),this._vertices=null,this._indices&&(e.deleteBuffer(this._indices),this._indices=null),this._wire_indices&&(e.deleteBuffer(this._wire_indices),this._wire_indices=null)}},{key:"mul_flake_to_gocs",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],u=e[5],s=e[9],l=e[13],_=e[2],c=e[6],f=e[10],h=e[14],d=e[3],v=e[7],p=e[11],y=e[15],m=this._center[0],g=this._center[1],b=this._center[2];return t[0]=r,t[1]=o,t[2]=_,t[3]=d,t[4]=n,t[5]=u,t[6]=c,t[7]=v,t[8]=i,t[9]=s,t[10]=f,t[11]=p,t[12]=r*m+n*g+i*b+a,t[13]=o*m+u*g+s*b+l,t[14]=_*m+c*g+f*b+h,t[15]=d*m+v*g+p*b+y,t}},{key:"draw",value:function(e){var t=this._gl,r=e.isWireframe();e.bindVertexAttribs(this._vertex_attribs);var n=r?this.wire_indices:this.indices;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);var i=r?t.LINES:t.TRIANGLES,a=r?this.num_wire_indices:this.num_indices;t.drawElements(i,a,this._index_type,0)}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"indices",get:function(){return null===this._indices&&this._createIndices(),this._indices}},{key:"num_indices",get:function(){return null===this._indices&&this._createIndices(),this._num_indices}},{key:"wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._wire_indices}},{key:"num_wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._num_wire_indices}}]),e}();s.VERTEX_SIZE=8,s.VERTEX_BYTES=4*s.VERTEX_SIZE,s.OFFSET_P=0,s.OFFSET_N=12,s.OFFSET_UV=24,t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e);var n={depth:!0,antialias:!0},i=this._getContextWebGL(t,n);if(!i)throw new Error("It doesn't appear your computer can support WebGL.");this._canvas=t,this._context=i,this._setupExtensions(i)}return n(e,[{key:"_getContextWebGL",value:function(e,t){for(var r=["webgl","experimental-webgl"],n=0;n<r.length;++n){var i=e.getContext(r[n],t);if(i)return i}return null}},{key:"_setupExtensions",value:function(e){this.OES_element_index_uint=e.getExtension("OES_element_index_uint"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){return S.defaultLineColor}function s(e){return S.defaultLineWidth}function l(e){return S.defaultRadius}function _(e){return S.defaultFillColor}function c(e){return S.defaultPointFGColor}function f(e){return S.defaultPointBGColor}function h(e){return S.defaultPointSize}function d(e){return S.defaultPointIconId}function v(e){return 100}function p(e){if(!e)return S.defaultExtrudedMode;var t="Feature"===e.type?e.geometry:e;switch(t.type){case C.POINT:case C.MULTI_POINT:return!0;case C.LINE_STRING:case C.MULTI_LINE_STRING:return!0;case C.POLYGON:case C.MULTI_POLYGON:return!0;default:throw new Error("Invalid GeoJSON: unknown type: "+t.type)}return S.defaultExtrudedMode}function y(e){return{url:e}}Object.defineProperty(t,"__esModule",{value:!0});var m=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),g=r(29),b=n(g),w=r(1),E=(n(w),r(3)),x=n(E),k=r(5),T=n(k),M=r(16),P=n(M),O=r(18),A=n(O),I=r(33),R=n(I),L=r(12),D=n(L),S=function(e){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i(this,t),r instanceof D.default);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new L.URLResource(r,{type:"json",transform:n.transform})}var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,{onLoad:n.onLoad}));return o._getLineColor=n.getLineColor||u,o._getLineWidth=n.getLineWidth||s,o._getRadius=n.getRadius||l,o._getFillColor=n.getFillColor||_,o._getPointFGColor=n.getPointFGColor||c,o._getPointBGColor=n.getPointBGColor||f,o._getPointSize=n.getPointSize||h,o._getPointIconId=n.getPointIconId||d,o._getElevation=n.getElevation||v,o._transform=n.transform||y,o._getExtrudedMode=n.getExtrudedMode||p,o._glenv=e.glenv,o._references={},o._cancelled=!1,o._finished=!1,o}return o(t,e),m(t,[{key:"_load",value:function(){var e=this;return this._resource.load().then(function(t){e._check_cancel(),e._load_geojson_object(t)})}},{key:"_load_geojson_object",value:function(e){var t;if(e.type===N.FEATURE_COLLECTION){var r=e.features;t=!1;for(var n=0,i=r.length;n<i;n++){var a=r[n],o=this._load_geojson_object(a.featureId?a.feature:a);o&&!t&&(t=o)}}else if(e.type===N.FEATURE){var u=e.geometry;t=this._load_geometry_object(u,e)}else{if(F.indexOf(e.type)===-1)throw new Error("Unnsupported Type: "+e.type);t=this._load_geometry_object(e,null)}return!this._cancelled&&t}},{key:"_load_geometry_object",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.coordinates;if(!r&&!e)return!1;switch(e.type){case C.POINT:case C.MULTI_POINT:return this._loadPoint(e,t);case C.LINE_STRING:case C.MULTI_LINE_STRING:return this._loadLines(e,t);case C.POLYGON:case C.MULTI_POLYGON:return this._loadPolygons(e,t);case C.GEOMETRY_COLLECTION:return!0;default:throw new Error("Invalid GeoJSON type: "+e.type)}}},{key:"_make_fetch_params",value:function(e){var r={signal:this._abort_ctrl.signal,credentials:(e.credentials||T.default.OMIT).credentials};return e.headers&&(r.headers=e.headers||t._defaultHeaders),r}},{key:"_loadLines",value:function(e,t){var r=this,n=this._getLineColor(t),i=this._getLineWidth(t),a=this._getExtrudedMode(t),o=this._getElevation(t);if(!e||4!==n.length)return!1;var u=e.type,s=e.coordinates,l=n.slice(0,3),_=n[3];return u===C.MULTI_LINE_STRING?(s.forEach(function(e){if(!r._generateLine(e,i,l,_,a,o))return!1}),!0):this._generateLine(s,i,l,_,a,o)}},{key:"_generateLine",value:function(e,t,r,n,i,a){if(!e)return!1;var o=0;i?i&&(o=a):o=0;var u=new P.default(this._scene),s=this._flatten(e,o);return!!s&&(u.addPoints(s),u.setLineWidth(t),u.setColor(r),u.setOpacity(n),this._scene.addEntity(u),!0)}},{key:"_loadPoint",value:function(e,t){var r=this._getPointFGColor(t),n=this._getPointBGColor(t),i=this._getPointIconId(t),a=this._getPointSize(t),o=this._getElevation(t);if(!e)return!1;var u=e.type,s={fg_color:r.slice(0,3),bg_color:n.slice(0,3),size:a};if(u===C.POINT){var l=new R.default(this._scene),_=new x.default(e.coordinates[0],e.coordinates[1],e.coordinates[2]||o);null!==i?l.addMakiIconPin(i,_,s):l.addPin(_,s),this._scene.addEntity(l)}else{for(var l=new R.default(this._scene),c=0;c<e.coordinates.length;c++){var f=e.coordinates[c],_=new x.default(f[0],f[1],f[2]||o);null!==i?l.addMakiIconPin(i,_,s):l.addPin(_,s)}this._scene.addEntity(l)}return!0}},{key:"_loadPolygons",value:function(e,t){var r=this,n=this._getFillColor(t),i=this._getExtrudedMode(t),a=this._getElevation(t);if(!e||4!==n.length)return!1;var o=e.type,u=e.coordinates,s=n.slice(0,3),l=n[3];return o===C.MULTI_POLYGON?(u.forEach(function(e){if(!r._generatePolygon(e,s,l,i,a))return!1}),!0):this._generatePolygon(u,s,l,i,a)}},{key:"_generatePolygon",value:function(e,t,r,n,i){if(!e)return!1;var a=n?i:0,o=new A.default(this._scene);o.setColor(t),o.setOpacity(r);for(var u=0;u<e.length;u++){var s=this._flatten(e[u],a,e[u].length-1);if(!s)return!1;0===u?o.addOuterBoundary(s):o.addInnerBoundary(s)}return this._scene.addEntity(o),!0}},{key:"_flatten",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;return e.reduce(function(e,n,i){return i>=r?e:2===n.length?e.concat(n,t):e.concat(n)},[])}}]),t}(b.default);S._defaultHeaders={},S.defaultLineColor=[0,0,0,1],S.defaultFillColor=[0,0,0,1],S.defaultLineWidth=1,S.defaultRadius=10,S.defaultExtrudedMode=!0,S.defaultPointFGColor=[1,0,0],S.defaultPointBGColor=[0,0,1],S.defaultPointSize=30,S.defaultPointIconId=null;var N={FEATURE:"Feature",FEATURE_COLLECTION:"FeatureCollection"},C={POINT:"Point",MULTI_POINT:"MultiPoint",LINE_STRING:"LineString",MULTI_LINE_STRING:"MultiLineString",POLYGON:"Polygon",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",FEATURE:"Feature"},F=Object.values(C);t.default=S,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(4),l=n(s),_=r(10),c=n(_),f=r(9),h=n(f),d=r(13),v=n(d),p=r(58),y=n(p),m=r(1),g=n(m),b=r(3),w=n(b),E=r(2),x=n(E),k=r(7),T=n(k),M=r(26),P=(n(M),r(11)),O=n(P),A=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n._entries=[],n._parent_props={size:null,origin:null},n._primitive_producer=new I(n),r&&r.json&&n._setupByJson(r.json),n}return o(t,e),u(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"addImageIcon",value:function(e,t,r){this._entries.push(new R(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"_getMaterial",value:function(){var e=this.scene;return e._ImageEntity_image_material||(e._ImageEntity_image_material=new y.default(e.glenv)),e._ImageEntity_image_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector3Property",value:function(e,t){var r=this._text_parent_props[e];r[0]==t[0]&&r[1]==t[1]&&r[2]==t[2]||(g.default.copyVector3(t,r),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new w.default,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;t.setFromArray(u.position),this.addImageIcon(t,u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.fg_color&&this.setFGColor(e.fg_color),e.bg_color&&this.setBGColor(e.bg_color)}}]),t}(l.default);A.DEFAULT_COLOR=g.default.createVector3f([1,1,1]),A.SAFETY_PIXEL_MARGIN=1,A.MAX_IMAGE_WIDTH=4096,A.CIRCLE_SEP_LENGTH=32,A.DEFAULT_ICON_SIZE=g.default.createVector2f([30,30]),A.DEFAULT_ORIGIN=g.default.createVector2f([.5,.5]),A.SAFETY_PIXEL_MARGIN=1,A.MAX_IMAGE_WIDTH=4096;var I=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r._glenv=e.scene.glenv,r._dirty=!0,r._transform=g.default.setIdentity(g.default.createMatrix()),r._properties={image:null};var n=new c.default(r._glenv,null,e._getMaterial(),r._transform);return n.properties=r._properties,r._primitive=n,r._primitives=[],r}return o(t,e),u(t,[{key:"createRegions",value:function(){var e=new T.default,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,u=o.position;e.addPoint(u)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0;
}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new L(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2}],vertices:t.vertices,indices:t.indices},i=new h.default(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var u=this._transform;u[12]=r/t,u[13]=n/t,u[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return w.default.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case x.default.RELATIVE:e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3);for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var u=0;u<r;++u)n[3*u+2]=t[u].position.altitude}return n}}]),t}(l.default.PrimitiveProducer),R=function(){function e(t,r,n,a){var o=this;i(this,e),this._owner=t,this._image_src=r,this._position=n.clone(),this._props=Object.assign({},a),this._copyPropertyVector2f("size"),this._copyPropertyVector2f("origin"),this._icon=e.iconLoader.load(r),this._icon.onEnd(function(e){o._owner.getPrimitiveProducer()._dirty=!0})}return u(e,[{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=g.default.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=g.default.createVector2f([t[e],t[e]]):t[e]=g.default.createVector2f(t[e]))}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||g.default.createVector2f([this._icon.width,this._icon.height])}},{key:"origin",get:function(){var e=this._props,t=this._owner._parent_props;return e.origin||t.origin||A.DEFAULT_ORIGIN}},{key:"icon",get:function(){return this._icon}}]),e}();R.iconLoader=new M.ImageIconLoader;var L=function(){function e(t,r){i(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0==n.length)return void(this._is_valid=!1);var a=this._setupLocation(n);this._texture=this._createTexture(a.width,a.height),this._vertices=this._createVertices(a.width,a.height,r),this._indices=this._createIndices()}return u(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,u=this._owner.entity._entries[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;if(s.isLoaded()){var l=e.get(s.icon);l||(e.set(s.icon,l=new D(this)),t.push(l)),l.add(r++,s)}}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort(function(e,t){return e.height_pixel-t.height_pixel});for(var t=[];e.length>0;){var r=new S(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=O.default.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,u={usage:v.default.Usage.ICON};return new v.default(o,r.canvas,u)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],u=i[14],s=1/e,l=1/t,_=this._items,c=0;c<_.length;++c){var f=_[c];if(!f.is_canceled)for(var h=0;h<f.entries.length;h++){var d=f.entries[h],v=d.entry,p=v.size,y=v.origin,m=3*d.index,g=r[m]-a,b=r[m+1]-o,w=r[m+2]-u,E=f.pos_x,x=f.pos_y,k=f.width,T=f.height;n.push(g,b,w),n.push(-y[0]*p[0],y[1]*p[1]),n.push(E*s,1-x*l),n.push(g,b,w),n.push(-y[0]*p[0],-(1-y[1])*p[1]),n.push(E*s,1-(x+T)*l),n.push(g,b,w),n.push((1-y[0])*p[0],-(1-y[1])*p[1]),n.push((E+k)*s,1-(x+T)*l),n.push(g,b,w),n.push((1-y[0])*p[0],y[1]*p[1]),n.push((E+k)*s,1-x*l)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=n.entries[i],o=4*a.index,u=o;e.push(u,u+1,u+2),e.push(u,u+2,u+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=A.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+A.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),D=function(){function e(t){i(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return u(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height);var t=!1;t&&(e.beginPath(),e.moveTo(this._pos_x,this._pos_y),e.lineTo(this._pos_x+this.width,this._pos_y),e.lineTo(this._pos_x+this.width,this._pos_y+this.height),e.lineTo(this._pos_x,this._pos_y+this.height),e.closePath(),e.stroke())}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),S=function(){function e(t){i(this,e);var r=0,n=0,a=[];for(r+=A.SAFETY_PIXEL_MARGIN;t.length>0;){var o=t.shift(),u=o.width_pixel+A.SAFETY_PIXEL_MARGIN;if(r+u<=A.MAX_IMAGE_WIDTH)a.push(o),r+=u,n=Math.max(o.height_pixel,n);else{if(0!=a.length){t.unshift(o);break}o.cancel()}}this._items=a,this._width_assumed=r,this._height_pixel=n}return u(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=A.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+A.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}();t.default=A,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(1),c=n(_),f=r(91),h=n(f),d=r(90),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(l.default);p.TEXUNIT_IMAGE=0,p._sparam=c.default.createVector2f(),p._bg_color=c.default.createVector3f(),p._fg_color=c.default.createVector3f(),t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.Dataset3DSceneBlobResource=t.Dataset3DSceneResource=t.DatasetResource=t.MaprayResource=void 0;var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(25),l=n(s),_=r(12),c=n(_),f=r(11),h=n(f),d=r(14),v=n(d),p=function(e){function t(e,r,n,o,u){i(this,t);var s=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r+" ["+e+"]",n));return Error.captureStackTrace&&Error.captureStackTrace(s,t),s.name="MaprayApiError",s.code=e,s.resonse=o,s.cause=u,u&&(s.stack+="\nCaused-By: "+u.stack),s}return o(t,e),t}(s.FetchError),y=t.MaprayResource=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._api=e,r}return o(t,e),u(t,[{key:"type",get:function(){throw new Error("Not Implemented")}}]),t}(c.default),m=t.DatasetResource=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n._datasetId=r,n}return o(t,e),u(t,[{key:"load",value:function(){return this._api.listFeatures(this._datasetId)}},{key:"type",get:function(){return"Dataset"}}]),t}(y),g=t.Dataset3DSceneResource=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return Array.isArray(r)||(r=[r]),n._datasetIds=r,n}return o(t,e),u(t,[{key:"load",value:function(){return this._api.get3DDatasetScene(this._datasetIds).then(function(e){return e})}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=h.default.resolveUrl(this._base_url,e);return this._api.fetch(l.default.METHOD.GET,r)}},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new b(this._api,e,{transform:this._transform})}},{key:"type",get:function(){return"3DDatasetScene"}}]),t}(y),b=t.Dataset3DSceneBlobResource=function(e){function t(e,r){i(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n._url=r;var o=r.lastIndexOf("/");if(o===-1)throw new Error("invalid url");return n._base_url=n._url.substr(0,o+1),n}return o(t,e),u(t,[{key:"load",value:function(){return this._api.fetch(l.default.METHOD.GET,this._url)}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=h.default.resolveUrl(this._base_url,e);return t===v.default.ResourceType.BINARY?this._api.fetch(l.default.METHOD.GET,r).then(function(e){if(!e.ok)throw new Error(e.statusText);return e.arrayBuffer()}):t===v.default.ResourceType.IMAGE?this._api.fetch(l.default.METHOD.GET,r).then(function(e){if(!e.ok)throw new Error(e.statusText);return e.blob()}).then(h.default.loadImage):this._api.fetch(l.default.METHOD.GET,e)}},{key:"type",get:function(){return"3DDatasetSceneBlob"}}]),t}(y),w=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),n=e.basePath.endsWith("/")?e.basePath.slice(0,-1):e.basePath;return r._option={token:e.token,version:e.version,basePath:n,userId:e.userId},r}return o(t,e),u(t,[{key:"getDatasetAsResource",value:function(e){return new m(this,e)}},{key:"get3DDatasetAsResource",value:function(e){return new g(this,e)}},{key:"getDatasets",value:function(){var e=this._option;return this.get("datasets",[e.userId],null)}},{key:"getDataset",value:function(e){var t=this._option;return this.get("datasets",[t.userId,e],null)}},{key:"createDataset",value:function(e,t){var r=this._option,n={name:e,description:t};return this.post("datasets",[r.userId],null,n)}},{key:"deleteDataset",value:function(e){var t=this._option;return this.delete("datasets",[t.userId,e])}},{key:"listFeatures",value:function(e){var t=this._option;return this.get("datasets",[t.userId,e,"features"])}},{key:"insertFeature",value:function(e,t){var r=this._option;return this.post("datasets",[r.userId,e,"features"],null,t)}},{key:"updateFeature",value:function(e,t,r){var n=this._option;return this.put("datasets",[n.userId,"features",t],null,r)}},{key:"list3DDatasets",value:function(){var e=this._option;return this.get("3ddatasets",[e.userId])}},{key:"create3DDataset",value:function(e,t,r){var n=this._option,i={name:e,description:t,path:r.path,format:r.format,srid:r.srid,x:r.x,y:r.y,z:r.z};return this.post("3ddatasets",[n.userId],null,i)}},{key:"update3DDataset",value:function(e,t,r,n){var i=this._option,a={name:t,description:r,path:n.path,format:n.format,srid:n.srid,x:n.x,y:n.y,z:n.z};return this.patch("3ddatasets",[i.userId,e],null,a)}},{key:"create3DDatasetUploadUrl",value:function(e){var t=this._option;return this.post("3ddatasets",["uploads",t.userId,e],null,{})}},{key:"get3DDataset",value:function(e){var t=this._option;return this.get("3ddatasets",[t.userId,e],null)}},{key:"delete3DDataset",value:function(e){var t=this._option;return this.delete("3ddatasets",[t.userId,e])}},{key:"get3DDatasetScene",value:function(e){var t=this._option;return this.get("3ddatasets",["scene",t.userId],{"3ddatasets_ids":Array.isArray(e)?e.join(","):e}).then(function(e){return e.entity_list.forEach(function(e){var t=e.index,r=parseInt(t);if(r.toString()!==t)throw new Error("Internal Error: ID couldn't be convert to 'number'");e.index=r}),e})}},{key:"get",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetchAPI(l.default.METHOD.GET,e,t,r,null,n)}},{key:"post",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(l.default.METHOD.POST,e,t,r,n,i)}},{key:"patch",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(l.default.METHOD.PATCH,e,t,r,n,i)}},{key:"put",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(l.default.METHOD.PUT,e,t,r,n,i)}},{key:"delete",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetchAPI(l.default.METHOD.DELETE,e,t,r,null,n)}},{key:"fetchAPI",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},o=this._option,u=o.basePath+"/"+t+"/"+o.version+(r.length>0?"/"+r.join("/"):"");return console.log("MaprayAPI: "+e+" "+u+(n?"?"+JSON.stringify(n):"")),this.fetch(e,u,n,i,a)}},{key:"fetch",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=this._option,o=i.headers||(i.headers={});return o["x-api-key"]=a.token,l.default.fetch(e,t,r,n,i).then(function(e){if(e.status!==l.default.RESPONSE_STATUS.NO_CONTENT){var t=e.headers.get(l.default.CONTENT_TYPE);return l.default.isJson(t)?e.json():(console.log("Unsupported Mime Type: "+t),e)}}).catch(function(e){if("FetchError"===e.name&&e.response)return e.response.json().catch(function(r){throw new p(-1,"Failed to fetch",t,null,e)}).then(function(r){throw new p(r.code,r.error,t,e.response,e)});throw new p(-1,"Failed to fetch",t,null,e)})}}]),t}(l.default);w.CLOUD_BASE_PATH="http://localhost:8080",t.default=w},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(1),c=n(_),f=r(93),h=n(f),d=r(92),v=n(d),p=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default))}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties,i=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY;return i<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,i[2]=e._height/e._width,this.setVector3("u_sparam",i);var a=n.width||t.DEFAULT_WIDTH,o=t._thickness;o[0]=a/2,o[1]=a/2,this.setVector2("u_thickness",o);var u=void 0!==n.color?n.color:t.DEFAULT_COLOR,s=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,l=t._color;c.default.copyVector3(u,l),l[3]=s,this.setVector4("u_color",l)}}]),t}(l.default);p.DEFAULT_WIDTH=1,p.DEFAULT_COLOR=c.default.createVector3f([1,1,1]),p.DEFAULT_OPACITY=1,p._sparam=c.default.createVector3f(),p._thickness=c.default.createVector2f(),p._color=c.default.createVector4f(),t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(42),u=(n(o),r(1)),s=n(u),l=r(10),_=n(l),c=r(9),f=n(c),h=r(31),d=n(h),v=r(13),p=n(v),y=r(62),m=n(y),g=r(43),b=n(g),w=r(44),E=n(w),x=function(){function e(t,r){i(this,e),this._entries=[],this._name_map={},this._default=null,this._offset_transform=s.default.setIdentity(s.default.createMatrix());var n={},a=!0,o=!1,u=void 0;try{for(var l,_=r.scenes[Symbol.iterator]();!(a=(l=_.next()).done);a=!0){var c=l.value,f=new k(t,c,n);this._entries.push(f),null!==c.name&&(this._name_map[c.name]=f)}}catch(e){o=!0,u=e}finally{try{!a&&_.return&&_.return()}finally{if(o)throw u}}if(r.default_scene_index>=0){if(!(r.default_scene_index<this._entries.length))throw new Error("default_scene_index is out of range");this._default=this._entries[r.default_scene_index]}else this._entries.length>=1&&(this._default=this._entries[0])}return a(e,[{key:"setOffsetTransform",value:function(e){s.default.copyMatrix(e,this._offset_transform)}},{key:"createPrimitives",value:function(e){var t=this._getEntry(e);if(null===t)return null;var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=t.primitives[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var l=o.value,_=l.fastClone();s.default.mul_AA(this._offset_transform,_.transform,_.transform),_.properties=T.fastCloneProperties(_.properties),r.push(_)}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}},{key:"_getEntry",value:function(e){if("number"==typeof e){if(0<=e&&e<this._entries.length)return this._entries[e]}else if("string"==typeof e){if(this._name_map.hasOwnProperty(e))return this._name_map[e]}else if(this._entries.length>0)return this._entries[0];return null}}]),e}(),k=function(){function e(t,r,n){i(this,e);var a=new T(t,r,n);this._primitives=a.primitives}return a(e,[{key:"primitives",get:function(){return this._primitives}}]),e}(),T=function(){function e(t,r,n){i(this,e),n.buffer_map||(n.buffer_map=new Map,n.texture_map=new Map),this._mr_scene=t,this._glenv=t.glenv,this._primitives=[],this._buffer_map=n.buffer_map,this._texture_map=n.texture_map;var a=s.default.setIdentity(s.default.createMatrix()),o=!0,u=!1,l=void 0;try{for(var _,c=r.root_nodes[Symbol.iterator]();!(o=(_=c.next()).done);o=!0){var f=_.value;this._addNode(f,a)}}catch(e){u=!0,l=e}finally{try{!o&&c.return&&c.return()}finally{if(u)throw l}}}return a(e,[{key:"_addNode",value:function(t,r){var n=e._getNodeToScene(t,r);if(null!==t.mesh){var i=!0,a=!1,o=void 0;try{for(var u,s=t.mesh.primitives[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var l=u.value;this._primitives.push(this._createPrimitive(l,n))}}catch(e){a=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(a)throw o}}}var _=!0,c=!1,f=void 0;try{for(var h,d=t.children[Symbol.iterator]();!(_=(h=d.next()).done);_=!0){var v=h.value;this._addNode(v,n)}}catch(e){c=!0,f=e}finally{try{!_&&d.return&&d.return()}finally{if(c)throw f}}}},{key:"_createPrimitive",value:function(e,t){var r=this._createMesh(e),n=this._createMaterial(e),i=new _.default(this._glenv,r,n,s.default.createMatrix(t));return i.pivot=this._createMeshPivot(e),i.bbox=this._createBoundingBox(e),i.properties=this._createProperties(e),i}},{key:"_createMesh",value:function(t){var r=new f.default.Initializer(e._convertPrimitiveMode(t),e._calcNumVertices(t)),n=t.attributes;for(var i in n)this._addAttribToInit(r,i,n[i]);var a=t.indices;return null!==a&&this._addIndexToInit(r,a),new f.default(this._glenv,r)}},{key:"_addAttribToInit",value:function(t,r,n){var i=this._findMeshBuffer(n.bufferView.buffer,d.default.Target.ATTRIBUTE),a=e._NumComponents[n.type],o=e._ComponentType[n.componentType],u={normalized:n.normalized,byte_stride:n.bufferView.byteStride,byte_offset:n.bufferView.byteOffset+n.byteOffset},s=e._VertexAttribId[r]||r;t.addAttribute(s,i,a,o,u)}},{key:"_addIndexToInit",value:function(t,r){var n=this._findMeshBuffer(r.bufferView.buffer,d.default.Target.INDEX),i=r.count,a=e._ComponentType[r.componentType],o={byte_offset:r.bufferView.byteOffset+r.byteOffset};t.addIndex(n,i,a,o)}},{key:"_findMeshBuffer",value:function(e,t){var r=this._buffer_map.get(e);return void 0===r&&(r=new d.default(this._glenv,e.binary,{target:t}),this._buffer_map.set(e,r)),r}},{key:"_createMaterial",value:function(e){var t=this._mr_scene;return t._ModelEntity_model_material||(t._ModelEntity_model_material=new m.default(t.glenv)),t._ModelEntity_model_material}},{key:"_createMeshPivot",value:function(e){var t=null,r=this._createBoundingBox(e);if(null!==r){t=s.default.createVector3();for(var n=0;n<3;++n)t[n]=(r[0][n]+r[1][n])/2}return t}},{key:"_createBoundingBox",value:function(e){var t=null,r=e.attributes.POSITION;if(void 0!==r){var n=r.min,i=r.max;null!==n&&null!==i&&(t=[s.default.createVector3(n),s.default.createVector3(i)])}return t}},{key:"_createProperties",value:function(e){var t=e.material;if(null===t)return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector4f([1,1,1,1]),baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},doubleSided:!1,alphaMode:"OPAQUE",alphaCutoff:.5,emissiveFactor:s.default.createVector3f([0,0,0]),emissiveTexture:null,normalTexture:null,occlusionTexture:null};var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector4f(r.baseColorFactor),baseColorTexture:this._createTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:this._createTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:s.default.createVector3f(t.emissiveFactor),emissiveTexture:this._createTextureParam(t.emissiveTexture),normalTexture:this._createTextureParam(t.normalTexture),occlusionTexture:this._createTextureParam(t.occlusionTexture)}}},{key:"_createTextureParam",value:function(e){if(null===e)return null;var t={texture:this._findTexture(e.texture),texCoord:e.texCoord};return e instanceof b.default?t.scale=e.scale:e instanceof E.default&&(t.strength=e.strength),t}},{key:"_findTexture",value:function(e){var t=this._texture_map.get(e);if(void 0===t){var r=e.sampler,n=this._glenv.context,i={mag_filter:void 0!==r.magFilter?r.magFilter:n.LINEAR,min_filter:void 0!==r.minFilter?r.minFilter:n.LINEAR_MIPMAP_LINEAR,wrap_s:r.wrapS,wrap_t:r.wrapT,flip_y:!1};t=new p.default(this._glenv,e.source.image,i),this._texture_map.set(e,t)}return t}},{key:"primitives",get:function(){return this._primitives}}],[{key:"_getNodeToScene",value:function(e,t){var r=t,n=e.matrix;return null!==n&&(r=s.default.createMatrix(),s.default.mul_AA(t,n,r)),r}},{key:"_convertPrimitiveMode",value:function(t){return e._DrawMode[t.mode]}},{key:"_calcNumVertices",value:function(e){var t=e.attributes,r=[];for(var n in t){var i=t[n];r.push(i.count)}return Math.min.apply(null,r)}},{key:"fastCloneProperties",value:function(t){var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:s.default.createVector3f(r.baseColorFactor),baseColorTexture:e._fastCloneTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:e._fastCloneTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:s.default.createVector3f(t.emissiveFactor),emissiveTexture:e._fastCloneTextureParam(t.emissiveTexture),normalTexture:e._fastCloneTextureParam(t.normalTexture),occlusionTexture:e._fastCloneTextureParam(t.occlusionTexture)}}},{key:"_fastCloneTextureParam",value:function(e){if(null===e)return null;var t={texture:e.texture,texCoord:e.texCoord};return"scale"in e?t.scale=e.scale:"strength"in e&&(t.strength=e.strength),t}}]),e}();T._DrawMode={0:f.default.DrawMode.POINTS,1:f.default.DrawMode.LINES,2:f.default.DrawMode.LINE_LOOP,3:f.default.DrawMode.LINE_STRIP,4:f.default.DrawMode.TRIANGLES,5:f.default.DrawMode.TRIANGLE_STRIP,6:f.default.DrawMode.TRIANGLE_FAN},T._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},T._ComponentType={5120:f.default.ComponentType.BYTE,5121:f.default.ComponentType.UNSIGNED_BYTE,5122:f.default.ComponentType.SHORT,5123:f.default.ComponentType.UNSIGNED_SHORT,5125:f.default.ComponentType.UNSIGNED_INT,5126:f.default.ComponentType.FLOAT},T._VertexAttribId={POSITION:"a_position",NORMAL:"a_normal",TANGENT:"a_tangent",TEXCOORD_0:"a_texcoord",TEXCOORD_1:"a_texcoord1",COLOR_0:"a_color"},t.default=x,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(13),c=n(_),f=r(95),h=n(f),d=r(94),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r._white_texture=new c.default(e,null,{usage:c.default.Usage.COLOR,color:[1,1,1,1]}),r.bindProgram(),r.setInteger("u_base_image",t.TEXUNIT_BASE_IMAGE),r}return o(t,e),u(t,[{key:"setParameters",value:function(e,r){var n=r.properties,i=n.pbrMetallicRoughness;this.setObjToClip(e,r),this.setObjToView(e,r),this.setVector4("u_base_color",i.baseColorFactor),this.setVector3("u_light_dir",[0,0,1]);var a=this._selectTexture(i.baseColorTexture,this._white_texture);this.bindTexture2D(t.TEXUNIT_BASE_IMAGE,a.handle)}},{key:"_selectTexture",value:function(e,t){return null!==e?e.texture:t}}]),t}(l.default);p.TEXUNIT_BASE_IMAGE=0,t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=r(35),s=n(u),l=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),t}(s.default);t.default=l,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(1),c=n(_),f=r(97),h=n(f),d=r(96),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r.setInteger("u_image_mask",t.TEXUNIT_IMAGE_MASK),r}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle);
var o=n.image_mask;this.bindTexture2D(t.TEXUNIT_IMAGE_MASK,o.handle)}}]),t}(l.default);p.TEXUNIT_IMAGE=0,p.TEXUNIT_IMAGE_MASK=1,p._sparam=c.default.createVector2f(),p._bg_color=c.default.createVector3f(),p._fg_color=c.default.createVector3f(),t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(1),c=n(_),f=r(99),h=n(f),d=r(98),v=n(d),p=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default))}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties,i=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY;return i<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r),this.setObjToView(e,r);var i=void 0!==n.color?n.color:t.DEFAULT_COLOR,a=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,o=t._color;c.default.copyVector3(i,o),o[3]=a,this.setVector4("u_color",o),this.setBoolean("u_lighting",n.lighting),this.setVector3("u_light_dir",[0,0,1])}}]),t}(l.default);p.DEFAULT_COLOR=c.default.createVector3f([1,1,1]),p.DEFAULT_OPACITY=1,p._color=c.default.createVector4f(),t.default=p,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this.flake=t}return n(e,[{key:"findMesh",value:function(){return this.flake.findMesh(this.lod)}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=n(o),s=r(24),l=n(s),_=r(53),c=n(_),f=r(69),h=n(f),d=r(74),v=n(d),p=r(40),y=n(p),m=function(){function e(t){i(this,e),this._viewer=t,this._glenv=t.glenv;var r=t.canvas_element;if(this._width=r.width,this._height=r.height,0===this._width||0===this._height)return void(this._rendering_cancel=!0);var n=t.camera,a=n.createRenderInfo();this._setupBasicMatrices(a,n),this._volume_planes=a.volume_planes,this._pixel_step=a.pixel_step,this._scene=t.scene,this._globe=t.globe,this._tile_texture_cache=t.tile_texture_cache,t._render_cache||(t._render_cache={surface_material:new h.default(t),wireframe_material:new v.default(t)}),this._flake_material=t.render_mode===y.default.RenderMode.WIREFRAME?t._render_cache.wireframe_material:t._render_cache.surface_material,this._debug_stats=t.debug_stats}return a(e,[{key:"_setupBasicMatrices",value:function(e,t){this._view_to_gocs=t.view_to_gocs,this._gocs_to_view=u.default.createMatrix(),u.default.inverse_A(this._view_to_gocs,this._gocs_to_view),this._view_to_clip=e.view_to_clip,this._gocs_to_clip=u.default.createMatrix(),u.default.mul_PzA(this._view_to_clip,this._gocs_to_view,this._gocs_to_clip)}},{key:"render",value:function(){if(!this._rendering_cancel){var e=this._glenv.context;if(e.viewport(0,0,this._width,this._height),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.depthFunc(e.LEQUAL),this._globe.status===l.default.Status.READY){var t;if(this._viewer.getVisibility(y.default.Category.GROUND)){var r=new c.default(this);t=r.traverse()}else t=[];e.enable(e.BLEND),e.depthMask(!0);for(var n=0;n<t.length;++n)this._drawFlake(t[n]);this._viewer.getVisibility(y.default.Category.ENTITY)&&this._scene.draw(this);var i=this._debug_stats;null!==i&&(i.num_drawing_flakes=t.length),this._globe.endFrame(),this._tile_texture_cache.endFrame(),this._viewer.layers.endFrame()}}}},{key:"_drawFlake",value:function(e){for(var t=e.findMesh(),r=this._flake_material,n=r.numDrawings(),i=0;i<n;++i)r.bindProgram(),r.setFlakeParameter(this,e,t,i)&&t.draw(r);var a=this._debug_stats;null!==a&&(a.num_drawing_flake_vertices+=t.num_vertices)}}]),e}();t.default=m,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i){r(this,e),this._glenv=t;try{this.vs_object=this._compile_shader("VERTEX_SHADER",n),this.fs_object=this._compile_shader("FRAGMENT_SHADER",i)}catch(e){var a=t.context;throw this.vs_object&&a.deleteShader(this.vs_object),this.fs_object&&a.deleteShader(this.fs_object),e}}return n(e,[{key:"dispose",value:function(){var e=this._glenv.context;this.vs_object&&(e.deleteShader(this.vs_object),this.vs_object=null),this.fs_object&&(e.deleteShader(this.fs_object),this.fs_object=null)}},{key:"_compile_shader",value:function(e,t){var r=this._glenv.context,n=r.createShader(r[e]);if(!n)throw new Error(e+" オブジェクトの生成に失敗しました");try{if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw new Error(e+" のコンパイルに失敗: "+i)}}catch(e){throw r.deleteShader(n),e}return n}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(23),l=n(s),_=r(1),c=(n(_),r(19)),f=(n(c),r(101)),h=n(f),d=r(100),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image_hi",t.TEXUNIT_IMAGE_HI),r.setInteger("u_image_lo",t.TEXUNIT_IMAGE_LO),r._tile_texture_cache=e.tile_texture_cache,r._layers=e.layers,r._dummy_tile_texture=r._createDummyTileTexture(e.glenv),r._image_zbias=0,r}return o(t,e),u(t,[{key:"numDrawings",value:function(){return 1+this._layers.numDrawingLayers()}},{key:"setFlakeParameter",value:function(e,r,n,i){this.setCommonParameter(e,n);var a=this._getMaterialParamater(r,i);return null!==a&&(this.setVector4("u_corner_lod",a.corner_lod),this.setVector4("u_texcoord_rect_hi",a.image_hi.texcoord_rect),this.setVector4("u_texcoord_rect_lo",a.image_lo.texcoord_rect),this.setVector2("u_image_param",[a.image_lo.lod,a.image_hi.lod==a.image_lo.lod?0:1/(a.image_hi.lod-a.image_lo.lod)]),this.setFloat("u_opacity",0==i?1:this._layers.getDrawingLayer(i-1).opacity),this.bindTexture2D(t.TEXUNIT_IMAGE_HI,a.image_hi.texture),this.bindTexture2D(t.TEXUNIT_IMAGE_LO,a.image_lo.texture),!0)}},{key:"_getMaterialParamater",value:function(e,t){var r=0==t?this._tile_texture_cache:this._layers.getDrawingLayer(t-1).tile_cache;this._image_zbias=r.getImageZBias();var n=e.flake,i=n.z;if(i<r.getImageZMin())return null;var a=n.x,o=n.y,u=Math.ceil(e.lod+this._image_zbias);if(i<u)return null;var s=r.findNearestAncestors(i,a,o,u);return t>=1&&null===s[0]?null:{corner_lod:[e.lod_00,e.lod_10,e.lod_01,e.lod_11],image_hi:this._getImageParamater(s[0],i,a,o,u),image_lo:this._getImageParamater(s[1],i,a,o,u-1)}}},{key:"_getImageParamater",value:function(e,t,r,n,i){var a;return null!==e?(a=Math.pow(2,e.z-t),{lod:e.z-this._image_zbias,texture:e.texture,texcoord_rect:[r*a-e.x,1-(n+1)*a+e.y,a,a]}):(a=Math.pow(2,-t),{lod:-this._image_zbias,texture:this._dummy_tile_texture,texcoord_rect:[r*a-Math.floor(a*(r+.5)),1-(n+1)*a+Math.floor(a*(n+.5)),a,a]})}},{key:"_createDummyTileTexture",value:function(e){var t=e.context,r=t.TEXTURE_2D,n=t.createTexture(),i=[128,128,128,255];return t.bindTexture(r,n),t.texImage2D(r,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(i)),t.bindTexture(r,null),n}}]),t}(l.default);p.TEXUNIT_IMAGE_HI=0,p.TEXUNIT_IMAGE_LO=1,t.default=p,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(6),l=n(s),_=r(1),c=n(_),f=r(103),h=n(f),d=r(102),v=n(d),p=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,h.default,v.default));return r.bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return o(t,e),u(t,[{key:"isTranslucent",value:function(e,t){return!0}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(l.default);p.TEXUNIT_IMAGE=0,p._sparam=c.default.createVector2f(),t.default=p,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n,i,a){r(this,e),this.z=t,this.x=n,this.y=i,this.texture=a}return n(e,[{key:"dispose",value:function(e){e.deleteTexture(this.texture),this.texture=null}}]),e}();t.default=i,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t,n,i,a){r(this,e),this._points=new Float64Array(2*a),this._polygons=new Set;for(var o=n,u=0,s=0;s<a;++s)this._points[u]=t[o],this._points[u+1]=t[o+1],o+=i,u+=2}return i(e,[{key:"addBoundary",value:function(e){this._polygons.add(u.create(this._points,e))}},{key:"run",value:function(){this._makeYMonotonePolygons();var e=new Uint32Array(3*this._numTriangles()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._polygons[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value,s=this._makeTriangleArray(u);e.set(s,t),t+=s.length}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return e}},{key:"_numTriangles",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;e+=o.numVertices()-2}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return e}},{key:"_makeYMonotonePolygons",value:function(){for(var e=this._getYOrderedVertices(),t=new s,r=new _(this._polygons),n=0;n<e.length;++n){var i=e[n];switch(i.getVertexType()){case"start":var a=i.getFrontEdge();t.addEdge(a,i);break;case"end":var o=i.getBackEdge(),u=t.getHelper(o);"merge"==u.getVertexType()&&r.addDiagonal(i,u),t.removeEdge(o);break;case"split":var l=t.findNearestLeftEdge(i);r.addDiagonal(i,t.getHelper(l)),t.setHelper(l,i);var c=i.getFrontEdge();t.addEdge(c,i);break;case"merge":var f=i.getBackEdge(),h=t.getHelper(f);"merge"==h.getVertexType()&&r.addDiagonal(i,h),t.removeEdge(f);var d=t.findNearestLeftEdge(i),v=t.getHelper(d);"merge"==v.getVertexType()&&r.addDiagonal(i,v),t.setHelper(d,i);break;default:if(i.isRightInner()){var p=i.getBackEdge(),y=t.getHelper(p);"merge"==y.getVertexType()&&r.addDiagonal(i,y),t.removeEdge(p);var m=i.getFrontEdge();t.addEdge(m,i)}else{var g=t.findNearestLeftEdge(i),b=t.getHelper(g);"merge"==b.getVertexType()&&r.addDiagonal(i,b),t.setHelper(g,i)}}}r.splitPolygons()}},{key:"_getYOrderedVertices",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var u=i.value;Array.prototype.push.apply(e,u.getVertices())}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}return e.sort(function(e,t){return o.comparePositionY(t,e)})}},{key:"_makeTriangleArray",value:function(e){var t=0,r=new Uint32Array(3*(e.numVertices()-2)),i=new f,a=0,u=e.getVertices().sort(function(e,t){return o.comparePositionY(t,e)}),s=u[0].prev===u[1];for(i.push(u[a++]),i.push(u[a++]);a<u.length-1;){var l=u[a],_=s?l===i.top.prev:l===i.top.next;if(_){for(var c=i.pop();i.size>0;){var h=i.top,d=s?[c,h]:[h,c],v=n(d,2),p=v[0],y=v[1];if(!o.isCCW(l,p,y))break;r[t++]=l.id,r[t++]=p.id,r[t++]=y.id,c=i.pop()}i.push(c),i.push(l)}else{for(var m=i.pop();i.size>0;){var g=i.pop(),b=s?[m,g]:[g,m],w=n(b,2),E=w[0],x=w[1];r[t++]=l.id,r[t++]=E.id,r[t++]=x.id,m=g}i.push(u[a-1]),i.push(l),s=!s}++a}for(var k=u[a],T=i.pop();i.size>0;){var M=i.pop(),P=s?[T,M]:[M,T],O=n(P,2),A=O[0],I=O[1];r[t++]=k.id,r[t++]=A.id,r[t++]=I.id,T=M}return r}}]),e}(),o=function(){function e(t,n,i){r(this,e),this.id=t,this.x=n,this.y=i,this.polygon=null,this.next=null,this.prev=null}return i(e,[{key:"clone",value:function(){return new e(this.id,this.x,this.y)}},{key:"getVertexType",value:function(){var t=this.prev,r=this.next,n=e.comparePositionY(t,this),i=e.comparePositionY(r,this);if(n>0&&i>0||n<0&&i<0){var a=t.y-this.y,o=this.x-t.x,u=r.x-this.x,s=r.y-this.y,l=a*u+o*s;return n>0&&i>0?l<0?"merge":"end":l<0?"split":"start"}return"regular"}},{key:"getFrontEdge",value:function(){return this}},{key:"getBackEdge",value:function(){return this.prev}},{key:"isRightInner",value:function(){return e.comparePositionY(this.next,this)<0}}],[{key:"comparePositionY",value:function(e,t){return e.y<t.y||e.y==t.y&&e.x>t.x?-1:e.y>t.y||e.y==t.y&&e.x<t.x?1:0}},{key:"isCCW",value:function(e,t,r){var n=t.x-e.x,i=t.y-e.y,a=r.x-e.x,o=r.y-e.y;return n*o-i*a>0}}]),e}(),u=function(){function e(){r(this,e),this._first=null}return i(e,[{key:"numVertices",value:function(){var e=0,t=this._first;++e;var r=this._first;for(t=t.next;t!==r;t=t.next)++e;return e}},{key:"getVertices",value:function(){var e=[],t=this._first;e.push(t);var r=this._first;for(t=t.next;t!==r;t=t.next)e.push(t);return e}},{key:"_updateVertices",value:function(){var e=this._first;e.polygon=this;var t=this._first;for(e=e.next;e!==t;e=e.next)e.polygon=this}}],[{key:"create",value:function(t,r){var n=new e,i=r[0],a=2*i,u=new o(i,t[a],t[a+1]);n._first=u;for(var s=1;s<r.length;++s){var l=u;i=r[s],a=2*i,u=new o(i,t[a],t[a+1]),l.next=u,u.prev=l}return n._first.prev=u,u.next=n._first,n._updateVertices(),n}},{key:"createByVertex",value:function(t){var r=new e;return r._first=t,r._updateVertices(),r}}]),e}(),s=function(){function e(){r(this,e),this._edges=new Map}return i(e,[{key:"addEdge",value:function(e,t){this._edges.set(e,{helper:t})}},{key:"removeEdge",value:function(e){this._edges.delete(e)}},{key:"setHelper",value:function(e,t){this._edges.get(e).helper=t}},{key:"getHelper",value:function(e){return this._edges.get(e).helper}},{key:"findNearestLeftEdge",value:function(e){var t=void 0,r=Number.MAX_VALUE,i=e.x,a=e.y,o=!0,u=!1,s=void 0;try{for(var l,_=this._edges[Symbol.iterator]();!(o=(l=_.next()).done);o=!0){var c=l.value,f=n(c,1),h=f[0],d=h.x,v=h.y,p=h.next.x,y=h.next.y,m=(p-d)/(y-v),g=d+(a-v)*m,b=i-g;b>0&&b<r&&(r=b,t=h)}}catch(e){u=!0,s=e}finally{try{!o&&_.return&&_.return()}finally{if(u)throw s}}if(void 0===t)throw new Error("Probably a degenerate polygon");return t}}]),e}(),l=function e(t,n){r(this,e),this.v1=t,this.v2=n},_=function(){function e(t){r(this,e),this._polygons=t,this._diagonals=[],this._dmap=new c}return i(e,[{key:"addDiagonal",value:function(e,t){var r=new l(e,t);this._diagonals.push(r),this._dmap.addDiagonal(r)}},{key:"splitPolygons",value:function(){for(this._shuffleArray(this._diagonals);this._diagonals.length>0;){var e=this._diagonals.pop();this._dmap.removeDiagonal(e);var t=e.v1,r=e.v2,i=this._splitPolygonHalf(t,r),a=n(i,2),o=a[0],s=a[1],l=this._splitPolygonHalf(r,t),_=n(l,2),c=_[0],f=_[1],h=t.polygon,d=r.polygon;h===d?(this._polygons.delete(h),this._polygons.add(u.createByVertex(o)),this._polygons.add(u.createByVertex(f))):(this._polygons.delete(h),this._polygons.delete(d),this._polygons.add(u.createByVertex(o))),this._replaceVertexInDiagonals(t,o,f),this._replaceVertexInDiagonals(r,s,c)}}},{key:"_splitPolygonHalf",value:function(e,t){var r=e.clone(),n=t.clone();return r.prev=e.prev,r.next=n,e.prev.next=r,n.prev=r,n.next=t.next,t.next.prev=n,[r,n]}},{key:"_replaceVertexInDiagonals",value:function(e,t,r){var n=!0,i=!1,a=void 0;try{for(var o,u=this._dmap.removeDiagonals(e)[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value,l=s.v1===e?s.v2:s.v1;s.v1=this._testDiagonal(t,l)?t:r,s.v2=l,this._dmap.addDiagonal(s)}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}}},{key:"_testDiagonal",value:function(e,t){var r=e.next.x-e.x,n=e.next.y-e.y,i=e.prev.x-e.x,a=e.prev.y-e.y,o=t.x-e.x,u=t.y-e.y,s=r*u-o*n>0,l=i*u-o*a<0,_=r*a-i*n;return _>=0?s&&l:s||l}},{key:"_shuffleArray",value:function(e){for(var t=e.length-1;t>0;--t){var r=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[r],e[r]=n}}}]),e}(),c=function(){function e(){r(this,e),this._map=new Map}return i(e,[{key:"addDiagonal",value:function(e){this._addDiagonalByVertex(e.v1,e),this._addDiagonalByVertex(e.v2,e)}},{key:"removeDiagonal",value:function(e){this._removeDiagonalByVertex(e.v1,e),this._removeDiagonalByVertex(e.v2,e)}},{key:"removeDiagonals",value:function(e){var t=this._map.get(e);if(void 0!==t){var r=t.slice(),n=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;this.removeDiagonal(s)}}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return[]}},{key:"_addDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)this._map.set(e,[t]);else{if(r.indexOf(t)!=-1)throw new Error("Unexpected");if(r.length<1||r.length>2)throw new Error("Unexpected");r.push(t)}}},{key:"_removeDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)throw new Error("Unexpected");var n=r.indexOf(t);if(n==-1)throw new Error("Unexpected");r.splice(n,1),0==r.length&&this._map.delete(e)}}]),e}(),f=function(){function e(){r(this,e),this._array=new Array}return i(e,[{key:"push",value:function(e){this._array.push(e)}},{key:"pop",value:function(){return this._array.pop()}},{key:"size",get:function(){return this._array.length}},{key:"top",get:function(){var e=this._array;return e.length>0?e[e.length-1]:null}}]),e}();t.default=a,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e),this._area_list=[],this._flat_area_list=null}return n(e,[{key:"isEmpty",value:function(){return 0==this._area_list.length}},{key:"clear",value:function(){this._area_list.length=0,this._flat_area_list=null}},{key:"addTileArea",value:function(e){this._area_list.push({z:e.z,x:e.x,y:e.y}),this._flat_area_list=null}},{key:"getFlatAreaList",value:function(){return null===this._flat_area_list&&(this._flat_area_list=this._createFlatAreaList()),this._flat_area_list}},{key:"_createFlatAreaList",value:function(){for(var e=new a,t=0;t<this._area_list.length;++t){var r=this._area_list[t];e.addDescendant(r.z,r.x,r.y)}return e.reduceTree(),e.collectFlatAreas(0,new Uint8Array(64),[])}}]),e}(),a=function(){function e(){r(this,e),this.present=!1,this.children=new Array(4).fill(null)}return n(e,[{key:"addDescendant",value:function(t,r,n){if(this.present!==!0)if(0==t)this.present=!0,this.children.fill(null);else{var i=Math.round(Math.pow(2,t-1)),a=Math.floor(r/i),o=Math.floor(n/i),u=a+2*o;null===this.children[u]&&(this.children[u]=new e),this.children[u].addDescendant(t-1,r%i,n%i)}}},{key:"reduceTree",value:function(){if(this.present===!0)return 1;for(var e=0,t=0;t<4;++t){var r=this.children[t];null!==r&&(e+=r.reduceTree())}return 4==e?(this.present=!0,this.children.fill(null),1):0}},{key:"collectFlatAreas",value:function(e,t,r){if(this.present===!0)r.push(new Uint8Array(t.slice(0,e)));else for(var n=0;n<4;++n){var i=this.children[n];null!==i&&(t[e]=n,i.collectFlatAreas(e+1,t,r))}return r}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(23),l=n(s),_=r(105),c=n(_),f=r(104),h=n(f),d=function(e){function t(e){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.default,h.default))}return o(t,e),u(t,[{key:"isWireframe",value:function(){return!0}},{key:"setFlakeParameter",value:function(e,t,r,n){return this.setCommonParameter(e,r),!0}}]),t}(l.default);t.default=d,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(41),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.accessors[r];this._type=n.type,this._componentType=n.componentType,this._count=n.count,this._bufferView=new u.default(t,n.bufferView),this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._normalized=n.normalized||!1,this._min=n.min?n.min.slice():null,this._max=n.max?n.max.slice():null,this._index=r}return a(e,[{key:"getRangeInBuffer",value:function(){var t=this._bufferView,r=e._ComponentData[this._componentType].bytes,n=r*e._NumComponents[this._type],i=0==t.byteStride?n:t.byteStride,a=this._byteOffset+t.byteOffset;return{first:a,last:a+i*(this._count-1)+n}}},{key:"modifyByteOrder",value:function(t){var r=e._ComponentData[this._componentType],n=r.bytes;if(1!=n)for(var i=e._NumComponents[this._type],a=this._byteOffset+this._bufferView.byteOffset,o=0==this._bufferView.byteStride?i:this._bufferView.byteStride/n,u=this._bufferView.buffer.binary,s=new DataView(u,a),l=new r.typedarray(u,a),_=r.getcompo,c=n/2,f=a/2,h=o*c,d=0;d<this._count;++d)for(var v=f+d*h,p=d*o,y=0;y<i;++y){var m=v+y*c;if(!t.getBit(m)){var g=p+y,b=_.call(s,g*n,!0);l[g]=b,t.setBit(m,!0)}}}},{key:"isIncluded",value:function(e,t){var r=this._byteOffset+this._bufferView.byteOffset;return e<=r&&r<t}},{key:"rebuildBySplitter",value:function(e,t){this._index=-1;var r=this._byteOffset+this._bufferView.byteOffset;this._byteOffset=r-t,this._bufferView.rebuildBySplitter(e)}},{key:"index",get:function(){return this._index}},{key:"bufferView",get:function(){return this._bufferView}},{key:"type",get:function(){return this._type}},{key:"componentType",get:function(){return this._componentType}},{key:"count",get:function(){return this._count}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"normalized",get:function(){return this._normalized}},{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();s._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},s._ComponentData={5120:{bytes:1,getcompo:DataView.prototype.getInt8,typedarray:Int8Array},5121:{bytes:1,getcompo:DataView.prototype.getUint8,typedarray:Uint8Array},5122:{bytes:2,getcompo:DataView.prototype.getInt16,typedarray:Int16Array},5123:{bytes:2,getcompo:DataView.prototype.getUint16,typedarray:Uint16Array},5125:{bytes:4,getcompo:DataView.prototype.getUint32,typedarray:Uint32Array},5126:{bytes:4,getcompo:DataView.prototype.getFloat32,typedarray:Float32Array}},t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){var i=this;if(r(this,e),void 0===t)this._index=-1,this._byteLength=0,this._uri=null,this._binary=null;else{this._index=n;var a=t.gjson.buffers[n];this._byteLength=a.byteLength,void 0!==a.uri?(t.onStartLoadBuffer(),t.loadBinary(a.uri).then(function(e){i._binary=e,t.onFinishLoadBuffer()}).catch(function(e){console.error(e),t.onFinishLoadBuffer(e)})):(this._uri=null,this._binary=null)}}return n(e,[{key:"createSubBuffer",value:function(t,r){var n=new e;return n._byteLength=r-t,n._binary=this._binary.slice(t,r),n}},{key:"index",get:function(){return this._index}},{key:"binary",get:function(){return this._binary}},{key:"byteLength",get:function(){return this._byteLength}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(78),u=n(o),s=r(46),l=n(s),_=function(){function e(t){i(this,e),this._buffer=t,this._attrib_accessors=[],this._index_accessors=[]}return a(e,[{key:"addAttributeAccessor",value:function(e){this._attrib_accessors.push(e)}},{key:"addIndexAccessor",value:function(e){this._index_accessors.push(e)}},{key:"rewriteByteOrder",value:function(){var e=new l.default(Math.ceil(this._buffer.byteLength/2)),t=!0,r=!1,n=void 0;try{for(var i,a=this._getUnitedOriginalAccessors()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;o.modifyByteOrder(e)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}}},{key:"splitBufferAndRebuildAccessors",value:function(){this._splitBufferAndRebuildAccessors(this._attrib_accessors),this._splitBufferAndRebuildAccessors(this._index_accessors)}},{key:"_splitBufferAndRebuildAccessors",value:function(t){var r=new u.default,n=!0,i=!1,a=void 0;try{for(var o,s=e._getOriginalAccessors(t)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var l=o.value;r.update(l)}}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}r.close(this._buffer);var _=!0,c=!1,f=void 0;try{for(var h,d=t[Symbol.iterator]();!(_=(h=d.next()).done);_=!0){var v=h.value;r.rebuildAccessor(v)}}catch(e){c=!0,f=e}finally{try{!_&&d.return&&d.return()}finally{if(c)throw f}}}},{key:"_getUnitedOriginalAccessors",value:function(){return e._getOriginalAccessors(this._attrib_accessors.concat(this._index_accessors))}},{key:"buffer",get:function(){return this._buffer}}],[{key:"_getOriginalAccessors",value:function(e){var t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value,s=u.index;t.has(s)||t.set(s,u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return t.values()}}]),e}();t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){r(this,e);var t=new a(-2,-1),n=new a(Math.pow(2,32)+1,Math.pow(2,32)+2);
t.next=n,n.prev=t,this._fragments=t}return n(e,[{key:"update",value:function(t){var r=t.getRangeInBuffer();this._updateByRange({first:e._floor4(r.first),last:r.last})}},{key:"close",value:function(e){this._fragments=this._fragments.next;for(var t=this._fragments;;t=t.next){if(null===t.next){t.prev.next=null;break}t.buffer=e.createSubBuffer(t.first,t.last)}}},{key:"rebuildAccessor",value:function(e){for(var t=this._fragments;null!==t;t=t.next)if(e.isIncluded(t.first,t.last)){e.rebuildBySplitter(t.buffer,t.first);break}}},{key:"_updateByRange",value:function(e){for(var t=this._fragments;null!==t.next;){if(t.isInside(e)){var r=t,n=t.next,i=new a(e.first,e.last);r.next=i,n.prev=i,i.prev=r,i.next=n;break}if(t.isTouch(e)){var o=t.prev,u=t.next;o.next=u,u.prev=o,e=t.mergeRange(e),t=o}else t=t.next}}}],[{key:"_floor4",value:function(e){return 4*Math.floor(e/4)}}]),e}(),a=function(){function e(t,n){r(this,e),this.first=t,this.last=n,this.buffer=null,this.prev=null,this.next=null}return n(e,[{key:"isInside",value:function(e){return this.last<e.first&&e.last<this.next.first}},{key:"isTouch",value:function(e){return this.last>=e.first&&e.last>=this.first}},{key:"mergeRange",value:function(e){return{first:Math.min(this.first,e.first),last:Math.max(this.last,e.last)}}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(42),u=n(o),s=r(87),l=n(s),_=r(77),c=n(_),f=r(81),h=n(f),d=r(76),v=n(d),p=r(80),y=n(p),m=function(){function e(t,r){i(this,e);var n=r||{};this._gjson=t,this._base_resource=n.base_resource,this._binary_type=n.binary_type,this._image_type=n.image_type,this._resolve=null,this._reject=null,this._scenes=[],this._default_scene_index=-1,this._buffer_entries=[],this._image_entries=[],this._body_finished=!1,this._load_count=0,this._load_error=null,this._settled=!1}return a(e,[{key:"load",value:function(){var e=this;return new Promise(function(t,r){e._resolve=t,e._reject=r;var n=e._loadVersion();n.major<2&&e._reject(new Error("glTF version error")),e._loadScenes(),e._loadDefaultSceneIndex(),e._onFinishLoadBody()})}},{key:"_loadVersion",value:function(){var e=this._gjson.asset,t=e.version,r=/^(\d+)\.(\d+)/.exec(t),n=Number(r[1]),i=Number(r[2]);return{major:n,minor:i}}},{key:"_loadScenes",value:function(){for(var e=(this._gjson.scenes||[]).length,t=[],r=0;r<e;++r)t.push(new l.default(this,r));this._scenes=t}},{key:"_loadDefaultSceneIndex",value:function(){"number"==typeof this._gjson.scene&&(this._default_scene_index=this._gjson.scene)}},{key:"loadBinary",value:function(e){return this._base_resource.loadSubResource(e,this._binary_type)}},{key:"loadImage",value:function(e){return this._base_resource.loadSubResource(e,this._image_type)}},{key:"findBuffer",value:function(e){return void 0===this._buffer_entries[e]&&(this._buffer_entries[e]=new c.default(new v.default(this,e))),this._buffer_entries[e].buffer}},{key:"findImage",value:function(e){return void 0===this._image_entries[e]&&(this._image_entries[e]=new h.default(new y.default(this,e))),this._image_entries[e].image}},{key:"addAccessor",value:function(e,t){var r=this._buffer_entries[e.bufferView.buffer.index];switch(t){case"ATTRIBUTE":r.addAttributeAccessor(e);break;case"INDEX":r.addIndexAccessor(e)}}},{key:"addTextureInfo",value:function(e){var t=e.texture.source,r=this._image_entries[t.index];r.addTextureInfo(e)}},{key:"onStartLoadBuffer",value:function(){this._load_count+=1}},{key:"onFinishLoadBuffer",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"onStartLoadImage",value:function(){this._load_count+=1}},{key:"onFinishLoadImage",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"_onFinishLoadBody",value:function(){this._body_finished=!0,this._onFinishLoadSomething()}},{key:"_onFinishLoadSomething",value:function(){this._settled||(null!==this._load_error?(this._reject(this._load_error),this._settled=!0):this._body_finished&&0==this._load_count&&(this._rewriteBuffersForByteOrder(),this._splitBuffersAndRebuildAccessors(),this._rebuildTextureInfo(),this._resolve(new u.default(this._scenes,this._default_scene_index)),this._settled=!0))}},{key:"_rewriteBuffersForByteOrder",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rewriteByteOrder()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"_splitBuffersAndRebuildAccessors",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.splitBufferAndRebuildAccessors()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"_rebuildTextureInfo",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._image_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rebuildTextureInfo()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"gjson",get:function(){return this._gjson}}]),e}();t.default=m,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(41),u=n(o),s=function(){function e(t,r){var n=this;i(this,e),this._index=r;var a=t.gjson.images[r];void 0!==a.uri?(t.onStartLoadImage(),t.loadImage(a.uri).then(function(e){n._image=e,t.onFinishLoadImage()}).catch(function(e){t.onFinishLoadImage(e)})):void 0!==a.bufferView&&(this._bufferView=new u.default(t,a.bufferView)),this._mimeType=a.mimeType,this._image=null}return a(e,[{key:"index",get:function(){return this._index}},{key:"image",get:function(){return this._image}}]),e}();t.default=s,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this._image=t,this._texinfo_objects=[]}return n(e,[{key:"addTextureInfo",value:function(e){this._texinfo_objects.push(e)}},{key:"rebuildTextureInfo",value:function(){var e=this._texinfo_objects;if(!(e.length<=1))for(var t=e[0].texture,r=1;r<e.length;++r)e[r].texture=t}},{key:"image",get:function(){return this._image}}]),e}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(20),u=n(o),s=r(43),l=n(s),_=r(44),c=n(_),f=function(){function e(t,r){i(this,e),this._pbrMetallicRoughness={baseColorFactor:[1,1,1,1],baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},this._doubleSided=!1,this._alphaMode="OPAQUE",this._alphaCutoff=.5,this._emissiveFactor=[0,0,0],this._emissiveTexture=null,this._normalTexture=null,this._occlusionTexture=null;var n=t.gjson.materials[r];this._setupPbrMetallicRoughness(n,t),this._setupGenericParameters(n,t)}return a(e,[{key:"_setupPbrMetallicRoughness",value:function(e,t){if(void 0!==e.pbrMetallicRoughness){var r=e.pbrMetallicRoughness,n=this._pbrMetallicRoughness;void 0!==r.baseColorFactor&&(n.baseColorFactor=r.baseColorFactor.slice()),void 0!==r.baseColorTexture&&(n.baseColorTexture=new u.default(r.baseColorTexture,t),t.addTextureInfo(n.baseColorTexture)),void 0!==r.metallicFactor&&(n.metallicFactor=r.metallicFactor),void 0!==r.roughnessFactor&&(n.roughnessFactor=r.roughnessFactor),void 0!==r.metallicRoughnessTexture&&(n.metallicRoughnessTexture=new u.default(r.metallicRoughnessTexture,t),t.addTextureInfo(n.metallicRoughnessTexture))}}},{key:"_setupGenericParameters",value:function(e,t){void 0!==e.doubleSided&&(this._doubleSided=e.doubleSided),void 0!==e.alphaMode&&(this._alphaMode=e.alphaMode),void 0!==e.alphaCutoff&&(this._alphaCutoff=e.alphaCutoff),void 0!==e.emissiveFactor&&(this._emissiveFactor=e.emissiveFactor.slice()),void 0!==e.emissiveTexture&&(this._emissiveTexture=new u.default(e.emissiveTexture,t),t.addTextureInfo(this._emissiveTexture)),void 0!==e.normalTexture&&(this._normalTexture=new l.default(e.normalTexture,t),t.addTextureInfo(this._normalTexture)),void 0!==e.occlusionTexture&&(this._occlusionTexture=new c.default(e.occlusionTexture,t),t.addTextureInfo(this._occlusionTexture))}},{key:"pbrMetallicRoughness",get:function(){return this._pbrMetallicRoughness}},{key:"doubleSided",get:function(){return this._doubleSided}},{key:"alphaMode",get:function(){return this._alphaMode}},{key:"alphaCutoff",get:function(){return this._alphaCutoff}},{key:"emissiveFactor",get:function(){return this._emissiveFactor}},{key:"emissiveTexture",get:function(){return this._emissiveTexture}},{key:"normalTexture",get:function(){return this._normalTexture}},{key:"occlusionTexture",get:function(){return this._occlusionTexture}}]),e}();t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(85),u=n(o),s=function(){function e(t,r){i(this,e),this._primitives=[];for(var n=t.gjson.meshes[r],a=n.primitives,o=0;o<a.length;++o){var s=a[o];this._primitives.push(new u.default(s,t))}}return a(e,[{key:"primitives",get:function(){return this._primitives}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(1),s=n(u),l=r(83),_=n(l),c=function(){function e(t,r){i(this,e);var n=t.gjson.nodes[r];this._children=[],this._matrix=null,this._mesh=null,this._setupChildren(n,t),this._setupMatrix(n),this._setupMesh(n,t)}return o(e,[{key:"_setupChildren",value:function(t,r){var n=t.children;if(void 0!==n)for(var i=0;i<n.length;++i){var a=n[i];this._children.push(new e(r,a))}}},{key:"_setupMatrix",value:function(e){if(e.matrix)this._matrix=s.default.createMatrix(e.matrix);else if(e.scale||e.rotation||e.translation){var t=e.scale||[1,1,1],r=a(t,3),n=r[0],i=r[1],o=r[2],u=e.rotation||[0,0,0,1],l=a(u,4),_=l[0],c=l[1],f=l[2],h=l[3],d=e.translation||[0,0,0],v=a(d,3),p=v[0],y=v[1],m=v[2];this._matrix=s.default.createMatrix([(1-2*(c*c+f*f))*n,2*(_*c+f*h)*n,2*(_*f-c*h)*n,0,2*(_*c-f*h)*i,(1-2*(_*_+f*f))*i,2*(_*h+c*f)*i,0,2*(c*h+_*f)*o,2*(c*f-_*h)*o,(1-2*(_*_+c*c))*o,0,p,y,m,1])}}},{key:"_setupMesh",value:function(e,t){var r=e.mesh;void 0!==r&&(this._mesh=new _.default(t,r))}},{key:"children",get:function(){return this._children}},{key:"matrix",get:function(){return this._matrix}},{key:"mesh",get:function(){return this._mesh}}]),e}();t.default=c,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(75),u=n(o),s=r(82),l=n(s),_=function(){function e(t,r){i(this,e),this._mode=void 0!==t.mode?t.mode:4,this._attributes={},this._indices=null,this._material=null,this._setupAttributes(t.attributes,r),this._setupIndices(t,r),this._setupMaterial(t,r)}return a(e,[{key:"_setupAttributes",value:function(e,t){for(var r in e){var n=new u.default(t,e[r]);this._attributes[r]=n,t.addAccessor(n,"ATTRIBUTE")}}},{key:"_setupIndices",value:function(e,t){if(void 0!==e.indices){var r=new u.default(t,e.indices);this._indices=r,t.addAccessor(r,"INDEX")}}},{key:"_setupMaterial",value:function(e,t){void 0!==e.material&&(this._material=new l.default(t,e.material))}},{key:"mode",get:function(){return this._mode}},{key:"attributes",get:function(){return this._attributes}},{key:"indices",get:function(){return this._indices}},{key:"material",get:function(){return this._material}}]),e}();t.default=_,e.exports=t.default},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,n){r(this,e);var i="number"==typeof n?t.gjson.samplers[n]:{};this._magFilter=i.magFilter,this._minFilter=i.minFilter,this._wrapS=void 0!==i.wrapS?i.wrapS:e.WRAP_DEFAULT,this._wrapT=void 0!==i.wrapT?i.wrapT:e.WRAP_DEFAULT}return n(e,[{key:"magFilter",get:function(){return this._magFilter}},{key:"minFilter",get:function(){return this._minFilter}},{key:"wrapS",get:function(){return this._wrapS}},{key:"wrapT",get:function(){return this._wrapT}}]),e}();i.WRAP_DEFAULT=10497,t.default=i,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(84),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.scenes[r];this._root_nodes=[],this._name=null;var a=!0,o=!1,s=void 0;try{for(var l,_=(n.nodes||[])[Symbol.iterator]();!(a=(l=_.next()).done);a=!0){var c=l.value;this._root_nodes.push(new u.default(t,c))}}catch(e){o=!0,s=e}finally{try{!a&&_.return&&_.return()}finally{if(o)throw s}}"string"==typeof n.name&&(this._name=n.name)}return a(e,[{key:"root_nodes",get:function(){return this._root_nodes}},{key:"name",get:function(){return this._name}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(86),u=n(o),s=function(){function e(t,r){i(this,e);var n=t.gjson.textures[r];this._sampler=new u.default(t,n.sampler),this._source=t.findImage(n.source)}return a(e,[{key:"source",get:function(){return this._source}},{key:"sampler",get:function(){return this._sampler}}]),e}();t.default=s,e.exports=t.default},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(79),u=n(o),s=function(){function e(){i(this,e)}return a(e,null,[{key:"load",value:function(e,t){var r=new u.default(e,t);return r.load()}}]),e}();t.default=s,e.exports=t.default},function(e,t){e.exports="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // テクスチャ座標\nuniform sampler2D u_image;      // 画像\n\n\nvoid\nmain()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}\n"},function(e,t){e.exports="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nuniform vec4 u_color;  // 線の基本色と不透明度\n\nvoid\nmain()\n{\n    gl_FragColor = vec4( u_color.xyz * u_color.w, u_color.w );\n}\n"},function(e,t){e.exports="/**\n * 太さ付き線分の頂点シェーダ\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec3 a_direction;   // 線分方向 (モデル座標系) = 終点位置 - 始点位置\nattribute vec2 a_where;       // 線分の4隅指定: 始点左: {-1, 1}, 始点右: {-1, -1}, 終点左: {1, 1}, 終点右: {1, -1}\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec3 u_sparam;        // 画面パラメータ: {2/w, 2/h, h/w}\nuniform vec2 u_thickness;     // 線の太さの半分: {u, v}\n\nvec2\noffset( vec4 cpos )\n{\n    vec4 q0 = cpos;\n    q0.y *= u_sparam.z;  // q0 = A * q0\n    vec4 q1 = cpos + u_obj_to_clip * vec4( a_direction, 0 );\n    q1.y *= u_sparam.z;  // q1 = A * q1\n\n    vec2 ds = normalize( q1.xy / q1.w - q0.xy / q0.w );\n    vec2 wt = a_where * u_thickness;\n    return mat2( ds.x, ds.y, -ds.y, ds.x ) * wt;\n}\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += offset( gl_Position ) * u_sparam.xy * gl_Position.w;\n}\n"},function(e,t){e.exports="precision highp float;\n\nvarying vec3  v_normal;    // 法線 (視点座標系)\nvarying vec2  v_texcoord;  // テクスチャ座標\n\nuniform vec3      u_light_dir;   // ライト逆方向 (視点座標系) と強さ\nuniform vec4      u_base_color;  // 基本色係数\nuniform sampler2D u_base_image;  // 基本色画像\n\n\nvoid\nmain()\n{\n    vec3 normal = normalize( v_normal );  // 法線 (視点座標系)\n\n    vec3 dlit = vec3( dot( normal, u_light_dir ) );  // 拡散光の強さ\n\n    gl_FragColor = u_base_color * texture2D( u_base_image, v_texcoord ) * vec4( dlit, 1.0 );\n}\n"},function(e,t){e.exports="attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec3 a_normal;      // 法線 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4  u_obj_to_view;  // モデル座標系から視点座標系への変換\n\nvarying vec3  v_normal;       // 法線 (視点座標系)\nvarying vec2  v_texcoord;     // テクスチャ座標\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    v_normal   =  normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );  // 法線 (視点座標系)\n    v_texcoord = a_texcoord;\n}\n"},function(e,t){e.exports="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // アイコンのテクスチャ座標\nvarying vec2 v_texmaskcoord;    // アイコンマスクのテクスチャ座標\nvarying vec3 v_fg_color;        // 前景色\nvarying vec3 v_bg_color;        // 背景色\n\nuniform sampler2D u_image;      // アイコン画像\nuniform sampler2D u_image_mask; // アイコンマスク画像\n\n\nvoid\nmain()\n{\n    float alpha = texture2D( u_image, v_texcoord ).w;          // 輝度\n    float mask = texture2D( u_image_mask, v_texmaskcoord ).w;  // マスク\n    alpha *= mask;\n    gl_FragColor = vec4(v_fg_color * alpha + v_bg_color * (1.0 - alpha), 1.0);\n}\n"},function(e,t){e.exports="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\nattribute vec2 a_texmaskcoord; // テクスチャマスク座標\nattribute vec3 a_fg_color;     // 前景色\nattribute vec3 a_bg_color;     // 背景色\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\nvarying vec2 v_texmaskcoord;   // テクスチャマスク座標\nvarying vec3 v_fg_color;       // 前景色\nvarying vec3 v_bg_color;       // 背景色\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_texmaskcoord = a_texmaskcoord;\n    v_fg_color = a_fg_color;\n    v_bg_color = a_bg_color;\n}\n"},function(e,t){e.exports="/**\n * 多角形のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\nuniform vec4 u_color;        // 基本色と不透明度\n\n\nvoid\nmain()\n{\n    vec3  color   = u_color.xyz * v_lit_diffuse;\n    float opacity = u_color.w;\n\n    gl_FragColor = vec4( color * opacity, opacity );\n}\n"},function(e,t){e.exports="/**\n * 多角形の頂点シェーダ\n */\n\nattribute vec4 a_position;   // 位置 (モデル座標系)\nattribute vec3 a_normal;     // 法線 (モデル座標系)\n\nuniform mat4 u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4 u_obj_to_view;  // モデル座標系から視点座標系への変換\nuniform bool u_lighting;     // 照光の有無\nuniform vec3 u_light_dir;    // ライト逆方向 (視点座標系) と強さ\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    if ( u_lighting ) {\n        // 法線 (視点座標系)\n        vec3 normal = normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );\n\n        // 拡散光の強さ\n        v_lit_diffuse = vec3( dot( normal, u_light_dir ) );\n    }\n    else {\n        // 照光なしのときは 1 に固定\n        v_lit_diffuse = vec3( 1 );\n    }\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2  v_texcoord_hi;    // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;    // 低レベル画像のテクスチャ座標\nvarying float v_lod;            // 補間された LOD\n\nuniform sampler2D u_image_hi;   // 高レベル画像\nuniform sampler2D u_image_lo;   // 低レベル画像\nuniform float     u_opacity;    // 不透明度\n\n/** 画像パラメータ\n *\n *  x = u_image_lo の LOD\n *  y = 1 / (u_image_hi の LOD - x)\n *\n *  ただし u_image_hi と u_image_lo が同じ画像のときは y = 0\n */\nuniform vec2 u_image_param;\n\n\nvoid main()\n{\n    vec4 color_hi = texture2D( u_image_hi, v_texcoord_hi );\n    vec4 color_lo = texture2D( u_image_lo, v_texcoord_lo );\n\n    // 画像の混合率\n    float lo_lod = u_image_param.x;\n    float  delta = u_image_param.y;\n    float  ratio = clamp( (v_lod - lo_lod) * delta, 0.0, 1.0 );\n\n    gl_FragColor = mix( color_lo, color_hi, ratio );\n    gl_FragColor.a *= u_opacity;  // 不透明度を適用\n}\n"},function(e,t){e.exports="attribute vec4 a_position;         // 位置 (地表断片座標系)\nattribute vec2 a_uv;               // uv 座標\n\nuniform mat4  u_obj_to_clip;       // 地表断片座標系からクリップ座標系への変換\n\nuniform vec4  u_texcoord_rect_hi;  // 高レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_texcoord_rect_lo;  // 低レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_corner_lod;        // uv = (0,0), (1,0), (0,1), (1,1) の LOD\n\nvarying vec2  v_texcoord_hi;       // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;       // 低レベル画像のテクスチャ座標\nvarying float v_lod;               // 補間された LOD\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    // uv 座標をテクスチャ座標に変換\n    v_texcoord_hi = u_texcoord_rect_hi.xy + u_texcoord_rect_hi.zw * a_uv;\n    v_texcoord_lo = u_texcoord_rect_lo.xy + u_texcoord_rect_lo.zw * a_uv;\n\n    // LOD の補間\n    float u = a_uv.x;\n    float v = a_uv.y;\n\n    float lod_00 = u_corner_lod.x;  // uv = (0,0) の LOD\n    float lod_10 = u_corner_lod.y;  // uv = (1,0) の LOD\n    float lod_01 = u_corner_lod.z;  // uv = (0,1) の LOD\n    float lod_11 = u_corner_lod.w;  // uv = (1,1) の LOD\n\n    float lod_u0 = mix( lod_00, lod_10, u );  // uv = (u, 0) の LOD\n    float lod_u1 = mix( lod_01, lod_11, u );  // uv = (u, 1) の LOD\n    float lod_uv = mix( lod_u0, lod_u1, v );  // uv = (u, v) の LOD\n\n    v_lod = lod_uv;\n}\n"},function(e,t){e.exports="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;     // テキストのテクスチャ座標\nvarying vec4 v_color;        // テキストの色と不透明度\n\nuniform sampler2D u_image;   // テキスト画像\n\nvoid\nmain()\n{\n    float level = texture2D( u_image, v_texcoord ).w;  // 輝度\n    float alpha = v_color.w * level;\n    gl_FragColor = vec4( v_color.xyz * alpha, alpha );\n}\n"},function(e,t){e.exports="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\nattribute vec4 a_color;       // テキストの色と不透明度\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\nvarying vec4 v_color;         // テキストの色と不透明度\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_color    = a_color;\n}\n"},function(e,t){e.exports="precision mediump float;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    vec4 color = (v_uv.x < 0.005 || v_uv.y < 0.005 || v_uv.x > 0.995 || v_uv.y > 0.995) ?\n                 vec4( 1, 1, 0, 1 ) : vec4( 0.5, 0.5, 0.5, 1 );\n    gl_FragColor = color;\n}\n"},function(e,t){e.exports="attribute vec4 a_position;\nattribute vec2 a_uv;\n\nuniform mat4 u_obj_to_clip;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_uv  = a_uv;\n}\n"}])});